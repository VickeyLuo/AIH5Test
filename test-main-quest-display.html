<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»çº¿ä»»åŠ¡æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: 3px;
            font-size: 12px;
        }
        button:hover {
            background: #45a049;
        }
        .quest-display {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #555;
            margin: 10px 0;
        }
        .border-yellow-500 { border-color: #eab308; }
        .border-green-500 { border-color: #22c55e; }
        .text-blue-400 { color: #60a5fa; }
        .text-green-400 { color: #4ade80; }
        .hidden { display: none; }
        .log {
            background: #1a1a1a;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid #444;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¸»çº¿ä»»åŠ¡æ˜¾ç¤ºæµ‹è¯•</h1>
        
        <div class="section">
            <h2>æ§åˆ¶é¢æ¿</h2>
            <button onclick="resetToFresh()">é‡ç½®ä¸ºæ–°æ¸¸æˆ</button>
            <button onclick="simulateFirstQuestCompleted()">æ¨¡æ‹Ÿå®Œæˆç¬¬1ä¸ªä»»åŠ¡</button>
            <button onclick="simulateSecondQuestCompleted()">æ¨¡æ‹Ÿå®Œæˆç¬¬2ä¸ªä»»åŠ¡</button>
            <button onclick="simulateAllQuestsCompleted()">æ¨¡æ‹Ÿæ‰€æœ‰ä»»åŠ¡å®Œæˆ</button>
            <button onclick="refreshDisplay()">åˆ·æ–°æ˜¾ç¤º</button>
            <button onclick="testInitializeQuests()">æµ‹è¯•åˆå§‹åŒ–ä»»åŠ¡</button>
        </div>
        
        <div class="grid">
            <div>
                <div class="section">
                    <h2>ä¸»çº¿ä»»åŠ¡æ˜¾ç¤ºé¢æ¿</h2>
                    <div id="mainQuestDisplay" class="quest-display border-yellow-500">
                        <h3 id="mainQuestTitle">åŠ è½½ä¸­...</h3>
                        <p id="mainQuestDescription">æ­£åœ¨åŠ è½½ä»»åŠ¡ä¿¡æ¯...</p>
                        <div id="mainQuestProgress" class="text-blue-400">è¿›åº¦: 0/1</div>
                        <div id="mainQuestReward">å¥–åŠ±: åŠ è½½ä¸­...</div>
                        <div id="mainQuestSubmitHint" class="hidden">ç‚¹å‡»æäº¤ä»»åŠ¡</div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>æ¸¸æˆçŠ¶æ€</h2>
                    <div id="gameStatus"></div>
                </div>
            </div>
            
            <div>
                <div class="section">
                    <h2>è°ƒè¯•æ—¥å¿—</h2>
                    <div id="debugLog" class="log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ¸¸æˆçŠ¶æ€
        let gameState = {
            player: {
                level: 1,
                quests: {
                    available: [],
                    active: [],
                    completed: []
                }
            }
        };

        // ä¸»çº¿ä»»åŠ¡é…ç½®
        let mainQuestChainConfig = [
            {
                id: 1,
                name: 'åˆå…¥æ±Ÿæ¹–',
                description: 'è£…å¤‡ä¸€ä»¶æ­¦å™¨å¼€å§‹ä½ çš„å†’é™©',
                type: 'equip',
                target: 'weapon',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 50, gold: 20 },
                order: 1
            },
            {
                id: 2,
                name: 'åˆè¯•èº«æ‰‹',
                description: 'å‡»è´¥5åªæ€ªç‰©',
                type: 'kill',
                target: 'any',
                targetCount: 5,
                currentCount: 0,
                rewards: { exp: 100, gold: 50 },
                order: 2
            },
            {
                id: 3,
                name: 'è´¢å¯Œç§¯ç´¯',
                description: 'æ”¶é›†200é‡‘å¸',
                type: 'collect',
                target: 'gold',
                targetCount: 200,
                currentCount: 0,
                rewards: { exp: 80, gold: 30 },
                order: 3
            }
        ];

        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function isMainQuest(questId) {
            return (typeof questId === 'number' && questId >= 1 && questId <= 20) || 
                   (typeof questId === 'string' && questId.startsWith('main_quest_'));
        }

        function updateGameStatus() {
            const statusDiv = document.getElementById('gameStatus');
            const availableMain = gameState.player.quests.available.filter(q => isMainQuest(q.id));
            const activeMain = gameState.player.quests.active.filter(q => isMainQuest(q.id));
            const completedMain = gameState.player.quests.completed.filter(q => isMainQuest(q.id));
            
            statusDiv.innerHTML = `
                <div class="status">å¯æ¥å–ä»»åŠ¡æ€»æ•°: ${gameState.player.quests.available.length}</div>
                <div class="status">å¯æ¥å–ä¸»çº¿ä»»åŠ¡: ${availableMain.length}</div>
                <div class="status">è¿›è¡Œä¸­ä»»åŠ¡æ€»æ•°: ${gameState.player.quests.active.length}</div>
                <div class="status">è¿›è¡Œä¸­ä¸»çº¿ä»»åŠ¡: ${activeMain.length}</div>
                <div class="status">å·²å®Œæˆä»»åŠ¡æ€»æ•°: ${gameState.player.quests.completed.length}</div>
                <div class="status">å·²å®Œæˆä¸»çº¿ä»»åŠ¡: ${completedMain.length}</div>
                <div class="status">é…ç½®ä¸­ä»»åŠ¡æ€»æ•°: ${mainQuestChainConfig.length}</div>
            `;
            
            if (availableMain.length > 0) {
                statusDiv.innerHTML += `<div class="status">å¯æ¥å–ä¸»çº¿: ${availableMain.map(q => `${q.name}(ID:${q.id})`).join(', ')}</div>`;
            }
            if (activeMain.length > 0) {
                statusDiv.innerHTML += `<div class="status">è¿›è¡Œä¸­ä¸»çº¿: ${activeMain.map(q => `${q.name}(ID:${q.id})`).join(', ')}</div>`;
            }
            if (completedMain.length > 0) {
                statusDiv.innerHTML += `<div class="status">å·²å®Œæˆä¸»çº¿: ${completedMain.map(q => `${q.name}(ID:${q.id})`).join(', ')}</div>`;
            }
        }

        function updateMainQuestDisplay() {
            log('=== å¼€å§‹æ›´æ–°ä¸»çº¿ä»»åŠ¡æ˜¾ç¤º ===');
            
            const activeMainQuests = gameState.player.quests.active.filter(q => isMainQuest(q.id));
            const availableMainQuests = gameState.player.quests.available.filter(q => isMainQuest(q.id));
            const completedMainQuests = gameState.player.quests.completed.filter(q => isMainQuest(q.id));
            
            log(`å½“å‰çŠ¶æ€: è¿›è¡Œä¸­ä¸»çº¿${activeMainQuests.length}ä¸ª, å¯æ¥å–ä¸»çº¿${availableMainQuests.length}ä¸ª, å·²å®Œæˆä¸»çº¿${completedMainQuests.length}ä¸ª`);
            
            const titleElement = document.getElementById('mainQuestTitle');
            const descriptionElement = document.getElementById('mainQuestDescription');
            const progressElement = document.getElementById('mainQuestProgress');
            const rewardElement = document.getElementById('mainQuestReward');
            const submitHintElement = document.getElementById('mainQuestSubmitHint');
            const displayElement = document.getElementById('mainQuestDisplay');
            
            // æŸ¥æ‰¾å½“å‰è¿›è¡Œä¸­çš„ä¸»çº¿ä»»åŠ¡
            const activeMainQuest = activeMainQuests[0];
            
            if (activeMainQuest) {
                log(`æ˜¾ç¤ºè¿›è¡Œä¸­çš„ä¸»çº¿ä»»åŠ¡: ${activeMainQuest.name} (ID: ${activeMainQuest.id})`);
                titleElement.textContent = activeMainQuest.name;
                descriptionElement.textContent = activeMainQuest.description;
                progressElement.textContent = `è¿›åº¦: ${Math.min(activeMainQuest.currentCount, activeMainQuest.targetCount)}/${activeMainQuest.targetCount}`;
                
                let rewardText = '';
                if (activeMainQuest.rewards.exp) rewardText += `ç»éªŒ+${activeMainQuest.rewards.exp}`;
                if (activeMainQuest.rewards.gold) rewardText += ` é‡‘å¸+${activeMainQuest.rewards.gold}`;
                if (activeMainQuest.rewards.item) rewardText += ` ${activeMainQuest.rewards.item}`;
                rewardElement.textContent = `å¥–åŠ±: ${rewardText}`;
                
                const isCompleted = activeMainQuest.currentCount >= activeMainQuest.targetCount;
                if (isCompleted) {
                    displayElement.className = 'quest-display border-green-500';
                    progressElement.className = 'text-green-400';
                    submitHintElement.className = '';
                    submitHintElement.textContent = 'ç‚¹å‡»æäº¤ä»»åŠ¡';
                } else {
                    displayElement.className = 'quest-display border-yellow-500';
                    progressElement.className = 'text-blue-400';
                    submitHintElement.className = 'hidden';
                }
            } else {
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯æ¥å–çš„ä¸»çº¿ä»»åŠ¡
                const availableMainQuest = availableMainQuests[0];
                
                log(`æ²¡æœ‰è¿›è¡Œä¸­çš„ä¸»çº¿ä»»åŠ¡ï¼ŒæŸ¥æ‰¾å¯æ¥å–ä»»åŠ¡: ${availableMainQuest ? availableMainQuest.name + ' (ID: ' + availableMainQuest.id + ')' : 'æ— '}`);
                
                if (availableMainQuest) {
                    log(`æ˜¾ç¤ºå¯æ¥å–çš„ä¸»çº¿ä»»åŠ¡: ${availableMainQuest.name}`);
                    titleElement.textContent = availableMainQuest.name;
                    descriptionElement.textContent = availableMainQuest.description;
                    progressElement.textContent = 'ç‚¹å‡»æ¥å–ä»»åŠ¡';
                    
                    let rewardText = '';
                    if (availableMainQuest.rewards.exp) rewardText += `ç»éªŒ+${availableMainQuest.rewards.exp}`;
                    if (availableMainQuest.rewards.gold) rewardText += ` é‡‘å¸+${availableMainQuest.rewards.gold}`;
                    if (availableMainQuest.rewards.item) rewardText += ` ${availableMainQuest.rewards.item}`;
                    rewardElement.textContent = `å¥–åŠ±: ${rewardText}`;
                    
                    displayElement.className = 'quest-display border-yellow-500';
                    progressElement.className = 'text-blue-400';
                    submitHintElement.className = '';
                    submitHintElement.textContent = 'ç‚¹å‡»æ¥å–ä»»åŠ¡';
                } else {
                    // è¿™é‡Œæ˜¯é—®é¢˜æ‰€åœ¨ï¼
                    log('âš ï¸ æ²¡æœ‰å¯æ¥å–çš„ä¸»çº¿ä»»åŠ¡ - è¿™å¯èƒ½æ˜¯é”™è¯¯çš„åˆ¤æ–­ï¼');
                    log(`è°ƒè¯•ä¿¡æ¯: å·²å®Œæˆ${completedMainQuests.length}ä¸ªä¸»çº¿ä»»åŠ¡ï¼Œé…ç½®ä¸­å…±æœ‰${mainQuestChainConfig.length}ä¸ªä»»åŠ¡`);
                    
                    if (completedMainQuests.length >= mainQuestChainConfig.length) {
                        log('âœ… ç¡®å®æ‰€æœ‰ä¸»çº¿ä»»åŠ¡éƒ½å®Œæˆäº†');
                        titleElement.textContent = 'ä¸»çº¿ä»»åŠ¡';
                        descriptionElement.textContent = 'æ­å–œï¼æ‰€æœ‰ä¸»çº¿ä»»åŠ¡å·²å®Œæˆï¼';
                        progressElement.textContent = 'ä»»åŠ¡å®Œæˆ';
                        rewardElement.textContent = 'æ„Ÿè°¢æ‚¨çš„æ¸¸ç©ï¼';
                    } else {
                        log('âŒ é”™è¯¯ï¼šåº”è¯¥è¿˜æœ‰ä¸»çº¿ä»»åŠ¡å¯æ¥å–ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°ï¼');
                        titleElement.textContent = 'ä¸»çº¿ä»»åŠ¡å¼‚å¸¸';
                        descriptionElement.textContent = 'ä»»åŠ¡ç³»ç»Ÿå‡ºç°å¼‚å¸¸ï¼Œè¯·åˆ·æ–°ä»»åŠ¡ç³»ç»Ÿ';
                        progressElement.textContent = 'ç³»ç»Ÿå¼‚å¸¸';
                        rewardElement.textContent = 'è¯·è”ç³»ç®¡ç†å‘˜';
                    }
                    
                    displayElement.className = 'quest-display border-green-500';
                    progressElement.className = 'text-green-400';
                    submitHintElement.className = 'hidden';
                }
            }
            
            log('=== ä¸»çº¿ä»»åŠ¡æ˜¾ç¤ºæ›´æ–°å®Œæˆ ===');
        }

        function initializeQuests() {
            log('=== å¼€å§‹åˆå§‹åŒ–ä»»åŠ¡ç³»ç»Ÿ ===');
            
            // æ¸…ç©ºç°æœ‰å¯æ¥ä»»åŠ¡
            gameState.player.quests.available = [];
            
            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯æ¥å–çš„ä¸»çº¿ä»»åŠ¡
            const completedMainQuests = gameState.player.quests.completed.filter(q => isMainQuest(q.id));
            const activeMainQuests = gameState.player.quests.active.filter(q => isMainQuest(q.id));
            
            log(`å·²å®Œæˆä¸»çº¿ä»»åŠ¡: ${completedMainQuests.length}ä¸ª`);
            log(`è¿›è¡Œä¸­ä¸»çº¿ä»»åŠ¡: ${activeMainQuests.length}ä¸ª`);
            
            const completedCount = completedMainQuests.length;
            const nextQuestIndex = completedCount;
            
            log(`è®¡ç®—ä¸‹ä¸€ä¸ªä»»åŠ¡ç´¢å¼•: ${nextQuestIndex}`);
            log(`é…ç½®ä¸­ä»»åŠ¡æ€»æ•°: ${mainQuestChainConfig.length}`);
            
            // å¦‚æœè¿˜æœ‰ä¸»çº¿ä»»åŠ¡æœªå®Œæˆï¼Œä¸”å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ä¸»çº¿ä»»åŠ¡
            if (nextQuestIndex < mainQuestChainConfig.length && activeMainQuests.length === 0) {
                const nextQuest = {...mainQuestChainConfig[nextQuestIndex]};
                nextQuest.currentCount = 0;
                
                // æ£€æŸ¥è¿™ä¸ªä»»åŠ¡æ˜¯å¦å·²ç»å­˜åœ¨
                const alreadyCompleted = gameState.player.quests.completed.some(q => q.id === nextQuest.id);
                const alreadyActive = gameState.player.quests.active.some(q => q.id === nextQuest.id);
                
                log(`æ£€æŸ¥ä»»åŠ¡ ${nextQuest.name} (ID: ${nextQuest.id}): å·²å®Œæˆ=${alreadyCompleted}, è¿›è¡Œä¸­=${alreadyActive}`);
                
                if (!alreadyCompleted && !alreadyActive) {
                    gameState.player.quests.available.push(nextQuest);
                    log(`âœ… æˆåŠŸæ·»åŠ æ–°çš„ä¸»çº¿ä»»åŠ¡: ${nextQuest.name} (ID: ${nextQuest.id})`);
                } else {
                    log(`âŒ è·³è¿‡ä»»åŠ¡ ${nextQuest.name}ï¼ŒåŸå› : ${alreadyCompleted ? 'å·²å®Œæˆ' : ''}${alreadyActive ? 'è¿›è¡Œä¸­' : ''}`);
                }
            } else {
                if (nextQuestIndex >= mainQuestChainConfig.length) {
                    log('ğŸ‰ æ‰€æœ‰ä¸»çº¿ä»»åŠ¡å·²å®Œæˆï¼');
                } else {
                    log('â³ æœ‰è¿›è¡Œä¸­çš„ä¸»çº¿ä»»åŠ¡ï¼Œä¸æ·»åŠ æ–°ä»»åŠ¡');
                }
            }
            
            log('=== ä»»åŠ¡ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ ===');
            updateGameStatus();
            updateMainQuestDisplay();
        }

        function resetToFresh() {
            gameState.player.quests = {
                available: [],
                active: [],
                completed: []
            };
            log('ğŸ”„ é‡ç½®ä¸ºæ–°æ¸¸æˆçŠ¶æ€');
            initializeQuests();
        }

        function simulateFirstQuestCompleted() {
            gameState.player.quests.completed = [
                {...mainQuestChainConfig[0], currentCount: 1}
            ];
            gameState.player.quests.active = [];
            gameState.player.quests.available = [];
            log('ğŸ¯ æ¨¡æ‹Ÿç¬¬1ä¸ªä»»åŠ¡å·²å®Œæˆ');
            initializeQuests();
        }

        function simulateSecondQuestCompleted() {
            gameState.player.quests.completed = [
                {...mainQuestChainConfig[0], currentCount: 1},
                {...mainQuestChainConfig[1], currentCount: 5}
            ];
            gameState.player.quests.active = [];
            gameState.player.quests.available = [];
            log('ğŸ¯ æ¨¡æ‹Ÿå‰2ä¸ªä»»åŠ¡å·²å®Œæˆ');
            initializeQuests();
        }

        function simulateAllQuestsCompleted() {
            gameState.player.quests.completed = mainQuestChainConfig.map(quest => ({
                ...quest,
                currentCount: quest.targetCount
            }));
            gameState.player.quests.active = [];
            gameState.player.quests.available = [];
            log('ğŸ¯ æ¨¡æ‹Ÿæ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ');
            initializeQuests();
        }

        function refreshDisplay() {
            log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ˜¾ç¤º');
            updateGameStatus();
            updateMainQuestDisplay();
        }

        function testInitializeQuests() {
            log('ğŸ§ª æµ‹è¯•åˆå§‹åŒ–ä»»åŠ¡å‡½æ•°');
            initializeQuests();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•');
            resetToFresh();
        };
    </script>
</body>
</html>