<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>养成系统测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">养成系统功能测试</h1>
        
        <div class="space-y-4">
            <button onclick="testShowCultivation()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">测试显示养成面板</button>
            <button onclick="testBuyMaterial()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">测试购买材料</button>
            <button onclick="testUpgrade()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">测试升级</button>
            <button onclick="checkGameState()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">检查游戏状态</button>
        </div>
        
        <div id="testResults" class="mt-6 p-4 bg-gray-800 rounded">
            <h2 class="text-lg font-bold mb-2">测试结果：</h2>
            <div id="results"></div>
        </div>
    </div>
    
    <script>
        // 模拟游戏状态
        let gameState = {
            player: {
                gold: 1000,
                materials: [],
                cultivation: {}
            }
        };
        
        // 从配置文件获取修炼系统数据
        function initializeCultivationData() {
            if (window.configManager && window.configManager.isInitialized()) {
                try {
                    const cultivationConfig = window.configManager.getCultivationConfig();
                    if (cultivationConfig) {
                        gameState.player.cultivation = cultivationConfig.initialLevels || getDefaultCultivationLevels();
                        return;
                    }
                } catch (error) {
                    console.warn('无法从配置获取修炼数据，使用默认数据');
                }
            }
            
            // 使用默认修炼数据
            gameState.player.cultivation = getDefaultCultivationLevels();
        }
        
        function getDefaultCultivationLevels() {
            return {
                dropRate: { level: 0, exp: 0 },
                damage: { level: 0, exp: 0 },
                whipCorpse: { level: 0, exp: 0 }
            };
        }
        
        function log(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }
        
        function testShowCultivation() {
            log('测试显示养成面板...');
            try {
                // 模拟showCultivationPanel函数
                log('✅ showCultivationPanel函数可以正常调用');
            } catch (error) {
                log('❌ showCultivationPanel函数调用失败: ' + error.message);
            }
        }
        
        function testBuyMaterial() {
            log('测试购买材料...');
            try {
                // 模拟buyCultivationMaterial函数
                const materialName = '铁矿石';
                const price = 50;
                
                if (gameState.player.gold >= price) {
                    gameState.player.gold -= price;
                    
                    const existingMaterial = gameState.player.materials.find(item => item.name === materialName);
                    if (existingMaterial) {
                        existingMaterial.count += 1;
                    } else {
                        gameState.player.materials.push({
                            name: materialName,
                            count: 1,
                            description: '基础锻造材料'
                        });
                    }
                    
                    log('✅ 成功购买' + materialName + ' x1，剩余金币: ' + gameState.player.gold);
                } else {
                    log('❌ 金币不足');
                }
            } catch (error) {
                log('❌ 购买材料失败: ' + error.message);
            }
        }
        
        function testUpgrade() {
            log('测试升级功能...');
            try {
                const type = 'dropRate';
                const cultivation = gameState.player.cultivation[type];
                
                // 从配置获取升级材料需求
                let requiredMaterials = [];
                if (window.configManager && window.configManager.isInitialized()) {
                    try {
                        const cultivationConfig = window.configManager.getCultivationConfig();
                        if (cultivationConfig && cultivationConfig.upgradeMaterials && cultivationConfig.upgradeMaterials[type]) {
                            const materialConfig = cultivationConfig.upgradeMaterials[type];
                            requiredMaterials = materialConfig.map(material => ({
                                name: material.name,
                                quantity: material.baseQuantity + (material.levelMultiplier || 1) * cultivation.level
                            }));
                        }
                    } catch (error) {
                        console.warn('无法从配置获取升级材料，使用默认材料');
                    }
                }
                
                // 如果配置中没有材料，使用默认材料
                if (requiredMaterials.length === 0) {
                    requiredMaterials = [
                        { name: '铁矿石', quantity: 2 + cultivation.level },
                        { name: '魔法水晶', quantity: 1 + Math.floor(cultivation.level / 2) }
                    ];
                }
                
                // 检查材料是否足够
                let canUpgrade = true;
                for (const material of requiredMaterials) {
                    const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                    if (!playerMaterial || playerMaterial.count < material.quantity) {
                        canUpgrade = false;
                        log('❌ 材料不足: ' + material.name + ' 需要' + material.quantity + '个');
                        break;
                    }
                }
                
                if (canUpgrade) {
                    // 消耗材料
                    for (const material of requiredMaterials) {
                        const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                        playerMaterial.count -= material.quantity;
                        if (playerMaterial.count <= 0) {
                            const index = gameState.player.materials.indexOf(playerMaterial);
                            gameState.player.materials.splice(index, 1);
                        }
                    }
                    
                    // 增加经验
                    cultivation.exp += 50;
                    const requiredExp = 100 + cultivation.level * 50;
                    
                    if (cultivation.exp >= requiredExp) {
                        cultivation.level++;
                        cultivation.exp -= requiredExp;
                        log('✅ ' + type + '升级到' + cultivation.level + '级！');
                    } else {
                        log('✅ ' + type + '获得50点经验');
                    }
                } else {
                    log('❌ 无法升级，材料不足');
                }
            } catch (error) {
                log('❌ 升级失败: ' + error.message);
            }
        }
        
        function checkGameState() {
            log('当前游戏状态:');
            log('金币: ' + gameState.player.gold);
            log('材料数量: ' + gameState.player.materials.length);
            gameState.player.materials.forEach(material => {
                log('- ' + material.name + ': ' + material.count + '个');
            });
            log('养成等级:');
            Object.keys(gameState.player.cultivation).forEach(type => {
                const cult = gameState.player.cultivation[type];
                log('- ' + type + ': 等级' + cult.level + ', 经验' + cult.exp);
            });
        }
        
        // 初始化测试数据
        function initializeTestData() {
            // 初始化修炼系统数据
            initializeCultivationData();
            
            // 从配置获取测试材料
            let testMaterials = [];
            if (window.configManager && window.configManager.isInitialized()) {
                try {
                    testMaterials = window.configManager.getTestMaterials() || [];
                } catch (error) {
                    console.warn('无法从配置获取测试材料，使用默认材料');
                }
            }
            
            // 如果配置中没有测试材料，使用默认材料
            if (testMaterials.length === 0) {
                testMaterials = [
                    { name: '铁矿石', count: 5, description: '基础锻造材料' },
                    { name: '魔法水晶', count: 3, description: '蕴含魔力的水晶' }
                ];
            }
            
            // 添加测试材料到游戏状态
            gameState.player.materials.push(...testMaterials);
        }
        
        // 页面加载时初始化
        window.onload = function() {
            initializeTestData();
            log('测试页面已加载，可以开始测试养成系统功能');
        }
    </script>
</body>
</html>