<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜æ¡£ä¿®å¤å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-yellow-400">ä¼ å¥‡æ–‡å­—æ¸¸æˆ - å­˜æ¡£ä¿®å¤å·¥å…·</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å­˜æ¡£çŠ¶æ€æ£€æŸ¥ -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-blue-400">å­˜æ¡£çŠ¶æ€æ£€æŸ¥</h2>
                <div class="space-y-2 mb-4">
                    <button onclick="checkAllSaves()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">æ£€æŸ¥æ‰€æœ‰å­˜æ¡£</button>
                    <button onclick="checkAutoSave()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded">æ£€æŸ¥è‡ªåŠ¨å­˜æ¡£</button>
                </div>
                <div id="saveStatus" class="bg-gray-700 p-4 rounded h-64 overflow-y-auto text-sm"></div>
            </div>
            
            <!-- å­˜æ¡£ä¿®å¤æ“ä½œ -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-red-400">å­˜æ¡£ä¿®å¤æ“ä½œ</h2>
                <div class="space-y-2 mb-4">
                    <button onclick="clearAllSaves()" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded">æ¸…é™¤æ‰€æœ‰å­˜æ¡£</button>
                    <button onclick="createDefaultSave()" class="w-full bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded">åˆ›å»ºé»˜è®¤å­˜æ¡£</button>
                    <button onclick="repairSaves()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">æ™ºèƒ½ä¿®å¤å­˜æ¡£</button>
                    <button onclick="forceRepairSaves()" class="w-full bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded">å¼ºåŠ›ä¿®å¤å­˜æ¡£</button>
                    <button onclick="exportSaves()" class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded">å¯¼å‡ºå­˜æ¡£æ•°æ®</button>
                </div>
                <div id="repairLog" class="bg-gray-700 p-4 rounded h-64 overflow-y-auto text-sm"></div>
            </div>
        </div>
        
        <!-- æ‰‹åŠ¨å­˜æ¡£ç¼–è¾‘ -->
        <div class="bg-gray-800 p-6 rounded-lg mt-6">
            <h2 class="text-xl font-bold mb-4 text-green-400">æ‰‹åŠ¨å­˜æ¡£ç¼–è¾‘</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">é€‰æ‹©å­˜æ¡£æ§½ä½:</label>
                    <select id="slotSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="auto">è‡ªåŠ¨å­˜æ¡£</option>
                        <option value="0">å­˜æ¡£æ§½ 1</option>
                        <option value="1">å­˜æ¡£æ§½ 2</option>
                        <option value="2">å­˜æ¡£æ§½ 3</option>
                        <option value="3">å­˜æ¡£æ§½ 4</option>
                        <option value="4">å­˜æ¡£æ§½ 5</option>
                    </select>
                </div>
                <div class="flex items-end space-x-2">
                    <button onclick="loadSaveForEdit()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">åŠ è½½å­˜æ¡£</button>
                    <button onclick="saveSaveFromEdit()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">ä¿å­˜å­˜æ¡£</button>
                </div>
            </div>
            <textarea id="saveEditor" class="w-full h-64 bg-gray-700 border border-gray-600 rounded p-3 text-sm font-mono" placeholder="å­˜æ¡£JSONæ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
        
        <!-- è¿”å›æ¸¸æˆ -->
        <div class="text-center mt-6">
            <a href="legend-text.html" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded text-lg font-bold">è¿”å›æ¸¸æˆ</a>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const statusDiv = document.getElementById('saveStatus');
            const repairDiv = document.getElementById('repairLog');
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : type === 'warning' ? 'text-yellow-400' : 'text-gray-300';
            const logEntry = `<div class="${colorClass}">[${time}] ${message}</div>`;
            
            if (type === 'repair') {
                repairDiv.innerHTML += logEntry;
                repairDiv.scrollTop = repairDiv.scrollHeight;
            } else {
                statusDiv.innerHTML += logEntry;
                statusDiv.scrollTop = statusDiv.scrollHeight;
            }
        }

        function checkAllSaves() {
            document.getElementById('saveStatus').innerHTML = '';
            log('å¼€å§‹æ£€æŸ¥æ‰€æœ‰å­˜æ¡£...');
            
            // æ£€æŸ¥è‡ªåŠ¨å­˜æ¡£
            const autoSave = localStorage.getItem('legendSave_auto');
            if (autoSave) {
                try {
                    const data = JSON.parse(autoSave);
                    log(`âœ… è‡ªåŠ¨å­˜æ¡£æ­£å¸¸ - ${data.player.class} ç­‰çº§${data.player.level} (${data.timestamp})`, 'success');
                } catch (error) {
                    log(`âŒ è‡ªåŠ¨å­˜æ¡£æŸå: ${error.message}`, 'error');
                }
            } else {
                log('âšª è‡ªåŠ¨å­˜æ¡£ä¸å­˜åœ¨', 'warning');
            }
            
            // æ£€æŸ¥5ä¸ªå­˜æ¡£æ§½ä½
            for (let i = 0; i < 5; i++) {
                const saveData = localStorage.getItem(`legendSave_${i}`);
                if (saveData) {
                    try {
                        const data = JSON.parse(saveData);
                        log(`âœ… å­˜æ¡£æ§½${i + 1}æ­£å¸¸ - ${data.player.class} ç­‰çº§${data.player.level} (${data.timestamp})`, 'success');
                    } catch (error) {
                        log(`âŒ å­˜æ¡£æ§½${i + 1}æŸå: ${error.message}`, 'error');
                    }
                } else {
                    log(`âšª å­˜æ¡£æ§½${i + 1}ä¸ºç©º`, 'warning');
                }
            }
            
            log('å­˜æ¡£æ£€æŸ¥å®Œæˆ');
        }

        function checkAutoSave() {
            document.getElementById('saveStatus').innerHTML = '';
            log('æ£€æŸ¥è‡ªåŠ¨å­˜æ¡£...');
            
            const autoSave = localStorage.getItem('legendSave_auto');
            if (autoSave) {
                try {
                    const data = JSON.parse(autoSave);
                    log('âœ… è‡ªåŠ¨å­˜æ¡£æ•°æ®ç»“æ„:', 'success');
                    log(`   èŒä¸š: ${data.player.class}`);
                    log(`   ç­‰çº§: ${data.player.level}`);
                    log(`   é‡‘å¸: ${data.player.gold}`);
                    log(`   ç”Ÿå‘½å€¼: ${data.player.hp}/${data.player.maxHp}`);
                    log(`   é­”æ³•å€¼: ${data.player.mp}/${data.player.maxMp}`);
                    log(`   ç»éªŒå€¼: ${data.player.exp}/${data.player.maxExp}`);
                    log(`   å½“å‰ä½ç½®: ${data.currentLocation}`);
                    log(`   ä¿å­˜æ—¶é—´: ${data.timestamp}`);
                    
                    // æ£€æŸ¥å…»æˆç³»ç»Ÿ
                    if (data.player.cultivation) {
                        log('âœ… å…»æˆç³»ç»Ÿæ•°æ®æ­£å¸¸:', 'success');
                        log(`   çˆ†ç‡æå‡: ç­‰çº§${data.player.cultivation.dropRate.level}, ç»éªŒ${data.player.cultivation.dropRate.exp}`);
                        log(`   ä¼¤å®³æå‡: ç­‰çº§${data.player.cultivation.damage.level}, ç»éªŒ${data.player.cultivation.damage.exp}`);
                        log(`   é­å°¸æ¦‚ç‡: ç­‰çº§${data.player.cultivation.whipCorpse.level}, ç»éªŒ${data.player.cultivation.whipCorpse.exp}`);
                    } else {
                        log('âš ï¸ å…»æˆç³»ç»Ÿæ•°æ®ç¼ºå¤±', 'warning');
                    }
                    
                    // æ£€æŸ¥ææ–™
                    if (data.player.materials) {
                        log(`âœ… ææ–™æ•°æ®æ­£å¸¸: ${data.player.materials.length}ä¸ªææ–™`, 'success');
                    } else {
                        log('âš ï¸ ææ–™æ•°æ®ç¼ºå¤±', 'warning');
                    }
                    
                    // æ£€æŸ¥ä»»åŠ¡ç³»ç»Ÿ
                    if (data.player.quests) {
                        log(`âœ… ä»»åŠ¡ç³»ç»Ÿæ•°æ®æ­£å¸¸:`, 'success');
                        log(`   å¯æ¥ä»»åŠ¡: ${data.player.quests.available.length}ä¸ª`);
                        log(`   è¿›è¡Œä¸­ä»»åŠ¡: ${data.player.quests.active.length}ä¸ª`);
                        log(`   å·²å®Œæˆä»»åŠ¡: ${data.player.quests.completed.length}ä¸ª`);
                    } else {
                        log('âš ï¸ ä»»åŠ¡ç³»ç»Ÿæ•°æ®ç¼ºå¤±', 'warning');
                    }
                    
                    // æ£€æŸ¥ç§°å·ç³»ç»Ÿ
                    if (data.player.titles) {
                        log(`âœ… ç§°å·ç³»ç»Ÿæ•°æ®æ­£å¸¸:`, 'success');
                        log(`   æ‹¥æœ‰ç§°å·: ${data.player.titles.owned.length}ä¸ª`);
                        log(`   å½“å‰ç§°å·: ${data.player.titles.current || 'æ— '}`);
                        log(`   ç§°å·å·è½´: ${data.player.titles.scrolls.length}ä¸ª`);
                    } else {
                        log('âš ï¸ ç§°å·ç³»ç»Ÿæ•°æ®ç¼ºå¤±', 'warning');
                    }
                    
                } catch (error) {
                    log(`âŒ è‡ªåŠ¨å­˜æ¡£æŸå: ${error.message}`, 'error');
                    log('åŸå§‹æ•°æ®:', 'error');
                    log(autoSave.substring(0, 200) + '...', 'error');
                }
            } else {
                log('âšª è‡ªåŠ¨å­˜æ¡£ä¸å­˜åœ¨', 'warning');
            }
        }

        function clearAllSaves() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            document.getElementById('repairLog').innerHTML = '';
            log('å¼€å§‹æ¸…é™¤æ‰€æœ‰å­˜æ¡£...', 'repair');
            
            // æ¸…é™¤è‡ªåŠ¨å­˜æ¡£
            localStorage.removeItem('legendSave_auto');
            log('âœ… å·²æ¸…é™¤è‡ªåŠ¨å­˜æ¡£', 'repair');
            
            // æ¸…é™¤5ä¸ªå­˜æ¡£æ§½ä½
            for (let i = 0; i < 5; i++) {
                localStorage.removeItem(`legendSave_${i}`);
                log(`âœ… å·²æ¸…é™¤å­˜æ¡£æ§½${i + 1}`, 'repair');
            }
            
            log('æ‰€æœ‰å­˜æ¡£å·²æ¸…é™¤å®Œæˆ', 'repair');
        }

        function createDefaultSave() {
            document.getElementById('repairLog').innerHTML = '';
            log('åˆ›å»ºé»˜è®¤å­˜æ¡£...', 'repair');
            
            // å°è¯•ä»é…ç½®æ–‡ä»¶è·å–é»˜è®¤å­˜æ¡£æ•°æ®
            let defaultSave = null;
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®ç®¡ç†å™¨
                if (window.parent && window.parent.configManager && window.parent.configManager.isInitialized()) {
                    const initialGameState = window.parent.configManager.getInitialGameState();
                    if (initialGameState) {
                        defaultSave = {
                            player: {
                                ...initialGameState.player,
                                class: initialGameState.player.class || 'warrior',
                                level: initialGameState.player.level || 1,
                                exp: initialGameState.player.exp || 0,
                                maxExp: initialGameState.player.maxExp || 100,
                                gold: initialGameState.player.gold || 100,
                                equipment: {
                                    weapon: null,
                                    helmet: null,
                                    armor: null,
                                    boots: null,
                                    ring: null,
                                    necklace: null,
                                    special1: null,
                                    special2: null,
                                    special3: null,
                                    special4: null
                                },
                                inventory: [...(initialGameState.player.inventory || [])],
                                materials: [...(initialGameState.player.materials || [])],
                                cultivation: initialGameState.player.cultivation || {
                                    dropRate: { level: 0, exp: 0 },
                                    damage: { level: 0, exp: 0 },
                                    whipCorpse: { level: 0, exp: 0 }
                                },
                                quests: initialGameState.player.quests || {
                                    available: [],
                                    active: [],
                                    completed: []
                                },
                                titles: initialGameState.player.titles || {
                                    owned: [],
                                    current: null,
                                    scrolls: []
                                }
                            },
                            currentLocation: initialGameState.currentLocation || 1,
                            timestamp: new Date().toLocaleString(),
                            version: '1.0'
                        };
                        log('âœ… ä»é…ç½®æ–‡ä»¶è·å–é»˜è®¤å­˜æ¡£æ•°æ®', 'repair');
                    }
                }
            } catch (error) {
                log('âš ï¸ æ— æ³•ä»é…ç½®æ–‡ä»¶è·å–é»˜è®¤æ•°æ®ï¼Œä½¿ç”¨å†…ç½®é»˜è®¤å€¼', 'repair');
            }
            
            // å¦‚æœæ— æ³•ä»é…ç½®è·å–ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
            if (!defaultSave) {
                defaultSave = {
                    player: {
                        class: 'warrior',
                        level: 1,
                        hp: 120,
                        maxHp: 120,
                        mp: 30,
                        maxMp: 30,
                        exp: 0,
                        maxExp: 100,
                        gold: 100,
                        attack: [15, 25],
                        defense: 8,
                        equipment: {
                            weapon: null,
                            helmet: null,
                            armor: null,
                            boots: null,
                            ring: null,
                            necklace: null,
                            special1: null,
                            special2: null,
                            special3: null,
                            special4: null
                        },
                        inventory: [],
                        materials: [],
                        cultivation: {
                            dropRate: { level: 0, exp: 0 },
                            damage: { level: 0, exp: 0 },
                            whipCorpse: { level: 0, exp: 0 }
                        },
                        quests: {
                            available: [],
                            active: [],
                            completed: []
                        },
                        titles: {
                            owned: [],
                            current: null,
                            scrolls: []
                        }
                    },
                    currentLocation: 1,
                    timestamp: new Date().toLocaleString(),
                    version: '1.0'
                };
            }
            
            localStorage.setItem('legendSave_auto', JSON.stringify(defaultSave));
            log('âœ… å·²åˆ›å»ºé»˜è®¤è‡ªåŠ¨å­˜æ¡£', 'repair');
            log('âœ… åŒ…å«å®Œæ•´çš„æ¸¸æˆç³»ç»Ÿï¼šè£…å¤‡ã€èƒŒåŒ…ã€å…»æˆã€ææ–™ã€ä»»åŠ¡ã€ç§°å·', 'repair');
            log('ä½ å¯ä»¥è¿›å…¥æ¸¸æˆç›´æ¥ç»§ç»­æ¸¸æˆ', 'repair');
        }

        function repairSaves() {
            document.getElementById('repairLog').innerHTML = '';
            log('å¼€å§‹å°è¯•ä¿®å¤å­˜æ¡£...', 'repair');
            
            let repairedCount = 0;
            
            // ä¿®å¤è‡ªåŠ¨å­˜æ¡£
            const autoSave = localStorage.getItem('legendSave_auto');
            if (autoSave) {
                try {
                    const data = JSON.parse(autoSave);
                    let needRepair = false;
                    
                    // æ£€æŸ¥å¹¶ä¿®å¤åŸºç¡€ç©å®¶æ•°æ®
                    if (!data.player) {
                        log('âŒ è‡ªåŠ¨å­˜æ¡£ä¸¥é‡æŸåï¼šç¼ºå°‘ç©å®¶æ•°æ®', 'repair');
                        throw new Error('ç¼ºå°‘ç©å®¶æ•°æ®');
                    }
                    
                    // ä¿®å¤åŸºç¡€å±æ€§
                    if (!data.player.class) {
                        data.player.class = 'warrior';
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šè®¾ç½®é»˜è®¤èŒä¸šä¸ºæˆ˜å£«', 'repair');
                    }
                    
                    if (!data.player.level || data.player.level < 1) {
                        data.player.level = 1;
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šè®¾ç½®é»˜è®¤ç­‰çº§ä¸º1', 'repair');
                    }
                    
                    if (!data.player.hp || !data.player.maxHp) {
                        data.player.hp = 120;
                        data.player.maxHp = 120;
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šè®¾ç½®é»˜è®¤ç”Ÿå‘½å€¼', 'repair');
                    }
                    
                    if (!data.player.mp || !data.player.maxMp) {
                        data.player.mp = 30;
                        data.player.maxMp = 30;
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šè®¾ç½®é»˜è®¤é­”æ³•å€¼', 'repair');
                    }
                    
                    if (data.player.gold === undefined || data.player.gold === null) {
                        data.player.gold = 100;
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šè®¾ç½®é»˜è®¤é‡‘å¸', 'repair');
                    }
                    
                    // ä¿®å¤è£…å¤‡ç³»ç»Ÿ
                    if (!data.player.equipment) {
                        data.player.equipment = {
                            weapon: null,
                            helmet: null,
                            armor: null,
                            boots: null,
                            ring: null,
                            necklace: null,
                            special1: null,
                            special2: null,
                            special3: null,
                            special4: null
                        };
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ è£…å¤‡ç³»ç»Ÿæ•°æ®', 'repair');
                    }
                    
                    // ä¿®å¤èƒŒåŒ…ç³»ç»Ÿ
                    if (!data.player.inventory) {
                        data.player.inventory = [];
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ èƒŒåŒ…ç³»ç»Ÿæ•°æ®', 'repair');
                    }
                    
                    // æ£€æŸ¥å¹¶ä¿®å¤å…»æˆç³»ç»Ÿ
                    if (!data.player.cultivation) {
                        data.player.cultivation = {
                            dropRate: { level: 0, exp: 0 },
                            damage: { level: 0, exp: 0 },
                            whipCorpse: { level: 0, exp: 0 }
                        };
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ å…»æˆç³»ç»Ÿæ•°æ®', 'repair');
                    }
                    
                    // æ£€æŸ¥å¹¶ä¿®å¤ææ–™ç³»ç»Ÿ
                    if (!data.player.materials) {
                        data.player.materials = [];
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ ææ–™ç³»ç»Ÿæ•°æ®', 'repair');
                    }
                    
                    // æ£€æŸ¥å¹¶ä¿®å¤ä»»åŠ¡ç³»ç»Ÿ
                    if (!data.player.quests) {
                        data.player.quests = {
                            available: [],
                            active: [],
                            completed: []
                        };
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ ä»»åŠ¡ç³»ç»Ÿæ•°æ®', 'repair');
                    }
                    
                    // æ£€æŸ¥å¹¶ä¿®å¤ç§°å·ç³»ç»Ÿ
                    if (!data.player.titles) {
                        data.player.titles = {
                            owned: [],
                            current: null,
                            scrolls: []
                        };
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ ç§°å·ç³»ç»Ÿæ•°æ®', 'repair');
                    }
                    
                    // æ£€æŸ¥å½“å‰ä½ç½®
                    if (!data.currentLocation) {
                        data.currentLocation = 1;
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šè®¾ç½®é»˜è®¤ä½ç½®ä¸ºæ‘åº„', 'repair');
                    }
                    
                    // æ£€æŸ¥ç‰ˆæœ¬å·
                    if (!data.version) {
                        data.version = '1.0';
                        needRepair = true;
                    }
                    
                    // æ£€æŸ¥æ—¶é—´æˆ³
                    if (!data.timestamp) {
                        data.timestamp = new Date().toLocaleString();
                        needRepair = true;
                        log('ğŸ”§ ä¿®å¤è‡ªåŠ¨å­˜æ¡£ï¼šæ·»åŠ æ—¶é—´æˆ³', 'repair');
                    }
                    
                    if (needRepair) {
                        localStorage.setItem('legendSave_auto', JSON.stringify(data));
                        repairedCount++;
                        log('âœ… è‡ªåŠ¨å­˜æ¡£ä¿®å¤å®Œæˆ', 'repair');
                    } else {
                        log('âœ… è‡ªåŠ¨å­˜æ¡£æ— éœ€ä¿®å¤', 'repair');
                    }
                } catch (error) {
                    log(`âŒ è‡ªåŠ¨å­˜æ¡£æ— æ³•ä¿®å¤: ${error.message}`, 'repair');
                    localStorage.removeItem('legendSave_auto');
                    log('ğŸ—‘ï¸ å·²åˆ é™¤æŸåçš„è‡ªåŠ¨å­˜æ¡£', 'repair');
                }
            }
            
            // ä¿®å¤5ä¸ªå­˜æ¡£æ§½ä½
            for (let i = 0; i < 5; i++) {
                const saveData = localStorage.getItem(`legendSave_${i}`);
                if (saveData) {
                    try {
                        const data = JSON.parse(saveData);
                        let needRepair = false;
                        
                        // æ£€æŸ¥å¹¶ä¿®å¤åŸºç¡€ç©å®¶æ•°æ®
                        if (!data.player) {
                            log(`âŒ å­˜æ¡£æ§½${i + 1}ä¸¥é‡æŸåï¼šç¼ºå°‘ç©å®¶æ•°æ®`, 'repair');
                            throw new Error('ç¼ºå°‘ç©å®¶æ•°æ®');
                        }
                        
                        // ä¿®å¤åŸºç¡€å±æ€§
                        if (!data.player.class) {
                            data.player.class = 'warrior';
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šè®¾ç½®é»˜è®¤èŒä¸šä¸ºæˆ˜å£«`, 'repair');
                        }
                        
                        if (!data.player.level || data.player.level < 1) {
                            data.player.level = 1;
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šè®¾ç½®é»˜è®¤ç­‰çº§ä¸º1`, 'repair');
                        }
                        
                        if (!data.player.hp || !data.player.maxHp) {
                            data.player.hp = 120;
                            data.player.maxHp = 120;
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šè®¾ç½®é»˜è®¤ç”Ÿå‘½å€¼`, 'repair');
                        }
                        
                        if (!data.player.mp || !data.player.maxMp) {
                            data.player.mp = 30;
                            data.player.maxMp = 30;
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šè®¾ç½®é»˜è®¤é­”æ³•å€¼`, 'repair');
                        }
                        
                        if (data.player.gold === undefined || data.player.gold === null) {
                            data.player.gold = 100;
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šè®¾ç½®é»˜è®¤é‡‘å¸`, 'repair');
                        }
                        
                        // ä¿®å¤è£…å¤‡ç³»ç»Ÿ
                        if (!data.player.equipment) {
                            data.player.equipment = {
                                weapon: null,
                                helmet: null,
                                armor: null,
                                boots: null,
                                ring: null,
                                necklace: null,
                                special1: null,
                                special2: null,
                                special3: null,
                                special4: null
                            };
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ è£…å¤‡ç³»ç»Ÿæ•°æ®`, 'repair');
                        }
                        
                        // ä¿®å¤èƒŒåŒ…ç³»ç»Ÿ
                        if (!data.player.inventory) {
                            data.player.inventory = [];
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ èƒŒåŒ…ç³»ç»Ÿæ•°æ®`, 'repair');
                        }
                        
                        // æ£€æŸ¥å¹¶ä¿®å¤å…»æˆç³»ç»Ÿ
                        if (!data.player.cultivation) {
                            data.player.cultivation = {
                                dropRate: { level: 0, exp: 0 },
                                damage: { level: 0, exp: 0 },
                                whipCorpse: { level: 0, exp: 0 }
                            };
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ å…»æˆç³»ç»Ÿæ•°æ®`, 'repair');
                        }
                        
                        // æ£€æŸ¥å¹¶ä¿®å¤ææ–™ç³»ç»Ÿ
                        if (!data.player.materials) {
                            data.player.materials = [];
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ ææ–™ç³»ç»Ÿæ•°æ®`, 'repair');
                        }
                        
                        // æ£€æŸ¥å¹¶ä¿®å¤ä»»åŠ¡ç³»ç»Ÿ
                        if (!data.player.quests) {
                            data.player.quests = {
                                available: [],
                                active: [],
                                completed: []
                            };
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ ä»»åŠ¡ç³»ç»Ÿæ•°æ®`, 'repair');
                        }
                        
                        // æ£€æŸ¥å¹¶ä¿®å¤ç§°å·ç³»ç»Ÿ
                        if (!data.player.titles) {
                            data.player.titles = {
                                owned: [],
                                current: null,
                                scrolls: []
                            };
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ ç§°å·ç³»ç»Ÿæ•°æ®`, 'repair');
                        }
                        
                        // æ£€æŸ¥å½“å‰ä½ç½®
                        if (!data.currentLocation) {
                            data.currentLocation = 1;
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šè®¾ç½®é»˜è®¤ä½ç½®ä¸ºæ‘åº„`, 'repair');
                        }
                        
                        // æ£€æŸ¥ç‰ˆæœ¬å·
                        if (!data.version) {
                            data.version = '1.0';
                            needRepair = true;
                        }
                        
                        // æ£€æŸ¥æ—¶é—´æˆ³
                        if (!data.timestamp) {
                            data.timestamp = new Date().toLocaleString();
                            needRepair = true;
                            log(`ğŸ”§ ä¿®å¤å­˜æ¡£æ§½${i + 1}ï¼šæ·»åŠ æ—¶é—´æˆ³`, 'repair');
                        }
                        
                        if (needRepair) {
                            localStorage.setItem(`legendSave_${i}`, JSON.stringify(data));
                            repairedCount++;
                            log(`âœ… å­˜æ¡£æ§½${i + 1}ä¿®å¤å®Œæˆ`, 'repair');
                        } else {
                            log(`âœ… å­˜æ¡£æ§½${i + 1}æ— éœ€ä¿®å¤`, 'repair');
                        }
                    } catch (error) {
                        log(`âŒ å­˜æ¡£æ§½${i + 1}æ— æ³•ä¿®å¤: ${error.message}`, 'repair');
                        localStorage.removeItem(`legendSave_${i}`);
                        log(`ğŸ—‘ï¸ å·²åˆ é™¤æŸåçš„å­˜æ¡£æ§½${i + 1}`, 'repair');
                    }
                }
            }
            
            log(`ä¿®å¤å®Œæˆï¼å…±ä¿®å¤äº† ${repairedCount} ä¸ªå­˜æ¡£`, 'repair');
        }
        
        function forceRepairSaves() {
            if (!confirm('å¼ºåŠ›ä¿®å¤ä¼šå°è¯•ä¿®å¤ä¸¥é‡æŸåçš„å­˜æ¡£ï¼Œå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ•°æ®ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            document.getElementById('repairLog').innerHTML = '';
            log('å¼€å§‹å¼ºåŠ›ä¿®å¤å­˜æ¡£...', 'repair');
            
            let repairedCount = 0;
            
            // å¼ºåŠ›ä¿®å¤è‡ªåŠ¨å­˜æ¡£
            const autoSave = localStorage.getItem('legendSave_auto');
            if (autoSave) {
                try {
                    // å°è¯•ä¿®å¤JSONæ ¼å¼é”™è¯¯
                    let cleanedData = autoSave;
                    
                    // ç§»é™¤å¯èƒ½çš„éæ³•å­—ç¬¦
                    cleanedData = cleanedData.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                    
                    // å°è¯•ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
                    cleanedData = cleanedData.replace(/,\s*}/g, '}');
                    cleanedData = cleanedData.replace(/,\s*]/g, ']');
                    
                    const data = JSON.parse(cleanedData);
                    
                    // å¦‚æœè§£ææˆåŠŸï¼Œè¿›è¡Œå®Œæ•´çš„æ•°æ®ä¿®å¤
                    const repairedData = createCompletePlayerData(data);
                    
                    localStorage.setItem('legendSave_auto', JSON.stringify(repairedData));
                    repairedCount++;
                    log('âœ… è‡ªåŠ¨å­˜æ¡£å¼ºåŠ›ä¿®å¤å®Œæˆ', 'repair');
                    
                } catch (error) {
                    log(`âŒ è‡ªåŠ¨å­˜æ¡£æ— æ³•ä¿®å¤ï¼Œåˆ›å»ºæ–°çš„é»˜è®¤å­˜æ¡£: ${error.message}`, 'repair');
                    const defaultData = createCompletePlayerData({});
                    localStorage.setItem('legendSave_auto', JSON.stringify(defaultData));
                    repairedCount++;
                    log('âœ… å·²åˆ›å»ºæ–°çš„è‡ªåŠ¨å­˜æ¡£', 'repair');
                }
            }
            
            // å¼ºåŠ›ä¿®å¤5ä¸ªå­˜æ¡£æ§½ä½
            for (let i = 0; i < 5; i++) {
                const saveData = localStorage.getItem(`legendSave_${i}`);
                if (saveData) {
                    try {
                        // å°è¯•ä¿®å¤JSONæ ¼å¼é”™è¯¯
                        let cleanedData = saveData;
                        
                        // ç§»é™¤å¯èƒ½çš„éæ³•å­—ç¬¦
                        cleanedData = cleanedData.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                        
                        // å°è¯•ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
                        cleanedData = cleanedData.replace(/,\s*}/g, '}');
                        cleanedData = cleanedData.replace(/,\s*]/g, ']');
                        
                        const data = JSON.parse(cleanedData);
                        
                        // å¦‚æœè§£ææˆåŠŸï¼Œè¿›è¡Œå®Œæ•´çš„æ•°æ®ä¿®å¤
                        const repairedData = createCompletePlayerData(data);
                        
                        localStorage.setItem(`legendSave_${i}`, JSON.stringify(repairedData));
                        repairedCount++;
                        log(`âœ… å­˜æ¡£æ§½${i + 1}å¼ºåŠ›ä¿®å¤å®Œæˆ`, 'repair');
                        
                    } catch (error) {
                        log(`âŒ å­˜æ¡£æ§½${i + 1}æ— æ³•ä¿®å¤ï¼Œå·²åˆ é™¤: ${error.message}`, 'repair');
                        localStorage.removeItem(`legendSave_${i}`);
                    }
                }
            }
            
            log(`å¼ºåŠ›ä¿®å¤å®Œæˆï¼å…±ä¿®å¤äº† ${repairedCount} ä¸ªå­˜æ¡£`, 'repair');
        }
        
        function createCompletePlayerData(existingData = {}) {
            // å°è¯•ä»é…ç½®æ–‡ä»¶è·å–é»˜è®¤å€¼
            let defaultPlayer = null;
            try {
                if (window.parent && window.parent.configManager && window.parent.configManager.isInitialized()) {
                    const initialGameState = window.parent.configManager.getInitialGameState();
                    if (initialGameState && initialGameState.player) {
                        defaultPlayer = {
                            ...initialGameState.player,
                            equipment: {
                                weapon: null,
                                helmet: null,
                                armor: null,
                                boots: null,
                                ring: null,
                                necklace: null,
                                special1: null,
                                special2: null,
                                special3: null,
                                special4: null
                            },
                            inventory: [...(initialGameState.player.inventory || [])],
                            materials: [...(initialGameState.player.materials || [])],
                            cultivation: initialGameState.player.cultivation || {
                                dropRate: { level: 0, exp: 0 },
                                damage: { level: 0, exp: 0 },
                                whipCorpse: { level: 0, exp: 0 }
                            },
                            quests: initialGameState.player.quests || {
                                available: [],
                                active: [],
                                completed: []
                            },
                            titles: initialGameState.player.titles || {
                                owned: [],
                                current: null,
                                scrolls: []
                            }
                        };
                    }
                }
            } catch (error) {
                // å¿½ç•¥é”™è¯¯ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
            }
            
            // å¦‚æœæ— æ³•ä»é…ç½®è·å–ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
            if (!defaultPlayer) {
                defaultPlayer = {
                    class: 'warrior',
                    level: 1,
                    hp: 120,
                    maxHp: 120,
                    mp: 30,
                    maxMp: 30,
                    exp: 0,
                    maxExp: 100,
                    gold: 100,
                    attack: [15, 25],
                    defense: 8,
                    equipment: {
                        weapon: null,
                        helmet: null,
                        armor: null,
                        boots: null,
                        ring: null,
                        necklace: null,
                        special1: null,
                        special2: null,
                        special3: null,
                        special4: null
                    },
                    inventory: [],
                    materials: [],
                    cultivation: {
                        dropRate: { level: 0, exp: 0 },
                        damage: { level: 0, exp: 0 },
                        whipCorpse: { level: 0, exp: 0 }
                    },
                    quests: {
                        available: [],
                        active: [],
                        completed: []
                    },
                    titles: {
                        owned: [],
                        current: null,
                        scrolls: []
                    }
                };
            }
            
            // åˆå¹¶ç°æœ‰æ•°æ®å’Œé»˜è®¤æ•°æ®
            const player = { ...defaultPlayer };
            
            if (existingData.player) {
                // ä¿ç•™æœ‰æ•ˆçš„ç°æœ‰æ•°æ®
                if (existingData.player.class) player.class = existingData.player.class;
                if (existingData.player.level && existingData.player.level > 0) player.level = existingData.player.level;
                if (existingData.player.hp) player.hp = existingData.player.hp;
                if (existingData.player.maxHp) player.maxHp = existingData.player.maxHp;
                if (existingData.player.mp) player.mp = existingData.player.mp;
                if (existingData.player.maxMp) player.maxMp = existingData.player.maxMp;
                if (existingData.player.exp !== undefined) player.exp = existingData.player.exp;
                if (existingData.player.maxExp) player.maxExp = existingData.player.maxExp;
                if (existingData.player.gold !== undefined) player.gold = existingData.player.gold;
                if (existingData.player.attack) player.attack = existingData.player.attack;
                if (existingData.player.defense) player.defense = existingData.player.defense;
                
                // åˆå¹¶å¤æ‚å¯¹è±¡
                if (existingData.player.equipment) {
                    player.equipment = { ...defaultPlayer.equipment, ...existingData.player.equipment };
                }
                if (existingData.player.inventory) {
                    player.inventory = existingData.player.inventory;
                }
                if (existingData.player.materials) {
                    player.materials = existingData.player.materials;
                }
                if (existingData.player.cultivation) {
                    player.cultivation = { ...defaultPlayer.cultivation, ...existingData.player.cultivation };
                }
                if (existingData.player.quests) {
                    player.quests = { ...defaultPlayer.quests, ...existingData.player.quests };
                }
                if (existingData.player.titles) {
                    player.titles = { ...defaultPlayer.titles, ...existingData.player.titles };
                }
            }
            
            return {
                player: player,
                currentLocation: existingData.currentLocation || 1,
                timestamp: new Date().toLocaleString(),
                version: '1.0'
            };
        }

        function exportSaves() {
            document.getElementById('repairLog').innerHTML = '';
            log('å¯¼å‡ºå­˜æ¡£æ•°æ®...', 'repair');
            
            const allSaves = {};
            
            // å¯¼å‡ºè‡ªåŠ¨å­˜æ¡£
            const autoSave = localStorage.getItem('legendSave_auto');
            if (autoSave) {
                allSaves.auto = autoSave;
            }
            
            // å¯¼å‡º5ä¸ªå­˜æ¡£æ§½ä½
            for (let i = 0; i < 5; i++) {
                const saveData = localStorage.getItem(`legendSave_${i}`);
                if (saveData) {
                    allSaves[`slot_${i}`] = saveData;
                }
            }
            
            const exportData = JSON.stringify(allSaves, null, 2);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([exportData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `legend_saves_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('âœ… å­˜æ¡£æ•°æ®å·²å¯¼å‡ºåˆ°æ–‡ä»¶', 'repair');
        }

        function loadSaveForEdit() {
            const slotSelect = document.getElementById('slotSelect');
            const saveEditor = document.getElementById('saveEditor');
            const slot = slotSelect.value;
            
            const saveKey = slot === 'auto' ? 'legendSave_auto' : `legendSave_${slot}`;
            const saveData = localStorage.getItem(saveKey);
            
            if (saveData) {
                try {
                    const data = JSON.parse(saveData);
                    saveEditor.value = JSON.stringify(data, null, 2);
                    log(`å·²åŠ è½½${slot === 'auto' ? 'è‡ªåŠ¨å­˜æ¡£' : `å­˜æ¡£æ§½${parseInt(slot) + 1}`}åˆ°ç¼–è¾‘å™¨`);
                } catch (error) {
                    saveEditor.value = saveData;
                    log(`å­˜æ¡£æŸåï¼Œå·²åŠ è½½åŸå§‹æ•°æ®`, 'error');
                }
            } else {
                saveEditor.value = '';
                log(`${slot === 'auto' ? 'è‡ªåŠ¨å­˜æ¡£' : `å­˜æ¡£æ§½${parseInt(slot) + 1}`}ä¸å­˜åœ¨`, 'warning');
            }
        }

        function saveSaveFromEdit() {
            const slotSelect = document.getElementById('slotSelect');
            const saveEditor = document.getElementById('saveEditor');
            const slot = slotSelect.value;
            
            try {
                const data = JSON.parse(saveEditor.value);
                const saveKey = slot === 'auto' ? 'legendSave_auto' : `legendSave_${slot}`;
                localStorage.setItem(saveKey, JSON.stringify(data));
                log(`âœ… å·²ä¿å­˜åˆ°${slot === 'auto' ? 'è‡ªåŠ¨å­˜æ¡£' : `å­˜æ¡£æ§½${parseInt(slot) + 1}`}`, 'success');
            } catch (error) {
                log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥å­˜æ¡£
        window.onload = function() {
            checkAllSaves();
        };
    </script>
</body>
</html>