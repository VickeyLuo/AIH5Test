<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ å¥‡æ¸¸æˆ - æ’è¡Œæ¦œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // åŠ¨æ€åŠ è½½network-manager.jsé¿å…ç¼“å­˜
        const script = document.createElement('script');
        script.src = './network-manager.js?v=' + Date.now();
        document.head.appendChild(script);
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .leaderboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .rank-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1a1a2e;
            font-weight: bold;
        }
        
        .rank-2 {
            background: linear-gradient(45deg, #c0c0c0, #e5e5e5);
        }
        
        .rank-3 {
            background: linear-gradient(45deg, #cd7f32, #daa520);
        }
        
        .player-row:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        
        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .class-warrior { color: #ef4444; }
        .class-mage { color: #3b82f6; }
        .class-taoist { color: #10b981; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">ğŸ† ä¼ å¥‡æ’è¡Œæ¦œ</h1>
            <p class="text-gray-300">æŸ¥çœ‹æœåŠ¡å™¨ä¸­æœ€å¼ºçš„ç©å®¶</p>
        </div>
        
        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="flex justify-center mb-6">
            <button onclick="window.location.href='legend-text.html'" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                ğŸ® è¿”å›æ¸¸æˆ
            </button>
        </div>
        
        <!-- æ’è¡Œæ¦œæ ‡ç­¾ -->
        <div class="flex justify-center mb-6">
            <div class="bg-gray-800 rounded-lg p-1 flex flex-wrap gap-1">
                <button id="levelTab" class="tab-button px-4 py-2 rounded-md active" onclick="switchTab('level')">
                    ğŸ† ç­‰çº§æ’è¡Œ
                </button>
                <button id="goldTab" class="tab-button px-4 py-2 rounded-md" onclick="switchTab('gold')">
                    ğŸ’° è´¢å¯Œæ’è¡Œ
                </button>
                <button id="monstersTab" class="tab-button px-4 py-2 rounded-md" onclick="switchTab('monsters')">
                    âš”ï¸ å‡»æ€æ’è¡Œ
                </button>
                <button id="questsTab" class="tab-button px-4 py-2 rounded-md" onclick="switchTab('quests')">
                    ğŸ“œ ä»»åŠ¡æ’è¡Œ
                </button>
                <button id="damageTab" class="tab-button px-4 py-2 rounded-md" onclick="switchTab('damage')">
                    ğŸ’¥ ä¼¤å®³æ’è¡Œ
                </button>
                <button id="onlineTab" class="tab-button px-4 py-2 rounded-md" onclick="switchTab('online')">
                    ğŸŸ¢ åœ¨çº¿ç©å®¶
                </button>
            </div>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="text-center py-12">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-300">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</p>
        </div>
        
        <!-- æ’è¡Œæ¦œå†…å®¹ -->
        <div id="leaderboardContent" class="hidden">
            <div class="leaderboard-card rounded-lg p-6 max-w-4xl mx-auto">
                <div id="leaderboardList" class="space-y-3">
                    <!-- æ’è¡Œæ¦œæ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="text-red-400 text-6xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-bold text-white mb-2">è¿æ¥å¤±è´¥</h3>
            <p class="text-gray-300 mb-4">æ— æ³•è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨</p>
            <button onclick="initializeLeaderboard()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                é‡è¯•è¿æ¥
            </button>
        </div>
        
        <!-- ç©å®¶è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="playerDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="leaderboard-card rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">ç©å®¶è¯¦æƒ…</h3>
                    <button onclick="closePlayerDetail()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="playerDetailContent">
                    <!-- ç©å®¶è¯¦æƒ…å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let networkManager = null;
        let currentTab = 'level';
        let leaderboardData = {};
        
        // åˆå§‹åŒ–æ’è¡Œæ¦œ
        async function initializeLeaderboard() {
            try {
                showLoadingState();
                
                // åˆå§‹åŒ–ç½‘ç»œç®¡ç†å™¨
                networkManager = new NetworkManager();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                networkManager.on('connected', () => {
                    console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    loadLeaderboardData();
                });
                
                networkManager.on('disconnected', () => {
                    console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                    showErrorState();
                });
                
                networkManager.on('leaderboard_data', (data) => {
                    console.log('æ”¶åˆ°æ’è¡Œæ¦œæ•°æ®:', data);
                    leaderboardData[data.type] = data.players;
                    displayLeaderboard(data.type, data.players);
                });
                
                networkManager.on('online_players', (data) => {
                    console.log('æ”¶åˆ°åœ¨çº¿ç©å®¶æ•°æ®:', data);
                    leaderboardData['online'] = data.players;
                    if (currentTab === 'online') {
                        displayOnlinePlayers(data.players);
                    }
                });
                
                // è¿æ¥åˆ°æœåŠ¡å™¨
                await networkManager.connect();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–æ’è¡Œæ¦œå¤±è´¥:', error);
                showErrorState();
            }
        }
        
        // åŠ è½½æ’è¡Œæ¦œæ•°æ®
        async function loadLeaderboardData() {
            if (!networkManager || !networkManager.isConnected()) {
                showErrorState();
                return;
            }
            
            // è¯·æ±‚å½“å‰æ ‡ç­¾çš„æ•°æ®
            if (currentTab === 'online') {
                networkManager.getOnlinePlayers();
            } else {
                try {
                    const result = await networkManager.getRankings(currentTab, 50);
                    if (result.success) {
                        // ç¼“å­˜æ•°æ® - æœåŠ¡å™¨è¿”å›çš„æ˜¯ {success, rankings, total} æ ¼å¼
                        const rankings = result.rankings || result.data || [];
                        leaderboardData[currentTab] = rankings;
                        displayLeaderboard(currentTab, rankings);
                    } else {
                        console.error('è·å–æ’è¡Œæ¦œå¤±è´¥:', result.error);
                        showErrorState();
                    }
                } catch (error) {
                    console.error('è·å–æ’è¡Œæ¦œé”™è¯¯:', error);
                    showErrorState();
                }
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            currentTab = tabName;
            
            // å¦‚æœå·²æœ‰æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤º
            if (leaderboardData[tabName]) {
                if (tabName === 'online') {
                    displayOnlinePlayers(leaderboardData[tabName]);
                } else {
                    displayLeaderboard(tabName, leaderboardData[tabName]);
                }
            } else {
                // å¦åˆ™é‡æ–°åŠ è½½æ•°æ®
                showLoadingState();
                loadLeaderboardData();
            }
        }
        
        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        function displayLeaderboard(type, players) {
            const container = document.getElementById('leaderboardList');
            container.innerHTML = '';
            
            if (!players || players.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>';
                showContent();
                return;
            }
            
            players.forEach((player, index) => {
                const rank = index + 1;
                const playerRow = createPlayerRow(player, rank, type);
                container.appendChild(playerRow);
            });
            
            showContent();
        }
        
        // æ˜¾ç¤ºåœ¨çº¿ç©å®¶
        function displayOnlinePlayers(players) {
            const container = document.getElementById('leaderboardList');
            container.innerHTML = '';
            
            if (!players || players.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">å½“å‰æ— åœ¨çº¿ç©å®¶</div>';
                showContent();
                return;
            }
            
            // æ·»åŠ æ ‡é¢˜
            const header = document.createElement('div');
            header.className = 'text-center text-white font-bold text-lg mb-4';
            header.textContent = `å½“å‰åœ¨çº¿ç©å®¶ (${players.length}äºº)`;
            container.appendChild(header);
            
            players.forEach((player, index) => {
                const playerRow = createOnlinePlayerRow(player, index + 1);
                container.appendChild(playerRow);
            });
            
            showContent();
        }
        
        // åˆ›å»ºç©å®¶è¡Œ
        function createPlayerRow(player, rank, type) {
            const div = document.createElement('div');
            div.className = 'player-row flex items-center justify-between p-4 rounded-lg cursor-pointer';
            div.onclick = () => showPlayerDetail(player);
            
            const rankBadgeClass = rank <= 3 ? `rank-badge rank-${rank}` : 'bg-gray-600 text-white';
            
            // ä»æœåŠ¡å™¨è¿”å›çš„æ•°æ®ç»“æ„ä¸­æå–ç©å®¶ä¿¡æ¯
            const playerData = player.gameState?.player || {};
            const playerStats = player.stats || {};
            const classColor = getClassColor(playerData.class);
            
            let valueText = '';
            switch (type) {
                case 'level':
                    valueText = `ç­‰çº§ ${playerData.level || 1}`;
                    break;
                case 'gold':
                    valueText = `${formatNumber(playerData.gold || 0)} é‡‘å¸`;
                    break;
                case 'monsters':
                    valueText = `å‡»æ€ ${formatNumber(playerStats.monstersKilled || 0)} æ€ªç‰©`;
                    break;
                case 'quests':
                    valueText = `å®Œæˆ ${formatNumber(playerStats.questsCompleted || 0)} ä»»åŠ¡`;
                    break;
                case 'damage':
                    valueText = `æœ€é«˜ä¼¤å®³ ${formatNumber(playerStats.highestDamage || 0)}`;
                    break;
                default:
                    valueText = `ç­‰çº§ ${playerData.level || 1}`;
            }
            
            // åœ¨çº¿çŠ¶æ€æ˜¾ç¤º
            const onlineStatus = player.isOnline ? 
                '<span class="text-green-400 text-xs">â—åœ¨çº¿</span>' : 
                '<span class="text-gray-500 text-xs">â—ç¦»çº¿</span>';
            
            div.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="${rankBadgeClass} w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">
                        ${rank}
                    </div>
                    <div>
                        <div class="text-white font-semibold">${player.username}</div>
                        <div class="text-sm ${classColor}">${getClassName(playerData.class)} ${onlineStatus}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-white font-semibold">${valueText}</div>
                    <div class="text-sm text-gray-400">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            `;
            
            return div;
        }
        
        // åˆ›å»ºåœ¨çº¿ç©å®¶è¡Œ
        function createOnlinePlayerRow(player, index) {
            const div = document.createElement('div');
            div.className = 'player-row flex items-center justify-between p-4 rounded-lg cursor-pointer';
            div.onclick = () => showPlayerDetail(player);
            
            const classColor = getClassColor(player.class);
            
            div.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    <div>
                        <div class="text-white font-semibold">${player.username}</div>
                        <div class="text-sm ${classColor}">${getClassName(player.class)} - ç­‰çº§ ${player.level}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-green-400 text-sm">åœ¨çº¿</div>
                    <div class="text-xs text-gray-400">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            `;
            
            return div;
        }
        
        // æ˜¾ç¤ºç©å®¶è¯¦æƒ…
        function showPlayerDetail(player) {
            const modal = document.getElementById('playerDetailModal');
            const content = document.getElementById('playerDetailContent');
            
            // ä»æœåŠ¡å™¨è¿”å›çš„æ•°æ®ç»“æ„ä¸­æå–ç©å®¶ä¿¡æ¯
            const playerData = player.gameState?.player || {};
            const playerStats = player.stats || {};
            const classColor = getClassColor(playerData.class);
            
            // åœ¨çº¿çŠ¶æ€
            const onlineStatusText = player.isOnline ? 
                '<span class="text-green-400">ğŸŸ¢ åœ¨çº¿</span>' : 
                '<span class="text-gray-500">âš« ç¦»çº¿</span>';
            
            // æœ€åç™»å½•æ—¶é—´
            const lastLoginText = player.lastLoginTime ? 
                new Date(player.lastLoginTime).toLocaleString('zh-CN') : 'æœªçŸ¥';
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center">
                        <h4 class="text-2xl font-bold text-white mb-2">${player.username}</h4>
                        <p class="${classColor} font-semibold">${getClassName(playerData.class)}</p>
                        <p class="text-sm mt-2">${onlineStatusText}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-800 p-3 rounded">
                            <div class="text-gray-400 text-sm">ç­‰çº§</div>
                            <div class="text-white font-bold text-lg">${playerData.level || 1}</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded">
                            <div class="text-gray-400 text-sm">ç»éªŒå€¼</div>
                            <div class="text-white font-bold text-lg">${formatNumber(playerData.exp || 0)}</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded">
                            <div class="text-gray-400 text-sm">é‡‘å¸</div>
                            <div class="text-white font-bold text-lg">${formatNumber(playerData.gold || 0)}</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded">
                            <div class="text-gray-400 text-sm">æ”»å‡»åŠ›</div>
                            <div class="text-white font-bold text-lg">${playerData.attack || 0}</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded">
                        <h5 class="text-white font-semibold mb-3">æ¸¸æˆç»Ÿè®¡</h5>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="text-gray-300">
                                <span class="text-gray-400">å‡»æ€æ€ªç‰©:</span> ${formatNumber(playerStats.monstersKilled || 0)}
                            </div>
                            <div class="text-gray-300">
                                <span class="text-gray-400">å®Œæˆä»»åŠ¡:</span> ${formatNumber(playerStats.questsCompleted || 0)}
                            </div>
                            <div class="text-gray-300">
                                <span class="text-gray-400">æœ€é«˜ä¼¤å®³:</span> ${formatNumber(playerStats.highestDamage || 0)}
                            </div>
                            <div class="text-gray-300">
                                <span class="text-gray-400">æ¸¸æˆæ—¶é•¿:</span> ${formatNumber(playerStats.totalPlayTime || 0)}åˆ†é’Ÿ
                            </div>
                        </div>
                    </div>
                    
                    ${playerData.equipment ? `
                    <div class="bg-gray-800 p-4 rounded">
                        <h5 class="text-white font-semibold mb-3">è£…å¤‡ä¿¡æ¯</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-300">
                            <div>æ­¦å™¨: ${playerData.equipment.weapon?.name || 'æ— '}</div>
                            <div>å¤´ç›”: ${playerData.equipment.helmet?.name || 'æ— '}</div>
                            <div>æŠ¤ç”²: ${playerData.equipment.armor?.name || 'æ— '}</div>
                            <div>é´å­: ${playerData.equipment.boots?.name || 'æ— '}</div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="text-center text-xs text-gray-500">
                        æœ€åç™»å½•: ${lastLoginText}
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        // å…³é—­ç©å®¶è¯¦æƒ…
        function closePlayerDetail() {
            document.getElementById('playerDetailModal').classList.add('hidden');
        }
        
        // å·¥å…·å‡½æ•°
        function getClassName(classType) {
            const classNames = {
                'warrior': 'æˆ˜å£«',
                'mage': 'æ³•å¸ˆ',
                'taoist': 'é“å£«'
            };
            return classNames[classType] || classType;
        }
        
        function getClassColor(classType) {
            const colors = {
                'warrior': 'class-warrior',
                'mage': 'class-mage',
                'taoist': 'class-taoist'
            };
            return colors[classType] || 'text-gray-400';
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('leaderboardContent').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }
        
        function showContent() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('leaderboardContent').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }
        
        function showErrorState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('leaderboardContent').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeLeaderboard();
        });
        
        // å®šæœŸåˆ·æ–°æ•°æ®
        setInterval(() => {
            if (networkManager && networkManager.isConnected()) {
                loadLeaderboardData();
            }
        }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>