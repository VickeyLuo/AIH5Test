<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字版传奇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="config-manager.js"></script>
    <script>
        // 动态加载network-manager.js避免缓存
        const script = document.createElement('script');
        script.src = './network-manager.js?v=' + Date.now();
        document.head.appendChild(script);
    </script>
    <script>
        // 角色创建函数 - 提前定义以供HTML按钮使用
        async function createCharacterWithClass(className) {
            const characterName = document.getElementById('characterName').value.trim();
            const errorElement = document.getElementById('characterNameError');
            
            if (!characterName) {
                errorElement.textContent = '请输入角色名称';
                return;
            }
            
            if (characterName.length < 2 || characterName.length > 10) {
                errorElement.textContent = '角色名称长度应在2-10个字符之间';
                return;
            }
            
            // 检查角色名是否已存在（同时检查内置登录和外部登录的角色）
            const accounts = getAccountData();
            const allCharacters = Object.values(accounts).flatMap(account => 
                account.characters.filter(char => char !== null)
            );
            
            // 同时检查外部登录的角色
            const externalCharacters = getExternalCharacters().filter(char => char !== null);
            const allExternalCharacters = externalCharacters;
            
            if (allCharacters.some(char => char.name === characterName) || 
                allExternalCharacters.some(char => char.name === characterName)) {
                errorElement.textContent = '角色名称已存在，请选择其他名称';
                return;
            }
            
            console.log('createCharacterWithClass - 开始创建角色:', characterName, className);
            
            // 异步创建新角色
            const gameData = await createNewGameState(className);
            // 设置玩家名字到游戏状态中
            gameData.player.name = characterName;
            const newCharacter = {
                name: characterName,
                class: className,
                level: 1,
                gameData: gameData
            };
            
            console.log('createCharacterWithClass - 角色创建完成:', newCharacter);
            
            // 判断是内置登录还是外部登录
            const urlParams = new URLSearchParams(window.location.search);
            const isExternalLogin = urlParams.get('external_login') === 'true';
            
            if (isExternalLogin) {
                // 外部登录：保存到外部登录存储
                const externalCharacters = getExternalCharacters();
                externalCharacters[currentCharacterSlot] = newCharacter;
                saveExternalCharacters(externalCharacters);
                
                // 如果网络已连接，同步到服务器
                if (networkManager && networkManager.isAuthenticated) {
                    syncCharacterToServer(newCharacter, currentCharacterSlot);
                }
                
                // 返回外部登录角色选择界面
                showExternalCharacterSelectScreen();
            } else {
                // 内置登录：保存到账号数据
                accounts[currentAccount].characters[currentCharacterSlot] = newCharacter;
                saveAccountData(accounts);
                
                // 返回内置登录角色选择界面
                showCharacterSelectScreen();
            }
            
            // 清空角色名输入框
            document.getElementById('characterName').value = '';
            document.getElementById('characterNameError').textContent = '';
        }
    </script>
    <style>
        /* 使用系统字体，避免网络依赖 */
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .game-container {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .stat-bar {
            background: linear-gradient(90deg, #ff4444 0%, #ff6666 100%);
            transition: width 0.3s ease;
        }
        
        .mp-bar {
            background: linear-gradient(90deg, #4444ff 0%, #6666ff 100%);
            transition: width 0.3s ease;
        }
        
        .exp-bar {
            background: linear-gradient(90deg, #44ff44 0%, #66ff66 100%);
            transition: width 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            border: 2px solid #ffd700;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #666 0%, #888 100%);
            color: #fff;
            border: 2px solid #666;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #888 0%, #666 100%);
            box-shadow: 0 0 10px rgba(136, 136, 136, 0.5);
        }
        
        .equipment-slot {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .equipment-slot:hover {
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ffd700;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .monster-card {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff4444;
            transition: all 0.3s ease;
        }
        
        .monster-card:hover {
            background: rgba(255, 0, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }
        
        .elite-monster {
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        .elite-monster:hover {
            background: rgba(255, 215, 0, 0.25);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }
        
        .boss-monster {
            background: rgba(255, 0, 128, 0.15);
            border: 2px solid #ff0080;
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
            animation: bossGlow 2s ease-in-out infinite alternate;
        }
        
        .boss-monster:hover {
            background: rgba(255, 0, 128, 0.25);
            box-shadow: 0 0 25px rgba(255, 0, 128, 0.7);
            transform: translateY(-3px);
        }
        
        @keyframes bossGlow {
            from {
                box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 0, 128, 0.8);
            }
        }
        
        .skill-btn {
            background: rgba(68, 68, 255, 0.2);
            border: 2px solid #4444ff;
            transition: all 0.3s ease;
        }
        
        .skill-btn:hover {
            background: rgba(68, 68, 255, 0.3);
            box-shadow: 0 0 10px rgba(68, 68, 255, 0.5);
        }
        
        .item-common { color: #ffffff; }
        .item-rare { color: #0099ff; }
        .item-epic { color: #9933ff; }
        .item-legendary { color: #ff9900; }
        .item-mythic { color: #ff0080; text-shadow: 0 0 5px #ff0080; }
        .item-supreme { color: #00ffff; text-shadow: 0 0 8px #00ffff; animation: glow 2s ease-in-out infinite alternate; }
        .item-transcendent { color: #ff6600; text-shadow: 0 0 10px #ff6600, 0 0 15px #ff3300; animation: transcendentGlow 1.5s ease-in-out infinite alternate; }
        
        @keyframes glow {
            from { text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff; }
            to { text-shadow: 0 0 12px #00ffff, 0 0 16px #00ffff, 0 0 20px #00ffff; }
        }
        
        @keyframes transcendentGlow {
            from { text-shadow: 0 0 10px #ff6600, 0 0 15px #ff3300, 0 0 20px #ff0000; }
            to { text-shadow: 0 0 15px #ff6600, 0 0 20px #ff3300, 0 0 25px #ff0000, 0 0 30px #ffaa00; }
        }
        
        /* 套装光环效果 - 自转光环带纹路 */
        .aura-tianShen, .aura-tianShen-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-tianShen::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(255, 215, 0, 0.8) 0deg, 
                rgba(255, 215, 0, 0.3) 60deg, 
                rgba(255, 215, 0, 0.8) 120deg, 
                rgba(255, 215, 0, 0.3) 180deg, 
                rgba(255, 215, 0, 0.8) 240deg, 
                rgba(255, 215, 0, 0.3) 300deg, 
                rgba(255, 215, 0, 0.8) 360deg);
            animation: rotateAura 4s linear infinite;
            z-index: -1;
        }
        
        .aura-tianShen::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 215, 0, 0.3);
            animation: pulseGlow 2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        /* 2件套小光环 */
        .aura-tianShen-small::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(255, 215, 0, 0.6) 0deg, 
                rgba(255, 215, 0, 0.2) 60deg, 
                rgba(255, 215, 0, 0.6) 120deg, 
                rgba(255, 215, 0, 0.2) 180deg, 
                rgba(255, 215, 0, 0.6) 240deg, 
                rgba(255, 215, 0, 0.2) 300deg, 
                rgba(255, 215, 0, 0.6) 360deg);
            animation: rotateAura 4s linear infinite;
            z-index: -1;
        }
        
        .aura-tianShen-small::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.4), inset 0 0 12px rgba(255, 215, 0, 0.2);
            animation: pulseGlow 2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-shenYu, .aura-shenYu-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-shenYu::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(139, 92, 246, 0.8) 0deg, 
                rgba(139, 92, 246, 0.3) 45deg, 
                rgba(139, 92, 246, 0.8) 90deg, 
                rgba(139, 92, 246, 0.3) 135deg, 
                rgba(139, 92, 246, 0.8) 180deg, 
                rgba(139, 92, 246, 0.3) 225deg, 
                rgba(139, 92, 246, 0.8) 270deg, 
                rgba(139, 92, 246, 0.3) 315deg, 
                rgba(139, 92, 246, 0.8) 360deg);
            animation: rotateAura 3.5s linear infinite;
            z-index: -1;
        }
        
        .aura-shenYu::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), inset 0 0 20px rgba(139, 92, 246, 0.3);
            animation: pulseGlow 2.5s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-shenYu-small::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(139, 92, 246, 0.6) 0deg, 
                rgba(139, 92, 246, 0.2) 45deg, 
                rgba(139, 92, 246, 0.6) 90deg, 
                rgba(139, 92, 246, 0.2) 135deg, 
                rgba(139, 92, 246, 0.6) 180deg, 
                rgba(139, 92, 246, 0.2) 225deg, 
                rgba(139, 92, 246, 0.6) 270deg, 
                rgba(139, 92, 246, 0.2) 315deg, 
                rgba(139, 92, 246, 0.6) 360deg);
            animation: rotateAura 3.5s linear infinite;
            z-index: -1;
        }
        
        .aura-shenYu-small::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.4), inset 0 0 12px rgba(139, 92, 246, 0.2);
            animation: pulseGlow 2.5s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-chuangShi, .aura-chuangShi-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-chuangShi::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(6, 182, 212, 0.8) 0deg, 
                rgba(6, 182, 212, 0.2) 30deg, 
                rgba(6, 182, 212, 0.8) 60deg, 
                rgba(6, 182, 212, 0.2) 90deg, 
                rgba(6, 182, 212, 0.8) 120deg, 
                rgba(6, 182, 212, 0.2) 150deg, 
                rgba(6, 182, 212, 0.8) 180deg, 
                rgba(6, 182, 212, 0.2) 210deg, 
                rgba(6, 182, 212, 0.8) 240deg, 
                rgba(6, 182, 212, 0.2) 270deg, 
                rgba(6, 182, 212, 0.8) 300deg, 
                rgba(6, 182, 212, 0.2) 330deg, 
                rgba(6, 182, 212, 0.8) 360deg);
            animation: rotateAura 3s linear infinite;
            z-index: -1;
        }
        
        .aura-chuangShi::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.6), inset 0 0 20px rgba(6, 182, 212, 0.3);
            animation: pulseGlow 2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-chuangShi-small::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(6, 182, 212, 0.6) 0deg, 
                rgba(6, 182, 212, 0.15) 30deg, 
                rgba(6, 182, 212, 0.6) 60deg, 
                rgba(6, 182, 212, 0.15) 90deg, 
                rgba(6, 182, 212, 0.6) 120deg, 
                rgba(6, 182, 212, 0.15) 150deg, 
                rgba(6, 182, 212, 0.6) 180deg, 
                rgba(6, 182, 212, 0.15) 210deg, 
                rgba(6, 182, 212, 0.6) 240deg, 
                rgba(6, 182, 212, 0.15) 270deg, 
                rgba(6, 182, 212, 0.6) 300deg, 
                rgba(6, 182, 212, 0.15) 330deg, 
                rgba(6, 182, 212, 0.6) 360deg);
            animation: rotateAura 3s linear infinite;
            z-index: -1;
        }
        
        .aura-chuangShi-small::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.4), inset 0 0 12px rgba(6, 182, 212, 0.2);
            animation: pulseGlow 2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-yongHeng, .aura-yongHeng-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-yongHeng::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(16, 185, 129, 0.8) 0deg, 
                rgba(16, 185, 129, 0.3) 72deg, 
                rgba(16, 185, 129, 0.8) 144deg, 
                rgba(16, 185, 129, 0.3) 216deg, 
                rgba(16, 185, 129, 0.8) 288deg, 
                rgba(16, 185, 129, 0.3) 360deg);
            animation: rotateAura 4.5s linear infinite;
            z-index: -1;
        }
        
        .aura-yongHeng::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), inset 0 0 20px rgba(16, 185, 129, 0.3);
            animation: pulseGlow 3.5s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-yongHeng-small::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(16, 185, 129, 0.6) 0deg, 
                rgba(16, 185, 129, 0.2) 72deg, 
                rgba(16, 185, 129, 0.6) 144deg, 
                rgba(16, 185, 129, 0.2) 216deg, 
                rgba(16, 185, 129, 0.6) 288deg, 
                rgba(16, 185, 129, 0.2) 360deg);
            animation: rotateAura 4.5s linear infinite;
            z-index: -1;
        }
        
        .aura-yongHeng-small::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4), inset 0 0 12px rgba(16, 185, 129, 0.2);
            animation: pulseGlow 3.5s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-hunDun, .aura-hunDun-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-hunDun::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(220, 38, 38, 0.9) 0deg, 
                rgba(220, 38, 38, 0.2) 20deg, 
                rgba(220, 38, 38, 0.9) 40deg, 
                rgba(220, 38, 38, 0.2) 60deg, 
                rgba(220, 38, 38, 0.9) 80deg, 
                rgba(220, 38, 38, 0.2) 100deg, 
                rgba(220, 38, 38, 0.9) 120deg, 
                rgba(220, 38, 38, 0.2) 140deg, 
                rgba(220, 38, 38, 0.9) 160deg, 
                rgba(220, 38, 38, 0.2) 180deg, 
                rgba(220, 38, 38, 0.9) 200deg, 
                rgba(220, 38, 38, 0.2) 220deg, 
                rgba(220, 38, 38, 0.9) 240deg, 
                rgba(220, 38, 38, 0.2) 260deg, 
                rgba(220, 38, 38, 0.9) 280deg, 
                rgba(220, 38, 38, 0.2) 300deg, 
                rgba(220, 38, 38, 0.9) 320deg, 
                rgba(220, 38, 38, 0.2) 340deg, 
                rgba(220, 38, 38, 0.9) 360deg);
            animation: rotateAura 2.5s linear infinite;
            z-index: -1;
        }
        
        .aura-hunDun::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.7), inset 0 0 25px rgba(220, 38, 38, 0.4);
            animation: pulseGlow 1.8s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-hunDun-small::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(220, 38, 38, 0.7) 0deg, 
                rgba(220, 38, 38, 0.15) 20deg, 
                rgba(220, 38, 38, 0.7) 40deg, 
                rgba(220, 38, 38, 0.15) 60deg, 
                rgba(220, 38, 38, 0.7) 80deg, 
                rgba(220, 38, 38, 0.15) 100deg, 
                rgba(220, 38, 38, 0.7) 120deg, 
                rgba(220, 38, 38, 0.15) 140deg, 
                rgba(220, 38, 38, 0.7) 160deg, 
                rgba(220, 38, 38, 0.15) 180deg, 
                rgba(220, 38, 38, 0.7) 200deg, 
                rgba(220, 38, 38, 0.15) 220deg, 
                rgba(220, 38, 38, 0.7) 240deg, 
                rgba(220, 38, 38, 0.15) 260deg, 
                rgba(220, 38, 38, 0.7) 280deg, 
                rgba(220, 38, 38, 0.15) 300deg, 
                rgba(220, 38, 38, 0.7) 320deg, 
                rgba(220, 38, 38, 0.15) 340deg, 
                rgba(220, 38, 38, 0.7) 360deg);
            animation: rotateAura 2.5s linear infinite;
            z-index: -1;
        }
        
        .aura-hunDun-small::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5), inset 0 0 15px rgba(220, 38, 38, 0.3);
            animation: pulseGlow 1.8s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-xuKong, .aura-xuKong-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-xuKong::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(124, 58, 237, 0.8) 0deg, 
                rgba(124, 58, 237, 0.1) 36deg, 
                rgba(124, 58, 237, 0.8) 72deg, 
                rgba(124, 58, 237, 0.1) 108deg, 
                rgba(124, 58, 237, 0.8) 144deg, 
                rgba(124, 58, 237, 0.1) 180deg, 
                rgba(124, 58, 237, 0.8) 216deg, 
                rgba(124, 58, 237, 0.1) 252deg, 
                rgba(124, 58, 237, 0.8) 288deg, 
                rgba(124, 58, 237, 0.1) 324deg, 
                rgba(124, 58, 237, 0.8) 360deg);
            animation: rotateAura 3.2s linear infinite;
            z-index: -1;
        }
        
        .aura-xuKong::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.6), inset 0 0 20px rgba(124, 58, 237, 0.3);
            animation: pulseGlow 2.2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-xuKong-small::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(124, 58, 237, 0.6) 0deg, 
                rgba(124, 58, 237, 0.08) 36deg, 
                rgba(124, 58, 237, 0.6) 72deg, 
                rgba(124, 58, 237, 0.08) 108deg, 
                rgba(124, 58, 237, 0.6) 144deg, 
                rgba(124, 58, 237, 0.08) 180deg, 
                rgba(124, 58, 237, 0.6) 216deg, 
                rgba(124, 58, 237, 0.08) 252deg, 
                rgba(124, 58, 237, 0.6) 288deg, 
                rgba(124, 58, 237, 0.08) 324deg, 
                rgba(124, 58, 237, 0.6) 360deg);
            animation: rotateAura 3.2s linear infinite;
            z-index: -1;
        }
        
        .aura-xuKong-small::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(124, 58, 237, 0.4), inset 0 0 12px rgba(124, 58, 237, 0.2);
            animation: pulseGlow 2.2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-longShen, .aura-longShen-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-longShen::before {
            content: '';
            position: absolute;
            top: -18px;
            left: -18px;
            right: -18px;
            bottom: -18px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(245, 158, 11, 0.9) 0deg, 
                rgba(245, 158, 11, 0.2) 15deg, 
                rgba(245, 158, 11, 0.9) 30deg, 
                rgba(245, 158, 11, 0.2) 45deg, 
                rgba(245, 158, 11, 0.9) 60deg, 
                rgba(245, 158, 11, 0.2) 75deg, 
                rgba(245, 158, 11, 0.9) 90deg, 
                rgba(245, 158, 11, 0.2) 105deg, 
                rgba(245, 158, 11, 0.9) 120deg, 
                rgba(245, 158, 11, 0.2) 135deg, 
                rgba(245, 158, 11, 0.9) 150deg, 
                rgba(245, 158, 11, 0.2) 165deg, 
                rgba(245, 158, 11, 0.9) 180deg, 
                rgba(245, 158, 11, 0.2) 195deg, 
                rgba(245, 158, 11, 0.9) 210deg, 
                rgba(245, 158, 11, 0.2) 225deg, 
                rgba(245, 158, 11, 0.9) 240deg, 
                rgba(245, 158, 11, 0.2) 255deg, 
                rgba(245, 158, 11, 0.9) 270deg, 
                rgba(245, 158, 11, 0.2) 285deg, 
                rgba(245, 158, 11, 0.9) 300deg, 
                rgba(245, 158, 11, 0.2) 315deg, 
                rgba(245, 158, 11, 0.9) 330deg, 
                rgba(245, 158, 11, 0.2) 345deg, 
                rgba(245, 158, 11, 0.9) 360deg);
            animation: rotateAura 2s linear infinite;
            z-index: -1;
        }
        
        .aura-longShen::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.7), inset 0 0 25px rgba(245, 158, 11, 0.4);
            animation: pulseGlow 1.5s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-wuXian, .aura-wuXian-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-wuXian::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(236, 72, 153, 0.9) 0deg, 
                rgba(236, 72, 153, 0.1) 10deg, 
                rgba(236, 72, 153, 0.9) 20deg, 
                rgba(236, 72, 153, 0.1) 30deg, 
                rgba(236, 72, 153, 0.9) 40deg, 
                rgba(236, 72, 153, 0.1) 50deg, 
                rgba(236, 72, 153, 0.9) 60deg, 
                rgba(236, 72, 153, 0.1) 70deg, 
                rgba(236, 72, 153, 0.9) 80deg, 
                rgba(236, 72, 153, 0.1) 90deg, 
                rgba(236, 72, 153, 0.9) 100deg, 
                rgba(236, 72, 153, 0.1) 110deg, 
                rgba(236, 72, 153, 0.9) 120deg, 
                rgba(236, 72, 153, 0.1) 130deg, 
                rgba(236, 72, 153, 0.9) 140deg, 
                rgba(236, 72, 153, 0.1) 150deg, 
                rgba(236, 72, 153, 0.9) 160deg, 
                rgba(236, 72, 153, 0.1) 170deg, 
                rgba(236, 72, 153, 0.9) 180deg, 
                rgba(236, 72, 153, 0.1) 190deg, 
                rgba(236, 72, 153, 0.9) 200deg, 
                rgba(236, 72, 153, 0.1) 210deg, 
                rgba(236, 72, 153, 0.9) 220deg, 
                rgba(236, 72, 153, 0.1) 230deg, 
                rgba(236, 72, 153, 0.9) 240deg, 
                rgba(236, 72, 153, 0.1) 250deg, 
                rgba(236, 72, 153, 0.9) 260deg, 
                rgba(236, 72, 153, 0.1) 270deg, 
                rgba(236, 72, 153, 0.9) 280deg, 
                rgba(236, 72, 153, 0.1) 290deg, 
                rgba(236, 72, 153, 0.9) 300deg, 
                rgba(236, 72, 153, 0.1) 310deg, 
                rgba(236, 72, 153, 0.9) 320deg, 
                rgba(236, 72, 153, 0.1) 330deg, 
                rgba(236, 72, 153, 0.9) 340deg, 
                rgba(236, 72, 153, 0.1) 350deg, 
                rgba(236, 72, 153, 0.9) 360deg);
            animation: rotateAura 1.5s linear infinite;
            z-index: -1;
        }
        
        .aura-wuXian::after {
            content: '';
            position: absolute;
            top: -12px;
            left: -12px;
            right: -12px;
            bottom: -12px;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(236, 72, 153, 0.8), inset 0 0 30px rgba(236, 72, 153, 0.5);
            animation: pulseGlow 1.2s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        .aura-chuangShiShen, .aura-chuangShiShen-small {
            position: relative;
            border-radius: 50%;
        }
        
        .aura-chuangShiShen::before {
            content: '';
            position: absolute;
            top: -25px;
            left: -25px;
            right: -25px;
            bottom: -25px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, 
                rgba(255, 255, 255, 1) 0deg, 
                rgba(255, 255, 255, 0.1) 5deg, 
                rgba(255, 255, 255, 1) 10deg, 
                rgba(255, 255, 255, 0.1) 15deg, 
                rgba(255, 255, 255, 1) 20deg, 
                rgba(255, 255, 255, 0.1) 25deg, 
                rgba(255, 255, 255, 1) 30deg, 
                rgba(255, 255, 255, 0.1) 35deg, 
                rgba(255, 255, 255, 1) 40deg, 
                rgba(255, 255, 255, 0.1) 45deg, 
                rgba(255, 255, 255, 1) 50deg, 
                rgba(255, 255, 255, 0.1) 55deg, 
                rgba(255, 255, 255, 1) 60deg, 
                rgba(255, 255, 255, 0.1) 65deg, 
                rgba(255, 255, 255, 1) 70deg, 
                rgba(255, 255, 255, 0.1) 75deg, 
                rgba(255, 255, 255, 1) 80deg, 
                rgba(255, 255, 255, 0.1) 85deg, 
                rgba(255, 255, 255, 1) 90deg, 
                rgba(255, 255, 255, 0.1) 95deg, 
                rgba(255, 255, 255, 1) 100deg, 
                rgba(255, 255, 255, 0.1) 105deg, 
                rgba(255, 255, 255, 1) 110deg, 
                rgba(255, 255, 255, 0.1) 115deg, 
                rgba(255, 255, 255, 1) 120deg, 
                rgba(255, 255, 255, 0.1) 125deg, 
                rgba(255, 255, 255, 1) 130deg, 
                rgba(255, 255, 255, 0.1) 135deg, 
                rgba(255, 255, 255, 1) 140deg, 
                rgba(255, 255, 255, 0.1) 145deg, 
                rgba(255, 255, 255, 1) 150deg, 
                rgba(255, 255, 255, 0.1) 155deg, 
                rgba(255, 255, 255, 1) 160deg, 
                rgba(255, 255, 255, 0.1) 165deg, 
                rgba(255, 255, 255, 1) 170deg, 
                rgba(255, 255, 255, 0.1) 175deg, 
                rgba(255, 255, 255, 1) 180deg, 
                rgba(255, 255, 255, 0.1) 185deg, 
                rgba(255, 255, 255, 1) 190deg, 
                rgba(255, 255, 255, 0.1) 195deg, 
                rgba(255, 255, 255, 1) 200deg, 
                rgba(255, 255, 255, 0.1) 205deg, 
                rgba(255, 255, 255, 1) 210deg, 
                rgba(255, 255, 255, 0.1) 215deg, 
                rgba(255, 255, 255, 1) 220deg, 
                rgba(255, 255, 255, 0.1) 225deg, 
                rgba(255, 255, 255, 1) 230deg, 
                rgba(255, 255, 255, 0.1) 235deg, 
                rgba(255, 255, 255, 1) 240deg, 
                rgba(255, 255, 255, 0.1) 245deg, 
                rgba(255, 255, 255, 1) 250deg, 
                rgba(255, 255, 255, 0.1) 255deg, 
                rgba(255, 255, 255, 1) 260deg, 
                rgba(255, 255, 255, 0.1) 265deg, 
                rgba(255, 255, 255, 1) 270deg, 
                rgba(255, 255, 255, 0.1) 275deg, 
                rgba(255, 255, 255, 1) 280deg, 
                rgba(255, 255, 255, 0.1) 285deg, 
                rgba(255, 255, 255, 1) 290deg, 
                rgba(255, 255, 255, 0.1) 295deg, 
                rgba(255, 255, 255, 1) 300deg, 
                rgba(255, 255, 255, 0.1) 305deg, 
                rgba(255, 255, 255, 1) 310deg, 
                rgba(255, 255, 255, 0.1) 315deg, 
                rgba(255, 255, 255, 1) 320deg, 
                rgba(255, 255, 255, 0.1) 325deg, 
                rgba(255, 255, 255, 1) 330deg, 
                rgba(255, 255, 255, 0.1) 335deg, 
                rgba(255, 255, 255, 1) 340deg, 
                rgba(255, 255, 255, 0.1) 345deg, 
                rgba(255, 255, 255, 1) 350deg, 
                rgba(255, 255, 255, 0.1) 355deg, 
                rgba(255, 255, 255, 1) 360deg);
            animation: rotateAura 1s linear infinite;
            z-index: -1;
        }
        
        .aura-chuangShiShen::after {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.9), inset 0 0 40px rgba(255, 255, 255, 0.6);
            animation: pulseGlow 1s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        /* 旋转光环动画 */
        @keyframes rotateAura {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 脉冲发光动画 */
        @keyframes pulseGlow {
            0% { 
                opacity: 0.6;
                transform: scale(1);
            }
            100% { 
                opacity: 1;
                transform: scale(1.05);
            }
        }
        
        .set-bonus {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border: 1px solid #ffd700;
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
        }
        
        .set-bonus-text {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 3px #ffa500;
        }
        
        .set-bonus-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .set-bonus-title {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            color: #000;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border-radius: 6px 6px 0 0;
            margin: -2px -2px 8px -2px;
        }
        
        .set-item {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 4px;
            padding: 6px;
            margin: 4px 0;
        }
        
        .set-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* 飘字效果样式 */
        .damage-text {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 2s ease-out forwards;
        }
        
        .damage-normal {
            color: #ff6b6b;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .damage-crit {
            color: #ffd700;
            font-size: 24px;
            text-shadow: 0 0 8px #ffd700, 1px 1px 2px rgba(0, 0, 0, 0.8);
            animation: critFloat 2s ease-out forwards;
        }
        
        .damage-heal {
            color: #4ade80;
            text-shadow: 0 0 5px #4ade80, 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-20px) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px) scale(0.8);
            }
        }
        
        @keyframes critFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1.2);
            }
            20% {
                transform: translateY(-10px) scale(1.4);
            }
            50% {
                opacity: 1;
                transform: translateY(-25px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
        }
         
         .set-count {
            color: #ffed4e;
            font-size: 12px;
        }
        
        .set-effect {
            color: #90ee90;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .set-next {
            color: #888;
            font-size: 11px;
            font-style: italic;
            margin-left: 8px;
        }
        
        /* 确保hidden类正常工作 */
        .hidden {
            display: none !important;
        }
        
        /* 地图战斗信息栏样式 */
        #mapBattleInfo {
            position: relative;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .map-battle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .map-battle-row:last-child {
            margin-bottom: 0;
        }
        
        .map-battle-player, .map-battle-monster {
            flex: 1;
            text-align: center;
        }
        
        .map-battle-vs {
            margin: 0 15px;
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
        }
        
        .map-battle-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .map-battle-hp, .map-battle-mp {
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .map-battle-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2px;
        }
        
        .map-battle-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .map-battle-hp-bar .map-battle-bar-fill {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .map-battle-mp-bar .map-battle-bar-fill {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }
        
        .map-battle-actions {
            text-align: center;
            margin-top: 8px;
        }
        
        .map-battle-escape {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .map-battle-escape:hover {
            background: rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        
        #mapBattleEffects {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 99;
        }
        
        /* 地图怪物战斗状态样式 */
        .in-battle {
            border: 2px solid #ffd700 !important;
            border-radius: 50% !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6) !important;
            animation: battleGlow 1.5s ease-in-out infinite alternate !important;
            z-index: 1 !important;
        }
        
        .in-battle .monster-hp-container {
            z-index: 2 !important;
        }
        
        .dead {
            opacity: 0.3 !important;
            filter: grayscale(100%) !important;
            pointer-events: none !important;
        }
        
        @keyframes battleGlow {
            0% {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            }
            100% {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.9);
            }
        }
        
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
        }
        
        /* 飘字效果样式 */
        .floating-text {
            position: fixed;
            z-index: 9999;
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }
        
        @keyframes critFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1.2);
            }
            20% {
                transform: translateY(-10px) scale(1.4);
            }
            50% {
                opacity: 1;
                transform: translateY(-35px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-70px) scale(0.9);
            }
        }
        
        .floating-text.success {
            color: #10b981;
        }
        
        .floating-text.craft {
            color: #f59e0b;
        }
        
        .floating-text.gold {
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9), 0 0 10px rgba(255, 215, 0, 0.5);
            animation: goldFloat 2s ease-out forwards;
        }
        
        @keyframes goldFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1.2);
            }
            30% {
                opacity: 1;
                transform: translateY(-20px) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.9);
            }
        }
        
        /* 角色动画样式 */
        .character-sprite {
            width: 48px;
            height: 48px;
            position: relative;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .character-idle {
            animation: idle 2s ease-in-out infinite;
        }
        
        .character-attack {
            animation: attack 0.6s ease-out;
        }
        
        .character-hurt {
            animation: hurt 0.4s ease-out;
        }
        
        .character-skill {
            animation: skill 1s ease-out;
        }
        
        @keyframes idle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }
        
        @keyframes attack {
            0% { transform: translateX(0) scale(1); }
            30% { transform: translateX(40px) scale(1.2); }
            50% { transform: translateX(50px) scale(1.3); }
            70% { transform: translateX(20px) scale(1.1); }
            100% { transform: translateX(0) scale(1); }
        }
        
        @keyframes hurt {
            0% { transform: translateX(0) scale(1); filter: brightness(1); }
            20% { transform: translateX(-10px) scale(1.15); filter: brightness(1.8) hue-rotate(0deg); }
            40% { transform: translateX(10px) scale(1.12); filter: brightness(1.6) hue-rotate(180deg); }
            60% { transform: translateX(-5px) scale(1.08); filter: brightness(1.4) hue-rotate(90deg); }
            80% { transform: translateX(5px) scale(1.05); filter: brightness(1.2); }
            100% { transform: translateX(0) scale(1); filter: brightness(1); }
        }
        
        @keyframes skill {
            0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
            25% { transform: scale(1.2) rotate(-5deg); filter: brightness(1.3) hue-rotate(60deg); }
            50% { transform: scale(1.1) rotate(5deg); filter: brightness(1.5) hue-rotate(120deg); }
            75% { transform: scale(1.15) rotate(-3deg); filter: brightness(1.2) hue-rotate(180deg); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes mapAttack {
            0% { transform: translate(-50%, -50%); }
            40% { transform: translate(-30%, -50%); }
            60% { transform: translate(-20%, -50%); }
            100% { transform: translate(-50%, -50%); }
        }
        
        @keyframes mapMonsterAttack {
            0% { transform: translate(-50%, -50%) scale(1); }
            30% { transform: translate(-10%, -50%) scale(1.1); }
            50% { transform: translate(10%, -50%) scale(1.2); }
            70% { transform: translate(-10%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes mapHurt {
            0% { transform: translate(-50%, -50%) scale(1); }
            25% { transform: translate(-55%, -50%) scale(1.15); }
            50% { transform: translate(-45%, -50%) scale(1.12); }
            75% { transform: translate(-52%, -50%) scale(1.08); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }
        
        @keyframes battleShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        /* 登录系统样式 */
        .start-screen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .game-logo {
            margin-bottom: 40px;
        }
        
        .game-logo svg {
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        }
        
        .game-title {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .game-subtitle {
            color: #94a3b8;
            font-size: 1.2rem;
            margin-bottom: 40px;
        }
        
        .login-form {
            background: rgba(30, 41, 59, 0.9);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 100%;
        }
        
        .login-title {
            color: #ffd700;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #e2e8f0;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #475569;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .character-select {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .character-select-title {
            color: #ffd700;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .character-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .character-slot {
            background: rgba(30, 41, 59, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .character-slot:hover {
            border-color: #ffd700;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
            transform: translateY(-5px);
        }
        
        .character-info .character-name {
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .character-details {
            color: #94a3b8;
            margin-bottom: 20px;
        }
        
        .character-details div {
            margin-bottom: 5px;
        }
        
        .empty-slot {
            color: #64748b;
        }
        
        .empty-slot-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .character-creation-screen {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .character-creation-title {
            color: #ffd700;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .character-name-input {
            max-width: 400px;
            margin: 0 auto 30px;
            text-align: center;
        }
        
        .character-name-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #475569;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            font-size: 18px;
            text-align: center;
        }
        
        .character-name-input input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .class-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .class-card {
            background: rgba(30, 41, 59, 0.9);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .class-card:hover {
            border-color: #ffd700;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
            transform: translateY(-5px);
        }
        
        .class-card.warrior:hover {
            border-color: #ef4444;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
        }
        
        .class-card.mage:hover {
            border-color: #3b82f6;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }
        
        .class-card.taoist:hover {
            border-color: #10b981;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
        }
        
        .class-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .class-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .class-description {
            color: #94a3b8;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        /* 移动端优化样式 - 9:16竖屏适配 */
        @media (max-width: 768px) {
            body {
                padding: 2px;
            }
            
            .max-w-7xl {
                max-width: 100%;
                padding: 0 4px;
            }
            
            .game-container {
                margin-bottom: 8px;
                padding: 8px;
            }
            
            .grid {
                gap: 6px;
            }
            
            .btn-primary, .btn-secondary, .skill-btn {
                min-height: 40px;
                font-size: 13px;
                padding: 6px 10px;
            }
            
            .equipment-slot {
                min-height: 45px;
                font-size: 11px;
            }
            
            .text-4xl {
                font-size: 1.8rem;
            }
            
            .character-sprite {
                width: 35px;
                height: 35px;
            }
            
            .floating-text {
                font-size: 14px;
            }
            
            .log-area {
                font-size: 11px;
            }
            
            .monster-card {
                padding: 6px;
            }
            
            .space-y-2 > * + * {
                margin-top: 6px;
            }
            
            .space-y-3 > * + * {
                margin-top: 8px;
            }
            
            .grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-1.lg\:grid-cols-4 {
                grid-template-columns: 1fr;
            }
            
            .lg\:col-span-1 {
                grid-column: span 1;
            }
            
            .lg\:col-span-3 {
                grid-column: span 1;
            }
            
            /* 移动端专用高度控制 */
            #gameMap {
                height: 250px !important;
            }
            
            /* 游戏日志区域移动端优化 */
            .mobile-log-container {
                height: 180px !important;
            }
            
            .mobile-log-container .log-area {
                height: 160px !important;
            }
            
            /* 任务套装区域移动端优化 */
            .mobile-quest-set-container {
                height: 120px !important;
            }
            
            /* 功能按钮区域移动端优化 */
            .mobile-function-buttons {
                height: 60px !important;
                overflow-x: auto;
                overflow-y: hidden;
            }
            
            .mobile-function-buttons .grid {
                display: flex;
                flex-wrap: nowrap;
                gap: 8px;
                padding-bottom: 8px;
            }
            
            .mobile-function-buttons button {
                flex-shrink: 0;
                min-width: 80px;
            }
            
            /* 标签切换样式 */
            .mobile-tab-buttons {
                display: flex;
                border-bottom: 1px solid #374151;
                margin-bottom: 8px;
            }
            
            .mobile-tab-button {
                flex: 1;
                padding: 6px 8px;
                background: #374151;
                color: #9CA3AF;
                border: none;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .mobile-tab-button.active {
                background: #1F2937;
                color: #FCD34D;
                border-bottom: 2px solid #FCD34D;
            }
            
            .mobile-tab-content {
                height: 90px;
                overflow-y: auto;
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover, .btn-secondary:hover, .skill-btn:hover {
                transform: scale(0.98);
            }
            
            .btn-primary:active, .btn-secondary:active, .skill-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }
            
            .monster-card:hover {
                transform: none;
            }
            
            .equipment-slot:hover {
                background: rgba(255, 215, 0, 0.1);
                box-shadow: none;
            }
            
            /* 防止双击缩放 */
            button {
                touch-action: manipulation;
                user-select: none;
            }
            
            /* 移动端飘字优化 */
            .floating-text {
                font-size: 18px;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            }
            
            /* 战斗动画区域移动端优化 */
            #battleAnimationArea {
                height: 120px;
            }
            
            #damageTextContainer {
                overflow: visible;
                z-index: 1000;
            }
            
            /* 登录系统移动端适配 */
            .game-title {
                font-size: 2rem;
            }
            
            .login-form {
                padding: 30px 20px;
                margin: 0 10px;
            }
            
            .character-slots {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .class-selection {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .character-select-title,
            .character-creation-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <!-- 启动界面 -->
        <div id="startScreen" class="game-container rounded-lg p-8 mb-6 text-center">
            <!-- 传奇游戏封面 -->
            <div class="mb-8">
                <svg width="300" height="200" viewBox="0 0 300 200" class="mx-auto mb-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- 背景渐变 -->
                    <defs>
                        <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#1a1a2e;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#16213e;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#0f3460;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="titleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#ffed4e;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ffa500;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- 背景 -->
                    <rect width="300" height="200" fill="url(#bgGradient)" rx="10"/>
                    
                    <!-- 装饰性边框 -->
                    <rect x="5" y="5" width="290" height="190" fill="none" stroke="#ffd700" stroke-width="2" rx="8"/>
                    <rect x="10" y="10" width="280" height="180" fill="none" stroke="#ffd700" stroke-width="1" rx="6" opacity="0.5"/>
                    
                    <!-- 中央宝剑图标 -->
                    <g transform="translate(150,100)">
                        <!-- 剑身 -->
                        <rect x="-3" y="-40" width="6" height="60" fill="#c0c0c0" stroke="#ffd700" stroke-width="1"/>
                        <!-- 剑柄 -->
                        <rect x="-2" y="20" width="4" height="15" fill="#8b4513"/>
                        <!-- 护手 -->
                        <rect x="-12" y="18" width="24" height="4" fill="#ffd700"/>
                        <!-- 剑尖 -->
                        <polygon points="0,-45 -3,-40 3,-40" fill="#c0c0c0" stroke="#ffd700" stroke-width="1"/>
                        <!-- 宝石 -->
                        <circle cx="0" cy="25" r="3" fill="#ff0000" stroke="#ffd700" stroke-width="1"/>
                    </g>
                    
                    <!-- 装饰性光效 -->
                    <g opacity="0.3">
                        <circle cx="50" cy="50" r="2" fill="#ffd700">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="250" cy="60" r="1.5" fill="#ffd700">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="3s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="80" cy="150" r="1" fill="#ffd700">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="2.5s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="220" cy="140" r="2" fill="#ffd700">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="1.8s" repeatCount="indefinite"/>
                        </circle>
                    </g>
                </svg>
                
                <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-yellow-300 to-orange-400 mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">传奇世界</h1>
                <p class="text-xl text-gray-300 mb-2">Legend of Mir</p>
                <p class="text-gray-400">重温经典，再创辉煌</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showLoginScreen()" class="btn-primary px-8 py-3 rounded-lg text-lg font-bold w-64 mx-auto block hover:scale-105 transition-transform">
                    🎮 开始游戏
                </button>
                <button onclick="showAbout()" class="btn-secondary px-8 py-2 rounded-lg w-64 mx-auto block hover:scale-105 transition-transform">
                    📖 游戏说明
                </button>
            </div>
        </div>

        <!-- 登录界面 -->
        <div id="loginScreen" class="game-container rounded-lg p-6 mb-6 hidden">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-yellow-400 mb-2">账号登录</h2>
                <p class="text-gray-300">请输入您的账号信息</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-white font-bold mb-2">账号</label>
                        <input type="text" id="loginUsername" class="w-full px-4 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none" placeholder="请输入账号" maxlength="20">
                    </div>
                    <div>
                        <label class="block text-white font-bold mb-2">密码</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none" placeholder="请输入密码" maxlength="20">
                    </div>
                    <div id="loginError" class="text-red-400 text-sm hidden"></div>
                    
                    <div class="space-y-3 pt-4">
                        <button onclick="handleLogin()" class="btn-primary px-6 py-3 rounded-lg w-full font-bold">
                            🔑 登录游戏
                        </button>
                        <button onclick="handleRegister()" class="btn-secondary px-6 py-2 rounded-lg w-full">
                            📝 注册新账号
                        </button>
                        <button onclick="showStartScreen()" class="text-gray-400 hover:text-white transition-colors w-full py-2">
                            ← 返回主界面
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色选择界面 -->
        <div id="characterSelectScreen" class="game-container rounded-lg p-6 mb-6 hidden">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-yellow-400 mb-2">选择角色</h2>
                <p class="text-gray-300">欢迎回来，<span id="welcomeUsername"></span></p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- 角色槽位1 -->
                <div id="charSlot1" class="character-slot bg-gray-800 border-2 border-gray-600 rounded-lg p-4">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gray-700 rounded-full flex items-center justify-center">
                            <span class="text-2xl">👤</span>
                        </div>
                        <div class="character-info">
                            <div class="text-gray-400">空角色槽</div>
                            <div class="text-sm text-gray-500">点击创建角色</div>
                        </div>
                    </div>
                </div>
                
                <!-- 角色槽位2 -->
                <div id="charSlot2" class="character-slot bg-gray-800 border-2 border-gray-600 rounded-lg p-4">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gray-700 rounded-full flex items-center justify-center">
                            <span class="text-2xl">👤</span>
                        </div>
                        <div class="character-info">
                            <div class="text-gray-400">空角色槽</div>
                            <div class="text-sm text-gray-500">点击创建角色</div>
                        </div>
                    </div>
                </div>
                
                <!-- 角色槽位3 -->
                <div id="charSlot3" class="character-slot bg-gray-800 border-2 border-gray-600 rounded-lg p-4">
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gray-700 rounded-full flex items-center justify-center">
                            <span class="text-2xl">👤</span>
                        </div>
                        <div class="character-info">
                            <div class="text-gray-400">空角色槽</div>
                            <div class="text-sm text-gray-500">点击创建角色</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center space-y-3">
                <button onclick="switchAccount()" class="btn-primary px-6 py-2 rounded-lg">
                    🔄 重新选择账号
                </button>
                <button onclick="logout()" class="btn-secondary px-6 py-2 rounded-lg">
                    🚪 退出登录
                </button>
            </div>
        </div>

        <!-- 角色创建界面 -->
        <div id="characterCreation" class="game-container rounded-lg p-6 mb-6 hidden">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-yellow-400 mb-2">创建角色</h2>
                <p class="text-gray-300">为您的角色选择职业并命名</p>
            </div>
            
            <!-- 角色命名 -->
            <div class="text-center mb-6">
                <div class="max-w-md mx-auto">
                    <label class="block text-white font-bold mb-2">角色名称</label>
                    <input type="text" id="characterName" class="w-full px-4 py-2 bg-gray-800 border-2 border-gray-600 rounded-lg text-white focus:border-yellow-400 focus:outline-none text-center" placeholder="请输入角色名称" maxlength="12">
                    <div id="characterNameError" class="text-red-400 text-sm mt-2 hidden"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-white mb-3">战士</h3>
                    <div class="bg-gray-800 p-4 rounded border-2 border-red-500">
                        <p class="text-gray-300 mb-2">高血量，高防御</p>
                        <p class="text-sm text-gray-400">生命: 120 | 魔法: 30</p>
                        <p class="text-sm text-gray-400">攻击: 15-25 | 防御: 8</p>
                        <button onclick="createCharacterWithClass('warrior')" class="btn-primary px-4 py-2 rounded mt-3">选择战士</button>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-xl font-bold text-white mb-3">法师</h3>
                    <div class="bg-gray-800 p-4 rounded border-2 border-blue-500">
                        <p class="text-gray-300 mb-2">高魔法，强技能</p>
                        <p class="text-sm text-gray-400">生命: 80 | 魔法: 100</p>
                        <p class="text-sm text-gray-400">攻击: 10-20 | 防御: 3</p>
                        <button onclick="createCharacterWithClass('mage')" class="btn-primary px-4 py-2 rounded mt-3">选择法师</button>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-xl font-bold text-white mb-3">道士</h3>
                    <div class="bg-gray-800 p-4 rounded border-2 border-green-500">
                        <p class="text-gray-300 mb-2">平衡发展，召唤</p>
                        <p class="text-sm text-gray-400">生命: 100 | 魔法: 70</p>
                        <p class="text-sm text-gray-400">攻击: 12-22 | 防御: 5</p>
                        <button onclick="createCharacterWithClass('taoist')" class="btn-primary px-4 py-2 rounded mt-3">选择道士</button>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button onclick="returnToCharacterSelect()" class="btn-secondary px-6 py-2 rounded-lg">
                    ← 返回角色选择
                </button>
            </div>
        </div>

        <!-- 主游戏界面 -->
        <div id="gameInterface" class="hidden">
            <!-- 顶部信息栏 -->
            <div class="fixed top-0 left-0 right-0 z-50 bg-black bg-opacity-95 border-b-2 border-yellow-400">
                <div class="max-w-7xl mx-auto px-4 py-3">
                    <div class="flex items-center justify-between">
                        <!-- 左侧：角色信息和经验条 -->
                        <div class="flex items-center space-x-4">
                            <!-- 玩家头像 -->
                            <div class="w-12 h-12 rounded-full border-2 border-yellow-400 bg-gray-800 flex items-center justify-center cursor-pointer" onclick="showAvatarPanel()">
                                <svg id="playerAvatar" width="32" height="32" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                    <!-- 默认头像 -->
                                    <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                                    <rect x="18" y="18" width="12" height="4" fill="#8B4513"/>
                                    <rect x="22" y="22" width="2" height="2" fill="#000"/>
                                    <rect x="24" y="22" width="2" height="2" fill="#000"/>
                                </svg>
                            </div>
                            
                            <!-- 角色基本信息 -->
                            <div class="text-sm">
                                <div class="flex items-center space-x-2">
                                    <span class="text-yellow-400 font-bold" id="playerClass">未选择职业</span>
                                    <span class="text-white">Lv.<span id="playerLevel">1</span></span>
                                </div>
                                <div class="flex items-center space-x-4 mt-1">
                                    <!-- 生命值 -->
                                    <div class="flex items-center space-x-1">
                                        <span class="text-red-400">❤</span>
                                        <span id="hpText" class="text-white text-xs">100/100</span>
                                        <div class="w-16 bg-gray-700 rounded-full h-2">
                                            <div id="hpBar" class="stat-bar h-2 rounded-full" style="width: 100%"></div>
                                        </div>
                                    </div>
                                    <!-- 魔法值 -->
                                    <div class="flex items-center space-x-1">
                                        <span class="text-blue-400">✦</span>
                                        <span id="mpText" class="text-white text-xs">50/50</span>
                                        <div class="w-16 bg-gray-700 rounded-full h-2">
                                            <div id="mpBar" class="mp-bar h-2 rounded-full" style="width: 100%"></div>
                                        </div>
                                    </div>
                                    <!-- 金币 -->
                                    <div class="flex items-center space-x-1">
                                        <span class="text-yellow-400">💰</span>
                                        <span id="playerGold" class="text-yellow-400 text-xs">100</span>
                                    </div>
                                </div>
                                <!-- 经验条 -->
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-green-400 text-xs">经验:</span>
                                    <span id="playerExp" class="text-green-400 text-xs">0/100</span>
                                    <div class="w-24 bg-gray-700 rounded-full h-2">
                                        <div id="expBar" class="exp-bar h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：当前位置和存档功能 -->
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-right">
                                <div class="text-yellow-400 font-bold">当前位置</div>
                                <div class="text-white" id="currentLocationTop">新手村</div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 主游戏区域 -->
            <div class="pt-20">
                <!-- 地图区域 - 上方 -->
                <div id="mapArea" class="game-container rounded-lg p-4 mb-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">地图视图</h3>
                        
                        <!-- 战斗信息栏 -->
                        <div id="mapBattleInfo" class="hidden">
                            <div class="map-battle-row">
                                <div class="map-battle-player">
                                    <div class="map-battle-name text-blue-400" id="mapPlayerName">玩家</div>
                                    <div class="map-battle-hp">生命: <span id="mapPlayerHP">100/100</span></div>
                                    <div class="map-battle-bar map-battle-hp-bar">
                                        <div class="map-battle-bar-fill" id="mapPlayerHPBar" style="width: 100%"></div>
                                    </div>
                                    <div class="map-battle-mp">魔法: <span id="mapPlayerMP">50/50</span></div>
                                    <div class="map-battle-bar map-battle-mp-bar">
                                        <div class="map-battle-bar-fill" id="mapPlayerMPBar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div class="map-battle-vs">VS</div>
                                <div class="map-battle-monster">
                                    <div class="map-battle-name text-red-400" id="mapMonsterName">怪物</div>
                                    <div class="map-battle-hp">生命: <span id="mapMonsterHP">50/50</span></div>
                                    <div class="map-battle-bar map-battle-hp-bar">
                                        <div class="map-battle-bar-fill" id="mapMonsterHPBar" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="map-battle-actions">
                                <button class="map-battle-escape" onclick="escapeBattle()">逃跑</button>
                            </div>
                        </div>
                        
                        <div id="gameMap" class="relative bg-gray-900 rounded-lg border-2 border-gray-600" style="height: 400px; width: 100%;">
                            <!-- 地图背景网格 -->
                            <div class="absolute inset-0 opacity-20">
                                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#4B5563" stroke-width="1"/>
                                        </pattern>
                                    </defs>
                                    <rect width="100%" height="100%" fill="url(#grid)" />
                                </svg>
                            </div>
                            
                            <!-- 玩家位置 -->
                            <div id="playerOnMap" class="absolute cursor-pointer" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
                                <div class="relative">
                                    <!-- 称号显示 -->
                                    <div id="playerTitleOnMap" class="absolute -top-16 left-1/2 transform -translate-x-1/2 text-xs font-bold whitespace-nowrap hidden">
                                        <div class="relative px-2 py-1 rounded-lg border-2 shadow-lg backdrop-blur-sm">
                                            <div class="absolute inset-0 bg-gradient-to-r from-yellow-400/20 to-orange-400/20 rounded-lg animate-pulse"></div>
                                            <div class="relative z-10 flex items-center space-x-1">
                                                <span class="text-yellow-300">👑</span>
                                                <span id="playerTitleText" class="text-yellow-300 font-bold drop-shadow-lg"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="w-12 h-12 bg-blue-500 rounded-full border-2 border-white flex items-center justify-center">
                                        <span class="text-white text-sm font-bold">玩</span>
                                    </div>
                                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs text-blue-400 font-bold whitespace-nowrap">
                                        <span id="playerNameOnMap">玩家</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 怪物位置容器 -->
                            <div id="monstersOnMap">
                                <!-- 怪物将在这里动态生成 -->
                            </div>
                            
                            <!-- 地图战斗特效容器 -->
            <div id="mapBattleEffects" class="absolute inset-0 pointer-events-none" style="z-index: 50;">
                <!-- 战斗特效和飘字将在这里显示 -->
            </div>
            
            <!-- 自动回收控制区域 -->
            <div class="absolute bottom-2 left-2" style="z-index: 60;">
                <div class="flex flex-col space-y-2">
                    <!-- 自动回收开关 -->
                    <button id="autoRecycleToggleMap" onclick="toggleAutoRecycle()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 transition-all duration-200 flex items-center space-x-2">
                        <span id="autoRecycleIconMap">♻️</span>
                        <span id="autoRecycleTextMap" class="text-xs font-bold">自动回收</span>
                    </button>
                    <!-- 品质选择 -->
                    <select id="autoRecycleQualityMap" onchange="setAutoRecycleQuality(this.value)" class="bg-gray-800 hover:bg-gray-700 text-white text-xs px-2 py-1 rounded border border-gray-600 transition-all duration-200">
                        <option value="common">普通及以下</option>
                        <option value="uncommon">优秀及以下</option>
                        <option value="rare">稀有及以下</option>
                        <option value="epic">史诗及以下</option>
                        <option value="legendary">传说及以下</option>
                        <option value="supreme">至尊及以下</option>
                        <option value="transcendent">超越及以下</option>
                    </select>
                </div>
            </div>
            
            <!-- 右侧按钮组 -->
            <div class="absolute bottom-2 right-2" style="z-index: 60;">
                <div class="flex flex-col space-y-2">
                    <!-- 地图配置按钮 -->
                     <button id="mapConfigBtn" onclick="showMapConfig()" class="bg-purple-800 hover:bg-purple-700 text-white px-3 py-2 rounded-lg border border-purple-600 transition-all duration-200 flex items-center space-x-2">
                         <span>⚙️</span>
                         <span class="text-xs font-bold">地图配置</span>
                     </button>
                     <!-- 刷新怪物按钮 -->
                     <button id="refreshMonstersBtn" onclick="refreshMapMonsters()" class="bg-green-800 hover:bg-green-700 text-white px-3 py-2 rounded-lg border border-green-600 transition-all duration-200 flex items-center space-x-2">
                         <span>🔄</span>
                         <span class="text-xs font-bold">刷新怪物</span>
                     </button>
                    <!-- 自动战斗开关 -->
                    <button id="autoFightToggle" onclick="toggleAutoFight()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 transition-all duration-200 flex items-center space-x-2">
                        <span id="autoFightIcon">⚔️</span>
                        <span id="autoFightText" class="text-xs font-bold">自动战斗</span>
                    </button>
                </div>
            </div>
        </div>
                    </div>
                    
                    <!-- 中间左右布局 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                        <!-- 游戏日志区域 - 左侧 (更宽) -->
                        <div class="lg:col-span-2">
                            <div class="game-container rounded-lg mobile-log-container" style="height: 315px; padding: 4px;">
                                <h3 class="text-xl font-bold text-yellow-400 mb-1">游戏日志</h3>
                                <div id="gameLog" class="log-area text-sm text-gray-300" style="height: 295px; overflow-y: auto; padding: 4px;">
                                    <div>欢迎来到传奇世界！</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧任务/套装标签区域 -->
                        <div class="lg:col-span-1">
                            <div class="game-container rounded-lg p-4 mobile-quest-set-container" style="height: 299px;">
                                <!-- 移动端标签切换 -->
                                <div class="mobile-tab-buttons hidden md:hidden">
                                    <button class="mobile-tab-button active" onclick="switchMobileTab('quest')">任务</button>
                                    <button class="mobile-tab-button" onclick="switchMobileTab('set')">套装</button>
                                </div>
                                
                                <!-- 桌面端显示 -->
                                <div class="desktop-quest-set-content">
                                    <!-- 任务区域 -->
                                    <div class="mb-4">
                                        <h4 class="text-lg font-bold text-yellow-400 mb-2">主线任务</h4>
                                        <div class="space-y-2" style="height: 108px; overflow-y: auto;">
                                            <!-- 主线任务显示 -->
                                            <div id="mainQuestDisplay" class="bg-gray-800 p-3 rounded-lg border border-yellow-500 cursor-pointer hover:bg-gray-700 transition-colors" onclick="handleMainQuestClick()">
                                                <div class="text-yellow-400 font-bold text-sm mb-1">主线任务</div>
                                                <div id="mainQuestTitle" class="text-white font-semibold text-sm mb-1">新手引导</div>
                                                <div id="mainQuestDescription" class="text-gray-300 text-xs mb-2">击败1只怪物</div>
                                                <div class="flex justify-between items-center">
                                                    <div id="mainQuestProgress" class="text-blue-400 text-xs">进度: 0/1</div>
                                                    <div id="mainQuestReward" class="text-green-400 text-xs">奖励: 经验+10</div>
                                                </div>
                                                <div id="mainQuestSubmitHint" class="text-center text-yellow-300 text-xs mt-2 hidden">点击提交任务</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 套装效果区域 -->
                                    <div>
                                        <h4 class="text-lg font-bold text-purple-400 mb-2">套装效果</h4>
                                        <div id="setBonusContent" class="space-y-2" style="height: 127px; overflow-y: auto;">
                                            <!-- 套装效果将在这里显示 -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 移动端标签内容 -->
                                <div class="mobile-tab-content hidden" id="mobileQuestTab">
                                    <div id="mainQuestDisplayMobile" class="bg-gray-800 p-2 rounded-lg border border-yellow-500 cursor-pointer hover:bg-gray-700 transition-colors" onclick="handleMainQuestClick()">
                                        <div class="text-yellow-400 font-bold text-xs mb-1">主线任务</div>
                                        <div id="mainQuestTitleMobile" class="text-white font-semibold text-xs mb-1">新手引导</div>
                                        <div id="mainQuestDescriptionMobile" class="text-gray-300 text-xs mb-1">击败1只怪物</div>
                                        <div class="flex justify-between items-center">
                                            <div id="mainQuestProgressMobile" class="text-blue-400 text-xs">进度: 0/1</div>
                                            <div id="mainQuestRewardMobile" class="text-green-400 text-xs">奖励: 经验+10</div>
                                        </div>
                                        <div id="mainQuestSubmitHintMobile" class="text-center text-yellow-300 text-xs mt-1 hidden">点击提交任务</div>
                                    </div>
                                </div>
                                
                                <div class="mobile-tab-content hidden" id="mobileSetTab">
                                    <div id="setBonusContentMobile" class="space-y-1">
                                        <!-- 套装效果将在这里显示 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能区域 - 底部 -->
                    <div class="game-container rounded-lg p-4 mb-4">
                        <h3 class="text-xl font-bold text-blue-400 mb-3">功能区域</h3>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mobile-function-buttons">
                            <button onclick="showMapArea()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">🗺️</span>
                                <span class="text-xs">地图</span>
                            </button>
                            <button onclick="showInventory()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">🎒</span>
                                <span class="text-xs">背包</span>
                            </button>
                            <button onclick="showShop()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">🏪</span>
                                <span class="text-xs">商店</span>
                            </button>
                            <button onclick="showAttributePanelModal()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">📊</span>
                                <span class="text-xs">属性</span>
                            </button>
                            <button onclick="showCraftPanelModal()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">🔨</span>
                                <span class="text-xs">合成</span>
                            </button>
                            <button onclick="showRankingPanelModal()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">🏆</span>
                                <span class="text-xs">排行榜</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 md:grid-cols-3 gap-2 mt-2 mobile-function-buttons">
                            <button onclick="showCultivationPanelModal()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">🌱</span>
                                <span class="text-xs">养成</span>
                            </button>
                            <button onclick="showQuestPanelModal()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">📋</span>
                                <span class="text-xs">任务</span>
                            </button>
                            <button onclick="showTitlePanelModal()" class="btn-primary px-3 py-2 rounded-lg flex flex-col items-center space-y-1">
                                <span class="text-lg">👑</span>
                                <span class="text-xs">称号</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 战斗区域 -->
                    <div id="battleArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <h3 class="text-xl font-bold text-red-400 mb-3">战斗中</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">你</h4>
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="text-sm text-gray-300">生命: <span id="battlePlayerHp">100/100</span></div>
                                    <div class="text-sm text-gray-300">魔法: <span id="battlePlayerMp">50/50</span></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">敌人</h4>
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="text-sm text-gray-300">名称: <span id="battleMonsterName">骷髅</span></div>
                                    <div class="text-sm text-gray-300">生命: <span id="battleMonsterHp">50/50</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 战斗动画区域 -->
                        <div class="mt-4 mb-4">
                            <div id="battleAnimationArea" class="bg-gray-800 rounded-lg p-4 relative overflow-hidden" style="height: 120px;">
                                <div class="absolute bottom-4 left-8">
                                    <div id="playerFighter" class="character-sprite character-idle">
                                        <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                            <!-- 玩家角色 - 法师 -->
                                            <rect x="20" y="35" width="8" height="10" fill="#8B4513"/> <!-- 腿 -->
                                            <rect x="18" y="25" width="12" height="15" fill="#4169E1"/> <!-- 身体/袍子 -->
                                            <rect x="16" y="30" width="4" height="8" fill="#FDBCB4"/> <!-- 左臂 -->
                                            <rect x="28" y="30" width="4" height="8" fill="#FDBCB4"/> <!-- 右臂 -->
                                            <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/> <!-- 头 -->
                                            <rect x="18" y="18" width="12" height="4" fill="#8B4513"/> <!-- 帽子 -->
                                            <rect x="22" y="22" width="2" height="2" fill="#000"/> <!-- 左眼 -->
                                            <rect x="24" y="22" width="2" height="2" fill="#000"/> <!-- 右眼 -->
                                            <rect x="30" y="28" width="8" height="2" fill="#8B4513"/> <!-- 法杖 -->
                                            <rect x="36" y="26" width="4" height="4" fill="#FFD700"/> <!-- 法杖顶部 -->
                                        </svg>
                                    </div>
                                    <div class="text-xs text-center text-blue-400 mt-1">玩家</div>
                                </div>
                                <div class="absolute bottom-4 right-8">
                                    <div id="monsterFighter" class="character-sprite character-idle">
                                        <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                            <!-- 怪物角色 - 骷髅 -->
                                            <rect x="20" y="35" width="8" height="10" fill="#F5F5DC"/> <!-- 腿骨 -->
                                            <rect x="18" y="25" width="12" height="15" fill="#F5F5DC"/> <!-- 身体骨架 -->
                                            <rect x="16" y="30" width="4" height="8" fill="#F5F5DC"/> <!-- 左臂骨 -->
                                            <rect x="28" y="30" width="4" height="8" fill="#F5F5DC"/> <!-- 右臂骨 -->
                                            <rect x="20" y="20" width="8" height="8" fill="#F5F5DC"/> <!-- 头骨 -->
                                            <rect x="22" y="22" width="2" height="2" fill="#FF0000"/> <!-- 左眼窝 -->
                                            <rect x="24" y="22" width="2" height="2" fill="#FF0000"/> <!-- 右眼窝 -->
                                            <rect x="22" y="25" width="4" height="1" fill="#000"/> <!-- 嘴 -->
                                            <rect x="30" y="28" width="8" height="2" fill="#8B4513"/> <!-- 武器 -->
                                        </svg>
                                    </div>
                                    <div class="text-xs text-center text-red-400 mt-1">怪物</div>
                                </div>
                                <!-- 攻击特效 -->
                                <div id="attackEffect" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl opacity-0 transition-all duration-500">
                                    ⚡
                                </div>
                                <!-- 飘字容器 -->
                                <div id="damageTextContainer" class="absolute inset-0 pointer-events-none" style="z-index: 100; overflow: visible;">
                                    <!-- 飘字将在这里动态生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="mb-3">
                                <button id="autoBattleBtn" onclick="toggleAutoBattle()" class="btn-primary px-6 py-2 rounded mr-2">开始自动战斗</button>
                                <button onclick="flee()" class="btn-secondary px-4 py-2 rounded">逃跑</button>
                                <!-- 鞭尸按钮已改为自动触发，不再需要手动按钮 -->
                <!-- <button id="whipCorpseBtn" onclick="whipCorpse()" class="btn-secondary px-4 py-2 rounded ml-2 hidden">鞭尸</button> -->
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="useSkill('fireball')" class="skill-btn px-4 py-2 rounded text-white">火球术 (10MP)</button>
                                <button onclick="useSkill('heal')" class="skill-btn px-4 py-2 rounded text-white">治疗术 (15MP)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 商店区域 -->
                    <div id="shopArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-yellow-400">商店</h3>
                            <div class="space-x-2">
                                <button id="buyTab" onclick="switchShopTab('buy')" class="btn-primary px-4 py-2 rounded">购买</button>
                                <button id="sellTab" onclick="switchShopTab('sell')" class="btn-secondary px-4 py-2 rounded">出售</button>
                            </div>
                        </div>
                        <div id="shopItems" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- 商店物品将在这里动态生成 -->
                        </div>
                    </div>
                    

                    
                    <!-- 合成系统区域 -->
                    <div id="craftArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-purple-400">装备合成</h3>
                            <button onclick="hideCraftPanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <!-- 合成配方选择 -->
                        <div class="mb-4">
                            <h4 class="text-lg font-bold text-blue-400 mb-3">合成配方</h4>
                            <div id="craftRecipes" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <!-- 合成配方将在这里动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 合成详情 -->
                        <div id="craftDetails" class="bg-gray-800 rounded-lg p-4 hidden">
                            <h4 class="text-lg font-bold text-green-400 mb-3">合成详情</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="text-md font-bold text-yellow-400 mb-2">所需材料</h5>
                                    <div id="craftMaterials" class="space-y-2 text-sm">
                                        <!-- 所需材料列表 -->
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-md font-bold text-yellow-400 mb-2">合成结果</h5>
                                    <div id="craftResult" class="bg-gray-700 rounded p-3">
                                        <!-- 合成结果预览 -->
                                    </div>
                                    <button id="craftButton" onclick="performCraft()" class="btn-primary px-4 py-2 rounded mt-3 w-full" disabled>合成</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 任务系统区域 -->
                    <div id="questArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-green-400">任务系统</h3>
                            <button onclick="hideQuestPanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- 可接任务 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">可接任务</h4>
                                <div id="availableQuests" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- 可接任务列表 -->
                                </div>
                            </div>
                            
                            <!-- 进行中任务 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-yellow-400 mb-3">进行中任务</h4>
                                <div id="activeQuests" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- 进行中任务列表 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 已完成任务 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-green-400 mb-3">已完成任务</h4>
                            <div id="completedQuests" class="space-y-2 max-h-40 overflow-y-auto">
                                <!-- 已完成任务列表 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 称号系统区域 -->
                    <div id="titleArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-purple-400">称号系统</h3>
                            <button onclick="hideTitlePanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- 当前称号 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-gold mb-3">当前称号</h4>
                                <div id="currentTitle" class="text-center p-4 border-2 border-gold rounded-lg">
                                    <div class="text-gray-400">未激活称号</div>
                                </div>
                                <div id="titleEffect" class="mt-3 text-sm text-gray-300">
                                    <!-- 称号效果显示 -->
                                </div>
                            </div>
                            
                            <!-- 拥有的称号 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">拥有的称号</h4>
                                <div id="ownedTitles" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- 拥有的称号列表 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 称号卷轴 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-orange-400 mb-3">称号卷轴</h4>
                            <div id="titleScrolls" class="space-y-2 max-h-40 overflow-y-auto">
                                <!-- 称号卷轴列表 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 属性面板区域 -->
                    <div id="attributeArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-yellow-400">角色属性</h3>
                            <button onclick="hideAttributePanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 基础属性 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">基础属性</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">职业:</span>
                                        <span id="attrClass" class="text-white">战士</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="attrLevel" class="text-white">1</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">生命值:</span>
                                        <span id="attrHp" class="text-white">100/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">魔法值:</span>
                                        <span id="attrMp" class="text-white">50/50</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验值:</span>
                                        <span id="attrExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">金币:</span>
                                        <span id="attrGold" class="text-white">100</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 战斗属性 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-red-400 mb-3">战斗属性</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">攻击力:</span>
                                        <span id="attrAttack" class="text-white">10-20</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">防御力:</span>
                                        <span id="attrDefense" class="text-white">5</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">暴击率:</span>
                                        <span id="attrCritRate" class="text-yellow-400">5%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">暴击伤害:</span>
                                        <span id="attrCritDamage" class="text-yellow-400">150%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">法术强度:</span>
                                        <span id="attrMagicPower" class="text-blue-400">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 装备槽位 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-blue-400 mb-3">当前装备</h4>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">武器</div>
                                    <div id="weapon" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">头盔</div>
                                    <div id="helmet" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">防具</div>
                                    <div id="armor" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">靴子</div>
                                    <div id="boots" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">戒指</div>
                                    <div id="ring" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">项链</div>
                                    <div id="necklace" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">护符1</div>
                                    <div id="special1" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">护符2</div>
                                    <div id="special2" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">护符3</div>
                                    <div id="special3" class="text-white">无</div>
                                </div>
                                <div class="equipment-slot rounded p-2 bg-gray-700">
                                    <div class="text-gray-400 text-xs mb-1">护符4</div>
                                    <div id="special4" class="text-white">无</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 装备加成详情 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-green-400 mb-3">装备加成</h4>
                            <div id="equipmentBonus" class="text-sm text-gray-300">
                                <div>当前无装备加成</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 养成系统区域 -->
                    <div id="cultivationArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-purple-400">养成系统</h3>
                            <button onclick="hideCultivationPanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 爆率提升 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-yellow-400 mb-3">爆率提升</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="dropRateLevel" class="text-white">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验:</span>
                                        <span id="dropRateExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">效果:</span>
                                        <span id="dropRateEffect" class="text-green-400">+0%</span>
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="upgradeCultivation('dropRate')" class="btn-primary px-4 py-2 rounded w-full text-sm">升级 (消耗材料)</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 伤害提升 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-red-400 mb-3">伤害提升</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="damageLevel" class="text-white">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验:</span>
                                        <span id="damageExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">效果:</span>
                                        <span id="damageEffect" class="text-green-400">+0%</span>
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="upgradeCultivation('damage')" class="btn-primary px-4 py-2 rounded w-full text-sm">升级 (消耗材料)</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 鞭尸概率 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">鞭尸概率</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="whipCorpseLevel" class="text-white">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验:</span>
                                        <span id="whipCorpseExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">效果:</span>
                                        <span id="whipCorpseEffect" class="text-green-400">0%</span>
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="upgradeCultivation('whipCorpse')" class="btn-primary px-4 py-2 rounded w-full text-sm">升级 (消耗材料)</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 升级材料需求 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-orange-400 mb-3">升级材料需求</h4>
                            <div id="cultivationMaterials" class="text-sm text-gray-300">
                                <div>选择要升级的养成项目查看材料需求</div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // 添加全局错误处理器，阻止跨域错误显示在控制台
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('Cross origin')) {
                event.preventDefault();
                return false;
            }
        });
        
        // 阻止未处理的Promise rejection显示在控制台
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Cross origin') || 
                 event.reason.message.includes('Config load failed'))) {
                event.preventDefault();
                return false;
            }
        });
        
        // 登录系统全局变量
        let currentAccount = null;
        let currentCharacterSlot = null;
        
        // 账号数据存储结构: { username: { password: 'xxx', characters: [{}, {}, {}] } }
        function getAccountData() {
            const data = localStorage.getItem('legendGameAccounts');
            return data ? JSON.parse(data) : {};
        }
        
        function saveAccountData(accounts) {
            localStorage.setItem('legendGameAccounts', JSON.stringify(accounts));
        }
        
        // 界面切换函数
        function showStartScreen() {
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('characterSelectScreen').classList.add('hidden');
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
        }
        
        function showLoginScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('characterSelectScreen').classList.add('hidden');
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
            
            // 清空输入框
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }
        
        function showCharacterSelectScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('characterSelectScreen').classList.remove('hidden');
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
            
            updateCharacterSlots();
        }
        
        function showCharacterCreationScreen() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('characterSelectScreen').classList.add('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
            document.getElementById('characterCreation').classList.remove('hidden');
            
            // 清空角色名输入框
            document.getElementById('characterName').value = '';
            document.getElementById('characterNameError').textContent = '';
        }
        
        function showGameArea() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('characterSelectScreen').classList.add('hidden');
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');
        }
        
        // 登录相关函数
        function handleLogin() {
            console.log('登录按钮被点击，开始处理登录...');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            
            console.log('输入的用户名:', username);
            console.log('密码长度:', password.length);
            
            if (!username || !password) {
                console.log('用户名或密码为空');
                errorElement.textContent = '请输入账号和密码';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const accounts = getAccountData();
            console.log('获取到的账号数据:', accounts);
            
            if (accounts[username] && accounts[username].password === password) {
                // 登录成功
                console.log('登录成功，用户:', username);
                currentAccount = username;
                
                // 检查玩家是否有角色
                const characters = accounts[username].characters;
                const hasCharacters = characters.some(char => char !== null);
                
                console.log('角色数据:', characters);
                console.log('是否有角色:', hasCharacters);
                
                if (hasCharacters) {
                    // 有角色，进入角色选择界面
                    console.log('进入角色选择界面');
                    showCharacterSelectScreen();
                } else {
                    // 没有角色，进入角色创建界面
                    console.log('进入角色创建界面');
                    currentCharacterSlot = 0; // 默认使用第一个槽位
                    showCharacterCreationScreen();
                }
            } else {
                console.log('登录失败，账号或密码错误');
                errorElement.textContent = '账号或密码错误';
                errorElement.classList.remove('hidden');
            }
        }
        
        function handleRegister() {
            console.log('注册按钮被点击，开始处理注册...');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            
            console.log('注册用户名:', username);
            console.log('注册密码长度:', password.length);
            
            if (!username || !password) {
                console.log('注册时用户名或密码为空');
                errorElement.textContent = '请输入账号和密码';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (username.length < 3 || password.length < 6) {
                console.log('注册时用户名或密码长度不符合要求');
                errorElement.textContent = '账号至少3位，密码至少6位';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const accounts = getAccountData();
            console.log('注册时获取到的账号数据:', accounts);
            
            if (accounts[username]) {
                console.log('账号已存在');
                errorElement.textContent = '账号已存在';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // 注册新账号
            accounts[username] = {
                password: password,
                characters: [null, null, null] // 三个角色槽位
            };
            
            console.log('保存新账号数据:', accounts);
            saveAccountData(accounts);
            currentAccount = username;
            
            // 新注册的账号没有角色，直接进入角色创建界面
            console.log('注册成功，进入角色创建界面');
            currentCharacterSlot = 0; // 默认使用第一个槽位
            showCharacterCreationScreen();
        }
        
        function logout() {
            currentAccount = null;
            currentCharacterSlot = null;
            
            // 检查是否为外部登录
            const urlParams = new URLSearchParams(window.location.search);
            const isExternalLogin = urlParams.get('external_login') === 'true';
            
            if (isExternalLogin) {
                // 外部登录：返回到登录页面
                window.location.href = 'login.html';
            } else {
                // 内置登录：返回到开始页面
                showStartScreen();
            }
        }
        
        function switchAccount() {
            // 清除当前账号和角色选择，但保留localStorage中的账号数据
            currentAccount = null;
            currentCharacterSlot = null;
            
            // 检查是否为外部登录
            const urlParams = new URLSearchParams(window.location.search);
            const isExternalLogin = urlParams.get('external_login') === 'true';
            
            if (isExternalLogin) {
                // 外部登录：返回到登录页面
                window.location.href = 'login.html';
            } else {
                // 内置登录：清空登录表单并返回登录界面
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').textContent = '';
                showLoginScreen();
            }
            
            console.log('已切换到账号选择界面');
        }
        
        // 角色选择相关函数
        function updateCharacterSlots() {
            if (!currentAccount) return;
            
            const accounts = getAccountData();
            const characters = accounts[currentAccount].characters;
            
            for (let i = 0; i < 3; i++) {
                const slotElement = document.getElementById(`charSlot${i + 1}`);
                const character = characters[i];
                
                if (character) {
                    // 显示已有角色
                    slotElement.innerHTML = `
                        <div class="character-info">
                            <div class="character-name">${character.name}</div>
                            <div class="character-details">
                                <div>职业: ${character.class}</div>
                                <div>等级: ${character.level}</div>
                            </div>
                            <button onclick="selectCharacter(${i})" class="btn-primary mt-2">选择角色</button>
                            <button onclick="deleteCharacter(${i})" class="btn-danger mt-1">删除角色</button>
                        </div>
                    `;
                } else {
                    // 显示空槽位
                    slotElement.innerHTML = `
                        <div class="empty-slot">
                            <div class="empty-slot-text">空槽位</div>
                            <button onclick="createNewCharacter(${i})" class="btn-primary mt-2">创建角色</button>
                        </div>
                    `;
                }
            }
        }
        
        async function selectCharacter(slotIndex) {
            if (!currentAccount) return;
            
            const accounts = getAccountData();
            const character = accounts[currentAccount].characters[slotIndex];
            
            if (character) {
                currentCharacterSlot = slotIndex;
                console.log('selectCharacter - 选择角色:', character.name);
                console.log('selectCharacter - 角色任务状态:', {
                    available: character.gameData.player.quests.available.length,
                    active: character.gameData.player.quests.active.length,
                    completed: character.gameData.player.quests.completed.length
                });
                
                // 详细输出completed数组的结构
                console.log('selectCharacter - completed数组详细结构:');
                character.gameData.player.quests.completed.forEach((quest, index) => {
                    console.log(`  [${index}]:`, {
                        id: quest.id,
                        name: quest.name,
                        type: quest.type,
                        hasId: !!quest.id,
                        idType: typeof quest.id,
                        isMainQuest: quest.id && isMainQuest(quest.id),
                        fullObject: quest
                    });
                });
                
                // 加载角色数据到游戏状态
                gameState = character.gameData;
                console.log('selectCharacter - 加载角色数据完成，gameState已更新');
                
                // 强制刷新浏览器缓存提示
                console.warn('⚠️ 如果问题仍然存在，请按 Ctrl+F5 (Windows) 或 Cmd+Shift+R (Mac) 强制刷新页面清除缓存');
                
                // 异步重新初始化任务系统
                await initializeQuests();
                console.log('selectCharacter - 任务系统初始化完成，新状态:', {
                    available: gameState.player.quests.available.length,
                    active: gameState.player.quests.active.length,
                    completed: gameState.player.quests.completed.length,
                    availableQuests: gameState.player.quests.available.map(q => ({ id: q.id, name: q.name })),
                    activeQuests: gameState.player.quests.active.map(q => ({ id: q.id, name: q.name }))
                });
                
                updateDisplay();
                // 确保任务显示也得到更新
                updateQuestDisplay();
                updateMainQuestDisplay();
                showGameArea();
            }
        }
        
        function createNewCharacter(slotIndex) {
            currentCharacterSlot = slotIndex;
            showCharacterCreationScreen();
        }
        
        function deleteCharacter(slotIndex) {
            if (!currentAccount) return;
            
            if (confirm('确定要删除这个角色吗？此操作不可恢复！')) {
                const accounts = getAccountData();
                accounts[currentAccount].characters[slotIndex] = null;
                saveAccountData(accounts);
                updateCharacterSlots();
            }
        }
        
        // 角色创建相关函数 - createCharacterWithClass函数已移至页面顶部
        
        async function createNewGameState(className) {
            const initialState = getInitialGameState();
            const classData = getClassData()[className];
            
            if (classData) {
                initialState.player.class = className;
                initialState.player.hp = classData.hp;
                initialState.player.maxHp = classData.hp;
                initialState.player.mp = classData.mp;
                initialState.player.maxMp = classData.mp;
                initialState.player.attack = [...classData.attack];
                initialState.player.defense = classData.defense;
            }
            
            console.log('createNewGameState - 创建新游戏状态:', className, initialState);
            console.log('createNewGameState - 初始任务状态:', {
                available: initialState.player.quests.available.length,
                active: initialState.player.quests.active.length,
                completed: initialState.player.quests.completed.length
            });
            
            // 临时设置gameState以便initializeQuests能正常工作
            const tempGameState = gameState;
            gameState = initialState;
            
            // 异步初始化任务系统
            await initializeQuests();
            console.log('createNewGameState - 任务系统初始化完成，新状态:', {
                available: gameState.player.quests.available.length,
                active: gameState.player.quests.active.length,
                completed: gameState.player.quests.completed.length,
                availableQuests: gameState.player.quests.available.map(q => q.name)
            });
            
            // 恢复原gameState
            const result = gameState;
            gameState = tempGameState;
            
            return result;
        }
        
        // 游戏保存函数（修改为保存到当前账号角色槽位）
        // saveGameToAccount 函数已移除
        
        // 游戏说明函数
        function showAbout() {
            alert('🎮 传奇世界 - 游戏说明\n\n' +
                  '📖 游戏特色：\n' +
                  '• 经典传奇玩法，三大职业任你选择\n' +
                  '• 战士：近战物理输出，血厚防高\n' +
                  '• 法师：远程魔法攻击，群体伤害\n' +
                  '• 道士：辅助治疗，召唤神兽\n\n' +
                  '🎯 游戏目标：\n' +
                  '• 击败各种怪物获得经验和装备\n' +
                  '• 提升角色等级和属性\n' +
                  '• 收集稀有装备和材料\n' +
                  '• 完成任务获得奖励\n\n' +
                  '💡 操作提示：\n' +
                  '• 点击怪物进行战斗\n' +
                  '• 使用技能造成更多伤害\n' +
                  '• 合理搭配装备提升实力');
        }
        
        // 外部登录后的角色选择处理
        function showExternalLoginCharacterSelect() {
            // 等待网络认证完成后再显示角色选择界面
            if (networkManager && networkManager.isAuthenticated) {
                // 已认证，直接显示角色选择界面
                console.log('网络已认证，显示外部登录角色选择界面');
                showExternalCharacterSelectScreen();
            } else {
                console.log('等待网络认证完成后显示角色选择界面...');
                // 等待认证完成
                let authTimeout = setTimeout(() => {
                    console.warn('认证超时，显示默认角色选择界面');
                    showExternalCharacterSelectScreen();
                }, 10000); // 10秒超时
                
                // 认证成功处理
                const handleAuthenticated = (data) => {
                    console.log('认证成功，显示角色选择界面');
                    clearTimeout(authTimeout);
                    showExternalCharacterSelectScreen();
                    // 移除临时监听器
                    networkManager.off('authenticated', handleAuthenticated);
                    networkManager.off('auth_error', handleAuthError);
                };
                
                // 认证失败处理
                const handleAuthError = (data) => {
                    console.error('认证失败，显示默认角色选择界面:', data);
                    clearTimeout(authTimeout);
                    showExternalCharacterSelectScreen();
                    // 移除临时监听器
                    networkManager.off('authenticated', handleAuthenticated);
                    networkManager.off('auth_error', handleAuthError);
                };
                
                networkManager.on('authenticated', handleAuthenticated);
                networkManager.on('auth_error', handleAuthError);
            }
        }
        
        // 显示外部登录的角色选择界面
        function showExternalCharacterSelectScreen() {
            // 隐藏所有其他界面
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
            
            // 显示角色选择界面
            document.getElementById('characterSelectScreen').classList.remove('hidden');
            
            // 更新角色选择界面的标题和说明
            const titleElement = document.querySelector('#characterSelectScreen h2');
            if (titleElement) {
                titleElement.textContent = '选择角色';
            }
            
            // 更新欢迎信息
            const welcomeElement = document.getElementById('welcomeUsername');
            if (welcomeElement) {
                welcomeElement.textContent = '外部登录用户';
            }
            
            // 为外部登录用户创建虚拟角色槽位
            updateExternalLoginCharacterSlots();
        }
        
        // 更新外部登录的角色槽位显示
        function updateExternalLoginCharacterSlots() {
            // 外部登录用户使用网络存储的角色数据
            // 如果没有网络角色数据，则显示空槽位供创建角色
            
            // 模拟从服务器获取角色数据（实际应该从网络管理器获取）
            const externalCharacters = getExternalCharacters();
            
            for (let i = 0; i < 3; i++) {
                const slotElement = document.getElementById(`charSlot${i + 1}`);
                const character = externalCharacters[i];
                
                if (character) {
                    // 显示已有角色
                    slotElement.innerHTML = `
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-3 bg-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-2xl">${getClassIcon(character.class)}</span>
                            </div>
                            <div class="character-info">
                                <div class="text-white font-bold">${character.name}</div>
                                <div class="text-gray-300 text-sm">职业: ${getClassDisplayName(character.class)}</div>
                                <div class="text-gray-300 text-sm">等级: ${character.level}</div>
                            </div>
                            <div class="mt-3 space-y-2">
                                <button onclick="selectExternalLoginCharacter(${i})" class="btn-primary px-4 py-2 rounded w-full text-sm">选择角色</button>
                                <button onclick="deleteExternalCharacter(${i})" class="btn-danger px-4 py-2 rounded w-full text-sm">删除角色</button>
                            </div>
                        </div>
                    `;
                } else {
                    // 显示空槽位
                    slotElement.innerHTML = `
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-3 bg-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-2xl">👤</span>
                            </div>
                            <div class="character-info">
                                <div class="text-gray-400">空角色槽</div>
                                <div class="text-sm text-gray-500">点击创建角色</div>
                            </div>
                            <div class="mt-3">
                                <button onclick="createExternalCharacter(${i})" class="btn-primary px-4 py-2 rounded w-full text-sm">创建角色</button>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // 获取外部登录的角色数据
        function getExternalCharacters() {
            // 从localStorage获取外部登录的角色数据
            const externalData = localStorage.getItem('externalLoginCharacters');
            if (externalData) {
                return JSON.parse(externalData);
            }
            return [null, null, null]; // 默认三个空槽位
        }
        
        // 保存外部登录的角色数据
        function saveExternalCharacters(characters) {
            localStorage.setItem('externalLoginCharacters', JSON.stringify(characters));
        }
        
        // 获取职业图标
        function getClassIcon(className) {
            const icons = {
                'warrior': '⚔️',
                'mage': '🔮',
                'taoist': '☯️'
            };
            return icons[className] || '👤';
        }
        
        // 获取职业显示名称
        function getClassDisplayName(className) {
            const names = {
                'warrior': '战士',
                'mage': '法师',
                'taoist': '道士'
            };
            return names[className] || className;
        }
        
        // 外部登录角色选择处理
        async function selectExternalLoginCharacter(slotIndex) {
            const externalCharacters = getExternalCharacters();
            const character = externalCharacters[slotIndex];
            
            if (character) {
                console.log('外部登录选择角色:', character.name);
                
                try {
                    // 加载角色数据到游戏状态
                    gameState = character.gameData;
                    console.log('外部登录角色数据加载完成');
                    
                    // 异步重新初始化任务系统
                    await initializeQuests();
                    console.log('外部登录任务系统初始化完成');
                    
                    // 更新显示并进入游戏
                    updateDisplay();
                    updateQuestDisplay();
                    updateMainQuestDisplay();
                    showGameArea();
                    
                    // 如果网络已连接，同步游戏状态
                    if (networkManager && networkManager.isAuthenticated) {
                        syncGameStateToServer();
                    }
                    
                } catch (error) {
                    console.error('外部登录角色选择失败:', error);
                    alert('角色选择失败，请重试');
                }
            }
        }
        
        // 创建外部登录角色
        function createExternalCharacter(slotIndex) {
            currentCharacterSlot = slotIndex;
            showCharacterCreationScreen();
        }
        
        // 删除外部登录角色
        function deleteExternalCharacter(slotIndex) {
            if (confirm('确定要删除这个角色吗？此操作不可恢复！')) {
                const externalCharacters = getExternalCharacters();
                externalCharacters[slotIndex] = null;
                saveExternalCharacters(externalCharacters);
                updateExternalLoginCharacterSlots();
                
                // 如果网络已连接，同步删除到服务器
                if (networkManager && networkManager.isAuthenticated) {
                    syncCharacterDeletionToServer(slotIndex);
                }
            }
        }
        
        // 返回角色选择界面（根据登录方式决定）
        function returnToCharacterSelect() {
            const urlParams = new URLSearchParams(window.location.search);
            const isExternalLogin = urlParams.get('external_login') === 'true';
            
            if (isExternalLogin) {
                showExternalCharacterSelectScreen();
            } else {
                showCharacterSelectScreen();
            }
        }
        
        // 网络同步相关函数（占位符，实际应该与服务器通信）
        function syncCharacterToServer(character, slotIndex) {
            console.log('同步角色到服务器:', character.name, '槽位:', slotIndex);
            // 实际实现应该发送网络请求到服务器
        }
        
        function syncCharacterDeletionToServer(slotIndex) {
            console.log('同步角色删除到服务器，槽位:', slotIndex);
            // 实际实现应该发送网络请求到服务器
        }
        
        function syncGameStateToServer() {
            console.log('同步游戏状态到服务器');
            // 实际实现应该发送网络请求到服务器
        }
        
        // 页面初始化时显示启动界面
        window.addEventListener('load', function() {
            showStartScreen();
        });
        
        // 初始化配置管理器
        let configManager;
        
        // 页面加载完成后初始化配置管理器
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                configManager = new ConfigManager();
                await configManager.preloadAll();
                console.log('配置管理器初始化完成');
            } catch (error) {
                // 静默处理初始化错误
                configManager = new ConfigManager();
            }
            
            // 初始化模态框事件监听器
            initializeModalEventListeners();
        });
        
        // 初始化模态框事件监听器
        function initializeModalEventListeners() {
            // 为所有模态框添加点击外部关闭功能
            const modals = [
                { id: 'moreFunctionsModal', closeFunction: 'hideMoreFunctions' },
                { id: 'attributeModal', closeFunction: 'hideAttributePanelModal' },
                { id: 'cultivationModal', closeFunction: 'hideCultivationPanelModal' },
                { id: 'craftModal', closeFunction: 'hideCraftPanelModal' },
                { id: 'questModal', closeFunction: 'hideQuestPanelModal' },
                { id: 'rankingModal', closeFunction: 'hideRankingPanelModal' }
            ];
            
            modals.forEach(modal => {
                const modalElement = document.getElementById(modal.id);
                if (modalElement) {
                    modalElement.addEventListener('click', function(event) {
                        // 只有当点击的是模态框背景（不是内容区域）时才关闭
                        if (event.target === modalElement) {
                            // 调用对应的关闭函数
                            if (window[modal.closeFunction]) {
                                window[modal.closeFunction]();
                            }
                        }
                    });
                    
                    // 为模态框内容区域添加事件阻止冒泡
                    const contentDiv = modalElement.querySelector('.bg-gray-900');
                    if (contentDiv) {
                        contentDiv.addEventListener('click', function(event) {
                            event.stopPropagation();
                        });
                    }
                }
            });
            
            // 初始化装备槽事件委托
            initializeEquipmentSlotEventDelegation();
            
            // 初始化模态框装备槽事件委托
            initializeModalEquipmentSlotEventDelegation();
            
            // 初始化怪物点击事件委托
            initializeMonsterEventDelegation();
        }
        
        // 初始化装备槽事件委托
        function initializeEquipmentSlotEventDelegation() {
            // 为装备区域添加事件委托
            const equipmentArea = document.getElementById('equipmentArea');
            if (equipmentArea) {
                equipmentArea.addEventListener('click', function(event) {
                    // 查找最近的装备槽容器
                    const slotContainer = event.target.closest('[data-slot-key]');
                    if (slotContainer) {
                        const slotKey = slotContainer.getAttribute('data-slot-key');
                        const slotName = slotContainer.getAttribute('data-slot-name');
                        
                        // 检查是否有装备
                        const equipment = gameState.player.equipment;
                        if (equipment[slotKey]) {
                            event.preventDefault();
                            event.stopPropagation();
                            console.log(`事件委托 - 点击卸下装备: ${slotName}`, event.target);
                            unequipItem(slotKey, slotName);
                        }
                    }
                });
            }
        }
        
        // 初始化模态框装备槽事件委托
        function initializeModalEquipmentSlotEventDelegation() {
            // 为模态框装备槽容器添加事件委托
            const modalEquipmentContainer = document.getElementById('modalEquipmentSlots');
            if (modalEquipmentContainer) {
                modalEquipmentContainer.addEventListener('click', function(event) {
                    // 查找最近的装备槽容器
                    const slotContainer = event.target.closest('[data-modal-slot-key]');
                    if (slotContainer) {
                        const slotKey = slotContainer.getAttribute('data-modal-slot-key');
                        
                        // 检查是否有装备
                        const equipment = gameState.player.equipment;
                        if (equipment[slotKey]) {
                            event.preventDefault();
                            event.stopPropagation();
                            console.log(`事件委托 - 模态框点击卸下装备: ${slotKey}`, event.target);
                            unequipItem(slotKey);
                        }
                    }
                });
            }
        }
        
        // 初始化怪物点击事件委托
        let monsterEventDelegationInitialized = false;
        function initializeMonsterEventDelegation() {
            // 避免重复初始化事件委托
            if (monsterEventDelegationInitialized) {
                return;
            }
            
            // 为怪物容器添加事件委托
            const monstersContainer = document.getElementById('monstersOnMap');
            if (monstersContainer) {
                monstersContainer.addEventListener('click', function(event) {
                    // 查找最近的怪物元素
                    const monsterElement = event.target.closest('[data-monster-id]');
                    if (monsterElement) {
                        const monsterId = monsterElement.getAttribute('data-monster-id');
                        // 从mapMonsters数组中找到对应的怪物数据
                        const monsterData = mapMonsters.find(m => m.id === monsterId);
                        if (monsterData) {
                            event.preventDefault();
                            event.stopPropagation();
                            moveToMonsterAndFight(monsterData);
                        }
                    }
                });
                monsterEventDelegationInitialized = true;
            }
        }
        
        // 游戏状态
        // 获取初始游戏状态数据
        function getInitialGameState() {
            if (configManager && configManager.isInitialized()) {
                return configManager.getInitialGameState();
            }
            return getDefaultInitialGameState();
        }

        // 默认初始游戏状态配置
        function getDefaultInitialGameState() {
            return {
                player: {
                    class: '',
                    level: 1,
                    hp: 100,
                    maxHp: 100,
                    mp: 50,
                    maxMp: 50,
                    exp: 0,
                    maxExp: 100,
                    gold: 100,
                    attack: [10, 20],
                    defense: 5,
                    equipment: {
                        weapon: null,
                        helmet: null,
                        armor: null,
                        boots: null,
                        ring: null,
                        necklace: null,
                        special1: null,
                        special2: null,
                        special3: null,
                        special4: null
                    },
                    inventory: [
                        // 添加测试用的特殊装备
                        { name: '测试力量护符', type: 'special', tier: 1, percentDamage: 10, price: 500, rarity: 'rare', description: '增加10%伤害' },
                        { name: '测试生命护符', type: 'special', tier: 1, percentHp: 15, price: 500, rarity: 'rare', description: '增加15%生命值' }
                    ],
                    materials: [ // 养成材料存储
                        { name: '铁矿石', count: 10 },
                        { name: '银矿石', count: 5 },
                        { name: '黄金矿石', count: 3 },
                        { name: '魔法水晶', count: 8 },
                        { name: '稀有宝石', count: 2 }
                    ],
                    // 养成系统
                    cultivation: {
                        dropRate: { level: 0, exp: 0 },      // 爆率提升
                        damage: { level: 0, exp: 0 },        // 伤害提升
                        whipCorpse: { level: 0, exp: 0 }     // 鞭尸概率
                    },
                    // 任务系统
                    quests: {
                        active: [],      // 当前进行中的任务
                        completed: [],   // 已完成的任务
                        available: []    // 可接取的任务
                    },
                    // 称号系统
                    titles: {
                        owned: [],       // 拥有的称号
                        active: null,    // 当前激活的称号
                        scrolls: [],     // 称号卷轴
                        fragments: 0     // 称号碎片
                    }
                },
                currentLocation: 1,
                inBattle: false,
                currentMonster: null,
                shopMode: 'buy',
                autoBattle: false,
                battleInterval: null,
                showWhipCorpse: false,  // 是否显示鞭尸按钮
                // 自动回收配置
                autoRecycle: {
                    enabled: false,
                    maxQuality: 'common'  // common, rare, epic, legendary, mythic
                },
                // 合成树数据
                craftingTree: {
                    selectedNode: null,  // 当前选中的节点
                    viewOffset: { x: 0, y: 0 },  // 视图偏移
                    zoomLevel: 1  // 缩放级别
                }
            };
        }

        let gameState = {
            player: {
                class: '',
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                exp: 0,
                maxExp: 100,
                gold: 100,
                attack: [10, 20],
                defense: 5,
                equipment: {
                    weapon: null,
                    helmet: null,
                    armor: null,
                    boots: null,
                    ring: null,
                    necklace: null,
                    special1: null,
                    special2: null,
                    special3: null,
                    special4: null
                },
                inventory: [],
                materials: [],
                // 养成系统
                cultivation: {
                    dropRate: { level: 0, exp: 0 },      // 爆率提升
                    damage: { level: 0, exp: 0 },        // 伤害提升
                    whipCorpse: { level: 0, exp: 0 }     // 鞭尸概率
                },
                // 任务系统
                quests: {
                    active: [],      // 当前进行中的任务
                    completed: [],   // 已完成的任务
                    available: []    // 可接取的任务
                },
                // 称号系统
                titles: {
                    owned: [],       // 拥有的称号
                    active: null,    // 当前激活的称号
                    scrolls: [],     // 称号卷轴
                    fragments: 0     // 称号碎片
                }
            },
            currentLocation: 'village',
            inBattle: false,
            currentMonster: null,
            shopMode: 'buy',
            autoBattle: false,
            battleInterval: null,
            showWhipCorpse: false,  // 是否显示鞭尸按钮
            // 自动回收配置
            autoRecycle: {
                enabled: false,
                maxQuality: 'common'  // common, rare, epic, legendary, mythic
            },
            // 合成树数据
            craftingTree: {
                selectedNode: null,  // 当前选中的节点
                viewOffset: { x: 0, y: 0 },  // 视图偏移
                zoomLevel: 1  // 缩放级别
            }
        };

        // 切换商店标签页
        function switchShopTab(mode) {
            gameState.shopMode = mode;
            
            // 更新按钮样式
            const buyTab = document.getElementById('buyTab');
            const sellTab = document.getElementById('sellTab');
            
            if (mode === 'buy') {
                buyTab.className = 'btn-primary px-4 py-2 rounded';
                sellTab.className = 'btn-secondary px-4 py-2 rounded';
            } else {
                buyTab.className = 'btn-secondary px-4 py-2 rounded';
                sellTab.className = 'btn-primary px-4 py-2 rounded';
            }
            
            showShop();
        }

        // 设置商店模式（用于弹窗）
        async function setShopMode(mode) {
            gameState.shopMode = mode;
            
            // 更新弹窗中的按钮样式
            const modalBuyBtn = document.querySelector('#shopModal .shop-mode-btn[onclick="setShopMode(\'buy\')"]');
            const modalSellBtn = document.querySelector('#shopModal .shop-mode-btn[onclick="setShopMode(\'sell\')"]');
            
            if (modalBuyBtn && modalSellBtn) {
                if (mode === 'buy') {
                    modalBuyBtn.className = 'shop-mode-btn bg-blue-500 text-white px-4 py-2 rounded mr-2';
                    modalSellBtn.className = 'shop-mode-btn bg-gray-300 text-gray-700 px-4 py-2 rounded';
                } else {
                    modalBuyBtn.className = 'shop-mode-btn bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2';
                    modalSellBtn.className = 'shop-mode-btn bg-blue-500 text-white px-4 py-2 rounded';
                }
            }
            
            await updateShopDisplay();
        }

        // 从配置管理器获取职业数据的函数
        function getClassData() {
            if (configManager) {
                try {
                    // 注意：这里需要根据实际的配置管理器方法名调整
                    // 如果没有专门的职业配置，可以从其他配置中获取或使用默认值
                    return getDefaultClassConfig();
                } catch (error) {
                    console.error('获取职业配置失败，使用默认配置:', error);
                }
            }
            return getDefaultClassConfig();
        }
        
        // 默认职业配置
        function getDefaultClassConfig() {
            return {
                warrior: {
                    name: '战士',
                    hp: 120,
                    mp: 30,
                    attack: [15, 25],
                    defense: 8,
                    critRate: 5,
                    critDamage: 150,
                    skills: {
                        basicSword: { name: '基本剑术', level: 0, maxLevel: 3, mpCost: 0, description: '提升攻击命中率' },
                        attackSword: { name: '攻杀剑术', level: 0, maxLevel: 3, mpCost: 5, description: '强力攻击技能' },
                        halfMoon: { name: '半月弯刀', level: 0, maxLevel: 3, mpCost: 8, description: '扇形范围攻击' },
                        wildSlash: { name: '野蛮冲撞', level: 0, maxLevel: 3, mpCost: 12, description: '冲撞击退敌人' }
                    }
                },
                mage: {
                    name: '法师',
                    hp: 80,
                    mp: 100,
                    attack: [10, 20],
                    defense: 3,
                    critRate: 8,
                    critDamage: 180,
                    skills: {
                        fireball: { name: '火球术', level: 0, maxLevel: 3, mpCost: 10, description: '发射火球攻击敌人' },
                        heal: { name: '治愈术', level: 0, maxLevel: 3, mpCost: 15, description: '恢复生命值' },
                        lightning: { name: '雷电术', level: 0, maxLevel: 3, mpCost: 18, description: '召唤雷电攻击' },
                        magicShield: { name: '魔法盾', level: 0, maxLevel: 3, mpCost: 25, description: '魔法护盾减免伤害' }
                    }
                },
                taoist: {
                    name: '道士',
                    hp: 100,
                    mp: 70,
                    attack: [12, 22],
                    defense: 5,
                    critRate: 6,
                    critDamage: 160,
                    skills: {
                        heal: { name: '治愈术', level: 0, maxLevel: 3, mpCost: 15, description: '恢复生命值' },
                        poison: { name: '施毒术', level: 0, maxLevel: 3, mpCost: 8, description: '给敌人施加毒素' },
                        soulFire: { name: '灵魂火符', level: 0, maxLevel: 3, mpCost: 12, description: '远程火符攻击' },
                        summon: { name: '召唤骷髅', level: 0, maxLevel: 3, mpCost: 30, description: '召唤骷髅战士' }
                    }
                }
            };
        }
        
        // 职业配置（从配置文件读取）
        let classes = {};

        // 从配置管理器获取怪物数据的函数
        function getMonsterData() {
            if (configManager) {
                try {
                    return configManager.getMonsterConfig();
                } catch (error) {
                    console.error('获取怪物配置失败，使用默认配置:', error);
                }
            }
            // 如果配置管理器未初始化或获取失败，返回空对象
            return {};
        }
        
        // 怪物配置（从配置文件读取）
        let monsters = {};

        // 从配置管理器获取装备数据的函数
        function getEquipmentData() {
            if (configManager && configManager.configs && configManager.configs.has('equipment')) {
                try {
                    const equipmentConfig = configManager.configs.get('equipment');
                    if (equipmentConfig && equipmentConfig.data) {
                        // 处理装备数据中的attack字段格式转换
                        const processedData = JSON.parse(JSON.stringify(equipmentConfig.data));
                        
                        // 处理所有装备类型中的attack字段
                        ['weapons', 'accessories'].forEach(equipmentType => {
                            if (processedData[equipmentType]) {
                                processedData[equipmentType].forEach(item => {
                                    if (item.attack && typeof item.attack === 'string' && item.attack.includes(',')) {
                                        // 将字符串格式的attack转换为数组格式
                                        const attackParts = item.attack.split(',').map(v => parseFloat(v.trim()));
                                        item.attack = attackParts.length >= 2 ? [attackParts[0], attackParts[1]] : [attackParts[0] || 0, attackParts[0] || 0];
                                    } else if (item.attack && !Array.isArray(item.attack)) {
                                        // 处理单一数值的attack
                                        const val = parseFloat(item.attack) || 0;
                                        item.attack = [val, val];
                                    }
                                });
                            }
                        });
                        
                        return processedData;
                    }
                } catch (error) {
                    console.error('获取装备配置失败，使用默认配置:', error);
                }
            }
            // 如果配置管理器未初始化或获取失败，返回默认配置
            return getDefaultEquipmentConfig();
        }
        
        // 默认装备配置（作为后备）
        function getDefaultEquipmentConfig() {
            return {
                weapons: [
                    { name: '木剑', attack: [5, 10], critRate: 0, critDamage: 0, price: 50, rarity: 'common' },
                    { name: '铁剑', attack: [10, 18], critRate: 2, critDamage: 10, price: 150, rarity: 'common' },
                    { name: '银剑', attack: [15, 25], critRate: 3, critDamage: 15, price: 300, rarity: 'rare' }
                ],
                armors: [
                    { name: '布衣', defense: 2, hp: 0, mp: 0, price: 30, rarity: 'common' },
                    { name: '皮甲', defense: 5, hp: 10, mp: 0, price: 100, rarity: 'common' }
                ],
                helmets: [
                    { name: '布帽', defense: 1, hp: 0, mp: 0, price: 20, rarity: 'common' },
                    { name: '皮帽', defense: 3, hp: 5, mp: 0, price: 80, rarity: 'common' }
                ],
                boots: [
                    { name: '布鞋', defense: 1, hp: 0, mp: 0, price: 15, rarity: 'common' },
                    { name: '皮靴', defense: 2, hp: 5, mp: 0, price: 60, rarity: 'common' }
                ],
                accessories: [
                    { name: '力量戒指', attack: [2, 5], critRate: 3, price: 200, rarity: 'rare', type: 'ring' }
                ],
                potions: [
                    { name: '小血瓶', type: 'hp', heal: 50, price: 20, rarity: 'common' }
                ],
                materials: [
                    { name: '铁矿石', rarity: 'common', price: 10, description: '基础合成材料' }
                ],
                specialEquipment: [
                    { name: '力量护符', type: 'special', tier: 1, percentDamage: 10, price: 500, rarity: 'rare', description: '增加10%伤害' }
                ]
            };
        }
        
        // 装备配置（动态获取）
        let equipment = getEquipmentData();
        
        // 如果配置管理器未初始化或缺少必要数组，使用硬编码配置作为后备
        if (!equipment || !equipment.weapons || !equipment.potions || !equipment.armors || !equipment.accessories) {
            equipment = {
                weapons: [
                { name: '木剑', attack: [5, 10], critRate: 0, critDamage: 0, price: 50, rarity: 'common' },
                { name: '铁剑', attack: [10, 18], critRate: 2, critDamage: 10, price: 150, rarity: 'common' },
                { name: '银剑', attack: [15, 25], critRate: 3, critDamage: 15, price: 300, rarity: 'rare' },
                { name: '黄金剑', attack: [20, 35], critRate: 5, critDamage: 25, price: 600, rarity: 'epic' },
                { name: '屠龙刀', attack: [30, 50], critRate: 8, critDamage: 40, price: 1500, rarity: 'legendary' },
                { name: '法师之杖', attack: [8, 15], critRate: 6, critDamage: 30, magicPower: 20, price: 400, rarity: 'rare', class: 'mage' },
                { name: '道士法杖', attack: [10, 18], critRate: 4, critDamage: 20, magicPower: 15, price: 350, rarity: 'rare', class: 'taoist' },
                // 神话品质武器
                { name: '天神之剑', attack: [45, 75], critRate: 15, critDamage: 60, price: 5000, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔刃', attack: [50, 80], critRate: 12, critDamage: 80, vampiric: 15, price: 6000, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法杖', attack: [35, 60], critRate: 20, critDamage: 70, magicPower: 50, price: 5500, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道杖', attack: [40, 65], critRate: 18, critDamage: 65, magicPower: 40, price: 5200, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质武器
                { name: '混沌之刃', attack: [70, 120], critRate: 25, critDamage: 100, chaosStrike: 20, price: 15000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法杖', attack: [60, 100], critRate: 30, critDamage: 90, magicPower: 80, voidPower: 30, price: 14000, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质武器
                { name: '龙神之剑', attack: [120, 200], critRate: 35, critDamage: 150, dragonPower: 50, price: 30000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣剑', attack: [100, 180], critRate: 40, critDamage: 140, price: 32000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限之刃', attack: [150, 250], critRate: 45, critDamage: 200, price: 50000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神杖', attack: [80, 150], critRate: 50, critDamage: 180, magicPower: 120, price: 45000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            armors: [
                { name: '布衣', defense: 2, hp: 0, mp: 0, price: 30, rarity: 'common' },
                { name: '皮甲', defense: 5, hp: 10, mp: 0, price: 100, rarity: 'common' },
                { name: '铁甲', defense: 8, hp: 20, mp: 0, critRate: 1, price: 250, rarity: 'rare' },
                { name: '银甲', defense: 12, hp: 30, mp: 10, critRate: 2, price: 500, rarity: 'epic' },
                { name: '龙鳞甲', defense: 20, hp: 50, mp: 20, critRate: 4, critDamage: 15, price: 1200, rarity: 'legendary' },
                { name: '法师长袍', defense: 6, hp: 15, mp: 40, magicPower: 25, price: 300, rarity: 'rare', class: 'mage' },
                { name: '道士袍', defense: 8, hp: 25, mp: 30, magicPower: 15, price: 280, rarity: 'rare', class: 'taoist' },
                // 神话品质防具
                { name: '天神战甲', defense: 35, hp: 100, mp: 50, critRate: 8, critDamage: 25, price: 4500, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔甲', defense: 40, hp: 120, mp: 40, vampiric: 10, damageReduction: 15, price: 5000, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法袍', defense: 25, hp: 80, mp: 150, magicPower: 60, spellVamp: 20, price: 4800, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道袍', defense: 30, hp: 100, mp: 120, magicPower: 45, price: 4600, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质防具
                { name: '混沌战甲', defense: 60, hp: 200, mp: 80, critRate: 15, chaosShield: 25, price: 12000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法袍', defense: 45, hp: 150, mp: 250, magicPower: 100, voidShield: 30, price: 11000, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质防具
                { name: '龙神战甲', defense: 100, hp: 400, mp: 150, critRate: 25, dragonShield: 40, price: 25000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣甲', defense: 80, hp: 350, mp: 200, holyShield: 50, price: 27000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限战甲', defense: 120, hp: 500, mp: 250, infiniteShield: 60, price: 40000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神袍', defense: 70, hp: 300, mp: 400, magicPower: 150, creationShield: 70, price: 38000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            helmets: [
                { name: '布帽', defense: 1, hp: 0, mp: 0, price: 20, rarity: 'common' },
                { name: '皮帽', defense: 3, hp: 5, mp: 0, price: 80, rarity: 'common' },
                { name: '铁盔', defense: 6, hp: 15, mp: 0, critRate: 1, price: 200, rarity: 'rare' },
                { name: '银盔', defense: 10, hp: 25, mp: 8, critRate: 2, price: 400, rarity: 'epic' },
                { name: '龙鳞盔', defense: 15, hp: 40, mp: 15, critRate: 3, critDamage: 10, price: 1000, rarity: 'legendary' },
                { name: '法师帽', defense: 4, hp: 10, mp: 30, magicPower: 20, price: 250, rarity: 'rare', class: 'mage' },
                { name: '道士冠', defense: 6, hp: 20, mp: 25, magicPower: 12, price: 230, rarity: 'rare', class: 'taoist' },
                // 神话品质头盔
                { name: '天神头盔', defense: 25, hp: 80, mp: 40, critRate: 6, critDamage: 20, price: 3500, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔盔', defense: 30, hp: 100, mp: 30, vampiric: 8, damageReduction: 12, price: 4000, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法冠', defense: 20, hp: 60, mp: 120, magicPower: 50, spellVamp: 15, price: 3800, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道冠', defense: 25, hp: 80, mp: 100, magicPower: 35, price: 3600, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质头盔
                { name: '混沌头盔', defense: 45, hp: 150, mp: 60, critRate: 12, chaosShield: 20, price: 10000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法冠', defense: 35, hp: 120, mp: 200, magicPower: 80, voidShield: 25, price: 9000, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质头盔
                { name: '龙神头盔', defense: 80, hp: 320, mp: 120, critRate: 20, dragonShield: 30, price: 20000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣盔', defense: 65, hp: 280, mp: 160, holyShield: 40, price: 22000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限头盔', defense: 100, hp: 400, mp: 200, infiniteShield: 50, price: 32000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神冠', defense: 55, hp: 240, mp: 320, magicPower: 120, creationShield: 60, price: 30000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            boots: [
                { name: '布鞋', defense: 1, hp: 0, mp: 0, price: 15, rarity: 'common' },
                { name: '皮靴', defense: 2, hp: 5, mp: 0, price: 60, rarity: 'common' },
                { name: '铁靴', defense: 5, hp: 10, mp: 0, critRate: 1, price: 150, rarity: 'rare' },
                { name: '银靴', defense: 8, hp: 20, mp: 5, critRate: 2, price: 300, rarity: 'epic' },
                { name: '龙鳞靴', defense: 12, hp: 30, mp: 10, critRate: 3, critDamage: 8, price: 800, rarity: 'legendary' },
                { name: '法师靴', defense: 3, hp: 8, mp: 20, magicPower: 15, price: 200, rarity: 'rare', class: 'mage' },
                { name: '道士靴', defense: 4, hp: 15, mp: 15, magicPower: 10, price: 180, rarity: 'rare', class: 'taoist' },
                // 神话品质鞋子
                { name: '天神战靴', defense: 20, hp: 60, mp: 30, critRate: 5, critDamage: 15, price: 2800, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔靴', defense: 25, hp: 80, mp: 25, vampiric: 6, damageReduction: 10, price: 3200, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法靴', defense: 15, hp: 50, mp: 80, magicPower: 40, spellVamp: 12, price: 3000, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道靴', defense: 18, hp: 60, mp: 70, magicPower: 30, price: 2900, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质鞋子
                { name: '混沌战靴', defense: 35, hp: 120, mp: 50, critRate: 10, chaosShield: 15, price: 8000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法靴', defense: 28, hp: 100, mp: 150, magicPower: 60, voidShield: 20, price: 7500, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质鞋子
                { name: '龙神战靴', defense: 60, hp: 250, mp: 100, critRate: 15, dragonShield: 25, price: 16000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣靴', defense: 50, hp: 220, mp: 120, holyShield: 30, price: 18000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限战靴', defense: 80, hp: 320, mp: 150, infiniteShield: 40, price: 25000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神靴', defense: 40, hp: 200, mp: 250, magicPower: 100, creationShield: 50, price: 24000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            accessories: [
                { name: '力量戒指', attack: [2, 5], critRate: 3, price: 200, rarity: 'rare', type: 'ring' },
                { name: '敏捷戒指', critRate: 5, critDamage: 10, price: 250, rarity: 'rare', type: 'ring' },
                { name: '智慧戒指', mp: 20, magicPower: 15, price: 220, rarity: 'rare', type: 'ring' },
                { name: '生命项链', hp: 40, defense: 3, price: 300, rarity: 'epic', type: 'necklace' },
                { name: '暴击项链', critRate: 8, critDamage: 20, price: 400, rarity: 'epic', type: 'necklace' },
                // 神话品质饰品
                { name: '天神之戒', attack: [15, 25], critRate: 10, critDamage: 30, hp: 40, price: 3500, rarity: 'mythic', type: 'ring', setName: '天神套装' },
                { name: '天神项链', defense: 10, hp: 60, mp: 30, critRate: 8, price: 3800, rarity: 'mythic', type: 'necklace', setName: '天神套装' },
                { name: '深渊魔戒', attack: [18, 30], vampiric: 12, hp: 35, price: 4000, rarity: 'mythic', type: 'ring', setName: '深渊套装' },
                { name: '深渊项链', defense: 8, hp: 50, vampiric: 10, damageReduction: 10, price: 4200, rarity: 'mythic', type: 'necklace', setName: '深渊套装' },
                { name: '创世法环', attack: [12, 20], mp: 60, magicPower: 40, spellCrit: 20, price: 3800, rarity: 'mythic', type: 'ring', class: 'mage', setName: '创世套装' },
                { name: '创世项链', defense: 6, mp: 80, magicPower: 35, spellVamp: 15, price: 4000, rarity: 'mythic', type: 'necklace', class: 'mage', setName: '创世套装' },
                { name: '永恒符印', attack: [14, 22], hp: 30, mp: 40, price: 3600, rarity: 'mythic', type: 'ring', class: 'taoist', setName: '永恒套装' },
                { name: '永恒项链', defense: 8, hp: 45, mp: 50, price: 3900, rarity: 'mythic', type: 'necklace', class: 'taoist', setName: '永恒套装' },
                // 至尊品质饰品
                { name: '混沌之环', attack: [25, 40], critRate: 20, chaosBonus: 30, hp: 60, price: 10000, rarity: 'supreme', type: 'ring', setName: '混沌套装' },
                { name: '混沌项链', defense: 15, hp: 80, chaosShield: 20, price: 10500, rarity: 'supreme', type: 'necklace', setName: '混沌套装' },
                { name: '虚空法印', attack: [20, 35], mp: 100, magicPower: 70, voidMastery: 40, price: 9500, rarity: 'supreme', type: 'ring', class: 'mage', setName: '虚空套装' },
                { name: '虚空项链', defense: 12, mp: 120, voidShield: 25, price: 10000, rarity: 'supreme', type: 'necklace', class: 'mage', setName: '虚空套装' },
                // 超神品质饰品
                { name: '龙神之戒', attack: [40, 70], critRate: 30, dragonPower: 50, hp: 120, price: 20000, rarity: 'transcendent', type: 'ring', setName: '龙神套装' },
                { name: '龙神项链', defense: 25, hp: 150, dragonShield: 35, price: 22000, rarity: 'transcendent', type: 'necklace', setName: '龙神套装' },
                { name: '神域圣环', attack: [35, 60], critRate: 35, hp: 100, price: 21000, rarity: 'transcendent', type: 'ring', setName: '神域套装' },
                { name: '神域项链', defense: 20, hp: 130, holyShield: 40, price: 23000, rarity: 'transcendent', type: 'necklace', setName: '神域套装' },
                { name: '无限法印', attack: [50, 90], critRate: 40, hp: 200, price: 35000, rarity: 'transcendent', type: 'ring', setName: '无限套装' },
                { name: '无限项链', defense: 30, hp: 250, infiniteShield: 50, price: 37000, rarity: 'transcendent', type: 'necklace', setName: '无限套装' },
                { name: '创世神印', attack: [30, 55], mp: 200, magicPower: 120, price: 33000, rarity: 'transcendent', type: 'ring', class: 'mage', setName: '创世神套装' },
                { name: '创世项链', defense: 18, mp: 250, creationShield: 60, price: 35000, rarity: 'transcendent', type: 'necklace', class: 'mage', setName: '创世神套装' }
            ],
            potions: [
                { name: '小血瓶', type: 'hp', heal: 50, price: 20, rarity: 'common' },
                { name: '中血瓶', type: 'hp', heal: 100, price: 50, rarity: 'common' },
                { name: '大血瓶', type: 'hp', heal: 200, price: 120, rarity: 'rare' },
                { name: '小蓝瓶', type: 'mp', heal: 30, price: 15, rarity: 'common' },
                { name: '中蓝瓶', type: 'mp', heal: 60, price: 40, rarity: 'common' },
                { name: '大蓝瓶', type: 'mp', heal: 120, price: 100, rarity: 'rare' }
            ],
            materials: [
                { name: '铁矿石', rarity: 'common', price: 10, description: '基础合成材料' },
                { name: '银矿石', rarity: 'rare', price: 30, description: '稀有合成材料' },
                { name: '黄金矿石', rarity: 'epic', price: 80, description: '史诗合成材料' },
                { name: '龙鳞片', rarity: 'legendary', price: 200, description: '传说合成材料' },
                { name: '魔法水晶', rarity: 'rare', price: 50, description: '魔法装备合成材料' },
                { name: '暗影精华', rarity: 'epic', price: 120, description: '高级合成材料' },
                { name: '神圣宝石', rarity: 'legendary', price: 300, description: '顶级合成材料' },
                // 超神品质合成材料
                { name: '龙之精华', rarity: 'transcendent', price: 800, description: '龙族力量的结晶' },
                { name: '圣光水晶', rarity: 'transcendent', price: 900, description: '神圣力量的载体' },
                { name: '天使之羽', rarity: 'transcendent', price: 1200, description: '天使遗留的神圣羽毛' },
                { name: '无限水晶', rarity: 'transcendent', price: 1500, description: '蕴含无限力量的水晶' },
                { name: '时空碎片', rarity: 'transcendent', price: 2000, description: '时空裂缝中的神秘碎片' }
                ],
                specialEquipment: [
                    { name: '力量护符', type: 'special', tier: 1, percentDamage: 10, price: 500, rarity: 'rare', description: '增加10%伤害' },
                    { name: '敏捷护符', type: 'special', tier: 1, percentCrit: 5, price: 450, rarity: 'rare', description: '增加5%暴击率' },
                    { name: '智慧护符', type: 'special', tier: 1, percentMagic: 15, price: 550, rarity: 'rare', description: '增加15%魔法伤害' },
                    { name: '生命护符', type: 'special', tier: 1, percentHp: 20, price: 400, rarity: 'rare', description: '增加20%生命值' }
                ]
            };
        }

        // 获取合成配方数据
        function getCraftingRecipeData() {
            if (configManager && configManager.isInitialized()) {
                return configManager.getCraftingRecipes();
            }
            return getDefaultCraftingRecipes();
        }

        // 默认合成配方配置
        function getDefaultCraftingRecipes() {
            return {
                // 初级四格装备合成
                '力量护符': {
                    materials: [{ name: '铁矿石', count: 5 }, { name: '魔法水晶', count: 2 }],
                    gold: 200,
                    result: '力量护符'
                },
                '生命护符': {
                    materials: [{ name: '铁矿石', count: 4 }, { name: '银矿石', count: 2 }],
                    gold: 200,
                    result: '生命护符'
                },
                '攻击护符': {
                    materials: [{ name: '银矿石', count: 3 }, { name: '魔法水晶', count: 1 }],
                    gold: 200,
                    result: '攻击护符'
                },
                // 中级四格装备合成
                '强化力量护符': {
                    materials: [{ name: '力量护符', count: 1 }, { name: '黄金矿石', count: 3 }, { name: '暗影精华', count: 1 }],
                    gold: 500,
                    result: '强化力量护符'
                },
                '强化生命护符': {
                    materials: [{ name: '生命护符', count: 1 }, { name: '黄金矿石', count: 3 }, { name: '魔法水晶', count: 2 }],
                    gold: 500,
                    result: '强化生命护符'
                },
                '强化攻击护符': {
                    materials: [{ name: '攻击护符', count: 1 }, { name: '银矿石', count: 5 }, { name: '暗影精华', count: 1 }],
                    gold: 500,
                    result: '强化攻击护符'
                },
                // 高级四格装备合成
                '神力护符': {
                    materials: [{ name: '强化力量护符', count: 1 }, { name: '强化攻击护符', count: 1 }, { name: '神圣宝石', count: 2 }, { name: '龙鳞片', count: 3 }],
                    gold: 1500,
                    result: '神力护符'
                },
                '永恒护符': {
                    materials: [{ name: '强化生命护符', count: 1 }, { name: '强化攻击护符', count: 1 }, { name: '神圣宝石', count: 3 }, { name: '暗影精华', count: 2 }],
                    gold: 1500,
                    result: '永恒护符'
                },
                // 超神品质特殊装备合成
                '龙神护符': {
                    materials: [{ name: '神力护符', count: 1 }, { name: '永恒护符', count: 1 }, { name: '神圣宝石', count: 8 }, { name: '龙鳞片', count: 10 }, { name: '龙之精华', count: 5 }],
                    gold: 5000,
                    result: '龙神护符'
                },
                '神域圣符': {
                    materials: [{ name: '神力护符', count: 1 }, { name: '永恒护符', count: 1 }, { name: '神圣宝石', count: 10 }, { name: '圣光水晶', count: 8 }, { name: '天使之羽', count: 3 }],
                    gold: 5500,
                    result: '神域圣符'
                },
                '无限符印': {
                    materials: [{ name: '龙神护符', count: 1 }, { name: '神域圣符', count: 1 }, { name: '神圣宝石', count: 15 }, { name: '无限水晶', count: 10 }, { name: '时空碎片', count: 5 }],
                    gold: 10000,
                    result: '无限符印'
                },
                '创世神符': {
                    materials: [{ name: '龙神护符', count: 1 }, { name: '神域圣符', count: 1 }, { name: '神圣宝石', count: 12 }, { name: '创世水晶', count: 8 }, { name: '混沌之心', count: 3 }],
                    gold: 9500,
                    result: '创世神符'
                },
                // 神话品质装备合成
                '天神之剑': {
                    materials: [{ name: '屠龙刀', count: 1 }, { name: '神圣宝石', count: 5 }, { name: '龙鳞片', count: 8 }],
                    gold: 3000,
                    result: '天神之剑'
                },
                '深渊魔刃': {
                    materials: [{ name: '屠龙刀', count: 1 }, { name: '暗影精华', count: 10 }, { name: '神圣宝石', count: 3 }],
                    gold: 3200,
                    result: '深渊魔刃'
                },
                '创世法杖': {
                    materials: [{ name: '法师之杖', count: 1 }, { name: '魔法水晶', count: 15 }, { name: '神圣宝石', count: 4 }],
                    gold: 3100,
                    result: '创世法杖'
                },
                '永恒道杖': {
                    materials: [{ name: '法师之杖', count: 1 }, { name: '神圣宝石', count: 4 }, { name: '龙鳞片', count: 6 }],
                    gold: 3000,
                    result: '永恒道杖'
                },
                '天神战甲': {
                    materials: [{ name: '钢铁战甲', count: 1 }, { name: '神圣宝石', count: 4 }, { name: '龙鳞片', count: 10 }],
                    gold: 2800,
                    result: '天神战甲'
                },
                '深渊魔甲': {
                    materials: [{ name: '钢铁战甲', count: 1 }, { name: '暗影精华', count: 12 }, { name: '神圣宝石', count: 3 }],
                    gold: 3000,
                    result: '深渊魔甲'
                },
                '创世法袍': {
                    materials: [{ name: '法师长袍', count: 1 }, { name: '魔法水晶', count: 12 }, { name: '神圣宝石', count: 3 }],
                    gold: 2900,
                    result: '创世法袍'
                },
                '永恒道袍': {
                    materials: [{ name: '法师长袍', count: 1 }, { name: '神圣宝石', count: 3 }, { name: '龙鳞片', count: 8 }],
                    gold: 2800,
                    result: '永恒道袍'
                },
                // 至尊品质装备合成
                '混沌之刃': {
                    materials: [{ name: '天神之剑', count: 1 }, { name: '深渊魔刃', count: 1 }, { name: '神圣宝石', count: 15 }],
                    gold: 8000,
                    result: '混沌之刃'
                },
                '虚空法杖': {
                    materials: [{ name: '创世法杖', count: 1 }, { name: '永恒道杖', count: 1 }, { name: '神圣宝石', count: 12 }],
                    gold: 7500,
                    result: '虚空法杖'
                },
                '混沌战甲': {
                    materials: [{ name: '天神战甲', count: 1 }, { name: '深渊魔甲', count: 1 }, { name: '神圣宝石', count: 10 }],
                    gold: 7000,
                    result: '混沌战甲'
                },
                '虚空法袍': {
                    materials: [{ name: '创世法袍', count: 1 }, { name: '永恒道袍', count: 1 }, { name: '神圣宝石', count: 8 }],
                    gold: 6500,
                    result: '虚空法袍'
                }
            };
        }

        // 初始化合成配方
        let craftingRecipes = {};

        // 创建角色
        async function createCharacter(className) {
            const classConfig = classes[className];
            gameState.player.class = className;
            gameState.player.hp = classConfig.hp;
            gameState.player.maxHp = classConfig.hp;
            gameState.player.mp = classConfig.mp;
            gameState.player.maxMp = classConfig.mp;
            gameState.player.attack = [...classConfig.attack];
            gameState.player.defense = classConfig.defense;
            gameState.player.gold = 100; // 确保新角色有正确的金币值
            
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');
            
            updateUI();
            updatePlayerInfo();
            
            // 初始化地图显示
            await generateMapMonsters();
            updateMapDisplay();
            
            // 初始化称号显示
            updatePlayerTitleOnMap();
            
            addLog(`你选择了${classConfig.name}职业，开始你的传奇之旅！`);
            
            // 初始化主线任务
            if (gameState.player.quests.available.length === 0 && gameState.player.quests.active.length === 0) {
                const firstMainQuest = {...mainQuestChain[0]};
                gameState.player.quests.available.push(firstMainQuest);
                addLog(`🎯 主线任务已解锁: ${firstMainQuest.name}`);
            }
            
            // 更新任务显示
            updateQuestDisplay();
            updateMainQuestDisplay();
            
            // 初始化玩家属性计算
            calculatePlayerStats();
        }

        // 更新UI
        // updateDisplay函数 - 用于更新游戏界面显示
        function updateDisplay() {
            updateUI();
        }
        
        function updateUI() {
            const player = gameState.player;
            
            document.getElementById('playerClass').textContent = classes[player.class].name;
            document.getElementById('playerLevel').textContent = player.level;
            // 更新金币显示 - 确保显示为纯数字，移除任何格式化字符
            const goldValue = parseInt(player.gold) || 0;
            document.getElementById('playerGold').textContent = goldValue;
            
            // 计算特殊装备的百分比生命值加成
            const specialBonus = calculateSpecialEquipmentBonus();
            // 计算套装效果
            const setBonus = calculateSetBonus();
            
            // 应用套装和特殊装备生命值、魔法值加成
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            // 确保当前血量和魔法值不超过最大值
            if (player.hp > totalMaxHp) {
                player.hp = totalMaxHp;
            }
            if (player.mp > totalMaxMp) {
                player.mp = totalMaxMp;
            }
            
            // 更新血量条
            const hpPercent = (player.hp / totalMaxHp) * 100;
            document.getElementById('hpBar').style.width = hpPercent + '%';
            document.getElementById('hpText').textContent = `${player.hp}/${totalMaxHp}`;
            
            // 更新魔法条
            const mpPercent = (player.mp / totalMaxMp) * 100;
            document.getElementById('mpBar').style.width = mpPercent + '%';
            document.getElementById('mpText').textContent = `${player.mp}/${totalMaxMp}`;
            
            // 更新经验条
            const expPercent = (player.exp / player.maxExp) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
            document.getElementById('playerExp').textContent = `${player.exp}/${player.maxExp}`;
            
            // 更新装备
            updateEquipmentDisplay();
            updateInventoryDisplay();
            
            // 更新养成系统显示
            updateCultivationDisplay();
            
            // 显示套装效果
            updateSetBonusDisplay(setBonus);
            
            // 更新套装光环效果
            updateSetAuraEffect();
        }
        
        // 更新套装效果显示
        function updateSetBonusDisplay(setBonus) {
            const setBonusContent = document.getElementById('setBonusContent');
            
            // 重新统计激活的套装
            const player = gameState.player;
            const setCount = {};
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.setName) {
                    setCount[item.setName] = (setCount[item.setName] || 0) + 1;
                }
            });
            
            const activeSets = {};
            Object.keys(setCount).forEach(setName => {
                const count = setCount[setName];
                if (count > 0) {
                    activeSets[setName] = count;
                }
            });
            
            // 清空内容
            setBonusContent.innerHTML = '';
            
            // 如果没有激活的套装，显示提示信息
            if (Object.keys(activeSets).length === 0) {
                setBonusContent.innerHTML = '<div class="text-gray-400 text-center py-4">暂无激活的套装效果</div>';
                return;
            }
            
            // 为每个激活的套装创建显示
            Object.keys(activeSets).forEach(setName => {
                const count = activeSets[setName];
                const setDiv = document.createElement('div');
                
                // 根据套装激活状态设置不同的样式
                let containerClass = 'set-item';
                let containerStyle = 'padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid;';
                
                if (count >= 4) {
                    // 4件套：金色发光效果
                    containerClass += ' bg-yellow-900';
                    containerStyle += ' border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);';
                } else if (count >= 2) {
                    // 2件套：橙色效果
                    containerClass += ' bg-orange-900';
                    containerStyle += ' border-color: #ff8c00; box-shadow: 0 0 10px rgba(255, 140, 0, 0.4);';
                } else {
                    // 未激活：默认灰色
                    containerClass += ' bg-gray-800';
                    containerStyle += ' border-color: #6b7280;';
                }
                
                setDiv.className = containerClass;
                setDiv.style.cssText = containerStyle;
                
                // 根据套装名称设置效果描述
                let setInfo = {
                    name: setName,
                    count: count,
                    twoSetBonus: '',
                    fourSetBonus: ''
                };
                
                if (setName === '天神套装') {
                    setInfo.twoSetBonus = '攻击力+20，防御力+15';
                    setInfo.fourSetBonus = '生命值+100，神圣之力：攻击力+30';
                } else if (setName === '深渊套装') {
                    setInfo.twoSetBonus = '攻击力+25，吸血+15%';
                    setInfo.fourSetBonus = '伤害减免+20%，暴击率+15%';
                } else if (setName === '创世套装') {
                    setInfo.twoSetBonus = '法术强度+40，魔法值+80';
                    setInfo.fourSetBonus = '法术暴击+20%，创世之力：法术强度+50';
                } else if (setName === '永恒套装') {
                    setInfo.twoSetBonus = '生命值+120，吸血+20%';
                    setInfo.fourSetBonus = '永恒重生：生命值+120，吸血+20%';
                } else if (setName === '混沌套装') {
                    setInfo.twoSetBonus = '攻击力+40，暴击率+20%';
                    setInfo.fourSetBonus = '暴击伤害+50%，伤害减免+25%';
                } else if (setName === '虚空套装') {
                    setInfo.twoSetBonus = '法术强度+60，法术暴击+25%';
                    setInfo.fourSetBonus = '虚空掌控+30%，法术吸血+25%';
                } else if (setName === '龙神套装') {
                    setInfo.twoSetBonus = '攻击力+80，暴击率+30%';
                    setInfo.fourSetBonus = '暴击伤害+100%，生命值+300';
                } else if (setName === '神域套装') {
                    setInfo.twoSetBonus = '防御力+50，生命值+250';
                    setInfo.fourSetBonus = '暴击率+35%，伤害减免+40%';
                } else if (setName === '无限套装') {
                    setInfo.twoSetBonus = '攻击力+120，生命值+400';
                    setInfo.fourSetBonus = '暴击率+50%，暴击伤害+150%';
                } else if (setName === '创世神套装') {
                    setInfo.twoSetBonus = '法术强度+150，魔法值+300';
                    setInfo.fourSetBonus = '暴击率+60%，法术强度+200';
                }
                
                let bonusText = `<div class="set-name">${setInfo.name}</div>`;
                bonusText += `<div class="set-count">(${setInfo.count}/4)</div>`;
                
                if (setInfo.count >= 2) {
                    bonusText += `<div class="set-effect" style="color: #ff8c00; font-weight: bold; text-shadow: 0 0 5px #ff8c00;">✓ 2件套: ${setInfo.twoSetBonus}</div>`;
                }
                
                if (setInfo.count >= 4) {
                    bonusText += `<div class="set-effect" style="color: #ffd700; font-weight: bold; text-shadow: 0 0 8px #ffd700;">✓ 4件套: ${setInfo.fourSetBonus}</div>`;
                } else if (setInfo.count >= 2) {
                    bonusText += `<div class="set-next" style="color: #888;">○ 4件套: ${setInfo.fourSetBonus}</div>`;
                }
                
                if (setInfo.count < 2) {
                    bonusText += `<div class="set-next" style="color: #888;">○ 2件套: ${setInfo.twoSetBonus}</div>`;
                }
                
                setDiv.innerHTML = bonusText;
                setBonusContent.appendChild(setDiv);
            });
        }

        // 更新套装光环效果
        function updateSetAuraEffect() {
            const player = gameState.player;
            const playerElement = document.getElementById('playerOnMap');
            
            if (!playerElement) return;
            
            // 移除所有现有的光环效果
            playerElement.classList.remove('aura-tianShen', 'aura-shenYu', 'aura-chuangShi', 'aura-yongHeng', 'aura-hunDun', 'aura-xuKong', 'aura-longShen', 'aura-wuXian', 'aura-chuangShiShen',
                'aura-tianShen-small', 'aura-shenYu-small', 'aura-chuangShi-small', 'aura-yongHeng-small', 'aura-hunDun-small', 'aura-xuKong-small', 'aura-longShen-small', 'aura-wuXian-small', 'aura-chuangShiShen-small');
            
            // 统计套装件数
            const setCount = {};
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.setName) {
                    setCount[item.setName] = (setCount[item.setName] || 0) + 1;
                }
            });
            
            // 收集所有激活的套装（2件套及以上）
            const activeSets = [];
            const setOrder = ['创世神套装', '无限套装', '神域套装', '龙神套装', '虚空套装', '混沌套装', '永恒套装', '创世套装', '深渊套装', '天神套装'];
            
            // 按品质优先级收集激活的套装
            setOrder.forEach(setName => {
                const count = setCount[setName] || 0;
                if (count >= 2) {
                    activeSets.push({ name: setName, count: count });
                }
            });
            
            if (activeSets.length === 0) return;
            
            // 选择显示的光环：优先4件套，其次最高品质的2件套
            let selectedSet = null;
            
            // 首先查找4件套
            for (const set of activeSets) {
                if (set.count >= 4) {
                    selectedSet = set;
                    break;
                }
            }
            
            // 如果没有4件套，选择最高品质的2件套
            if (!selectedSet) {
                selectedSet = activeSets[0]; // 由于按品质排序，第一个就是最高品质
            }
            
            if (selectedSet) {
                let auraClass = '';
                const isFullSet = selectedSet.count >= 4;
                
                switch(selectedSet.name) {
                    case '天神套装':
                        auraClass = isFullSet ? 'aura-tianShen' : 'aura-tianShen-small';
                        break;
                    case '深渊套装':
                        auraClass = isFullSet ? 'aura-shenYu' : 'aura-shenYu-small';
                        break;
                    case '创世套装':
                        auraClass = isFullSet ? 'aura-chuangShi' : 'aura-chuangShi-small';
                        break;
                    case '永恒套装':
                        auraClass = isFullSet ? 'aura-yongHeng' : 'aura-yongHeng-small';
                        break;
                    case '混沌套装':
                        auraClass = isFullSet ? 'aura-hunDun' : 'aura-hunDun-small';
                        break;
                    case '虚空套装':
                        auraClass = isFullSet ? 'aura-xuKong' : 'aura-xuKong-small';
                        break;
                    case '龙神套装':
                        auraClass = isFullSet ? 'aura-longShen' : 'aura-longShen-small';
                        break;
                    case '神域套装':
                        auraClass = isFullSet ? 'aura-tianShen' : 'aura-tianShen-small';
                        break;
                    case '无限套装':
                        auraClass = isFullSet ? 'aura-wuXian' : 'aura-wuXian-small';
                        break;
                    case '创世神套装':
                        auraClass = isFullSet ? 'aura-chuangShiShen' : 'aura-chuangShiShen-small';
                        break;
                }
                
                if (auraClass) {
                    playerElement.classList.add(auraClass);
                }
            }
        }

        // 更新装备显示
        function updateEquipmentDisplay() {
            console.log('更新装备显示开始');
            const equipment = gameState.player.equipment;
            
            // 更新装备显示并添加卸下功能
            const equipmentSlots = [
                { id: 'weapon', key: 'weapon', name: '武器' },
                { id: 'helmet', key: 'helmet', name: '头盔' },
                { id: 'armor', key: 'armor', name: '护甲' },
                { id: 'boots', key: 'boots', name: '靴子' },
                { id: 'ring', key: 'ring', name: '戒指' },
                { id: 'necklace', key: 'necklace', name: '项链' },
                { id: 'special1', key: 'special1', name: '护符1' },
                { id: 'special2', key: 'special2', name: '护符2' },
                { id: 'special3', key: 'special3', name: '护符3' },
                { id: 'special4', key: 'special4', name: '护符4' }
            ];
            
            equipmentSlots.forEach(slot => {
                const element = document.getElementById(slot.id);
                const item = equipment[slot.key];
                
                if (!element) {
                    console.error(`装备槽位元素未找到: ${slot.id}`);
                    return;
                }
                
                // 获取外层的装备槽位容器
                const slotContainer = element.parentElement;
                
                if (item) {
                    console.log(`更新装备槽位 ${slot.key}:`, item.name);
                    // 创建装备名称的HTML，包含稀有度颜色和套装信息
                    const rarityClass = `item-${item.rarity || 'common'}`;
                    let equipmentHTML = `<span class="${rarityClass}">${item.name}</span>`;
                    if (item.setName) {
                        equipmentHTML += `<br><span class="set-bonus-text text-xs">[${item.setName}]</span>`;
                    }
                    
                    element.innerHTML = equipmentHTML;
                    element.style.color = ''; // 重置颜色
                    
                    // 在外层容器上设置样式和事件
                    if (slotContainer) {
                        console.log(`为装备槽位 ${slot.key} 设置点击事件，容器类名:`, slotContainer.className);
                        slotContainer.style.cursor = 'pointer';
                        slotContainer.title = `点击卸下${slot.name}`;
                        
                        // 检查是否为套装装备，如果是则添加特殊边框效果
                        if (item.setName) {
                            // 统计当前套装件数
                            const setCount = {};
                            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
                            equipmentSlots.forEach(checkSlot => {
                                const checkItem = equipment[checkSlot];
                                if (checkItem && checkItem.setName) {
                                    setCount[checkItem.setName] = (setCount[checkItem.setName] || 0) + 1;
                                }
                            });
                            
                            const currentSetCount = setCount[item.setName] || 0;
                            if (currentSetCount >= 4) {
                                // 4件套：金色发光边框
                                slotContainer.style.border = '2px solid #ffd700';
                                slotContainer.style.boxShadow = '0 0 10px #ffd700, inset 0 0 10px rgba(255, 215, 0, 0.2)';
                            } else if (currentSetCount >= 2) {
                                // 2件套：橙色边框
                                slotContainer.style.border = '2px solid #ff8c00';
                                slotContainer.style.boxShadow = '0 0 8px #ff8c00, inset 0 0 8px rgba(255, 140, 0, 0.2)';
                            } else {
                                // 单件套装：淡金色边框
                                slotContainer.style.border = '1px solid #daa520';
                                slotContainer.style.boxShadow = '0 0 5px #daa520';
                            }
                        } else {
                            // 非套装装备：蓝色边框
                            slotContainer.style.border = '1px solid #60a5fa';
                            slotContainer.style.boxShadow = 'none';
                        }
                        
                        // 添加data属性用于事件委托
                        slotContainer.setAttribute('data-slot-key', slot.key);
                        slotContainer.setAttribute('data-slot-name', slot.name);
                    } else {
                        console.error(`装备槽位 ${slot.key} 的外层容器未找到`);
                    }
                } else {
                    console.log(`清空装备槽位 ${slot.key}`);
                    element.innerHTML = '无';
                    element.style.color = '#9ca3af'; // 灰色
                    
                    // 清除外层容器的样式和data属性
                    if (slotContainer) {
                        slotContainer.style.cursor = 'default';
                        slotContainer.title = '';
                        slotContainer.removeAttribute('data-slot-key');
                        slotContainer.removeAttribute('data-slot-name');
                    }
                }
            });
            console.log('装备显示更新完成');
        }
        
        // 卸下装备函数
        function unequipItem(slotKey, slotName) {
            const equipment = gameState.player.equipment;
            const item = equipment[slotKey];
            
            if (!item) {
                addLog(`${slotName}槽位没有装备`);
                return;
            }
            
            // 检查背包是否有空间
            if (gameState.player.inventory.length >= 50) {
                addLog('背包已满，无法卸下装备');
                return;
            }
            
            // 将装备放回背包
            gameState.player.inventory.push(item);
            equipment[slotKey] = null;
            
            addLog(`卸下了${item.name}`);
            
            // 强制更新UI和玩家信息
            updateUI();
            updatePlayerInfo();
            updateEquipmentDisplay();
            
            // 重新计算玩家属性
            calculatePlayerStats();
            
            // 立即重新计算套装效果并更新显示
            const setBonus = calculateSetBonus();
            updateSetBonusDisplay(setBonus);
            
            // 更新套装光环效果
            updateSetAuraEffect();
            
            // 显示浮动文本
            showFloatingText(`卸下 ${item.name}`, '#60a5fa');
            
            // 检查称号条件
            checkTitleConditions();
        }

        // 背包显示函数已移至第9466行，此处删除重复定义

        // 获取物品描述
        function getItemDescription(item) {
            if (!item) {
                return '无物品信息';
            }
            
            let desc = [];
            
            if (item.attack && !item.type) {
                // 处理攻击力显示
                let attackDisplay = '未知';
                if (Array.isArray(item.attack)) {
                    attackDisplay = item.attack[0] + '-' + item.attack[1];
                } else if (typeof item.attack === 'string' && item.attack.includes(',')) {
                    const attackParts = item.attack.split(',').map(v => parseFloat(v.trim()));
                    attackDisplay = attackParts[0] + '-' + attackParts[1];
                } else {
                    const val = parseFloat(item.attack) || 0;
                    attackDisplay = val + '-' + val;
                }
                desc.push(`攻击: ${attackDisplay}`);
                if (item.defense) desc.push(`防御: ${item.defense}`);
                if (item.hp) desc.push(`生命: +${item.hp}`);
                if (item.mp) desc.push(`魔法: +${item.mp}`);
                if (item.critRate) desc.push(`暴击率: +${item.critRate}%`);
                if (item.critDamage) desc.push(`暴击伤害: +${item.critDamage}%`);
                if (item.magicPower) desc.push(`法术强度: +${item.magicPower}`);
                if (item.vampiric) desc.push(`吸血: +${item.vampiric}%`);

                if (item.chaosStrike) desc.push(`混沌打击: +${item.chaosStrike}%`);
                if (item.voidPower) desc.push(`虚空之力: +${item.voidPower}%`);
            } else if (item.defense && !item.type) {
                desc.push(`防御: ${item.defense}`);
                if (item.hp) desc.push(`生命: +${item.hp}`);
                if (item.mp) desc.push(`魔法: +${item.mp}`);
                if (item.critRate) desc.push(`暴击率: +${item.critRate}%`);
                if (item.critDamage) desc.push(`暴击伤害: +${item.critDamage}%`);
                if (item.magicPower) desc.push(`法术强度: +${item.magicPower}`);
                if (item.vampiric) desc.push(`吸血: +${item.vampiric}%`);
                if (item.damageReduction) desc.push(`伤害减免: +${item.damageReduction}%`);
                if (item.spellVamp) desc.push(`法术吸血: +${item.spellVamp}%`);

                if (item.chaosShield) desc.push(`混沌护盾: +${item.chaosShield}%`);
                if (item.voidShield) desc.push(`虚空护盾: +${item.voidShield}%`);
            } else if (item.type === 'ring' || item.type === 'necklace') {
                if (item.attack) {
                    // 处理攻击力显示
                    let attackDisplay = '未知';
                    if (Array.isArray(item.attack)) {
                        attackDisplay = item.attack[0] + '-' + item.attack[1];
                    } else if (typeof item.attack === 'string' && item.attack.includes(',')) {
                        const attackParts = item.attack.split(',').map(v => parseFloat(v.trim()));
                        attackDisplay = attackParts[0] + '-' + attackParts[1];
                    } else {
                        const val = parseFloat(item.attack) || 0;
                        attackDisplay = val + '-' + val;
                    }
                    desc.push(`攻击: ${attackDisplay}`);
                }
                if (item.defense) desc.push(`防御: ${item.defense}`);
                if (item.hp) desc.push(`生命: +${item.hp}`);
                if (item.mp) desc.push(`魔法: +${item.mp}`);
                if (item.critRate) desc.push(`暴击率: +${item.critRate}%`);
                if (item.critDamage) desc.push(`暴击伤害: +${item.critDamage}%`);
                if (item.magicPower) desc.push(`法术强度: +${item.magicPower}`);
                if (item.vampiric) desc.push(`吸血: +${item.vampiric}%`);
                if (item.spellCrit) desc.push(`法术暴击: +${item.spellCrit}%`);
                if (item.chaosBonus) desc.push(`混沌加成: +${item.chaosBonus}%`);
                if (item.voidMastery) desc.push(`虚空掌控: +${item.voidMastery}%`);
                if (item.spellVamp) desc.push(`法术吸血: +${item.spellVamp}%`);
                if (item.damageReduction) desc.push(`伤害减免: +${item.damageReduction}%`);
                if (item.voidShield) desc.push(`虚空护盾: +${item.voidShield}%`);
            } else if (item.type === 'special') {
                if (item.percentDamage) desc.push(`伤害: +${item.percentDamage}%`);
                if (item.percentHp) desc.push(`生命: +${item.percentHp}%`);
                if (item.percentAttack) desc.push(`攻击: +${item.percentAttack}%`);
                if (item.divineMultiplier) desc.push(`神力倍攻: x${item.divineMultiplier}`);
            } else if (item.type === 'hp') {
                return `恢复生命: ${item.heal}`;
            } else if (item.type === 'mp') {
                return `恢复魔法: ${item.heal}`;
            } else if (item.description) {
                return item.description;
            }
            
            let result = desc.join(', ');
            
            // 添加套装信息
            if (item.setName) {
                result += `\n<span class="set-bonus-text">[${item.setName}]</span>`;
            }
            
            return result || '';
        }

        // 使用物品
        function useItem(index) {
            const item = gameState.player.inventory[index];
            console.log('useItem被调用，索引:', index, '物品:', item);
            if (!item) {
                console.log('物品不存在，索引:', index);
                return;
            }
            
            // 检查是否为装备类型
            const isEquipmentType = item.type === 'ring' || item.type === 'necklace' || item.type === 'helmet' || 
                                  item.type === 'boots' || item.type === 'special' || item.type === 'weapon' || 
                                  item.type === 'armor' || (item.attack && !item.type) || (item.defense && !item.type);
            
            // 如果是装备，检查等级和职业要求
            if (isEquipmentType) {
                const requirements = item.requirements || {};
                const requiredLevel = requirements.level || 1;
                const requiredClass = requirements.class || 'all';
                const playerLevel = gameState.player.level || 1;
                const playerClass = gameState.player.class || '';
                
                // 检查等级要求
                if (playerLevel < requiredLevel) {
                    const message = `等级不足！需要等级${requiredLevel}，当前等级${playerLevel}`;
                    addLog(message);
                    showFloatingText(message, 'error');
                    return;
                }
                
                // 检查职业要求
                if (requiredClass !== 'all' && requiredClass !== playerClass) {
                    const classNames = { warrior: '战士', mage: '法师', taoist: '道士' };
                    const requiredClassName = classNames[requiredClass] || requiredClass;
                    const playerClassName = classNames[playerClass] || playerClass || '未选择';
                    const message = `职业不符！需要${requiredClassName}，当前职业${playerClassName}`;
                    addLog(message);
                    showFloatingText(message, 'error');
                    return;
                }
            }
            
            let isEquipment = false;
            
            // 优先检查type属性，避免戒指项链被误判为武器
            if (item.type === 'ring') {
                // 戒指
                if (gameState.player.equipment.ring) {
                    gameState.player.inventory.push(gameState.player.equipment.ring);
                }
                gameState.player.equipment.ring = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'necklace') {
                // 项链
                if (gameState.player.equipment.necklace) {
                    gameState.player.inventory.push(gameState.player.equipment.necklace);
                }
                gameState.player.equipment.necklace = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'helmet') {
                // 头盔
                if (gameState.player.equipment.helmet) {
                    gameState.player.inventory.push(gameState.player.equipment.helmet);
                }
                gameState.player.equipment.helmet = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'boots') {
                // 鞋子
                if (gameState.player.equipment.boots) {
                    gameState.player.inventory.push(gameState.player.equipment.boots);
                }
                gameState.player.equipment.boots = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'special') {
                // 特殊装备（护符）
                console.log('尝试装备特殊装备:', item.name, '类型:', item.type);
                let equipped = false;
                for (let i = 1; i <= 4; i++) {
                    console.log(`检查槽位special${i}:`, gameState.player.equipment[`special${i}`]);
                    if (!gameState.player.equipment[`special${i}`]) {
                        gameState.player.equipment[`special${i}`] = item;
                        addLog(`装备了${item.name}到护符槽${i}`);
                        console.log(`成功装备${item.name}到槽位special${i}`);
                        gameState.player.inventory.splice(index, 1);
                        equipped = true;
                        isEquipment = true;
                        break;
                    }
                }
                if (!equipped) {
                    console.log('所有特殊装备槽位都已满');
                    addLog('特殊装备槽位已满，无法装备');
                    return;
                }
            } else if (item.type === 'weapon' || (item.attack && !item.type)) {
                // 武器（有weapon type或没有type属性但有attack属性）
                if (gameState.player.equipment.weapon) {
                    gameState.player.inventory.push(gameState.player.equipment.weapon);
                }
                gameState.player.equipment.weapon = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
                // 为武器设置临时type属性用于任务进度更新
                item.equipType = 'weapon';
            } else if (item.type === 'armor' || (item.defense && !item.type)) {
                // 防具（有armor type或没有type属性但有defense属性）
                if (gameState.player.equipment.armor) {
                    gameState.player.inventory.push(gameState.player.equipment.armor);
                }
                gameState.player.equipment.armor = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
                // 为防具设置临时type属性用于任务进度更新
                item.equipType = 'armor';
            } else if (item.type === 'hp') {
                // 血瓶
                const specialBonus = calculateSpecialEquipmentBonus();
                const setBonus = calculateSetBonus();
                const totalMaxHp = Math.floor(gameState.player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
                const healAmount = Math.min(item.heal, totalMaxHp - gameState.player.hp);
                gameState.player.hp += healAmount;
                addLog(`使用了${item.name}，恢复了${healAmount}点生命值`);
                gameState.player.inventory.splice(index, 1);
            } else if (item.type === 'mp') {
                // 蓝瓶
                const specialBonus = calculateSpecialEquipmentBonus();
                const setBonus = calculateSetBonus();
                const totalMaxMp = Math.floor(gameState.player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
                const healAmount = Math.min(item.heal, totalMaxMp - gameState.player.mp);
                gameState.player.mp += healAmount;
                addLog(`使用了${item.name}，恢复了${healAmount}点魔法值`);
                gameState.player.inventory.splice(index, 1);
            }
            
            // 如果装备了物品，更新任务进度
            if (isEquipment) {
                // 使用equipType或type属性来更新任务进度
                const equipmentType = item.equipType || item.type;
                if (equipmentType) {
                    updateQuestProgress('equip', equipmentType);
                }
                updateQuestProgress('equip', 'any');
                // 检查称号条件
                checkTitleConditions();
                
                // 强制更新装备显示
                updateEquipmentDisplay();
                
                // 立即重新计算套装效果并更新显示
                const setBonus = calculateSetBonus();
                updateSetBonusDisplay(setBonus);
                
                // 更新套装光环效果
                updateSetAuraEffect();
            }
            
            // 强制更新UI和玩家信息
            updateUI();
            updatePlayerInfo();
            
            // 显示浮动文本提示装备变化
            if (isEquipment) {
                showFloatingText(`装备 ${item.name}`, '#10b981');
            }
        }

        // 地图ID映射
        const mapIdMapping = {
            'village': 1, 'forest': 2, 'cave': 3, 'desert': 4, 'swamp': 5,
            'mountain': 6, 'dungeon': 7, 'tomb': 8, 'abyss': 9, 'volcano': 10,
            'magicforest': 11, 'shadowrealm': 12, 'dragonrealm': 13, 'godsdomain': 14,
            'chaosrealm': 15, 'voidrealm': 16, 'infiniterealm': 17, 'heaven': 18
        };
        
        const mapNameMapping = {
            1: '新手村', 2: '森林', 3: '洞穴', 4: '沙漠', 5: '沼泽',
            6: '雪山', 7: '地牢', 8: '古墓', 9: '深渊', 10: '火山',
            11: '魔法森林', 12: '影之领域', 13: '龙之领域', 14: '神之领域',
            15: '混沌领域', 16: '虚空领域', 17: '无限领域', 18: '天界'
        };

        // 前往位置
        async function goToLocation(location) {
            // 转换为数字ID
            const mapId = typeof location === 'string' ? mapIdMapping[location] || 1 : location;
            gameState.currentLocation = mapId;
            
            // 隐藏所有区域
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            // saveArea已移除
            // monsterArea已删除
            
            const locationNames = {
                village: '新手村',
                forest: '森林',
                cave: '洞穴',
                desert: '沙漠',
                swamp: '沼泽',
                mountain: '雪山',
                dungeon: '地牢',
                volcano: '火山',
                abyss: '深渊',
                heaven: '天界',
                ocean: '海洋',
                glacier: '冰川',
                tomb: '古墓',
                magicforest: '魔法森林',
                starfield: '星空',
                laboratory: '实验室',
                shadowrealm: '影之领域',
                crystalcave: '水晶洞穴',
                dragonrealm: '龙之领域',
                godsdomain: '神之领域',
                chaosrealm: '混沌领域',
                voidrealm: '虚空领域',
                infiniterealm: '无限领域',
                shop: '商店'
            };
            
            const displayName = mapNameMapping[mapId] || '未知区域';
            document.getElementById('currentLocationTop').textContent = displayName;
            
            if (location === 'shop') {
                showShop();
            } else {
                generateMonsters(location);
                // 只有在非地图战斗状态下才重新生成地图怪物
                if (!gameState.inBattle || !gameState.currentMapMonsterId) {
                    console.log('Generating map monsters due to location change');
                    await generateMapMonsters();
                }
                updateMapDisplay();
            }
            
            addLog(`你来到了${displayName}`);
        }

        // 生成怪物（已废弃，怪物区域已删除）
        function generateMonsters(location) {
            // 怪物区域已删除，此函数不再使用
            // 怪物现在通过地图系统显示
        }

        // 开始传统战斗（保留原有功能）
        function startBattle(monsterTemplate) {
            gameState.inBattle = true;
            gameState.currentMonster = {
                ...monsterTemplate,
                maxHp: monsterTemplate.hp
            };
            
            // 重置自动战斗状态
            gameState.autoBattle = false;
            if (gameState.battleInterval) {
                clearTimeout(gameState.battleInterval);
                gameState.battleInterval = null;
            }
            
            // 显示传统战斗界面
            // monsterArea已删除
            document.getElementById('battleArea').classList.remove('hidden');
            
            updateBattleUI();
            addLog(`遭遇了${monsterTemplate.name}！战斗开始！`);
        }
        
        // 开始地图战斗
        function startMapBattle(monsterTemplate) {
            gameState.inBattle = true;
            
            // 在地图怪物数组中找到对应的怪物并设置为当前战斗怪物
            const mapMonster = mapMonsters.find(m => m.id === monsterTemplate.id);
            if (mapMonster) {
                gameState.currentMonster = mapMonster;
                gameState.currentMapMonsterId = mapMonster.id;
            } else {
                gameState.currentMonster = {
                    ...monsterTemplate,
                    maxHp: monsterTemplate.hp
                };
            }
            
            // 重置自动战斗状态
            gameState.autoBattle = false;
            if (gameState.battleInterval) {
                clearTimeout(gameState.battleInterval);
                gameState.battleInterval = null;
            }
            
            // 显示地图战斗信息栏，隐藏其他区域
            // 不再显示顶部战斗信息栏，血条直接显示在角色头顶
            // document.getElementById('mapBattleInfo').classList.remove('hidden');
            // monsterArea已删除
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            // saveArea已移除
            document.getElementById('battleArea').classList.add('hidden');
            
            updateMapBattleUI();
            addLog(`遭遇了${monsterTemplate.name}！地图战斗开始！`);
        }

        // 更新地图战斗UI
        function updateMapBattleUI() {
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            if (!monster) return;
            
            // 计算玩家的实际最大血量和魔法值（包含装备和套装加成）
            const specialBonus = calculateSpecialEquipmentBonus();
            const setBonus = calculateSetBonus();
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            // 更新地图战斗信息面板中的玩家血量和魔法值
            const mapPlayerHPElement = document.getElementById('mapPlayerHP');
            const mapPlayerMPElement = document.getElementById('mapPlayerMP');
            const mapPlayerHPBarElement = document.getElementById('mapPlayerHPBar');
            const mapPlayerMPBarElement = document.getElementById('mapPlayerMPBar');
            
            if (mapPlayerHPElement) {
                mapPlayerHPElement.textContent = `${Math.floor(player.hp)}/${Math.floor(totalMaxHp)}`;
            }
            if (mapPlayerMPElement) {
                mapPlayerMPElement.textContent = `${Math.floor(player.mp)}/${Math.floor(totalMaxMp)}`;
            }
            if (mapPlayerHPBarElement) {
                const hpPercent = Math.min(100, Math.max(0, (player.hp / totalMaxHp) * 100));
                mapPlayerHPBarElement.style.width = hpPercent + '%';
            }
            if (mapPlayerMPBarElement) {
                const mpPercent = Math.min(100, Math.max(0, (player.mp / totalMaxMp) * 100));
                mapPlayerMPBarElement.style.width = mpPercent + '%';
            }
            
            // 更新地图战斗信息面板中的怪物血量
            const mapMonsterHPElement = document.getElementById('mapMonsterHP');
            const mapMonsterHPBarElement = document.getElementById('mapMonsterHPBar');
            const mapMonsterNameElement = document.getElementById('mapMonsterName');
            
            if (mapMonsterHPElement) {
                mapMonsterHPElement.textContent = `${Math.floor(monster.hp)}/${Math.floor(monster.maxHp)}`;
            }
            if (mapMonsterHPBarElement) {
                const monsterHpPercent = Math.min(100, Math.max(0, (monster.hp / monster.maxHp) * 100));
                mapMonsterHPBarElement.style.width = monsterHpPercent + '%';
            }
            if (mapMonsterNameElement) {
                mapMonsterNameElement.textContent = monster.name;
            }
            
            // 更新地图上怪物的血条显示
            if (gameState.currentMapMonsterId) {
                const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                if (monsterElement) {
                    const hpCircle = monsterElement.querySelector('.monster-hp-circle');
                    const hpText = monsterElement.querySelector('.monster-hp-text');
                    
                    const monsterHpPercent = Math.min(100, Math.max(0, (monster.hp / monster.maxHp) * 100));
                    
                    if (hpCircle) {
                        const circumference = 2 * Math.PI * 20;
                        const strokeDashoffset = (1 - monsterHpPercent / 100) * circumference;
                        hpCircle.style.strokeDashoffset = strokeDashoffset;
                        
                        // 怪物血条默认为红色，根据血量百分比调整亮度
                         if (monsterHpPercent > 60) {
                             hpCircle.style.stroke = '#ef4444'; // 红色
                         } else if (monsterHpPercent > 30) {
                             hpCircle.style.stroke = '#dc2626'; // 深红色
                         } else {
                             hpCircle.style.stroke = '#991b1b'; // 暗红色
                         }
                    }
                    
                    if (hpText) {
                        hpText.textContent = `${Math.floor(monster.hp)}/${Math.floor(monster.maxHp)}`;
                    }
                    
                    // 怪物死亡状态由攻击函数处理，这里不重复检查
                    // 如果怪物已死亡，跳过UI更新
                    if (monster.hp <= 0) {
                        return; // 怪物死亡后直接返回，避免继续更新UI
                    }
                }
            }
            
            // 更新地图上玩家的血条显示
            const playerElement = document.getElementById('playerOnMap');
            if (playerElement) {
                // 检查是否已有血条，如果没有则创建
                let playerHpContainer = playerElement.querySelector('.player-hp-container');
                if (!playerHpContainer) {
                    playerHpContainer = document.createElement('div');
                    playerHpContainer.className = 'player-hp-container absolute pointer-events-none';
                    playerHpContainer.style.cssText = 'top: 50%; left: 50%; width: 60px; height: 60px; transform: translate(-50%, -50%);';
                    const hpPercent = Math.min(100, (player.hp / totalMaxHp) * 100);
                    const circumference = 2 * Math.PI * 28; // 半径28的圆周长
                    const strokeDasharray = `${circumference}`;
                    const strokeDashoffset = (1 - hpPercent / 100) * circumference;
                    
                    playerHpContainer.innerHTML = `
                        <svg class="absolute inset-0 w-full h-full" style="transform: rotate(-90deg);">
                            <circle cx="50%" cy="50%" r="28" fill="none" stroke="rgba(75, 85, 99, 0.5)" stroke-width="3"/>
                            <circle class="player-hp-circle" cx="50%" cy="50%" r="28" fill="none" stroke="#10b981" stroke-width="3" 
                                    stroke-linecap="round" stroke-dasharray="${strokeDasharray}" stroke-dashoffset="${strokeDashoffset}" 
                                    style="transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;"/>
                        </svg>
                        <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs text-white font-bold text-center whitespace-nowrap player-hp-text">
                            ${Math.floor(player.hp)}/${Math.floor(totalMaxHp)}
                        </div>
                    `;
                    playerElement.appendChild(playerHpContainer);
                }
                
                // 更新玩家血条
                const playerHpPercent = Math.min(100, Math.max(0, (player.hp / totalMaxHp) * 100));
                const playerHpCircle = playerHpContainer.querySelector('.player-hp-circle');
                const playerHpText = playerHpContainer.querySelector('.player-hp-text');
                
                if (playerHpCircle) {
                    const circumference = 2 * Math.PI * 28;
                    const strokeDashoffset = (1 - playerHpPercent / 100) * circumference;
                    playerHpCircle.style.strokeDashoffset = strokeDashoffset;
                    
                    // 根据血量百分比改变颜色
                    if (playerHpPercent > 60) {
                        playerHpCircle.style.stroke = '#10b981'; // 绿色
                    } else if (playerHpPercent > 30) {
                        playerHpCircle.style.stroke = '#f59e0b'; // 黄色
                    } else {
                        playerHpCircle.style.stroke = '#ef4444'; // 红色
                    }
                }
                
                if (playerHpText) {
                    playerHpText.textContent = `${Math.floor(player.hp)}/${Math.floor(totalMaxHp)}`;
                }
            }
        }
        
        // 逃跑功能
        function escapeBattle() {
            if (!gameState.inBattle) return;
            
            // 如果是地图战斗，移除怪物的战斗状态
            if (gameState.currentMapMonsterId) {
                const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                if (monsterElement) {
                    monsterElement.classList.remove('in-battle');
                }
                
                // 移除玩家血条
                const playerElement = document.getElementById('playerOnMap');
                if (playerElement) {
                    const playerHpContainer = playerElement.querySelector('.player-hp-container');
                    if (playerHpContainer) {
                        playerHpContainer.remove();
                    }
                }
            }
            
            // 停止自动战斗
            if (gameState.autoBattle) {
                gameState.autoBattle = false;
                const autoBattleBtn = document.getElementById('autoBattleBtn');
                if (autoBattleBtn) {
                    autoBattleBtn.textContent = '自动战斗';
                    autoBattleBtn.style.background = 'rgba(34, 197, 94, 0.2)';
                }
            }
            
            // 记录逃跑日志
            addLog('你逃跑了！');
            
            // 结束战斗
            endBattle();
        }
        
        // 更新战斗UI
        function updateBattleUI() {
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            // 计算玩家的实际最大血量和魔法值（包含装备和套装加成）
            const specialBonus = calculateSpecialEquipmentBonus();
            const setBonus = calculateSetBonus();
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            document.getElementById('battlePlayerHp').textContent = `${Math.floor(player.hp)}/${Math.floor(totalMaxHp)}`;
            document.getElementById('battlePlayerMp').textContent = `${Math.floor(player.mp)}/${Math.floor(totalMaxMp)}`;
            document.getElementById('battleMonsterName').textContent = monster.name;
            document.getElementById('battleMonsterHp').textContent = `${Math.floor(monster.hp)}/${Math.floor(monster.maxHp)}`;
            
            // 更新玩家小人图标
            const playerFighter = document.getElementById('playerFighter');
            if (player.class === 'warrior') {
                playerFighter.textContent = '⚔️';
            } else if (player.class === 'mage') {
                playerFighter.textContent = '🧙‍♂️';
            } else if (player.class === 'taoist') {
                playerFighter.textContent = '🧙‍♀️';
            }
            
            // 更新怪物小人图标
            const monsterFighter = document.getElementById('monsterFighter');
            switch(monster.name) {
                case '小鸡':
                    monsterFighter.textContent = '🐔';
                    break;
                case '小鹿':
                    monsterFighter.textContent = '🦌';
                    break;
                case '史莱姆':
                    monsterFighter.textContent = '🟢';
                    break;
                case '哥布林':
                    monsterFighter.textContent = '👺';
                    break;
                case '森林狼':
                    monsterFighter.textContent = '🐺';
                    break;
                case '野猪':
                    monsterFighter.textContent = '🐗';
                    break;
                case '骷髅':
                    monsterFighter.textContent = '💀';
                    break;
                case '僵尸':
                    monsterFighter.textContent = '🧟';
                    break;
                case '沙漠蝎':
                    monsterFighter.textContent = '🦂';
                    break;
                case '沙虫':
                    monsterFighter.textContent = '🪱';
                    break;
                case '恶魔':
                    monsterFighter.textContent = '👹';
                    break;
                case '龙':
                    monsterFighter.textContent = '🐉';
                    break;
                case '雪狼':
                    monsterFighter.textContent = '🐺';
                    break;
                case '冰霜巨人':
                    monsterFighter.textContent = '🧊';
                    break;
                case '雪怪':
                    monsterFighter.textContent = '❄️';
                    break;
                case '毒蛇':
                    monsterFighter.textContent = '🐍';
                    break;
                case '沼泽巨鳄':
                    monsterFighter.textContent = '🐊';
                    break;
                case '腐尸怪':
                    monsterFighter.textContent = '🧟‍♂️';
                    break;
                case '火元素':
                    monsterFighter.textContent = '🔥';
                    break;
                case '熔岩兽':
                    monsterFighter.textContent = '🌋';
                    break;
                case '炎魔':
                    monsterFighter.textContent = '👹';
                    break;
                case '暗影刺客':
                    monsterFighter.textContent = '🥷';
                    break;
                case '深渊领主':
                    monsterFighter.textContent = '👺';
                    break;
                case '虚空恶魔':
                    monsterFighter.textContent = '👻';
                    break;
                case '堕落天使':
                    monsterFighter.textContent = '😈';
                    break;
                case '光明守护者':
                    monsterFighter.textContent = '👼';
                    break;
                case '天界战神':
                    monsterFighter.textContent = '⚡';
                    break;
                // 新增怪物图标
                case '海盗':
                    monsterFighter.textContent = '🏴‍☠️';
                    break;
                case '海妖':
                    monsterFighter.textContent = '🧜‍♀️';
                    break;
                case '深海巨兽':
                    monsterFighter.textContent = '🐙';
                    break;
                case '冰晶蜘蛛':
                    monsterFighter.textContent = '🕷️';
                    break;
                case '极地熊王':
                    monsterFighter.textContent = '🐻‍❄️';
                    break;
                case '冰龙':
                    monsterFighter.textContent = '🐲';
                    break;
                case '木乃伊':
                    monsterFighter.textContent = '🧟‍♂️';
                    break;
                case '法老守卫':
                    monsterFighter.textContent = '🛡️';
                    break;
                case '古代法老':
                    monsterFighter.textContent = '👑';
                    break;
                case '精灵射手':
                    monsterFighter.textContent = '🧝‍♀️';
                    break;
                case '树人长老':
                    monsterFighter.textContent = '🌳';
                    break;
                case '森林之王':
                    monsterFighter.textContent = '🦌';
                    break;
                case '星灵':
                    monsterFighter.textContent = '✨';
                    break;
                case '虚空行者':
                    monsterFighter.textContent = '🌌';
                    break;
                case '宇宙主宰':
                    monsterFighter.textContent = '🌟';
                    break;
                case '变异体':
                    monsterFighter.textContent = '🧬';
                    break;
                case '机械守卫':
                    monsterFighter.textContent = '🤖';
                    break;
                case '终极兵器':
                    monsterFighter.textContent = '⚙️';
                    break;
                case '影子武士':
                    monsterFighter.textContent = '🥷';
                    break;
                case '暗影领主':
                    monsterFighter.textContent = '👤';
                    break;
                case '黑暗之神':
                    monsterFighter.textContent = '🌑';
                    break;
                case '水晶蝙蝠':
                    monsterFighter.textContent = '🦇';
                    break;
                case '水晶巨人':
                    monsterFighter.textContent = '💎';
                    break;
                case '水晶龙王':
                    monsterFighter.textContent = '💠';
                    break;
                // Boss和精英怪物图标
                case '精英野兔':
                    monsterFighter.textContent = '🐰';
                    break;
                case '村长的宠物熊':
                    monsterFighter.textContent = '🐻';
                    break;
                case '精英狼王':
                    monsterFighter.textContent = '🐺';
                    break;
                case '森林守护者':
                    monsterFighter.textContent = '🌲';
                    break;
                case '精英骷髅战士':
                    monsterFighter.textContent = '⚔️';
                    break;
                case '亡灵领主':
                    monsterFighter.textContent = '👑';
                    break;
                case '精英沙漠毒蝎':
                    monsterFighter.textContent = '🦂';
                    break;
                case '沙漠霸主':
                    monsterFighter.textContent = '🏜️';
                    break;
                case '精英恶魔督军':
                    monsterFighter.textContent = '👺';
                    break;
                case '地牢魔王':
                    monsterFighter.textContent = '👹';
                    break;
                case '精英冰霜泰坦':
                    monsterFighter.textContent = '🧊';
                    break;
                case '雪山之王':
                    monsterFighter.textContent = '⛰️';
                    break;
                case '精英毒沼蟒':
                    monsterFighter.textContent = '🐍';
                    break;
                case '沼泽霸主':
                    monsterFighter.textContent = '🐊';
                    break;
                case '精英熔岩巨人':
                    monsterFighter.textContent = '🌋';
                    break;
                case '火山之神':
                    monsterFighter.textContent = '🔥';
                    break;
                case '精英深渊魔将':
                    monsterFighter.textContent = '👺';
                    break;
                case '深渊魔帝':
                    monsterFighter.textContent = '😈';
                    break;
                case '精英大天使':
                    monsterFighter.textContent = '👼';
                    break;
                case '天界至尊':
                    monsterFighter.textContent = '✨';
                    break;
                case '精英海盗船长':
                    monsterFighter.textContent = '🏴‍☠️';
                    break;
                case '海神波塞冬':
                    monsterFighter.textContent = '🔱';
                    break;
                case '精英冰霜女王':
                    monsterFighter.textContent = '❄️';
                    break;
                case '永恒冰神':
                    monsterFighter.textContent = '🧊';
                    break;
                case '精英法老祭司':
                    monsterFighter.textContent = '🏺';
                    break;
                case '不朽法老王':
                    monsterFighter.textContent = '👑';
                    break;
                case '精英自然守护者':
                    monsterFighter.textContent = '🌿';
                    break;
                case '世界树之灵':
                    monsterFighter.textContent = '🌳';
                    break;
                case '精英星际战士':
                    monsterFighter.textContent = '🚀';
                    break;
                case '宇宙创世神':
                    monsterFighter.textContent = '🌌';
                    break;
                case '精英机械领主':
                    monsterFighter.textContent = '🤖';
                    break;
                case '人工智能主脑':
                    monsterFighter.textContent = '🧠';
                    break;
                case '精英暗影执行者':
                    monsterFighter.textContent = '🥷';
                    break;
                case '虚无之主':
                    monsterFighter.textContent = '🌑';
                    break;
                case '精英水晶守护者':
                    monsterFighter.textContent = '💎';
                    break;
                case '水晶位面之王':
                    monsterFighter.textContent = '💠';
                    break;
                default:
                    monsterFighter.textContent = '👹';
            }
        }

        // 攻击
        // 自动战斗控制
        function toggleAutoBattle() {
            if (gameState.autoBattle) {
                stopAutoBattle();
            } else {
                startAutoBattle();
            }
        }

        function startAutoBattle() {
            if (!gameState.inBattle) return;
            
            gameState.autoBattle = true;
            document.getElementById('autoBattleBtn').textContent = '停止自动战斗';
            document.getElementById('autoBattleBtn').className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded mr-2';
            
            addLog('开始自动战斗...');
            autoBattleLoop();
        }

        function stopAutoBattle() {
            gameState.autoBattle = false;
            if (gameState.battleInterval) {
                clearTimeout(gameState.battleInterval);
                gameState.battleInterval = null;
            }
            
            document.getElementById('autoBattleBtn').textContent = '开始自动战斗';
            document.getElementById('autoBattleBtn').className = 'btn-primary px-6 py-2 rounded mr-2';
            
            addLog('停止自动战斗');
        }

        function autoBattleLoop() {
            console.log('autoBattleLoop called, inBattle:', gameState.inBattle, 'autoBattle:', gameState.autoBattle, 'monster hp:', gameState.currentMonster?.hp);
            
            if (!gameState.autoBattle || !gameState.inBattle) {
                console.log('autoBattleLoop exiting early due to battle state');
                return;
            }
            
            // 添加战斗场景震动效果
            const battleArea = document.getElementById('battleArea');
            if (battleArea) {
                battleArea.style.animation = 'battleShake 0.3s ease-in-out';
                setTimeout(() => {
                    battleArea.style.animation = '';
                }, 300);
            }
            
            // 执行一轮攻击
            playerAutoAttack();
            
            // 如果战斗还在继续，设置下一轮
            if (gameState.inBattle && gameState.autoBattle && gameState.currentMonster && gameState.currentMonster.hp > 0) {
                console.log('Setting monster attack timeout');
                gameState.battleInterval = setTimeout(() => {
                    console.log('Monster attack timeout triggered, checking state again...');
                    // 再次检查战斗状态和怪物状态
                    if (gameState.inBattle && gameState.autoBattle && gameState.currentMonster && gameState.currentMonster.hp > 0) {
                        console.log('Monster attacking...');
                        // 怪物攻击时也添加震动效果
                        if (battleArea) {
                            battleArea.style.animation = 'battleShake 0.2s ease-in-out';
                            setTimeout(() => {
                                battleArea.style.animation = '';
                            }, 200);
                        }
                        
                        monsterAttack();
                        // 怪物攻击后再次检查状态
                        if (gameState.inBattle && gameState.autoBattle && gameState.currentMonster && gameState.currentMonster.hp > 0) {
                            console.log('Setting next autoBattleLoop timeout');
                            gameState.battleInterval = setTimeout(autoBattleLoop, 1500);
                        } else {
                            console.log('Not setting next autoBattleLoop - battle ended or monster dead');
                        }
                    } else {
                        console.log('Monster attack timeout cancelled due to state change');
                    }
                }, 1000);
            } else {
                console.log('Not setting monster attack timeout - battle ended or monster dead');
            }
        }

        // 战斗动画函数
        function playPlayerAttackAnimation() {
            // 在地图战斗模式下，使用撞击动画效果
            if (gameState.inBattle && gameState.currentMapMonsterId) {
                // 地图战斗模式 - 玩家撞击动画
                const playerElement = document.getElementById('playerOnMap');
                const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                
                if (playerElement && monsterElement) {
                    // 添加撞击动画
                    playerElement.style.animation = 'mapAttack 0.6s ease-out';
                    
                    // 地图震动效果
                    const gameMap = document.getElementById('gameMap');
                    gameMap.classList.add('battleShake');
                    
                    setTimeout(() => {
                        playerElement.style.animation = '';
                        gameMap.classList.remove('battleShake');
                    }, 600);
                }
                return;
            }
            
            // 传统战斗界面模式
            const playerFighter = document.getElementById('playerFighter');
            const attackEffect = document.getElementById('attackEffect');
            
            if (!playerFighter || !attackEffect) return;
            
            // 移除旧动画类并添加攻击动画类
            playerFighter.className = 'character-sprite character-attack';
            
            // 显示攻击特效
            setTimeout(() => {
                attackEffect.style.opacity = '1';
                attackEffect.textContent = '⚔️';
            }, 150);
            
            // 恢复到待机状态
            setTimeout(() => {
                playerFighter.className = 'character-sprite character-idle';
                attackEffect.style.opacity = '0';
            }, 600);
        }
        
        function playMonsterAttackAnimation() {
            console.log('=== playMonsterAttackAnimation called ===', {
                inBattle: gameState.inBattle,
                currentMapMonsterId: gameState.currentMapMonsterId,
                currentMonster: gameState.currentMonster?.name
            });
            
            // 在地图战斗模式下，使用撞击动画效果
            if (gameState.inBattle && gameState.currentMapMonsterId) {
                // 地图战斗模式 - 怪物撞击动画
                const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                const playerElement = document.getElementById('playerOnMap');
                
                console.log('=== Map battle elements check ===', {
                    monsterElement: !!monsterElement,
                    playerElement: !!playerElement,
                    monsterId: gameState.currentMapMonsterId,
                    monsterElementId: monsterElement?.id,
                    playerElementId: playerElement?.id
                });
                
                if (monsterElement && playerElement) {
                    console.log('=== Applying monster attack animation ===');
                    console.log('Monster element before animation:', {
                        id: monsterElement.id,
                        currentAnimation: monsterElement.style.animation,
                        currentTransform: monsterElement.style.transform
                    });
                    
                    // 怪物使用撞击玩家的攻击动画
                    monsterElement.style.animation = 'mapMonsterAttack 1.0s ease-in-out';
                    
                    console.log('Monster element after setting animation:', {
                        animation: monsterElement.style.animation,
                        computedStyle: window.getComputedStyle(monsterElement).animation
                    });
                    
                    // 添加更明显的视觉效果
                    monsterElement.style.filter = 'brightness(1.5) saturate(1.5)';
                    monsterElement.style.border = '2px solid red';
                    monsterElement.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    
                    // 地图震动效果
                    const gameMap = document.getElementById('gameMap');
                    if (gameMap) {
                        gameMap.classList.add('battleShake');
                        console.log('=== Added battleShake to gameMap ===');
                    }
                    
                    setTimeout(() => {
                        monsterElement.style.animation = '';
                        monsterElement.style.filter = '';
                        monsterElement.style.border = '';
                        monsterElement.style.backgroundColor = '';
                        if (gameMap) {
                            gameMap.classList.remove('battleShake');
                        }
                        console.log('=== Monster attack animation completed ===');
                    }, 1000);
                } else {
                    console.error('=== Monster or player element not found for animation ===', {
                        monsterElement: !!monsterElement,
                        playerElement: !!playerElement,
                        allElementsWithMonsterId: document.querySelectorAll(`[id*="${gameState.currentMapMonsterId}"]`).length
                    });
                    // 备用视觉反馈
                    addLog('💥 怪物发起攻击！');
                }
                return;
            }
            
            // 传统战斗界面模式
            const monsterFighter = document.getElementById('monsterFighter');
            const attackEffect = document.getElementById('attackEffect');
            
            if (!monsterFighter || !attackEffect) return;
            
            // 移除旧动画类并添加攻击动画类
            monsterFighter.className = 'character-sprite character-attack';
            
            // 显示攻击特效
            setTimeout(() => {
                attackEffect.style.opacity = '1';
                attackEffect.textContent = '💥';
            }, 150);
            
            // 恢复到待机状态
            setTimeout(() => {
                monsterFighter.className = 'character-sprite character-idle';
                attackEffect.style.opacity = '0';
            }, 600);
        }
        
        function playSkillAnimation(skillType) {
            // 在地图战斗模式下，使用地图震动效果和特效显示
            if (gameState.inBattle && gameState.currentMapMonsterId) {
                // 地图战斗模式 - 添加震动效果和技能特效
                const gameMap = document.getElementById('gameMap');
                const mapBattleEffects = document.getElementById('mapBattleEffects');
                
                gameMap.classList.add('battleShake');
                
                // 在地图中显示技能特效
                if (mapBattleEffects) {
                    const skillEffect = document.createElement('div');
                    skillEffect.style.position = 'absolute';
                    skillEffect.style.fontSize = '48px';
                    skillEffect.style.left = '250px';
                    skillEffect.style.top = '150px';
                    skillEffect.style.zIndex = '1001';
                    skillEffect.style.animation = 'pulse 1s ease-out';
                    
                    if (skillType === 'fireball') {
                        skillEffect.textContent = '🔥';
                    } else if (skillType === 'heal') {
                        skillEffect.textContent = '✨';
                    }
                    
                    mapBattleEffects.appendChild(skillEffect);
                    
                    setTimeout(() => {
                        if (skillEffect.parentNode) {
                            skillEffect.parentNode.removeChild(skillEffect);
                        }
                    }, 1000);
                }
                
                setTimeout(() => {
                    gameMap.classList.remove('battleShake');
                }, 1000);
                return;
            }
            
            // 传统战斗界面模式
            const playerFighter = document.getElementById('playerFighter');
            const attackEffect = document.getElementById('attackEffect');
            
            if (!playerFighter || !attackEffect) return;
            
            // 移除旧动画类并添加技能动画类
            playerFighter.className = 'character-sprite character-skill';
            
            // 显示技能特效
            setTimeout(() => {
                attackEffect.style.opacity = '1';
                if (skillType === 'fireball') {
                    attackEffect.textContent = '🔥';
                } else if (skillType === 'heal') {
                    attackEffect.textContent = '✨';
                }
            }, 150);
            
            // 恢复到待机状态
            setTimeout(() => {
                playerFighter.className = 'character-sprite character-idle';
                attackEffect.style.opacity = '0';
            }, 1000);
        }
        
        function playHurtAnimation(target) {
            console.log('=== playHurtAnimation called ===', {
                target: target,
                inBattle: gameState.inBattle,
                currentMapMonsterId: gameState.currentMapMonsterId,
                currentMonster: gameState.currentMonster?.name
            });
            
            // 在地图战斗模式下，使用体型变化动画
            if (gameState.inBattle) {
                // 地图战斗模式 - 被攻击者体型变化动画
                let targetElement;
                if (target === 'player') {
                    targetElement = document.getElementById('playerOnMap');
                } else if (target === 'monster' && gameState.currentMapMonsterId) {
                    targetElement = document.getElementById(gameState.currentMapMonsterId);
                }
                
                console.log('=== Hurt animation target element check ===', {
                    target: target,
                    elementExists: !!targetElement,
                    elementId: targetElement?.id,
                    currentMapMonsterId: gameState.currentMapMonsterId,
                    allElementsWithMonsterId: target === 'monster' ? document.querySelectorAll(`[id*="${gameState.currentMapMonsterId}"]`).length : 'N/A'
                });
                
                if (targetElement) {
                    console.log('=== Applying hurt animation to', target, '===');
                    // 怪物和玩家使用相同的受击动画
                    targetElement.style.animation = 'mapHurt 0.8s ease-out';
                    
                    // 添加更明显的受伤效果
                    targetElement.style.filter = 'brightness(1.8) hue-rotate(0deg) saturate(2)';
                    targetElement.style.border = '2px solid yellow';
                    
                    setTimeout(() => {
                        targetElement.style.animation = '';
                        targetElement.style.filter = '';
                        targetElement.style.border = '';
                        console.log('=== Hurt animation completed for', target, '===');
                    }, 800);
                } else {
                    console.error('=== Target element not found for hurt animation ===', {
                        target: target,
                        currentMapMonsterId: gameState.currentMapMonsterId,
                        playerElement: !!document.getElementById('playerOnMap'),
                        monsterElement: gameState.currentMapMonsterId ? !!document.getElementById(gameState.currentMapMonsterId) : 'No monster ID'
                    });
                    // 备用视觉反馈
                    if (target === 'player') {
                        addLog('💢 你受到了伤害！');
                    } else {
                        addLog('💥 怪物受到了伤害！');
                    }
                }
                
                // 地图震动效果
                const gameMap = document.getElementById('gameMap');
                if (gameMap) {
                    gameMap.classList.add('battleShake');
                    console.log('=== Added battleShake for hurt animation ===');
                    setTimeout(() => {
                        gameMap.classList.remove('battleShake');
                    }, 400);
                }
                return;
            }
            
            // 传统战斗界面模式
            const element = document.getElementById(target === 'player' ? 'playerFighter' : 'monsterFighter');
            
            if (!element) return;
            
            // 移除旧动画类并添加受伤动画类
            element.className = 'character-sprite character-hurt';
            
            // 恢复到待机状态
            setTimeout(() => {
                element.className = 'character-sprite character-idle';
            }, 400);
        }

        // 飘字效果函数
        function showDamageText(damage, isCrit, isHeal, target) {
            // 在地图战斗模式下使用地图战斗特效容器
            let container;
            if (gameState.inBattle && gameState.currentMapMonsterId) {
                container = document.getElementById('mapBattleEffects');
            } else {
                container = document.getElementById('damageTextContainer');
            }
            
            if (!container) {
                console.error('damage text container not found');
                return;
            }
            
            // 调试信息
            console.log(`显示飘字: ${damage}, 暴击: ${isCrit}, 治疗: ${isHeal}, 目标: ${target}`);
            
            const damageText = document.createElement('div');
            
            // 设置飘字内容
            damageText.textContent = Math.floor(damage);
            
            // 设置基础样式
            damageText.className = 'floating-text';
            damageText.style.position = 'absolute';
            damageText.style.fontWeight = 'bold';
            damageText.style.fontSize = '18px';
            damageText.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
            damageText.style.pointerEvents = 'none';
            damageText.style.zIndex = '1000';
            
            // 设置飘字样式
            if (isHeal) {
                damageText.style.color = '#10b981'; // 绿色治疗
                damageText.textContent = '+' + Math.floor(damage);
                damageText.style.animation = 'floatUp 2s ease-out forwards';
            } else if (isCrit) {
                damageText.style.color = '#ef4444'; // 红色暴击
                damageText.style.fontSize = '24px';
                damageText.style.animation = 'critFloat 2s ease-out forwards';
                damageText.textContent = Math.floor(damage) + '!';
            } else {
                damageText.style.color = '#fbbf24'; // 黄色普通伤害
                damageText.style.animation = 'floatUp 2s ease-out forwards';
            }
            
            // 位置计算 - 根据战斗模式调整
            let x, y;
            if (gameState.inBattle && gameState.currentMapMonsterId) {
                // 地图战斗模式 - 从角色头顶开始飘字
                if (target === 'player') {
                    // 获取玩家在地图上的实际位置
                    const playerElement = document.getElementById('playerOnMap');
                    if (playerElement) {
                        const playerRect = playerElement.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        
                        // 计算相对于飘字容器的位置
                        x = playerRect.left - containerRect.left + playerRect.width / 2 + (Math.random() - 0.5) * 40;
                        y = playerRect.top - containerRect.top - 20 + (Math.random() - 0.5) * 20; // 从头顶开始
                    } else {
                        // 备用位置
                        x = 200 + Math.random() * 100;
                        y = 180 + Math.random() * 80;
                    }
                } else {
                    // 获取怪物在地图上的实际位置
                    if (gameState.currentMapMonsterId) {
                        const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                        if (monsterElement) {
                            const monsterRect = monsterElement.getBoundingClientRect();
                            const containerRect = container.getBoundingClientRect();
                            
                            // 计算相对于飘字容器的位置
                            x = monsterRect.left - containerRect.left + monsterRect.width / 2 + (Math.random() - 0.5) * 40;
                            y = monsterRect.top - containerRect.top - 20 + (Math.random() - 0.5) * 20; // 从头顶开始
                        } else {
                            // 备用位置
                            x = 300 + Math.random() * 100;
                            y = 120 + Math.random() * 80;
                        }
                    } else {
                        // 备用位置
                        x = 300 + Math.random() * 100;
                        y = 120 + Math.random() * 80;
                    }
                }
            } else {
                // 传统战斗界面模式
                if (target === 'player') {
                    // 玩家区域 - 左侧
                    x = 100 + Math.random() * 80;
                    y = 150 + Math.random() * 60;
                } else {
                    // 怪物区域 - 右侧
                    x = 300 + Math.random() * 80;
                    y = 150 + Math.random() * 60;
                }
            }
            
            damageText.style.left = x + 'px';
            damageText.style.top = y + 'px';
            
            // 添加到容器
            container.appendChild(damageText);
            
            // 动画结束后移除元素
            setTimeout(() => {
                if (damageText.parentNode) {
                    damageText.parentNode.removeChild(damageText);
                }
            }, 2000);
        }

        // 计算特殊装备加成
        function calculateSpecialEquipmentBonus() {
            const player = gameState.player;
            let bonus = {
                percentDamage: 0,
                percentHp: 0,
                percentMp: 0,
                percentAttack: 0,
                divineMultiplier: 1
            };
            
            // 检查所有特殊装备槽位
            ['special1', 'special2', 'special3', 'special4'].forEach(slot => {
                const equipment = player.equipment[slot];
                if (equipment) {
                    bonus.percentDamage += equipment.percentDamage || 0;
                    bonus.percentHp += equipment.percentHp || 0;
                    bonus.percentMp += equipment.percentMp || 0;
                    bonus.percentAttack += equipment.percentAttack || 0;
                    if (equipment.divineMultiplier) {
                        bonus.divineMultiplier *= equipment.divineMultiplier;
                    }
                }
            });
            
            return bonus;
        }

        // 计算套装效果
        function calculateSetBonus() {
            const player = gameState.player;
            const setCount = {};
            const setBonus = {
                attack: 0,
                defense: 0,
                hp: 0,
                mp: 0,
                critRate: 0,
                critDamage: 0,
                magicPower: 0,
                vampiric: 0,
                damageReduction: 0,
                specialEffects: []
            };
            
            // 统计套装件数（包含四格特殊装备）
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace', 'special1', 'special2', 'special3', 'special4'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.setName) {
                    setCount[item.setName] = (setCount[item.setName] || 0) + 1;
                }
            });
            
            // 计算套装效果
            Object.keys(setCount).forEach(setName => {
                const count = setCount[setName];
                
                if (setName === '天神套装') {
                    if (count >= 2) {
                        setBonus.attack += 20;
                        setBonus.critRate += 10;
                        setBonus.specialEffects.push('天神祝福：攻击力+20，暴击率+10%');
                    }
                    if (count >= 4) {
                        setBonus.hp += 100;
                        setBonus.critDamage += 30;
                        setBonus.specialEffects.push('天神庇护：生命值+100，暴击伤害+30%');
                    }
                } else if (setName === '深渊套装') {
                    if (count >= 2) {
                        setBonus.vampiric += 15;
                        setBonus.attack += 25;
                        setBonus.specialEffects.push('深渊之力：吸血+15%，攻击力+25');
                    }
                    if (count >= 4) {
                        setBonus.damageReduction += 20;
                        setBonus.critRate += 15;
                        setBonus.specialEffects.push('深渊统治：伤害减免+20%，暴击率+15%');
                    }
                } else if (setName === '创世套装') {
                    if (count >= 2) {
                        setBonus.magicPower += 40;
                        setBonus.mp += 80;
                        setBonus.specialEffects.push('创世之智：法术强度+40，魔法值+80');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 20;
                        setBonus.magicPower += 60;
                        setBonus.specialEffects.push('创世掌控：暴击率+20%，法术强度+60');
                    }
                } else if (setName === '永恒套装') {
                    if (count >= 2) {
                        setBonus.hp += 80;
                        setBonus.defense += 15;
                        setBonus.specialEffects.push('永恒守护：生命值+80，防御力+15');
                    }
                    if (count >= 4) {
                        setBonus.hp += 120;
                        setBonus.vampiric += 20;
                        setBonus.specialEffects.push('永恒重生：生命值+120，吸血+20%');
                    }
                } else if (setName === '混沌套装') {
                    if (count >= 2) {
                        setBonus.attack += 40;
                        setBonus.critRate += 20;
                        setBonus.specialEffects.push('混沌之力：攻击力+40，暴击率+20%');
                    }
                    if (count >= 4) {
                        setBonus.critDamage += 50;
                        setBonus.damageReduction += 25;
                        setBonus.specialEffects.push('混沌主宰：暴击伤害+50%，伤害减免+25%');
                    }
                } else if (setName === '虚空套装') {
                    if (count >= 2) {
                        setBonus.magicPower += 60;
                        setBonus.critRate += 25;
                        setBonus.specialEffects.push('虚空掌控：法术强度+60，暴击率+25%');
                    }
                    if (count >= 4) {
                        setBonus.magicPower += 80;
                        setBonus.mp += 150;
                        setBonus.specialEffects.push('虚空主宰：法术强度+80，魔法值+150');
                    }
                } else if (setName === '龙神套装') {
                    if (count >= 2) {
                        setBonus.attack += 80;
                        setBonus.critRate += 30;
                        setBonus.specialEffects.push('龙神之力：攻击力+80，暴击率+30%');
                    }
                    if (count >= 4) {
                        setBonus.critDamage += 100;
                        setBonus.hp += 300;
                        setBonus.specialEffects.push('龙神统治：暴击伤害+100%，生命值+300');
                    }
                } else if (setName === '神域套装') {
                    if (count >= 2) {
                        setBonus.defense += 50;
                        setBonus.hp += 250;
                        setBonus.specialEffects.push('神域庇护：防御力+50，生命值+250');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 35;
                        setBonus.damageReduction += 40;
                        setBonus.specialEffects.push('神域审判：暴击率+35%，伤害减免+40%');
                    }
                } else if (setName === '无限套装') {
                    if (count >= 2) {
                        setBonus.attack += 120;
                        setBonus.hp += 400;
                        setBonus.specialEffects.push('无限之力：攻击力+120，生命值+400');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 50;
                        setBonus.critDamage += 150;
                        setBonus.specialEffects.push('无限主宰：暴击率+50%，暴击伤害+150%');
                    }
                } else if (setName === '创世神套装') {
                    if (count >= 2) {
                        setBonus.magicPower += 150;
                        setBonus.mp += 300;
                        setBonus.specialEffects.push('创世神力：法术强度+150，魔法值+300');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 60;
                        setBonus.magicPower += 200;
                        setBonus.specialEffects.push('创世主宰：暴击率+60%，法术强度+200');
                    }
                }
            });
            
            return setBonus;
        }

        async function playerAutoAttack() {
            if (!gameState.inBattle) return;
            
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            // 播放攻击动画
            playPlayerAttackAnimation();
            
            // 计算玩家攻击力
            let playerAttack = player.attack[0] + Math.random() * (player.attack[1] - player.attack[0]);
            if (player.equipment.weapon) {
                playerAttack += player.equipment.weapon.attack[0] + Math.random() * (player.equipment.weapon.attack[1] - player.equipment.weapon.attack[0]);
            }
            
            // 获取特殊装备加成
            const specialBonus = calculateSpecialEquipmentBonus();
            
            // 应用百分比攻击加成
            playerAttack *= (1 + specialBonus.percentAttack / 100);
            
            // 计算套装效果
            const setBonus = calculateSetBonus();
            
            // 计算暴击
            let critRate = player.critRate || 0;
            let critDamage = player.critDamage || 150;
            
            // 装备暴击加成
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item) {
                    critRate += item.critRate || 0;
                    critDamage += item.critDamage || 0;
                }
            });
            
            // 应用套装暴击加成
            critRate += setBonus.critRate;
            critDamage += setBonus.critDamage;
            
            let isCrit = Math.random() * 100 < critRate;
            let finalDamage = Math.floor(playerAttack);
            
            // 应用套装攻击加成
            finalDamage += setBonus.attack;
            
            if (isCrit) {
                finalDamage = Math.floor(finalDamage * (critDamage / 100));
            }
            
            // 应用百分比伤害加成
            finalDamage *= (1 + specialBonus.percentDamage / 100);
            
            // 应用神力倍攻
            finalDamage *= specialBonus.divineMultiplier;
            
            // 应用养成系统伤害加成
            const cultivationDamageBonus = gameState.player.cultivation.damage.level * 5; // 每级5%伤害加成
            finalDamage *= (1 + cultivationDamageBonus / 100);
            
            finalDamage = Math.floor(finalDamage);
            
            // 延迟伤害计算，配合动画
            setTimeout(() => {
                monster.hp -= finalDamage;
                gameState.player.lastDamageDealt = finalDamage; // 记录造成的伤害用于吸血计算
                playHurtAnimation('monster');
                
                // 显示飘字效果
                showDamageText(finalDamage, isCrit, false, 'monster');
                
                if (isCrit) {
                    addLog(`暴击！你对${monster.name}造成了${finalDamage}点伤害`);
                } else {
                    addLog(`你对${monster.name}造成了${finalDamage}点伤害`);
                }
                
                // 应用套装吸血效果（在造成伤害后立即处理）
                if (setBonus.vampiric > 0 && finalDamage > 0) {
                    const vampiricHeal = Math.floor(finalDamage * setBonus.vampiric / 100);
                    const specialBonus = calculateSpecialEquipmentBonus();
                    const totalMaxHp = Math.floor(gameState.player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
                    const oldHp = gameState.player.hp;
                    gameState.player.hp = Math.min(totalMaxHp, gameState.player.hp + vampiricHeal);
                    const actualHeal = gameState.player.hp - oldHp;
                    if (actualHeal > 0) {
                        // 延迟显示绿色吸血飘字，让伤害飘字先显示
                        setTimeout(() => {
                            showDamageText(actualHeal, false, true, 'player');
                        }, 200);
                        addLog(`吸血效果恢复了${actualHeal}点生命`);
                    }
                }
                
                if (monster.hp <= 0) {
                    // 怪物死亡
                    const expGain = monster.exp;
                    const goldGain = monster.gold;
                    
                    gameState.player.exp += expGain;
                    gameState.player.gold += goldGain;
                    
                    // 发送战斗结果到服务器
                    sendBattleResultToServer({
                        monstersKilled: 1,
                        damage: finalDamage,
                        exp: expGain,
                        gold: goldGain,
                        monsterName: monster.name,
                        timestamp: Date.now()
                    });
                    
                    // 更新金币收集任务进度
                    updateQuestProgress('collect', 'gold', goldGain);
                    
                    addLog(`${monster.name}被击败了！获得${expGain}经验和${goldGain}金币`);
                    
                    // 更新任务进度
                    updateQuestProgress('kill', monster.name);
                    updateQuestProgress('kill', 'any');
                    
                    // 检查升级
                    checkLevelUp();
                    
                    // 随机掉落装备（应用养成系统爆率加成）
                    const cultivationDropBonus = gameState.player.cultivation.dropRate.level * 10; // 每级10%爆率加成
                    const finalDropRate = 0.6 + (cultivationDropBonus / 100);
                    if (Math.random() < finalDropRate) {
                        dropEquipment(gameState.currentMonster);
                    }
                    
                    // 自动进行鞭尸判断
                    autoWhipCorpse(gameState.currentMonster);
                    
                    // 检查称号条件
                    checkTitleConditions();
                    
                    // 保存击败的怪物信息用于手动鞭尸（保留原有功能）
                    gameState.lastDefeatedMonster = {...gameState.currentMonster};
                    
                    // 调用怪物死亡检查函数，统一处理
                    checkCurrentMonsterDeath();
                    return;
                }
                
                // 检查怪物死亡状态，如果没有死亡则更新UI
                if (!checkCurrentMonsterDeath()) {
                    updateMapBattleUI();
                    updateUI(); // 确保UI及时更新以反映吸血效果
                }
            }, 300);
        }

        // 手动攻击（保留给技能使用）
        function attack() {
            if (!gameState.inBattle) return;
            playerAutoAttack();
            
            // 如果不是自动战斗模式，怪物反击
            if (!gameState.autoBattle) {
                setTimeout(() => {
                    monsterAttack();
                }, 1000);
            }
        }

        // 怪物攻击
        function monsterAttack() {
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            // 播放怪物攻击动画
            playMonsterAttackAnimation();
            
            let monsterAttack = monster.attack[0] + Math.random() * (monster.attack[1] - monster.attack[0]);
            
            // 计算防御
            let defense = player.defense;
            const equipmentSlots = ['helmet', 'armor', 'boots'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.defense) {
                    defense += item.defense;
                }
            });
            
            // 计算套装效果
            const setBonus = calculateSetBonus();
            
            // 应用套装防御加成
            defense += setBonus.defense;
            
            let damage = Math.max(1, Math.floor(monsterAttack - defense));
            
            // 应用套装伤害减免
            if (setBonus.damageReduction > 0) {
                damage = Math.floor(damage * (1 - setBonus.damageReduction / 100));
                damage = Math.max(1, damage); // 确保至少造成1点伤害
            }
            
            // 延迟伤害计算，配合动画
            setTimeout(() => {
                player.hp -= damage;
                playHurtAnimation('player');
                
                // 显示飘字效果
                showDamageText(damage, false, false, 'player');
                
                addLog(`${monster.name}对你造成了${damage}点伤害`);
                
                // 吸血效果已移至playerAutoAttack函数中处理
                
                if (player.hp <= 0) {
                    // 玩家死亡
                    player.hp = 0;
                    addLog('你被击败了！');
                    endBattle();
                    // 这里可以添加复活逻辑
                    setTimeout(() => {
                        player.hp = player.maxHp;
                        addLog('你在新手村复活了');
                        goToLocation('village');
                    }, 2000);
                }
                
                // 立即更新UI以反映血量变化和吸血效果
                updateMapBattleUI();
                updateUI();
            }, 300);
        }

        // 使用技能
        async function useSkill(skillName) {
            if (!gameState.inBattle) return;
            
            const player = gameState.player;
            
            if (skillName === 'fireball' && player.mp >= 10) {
                player.mp -= 10;
                
                // 播放火球术动画
                playSkillAnimation('fireball');
                
                let damage = 20 + Math.random() * 15;
                
                // 获取特殊装备加成
                const specialBonus = calculateSpecialEquipmentBonus();
                
                // 计算套装效果
                const setBonus = calculateSetBonus();
                
                // 计算技能暴击
                let critRate = player.critRate || 0;
                let critDamage = player.critDamage || 150;
                
                // 装备暴击加成
                if (player.equipment.weapon) {
                    critRate += player.equipment.weapon.critRate || 0;
                    critDamage += player.equipment.weapon.critDamage || 0;
                }
                if (player.equipment.armor) {
                    critRate += player.equipment.armor.critRate || 0;
                    critDamage += player.equipment.armor.critDamage || 0;
                }
                if (player.equipment.accessory) {
                    critRate += player.equipment.accessory.critRate || 0;
                    critDamage += player.equipment.accessory.critDamage || 0;
                }
                
                // 应用套装暴击加成
                critRate += setBonus.critRate;
                critDamage += setBonus.critDamage;
                
                let isCrit = Math.random() * 100 < critRate;
                let finalDamage = Math.floor(damage);
                
                // 应用套装法术强度加成
                finalDamage += setBonus.magicPower;
                
                if (isCrit) {
                    finalDamage = Math.floor(finalDamage * (critDamage / 100));
                }
                
                // 应用百分比伤害加成
                finalDamage *= (1 + specialBonus.percentDamage / 100);
                
                // 应用神力倍攻
                finalDamage *= specialBonus.divineMultiplier;
                
                // 应用养成系统伤害加成
                const cultivationDamageBonus = gameState.player.cultivation.damage.level * 5; // 每级5%伤害加成
                finalDamage *= (1 + cultivationDamageBonus / 100);
                
                finalDamage = Math.floor(finalDamage);
                
                // 延迟伤害计算，配合动画
                setTimeout(() => {
                    gameState.currentMonster.hp -= finalDamage;
                    playHurtAnimation('monster');
                    
                    // 显示飘字效果
                    showDamageText(finalDamage, isCrit, false, 'monster');
                    
                    if (isCrit) {
                        addLog(`暴击！你使用火球术造成了${finalDamage}点伤害`);
                    } else {
                        addLog(`你使用火球术造成了${finalDamage}点伤害`);
                    }
                    
                    if (gameState.currentMonster.hp <= 0) {
                        const expGain = gameState.currentMonster.exp;
                        const goldGain = gameState.currentMonster.gold;
                        
                        gameState.player.exp += expGain;
                        gameState.player.gold += goldGain;
                        
                        // 发送战斗结果到服务器
                        sendBattleResultToServer({
                            monstersKilled: 1,
                            damage: finalDamage,
                            exp: expGain,
                            gold: goldGain,
                            monsterName: gameState.currentMonster.name,
                            skillUsed: 'fireball',
                            timestamp: Date.now()
                        });
                        
                        // 显示金币获得飘字效果
                        showFloatingText(`+${goldGain} 金币`, 'gold');
                        
                        // 更新金币收集任务进度
                        updateQuestProgress('collect', 'gold', goldGain);
                        
                        addLog(`${gameState.currentMonster.name}被击败了！获得${expGain}经验和${goldGain}金币`);
                        
                        // 更新任务进度
                        updateQuestProgress('kill', gameState.currentMonster.name);
                        updateQuestProgress('kill', 'any');
                        
                        checkLevelUp();
                        
                        // 随机掉落装备（应用养成系统爆率加成）
                        const cultivationDropBonus = gameState.player.cultivation.dropRate.level * 10; // 每级10%爆率加成
                        const finalDropRate = 0.6 + (cultivationDropBonus / 100);
                        if (Math.random() < finalDropRate) {
                            dropEquipment(gameState.currentMonster);
                        }
                        
                        // 自动进行鞭尸判断
                        autoWhipCorpse(gameState.currentMonster);
                        
                        // 检查称号条件
                        checkTitleConditions();
                        
                        // 保存击败的怪物信息用于手动鞭尸（保留原有功能）
                        gameState.lastDefeatedMonster = {...gameState.currentMonster};
                        
                        // 调用怪物死亡检查函数，统一处理
                        checkCurrentMonsterDeath();
                        return;
                    }
                    
                    // 检查怪物死亡状态，如果没有死亡则更新UI
                    if (!checkCurrentMonsterDeath()) {
                        updateMapBattleUI();
                    }
                    
                    // 只在非自动战斗模式下触发怪物反击
                    if (!gameState.autoBattle) {
                        setTimeout(() => {
                            monsterAttack();
                        }, 800);
                    }
                }, 400);
                
            } else if (skillName === 'heal' && player.mp >= 15) {
                player.mp -= 15;
                
                // 播放治疗术动画
                playSkillAnimation('heal');
                
                const healAmount = 30 + Math.random() * 20;
                
                // 延迟治疗效果，配合动画
                setTimeout(() => {
                    const specialBonus = calculateSpecialEquipmentBonus();
                    const setBonus = calculateSetBonus();
                    const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
                    const actualHeal = Math.min(Math.floor(healAmount), totalMaxHp - player.hp);
                    player.hp = Math.min(totalMaxHp, player.hp + Math.floor(healAmount));
                    
                    // 显示治疗飘字效果
                    showDamageText(actualHeal, false, true, 'player');
                    
                    addLog(`你使用治疗术恢复了${Math.floor(healAmount)}点生命`);
                    updateMapBattleUI();
                }, 400);
                
                // 治疗术不触发怪物攻击
                
            } else {
                addLog('魔法值不足！');
                return;
            }
            
            updateUI();
        }

        // 逃跑
        function flee() {
            if (Math.random() < 0.7) {
                addLog('你成功逃跑了！');
                endBattle();
            } else {
                addLog('逃跑失败！');
                setTimeout(() => {
                    monsterAttack();
                }, 1000);
            }
        }

        // 结束战斗
        async function endBattle() {
            console.log('endBattle called', {
                inBattle: gameState.inBattle,
                currentMapMonsterId: gameState.currentMapMonsterId,
                mapMonstersCount: mapMonsters.length
            });
            
            // 防止重复调用endBattle
            if (!gameState.inBattle) {
                console.log('endBattle called but not in battle, ignoring');
                return;
            }
            
            // 立即停止自动战斗并清除所有战斗相关的定时器
            console.log('endBattle: Stopping auto battle and clearing timers');
            gameState.autoBattle = false;
            if (gameState.battleInterval) {
                console.log('endBattle: Clearing battleInterval:', gameState.battleInterval);
                clearTimeout(gameState.battleInterval);
                gameState.battleInterval = null;
            } else {
                console.log('endBattle: No battleInterval to clear');
            }
            
            // 重置战斗状态
            gameState.inBattle = false;
            
            // 如果是地图战斗，处理地图上的怪物
            if (gameState.currentMapMonsterId) {
                console.log('Processing map monster removal for ID:', gameState.currentMapMonsterId);
                
                // 移除怪物的战斗状态样式
                const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                console.log('Monster element found:', !!monsterElement, 'Element:', monsterElement);
                
                if (monsterElement) {
                    // 立即禁用怪物的点击事件，防止重复点击
                    monsterElement.style.pointerEvents = 'none';
                    monsterElement.removeAttribute('data-monster-id');
                    
                    // 移除战斗状态样式
                    monsterElement.classList.remove('in-battle');
                    
                    // 添加死亡动画效果
                    monsterElement.style.transition = 'all 0.5s ease-out';
                    monsterElement.style.opacity = '0';
                    monsterElement.style.transform = 'translate(-50%, -50%) scale(0.5)';
                    
                    // 延迟移除DOM元素
                    setTimeout(() => {
                        if (monsterElement.parentNode) {
                            monsterElement.remove();
                            console.log('Monster element removed from DOM with animation');
                        }
                    }, 800);
                } else {
                    console.error('Monster element not found! Trying alternative removal methods...');
                    // 尝试通过类名或其他方式查找并移除
                    const monstersContainer = document.getElementById('monstersOnMap');
                    if (monstersContainer) {
                        const allMonsters = monstersContainer.querySelectorAll('[id^="monster_"]');
                        console.log('Found monsters by class:', allMonsters.length);
                        allMonsters.forEach(el => {
                            if (el.id === gameState.currentMapMonsterId) {
                                el.classList.remove('in-battle');
                                el.remove();
                                console.log('Monster removed by alternative method');
                            }
                        });
                    }
                }
                
                // 从地图怪物数组中移除
                const index = mapMonsters.findIndex(m => m.id === gameState.currentMapMonsterId);
                console.log('Monster index in array:', index);
                if (index > -1) {
                    mapMonsters.splice(index, 1);
                    console.log('Monster removed from array, new count:', mapMonsters.length);
                } else {
                    console.error('Monster not found in mapMonsters array!');
                }
                
                // 移除玩家血条
                const playerElement = document.getElementById('playerOnMap');
                if (playerElement) {
                    const playerHpContainer = playerElement.querySelector('.player-hp-container');
                    if (playerHpContainer) {
                        playerHpContainer.remove();
                        console.log('Player HP container removed');
                    }
                }
                
                gameState.currentMapMonsterId = null;
                console.log('currentMapMonsterId cleared');
            }
            
            gameState.currentMonster = null;
            
            // 重置自动战斗按钮状态
            const autoBattleBtn = document.getElementById('autoBattleBtn');
            if (autoBattleBtn) {
                autoBattleBtn.textContent = '开始自动战斗';
                autoBattleBtn.className = 'btn-primary px-6 py-2 rounded mr-2';
            }
            
            // 确保正确的UI状态切换
            console.log('Switching UI back to monster area');
            document.getElementById('mapBattleInfo').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            // saveArea已移除
            // monsterArea已删除
            
            // 确保地图区域可见
            const gameMapContainer = document.getElementById('gameMapContainer');
            if (gameMapContainer) {
                gameMapContainer.style.display = 'block';
            }
            
            // 重新启用所有按钮和交互
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = false;
            });
            
            // 更新玩家信息和UI
            updatePlayerInfo();
            updateUI();
            
            // 只清理当前战斗怪物的残留元素（如果存在）
            setTimeout(() => {
                if (gameState.currentMapMonsterId) {
                    console.log('Force cleaning current battle monster element:', gameState.currentMapMonsterId);
                    const monstersContainer = document.getElementById('monstersOnMap');
                    if (monstersContainer) {
                        // 只清理当前战斗的怪物DOM元素
                        const currentMonsterElement = document.getElementById(gameState.currentMapMonsterId);
                        if (currentMonsterElement) {
                            console.log('Removing remaining monster element:', currentMonsterElement.id);
                            currentMonsterElement.remove();
                        }
                    }
                }
            }, 1000);
            
            // 延迟重新生成怪物（如果地图上怪物数量不足）
            setTimeout(async () => {
                // 再次确认战斗状态已结束
                if (!gameState.inBattle) {
                    console.log('Checking if need to generate new monsters, current count:', mapMonsters.length);
                    if (mapMonsters.length < 3) {
                        console.log('Generating new monsters...');
                        await generateMapMonsters();
                    }
                    // 更新地图显示
                    updateMapMonstersHP();
                }
            }, 3000); // 3秒后再生成新怪物，给玩家更多时间
            
            // 同步游戏状态到服务器
            syncGameStateToServer();
            
            console.log('Battle ended, gameState.inBattle =', gameState.inBattle);
        }

        // 检查升级
        function checkLevelUp() {
            const player = gameState.player;
            
            while (player.exp >= player.maxExp) {
                player.exp -= player.maxExp;
                player.level++;
                player.maxExp = player.level * 100;
                
                // 升级属性提升
                const hpIncrease = 20;
                const mpIncrease = 10;
                
                player.maxHp += hpIncrease;
                player.maxMp += mpIncrease;
                
                // 计算包含装备和套装加成的最大血量和魔法值
                const specialBonus = calculateSpecialEquipmentBonus();
                const setBonus = calculateSetBonus();
                const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
                const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
                
                player.hp = totalMaxHp; // 升级回满血
                player.mp = totalMaxMp; // 升级回满蓝
                
                addLog(`恭喜升级！当前等级：${player.level}`);
                addLog(`生命值增加${hpIncrease}，魔法值增加${mpIncrease}`);
                
                // 更新任务进度
                updateQuestProgress('level', 'level');
                
                // 检查称号条件
                checkTitleConditions();
            }
            
            updateUI();
            
            // 等级提升后刷新任务面板，因为可能解锁新的支线任务
            updateQuestDisplay();
        }

        // 根据物品ID获取物品信息
        async function getItemById(itemId) {
            try {
                const equipmentData = await configManager.getEquipmentConfig();
                
                // 搜索所有装备类型
                const allItems = [
                    ...(equipmentData.weapons || []),
                    ...(equipmentData.armors || []),
                    ...(equipmentData.accessories || []),
                    ...(equipmentData.potions || []),
                    ...(equipmentData.helmets || []),
                    ...(equipmentData.boots || [])
                ];
                
                return allItems.find(item => item.id === itemId || item.name === itemId);
            } catch (error) {
                console.error('获取物品信息失败:', error);
                return null;
            }
        }
        
        // 根据材料ID获取材料名称
        function getMaterialNameById(materialId) {
            const materialMap = {
                'iron_ore': '铁矿石',
                'silver_ore': '银矿石',
                'gold_ore': '黄金矿石',
                'magic_crystal': '魔法水晶',
                'shadow_essence': '暗影精华',
                'dragon_scale': '龙鳞片',
                'holy_gem': '神圣宝石',
                'rare_gem': '稀有宝石',
                'dragon_essence': '龙之精华',
                'holy_crystal': '圣光水晶',
                'angel_feather': '天使之羽',
                'infinite_crystal': '无限水晶',
                'time_fragment': '时空碎片',
                'creation_crystal': '创世水晶',
                'chaos_heart': '混沌之心',
                'slime_gel': '史莱姆凝胶',
                'goblin_ear': '哥布林耳朵',
                'bone_fragment': '骨头碎片',
                'orc_tusk': '兽人獠牙',
                'fire_crystal': '火焰水晶',
                'chaos_crystal': '混沌水晶',
                'dragon_heart': '龙之心',
                'dragon_claw': '龙爪'
            };
            
            return materialMap[materialId] || materialId;
        }

        // 掉落装备
        async function dropEquipment(monster = null) {
            // 优先使用新的掉落系统
            if (monster && monster.dropIds) {
                try {
                    const drops = await configManager.calculateMonsterDrops(monster.id);
                    if (drops && drops.length > 0) {
                        for (const drop of drops) {
                            const { id, type, amount } = drop;
                            
                            if (type === 'gold') {
                                gameState.player.gold += amount;
                                addLog(`获得了${amount}金币`);
                                showFloatingText(`+${amount} 金币`, 'gold');
                            } else if (type === 'item') {
                                // 根据物品ID获取物品信息
                                const itemInfo = await getItemById(id);
                                if (itemInfo) {
                                    for (let i = 0; i < amount; i++) {
                                        gameState.player.inventory.push({...itemInfo});
                                    }
                                    addLog(`获得了物品：${itemInfo.name} x${amount}`);
                                } else {
                                    addLog(`获得了未知物品：${id} x${amount}`);
                                }
                            } else if (type === 'material') {
                                // 处理材料掉落
                                const materialName = getMaterialNameById(id);
                                const existingMaterial = gameState.player.materials.find(item => item.name === materialName);
                                if (existingMaterial) {
                                    existingMaterial.count += amount;
                                    addLog(`获得了材料：${materialName} x${amount} (总计: ${existingMaterial.count})`);
                                } else {
                                    gameState.player.materials.push({
                                        name: materialName,
                                        count: amount,
                                        description: getMaterialDescription(materialName)
                                    });
                                    addLog(`获得了材料：${materialName} x${amount}`);
                                }
                            }
                        }
                        updateInventoryDisplay();
                        updateUI();
                        updateQuestProgress('collect', 'item');
                        return;
                    }
                } catch (error) {
                    console.error('新掉落系统出错，使用旧系统:', error);
                }
            }
            
            // 如果新掉落系统失败或怪物没有dropIds，使用旧的掉落系统
            const equipment = getEquipmentData();
            let dropType = Math.random();
            let droppedItem;
            
            // Boss怪物特殊掉落
            if (monster && monster.type === 'boss' && monster.bossLoot) {
                // Boss有80%概率掉落特殊装备
                if (Math.random() < 0.8) {
                    // 根据Boss等级掉落不同品质的特殊装备
                    const specialEquipments = [
                        { name: '力量护符', type: 'special', tier: 1, percentDamage: 10, price: 500, rarity: 'rare', description: '增加10%伤害' },
                        { name: '生命护符', type: 'special', tier: 1, percentHp: 15, price: 500, rarity: 'rare', description: '增加15%生命值' },
                        { name: '攻击护符', type: 'special', tier: 1, percentAttack: 12, price: 600, rarity: 'rare', description: '增加12%攻击力' },
                        { name: '神力护符', type: 'special', tier: 2, divineMultiplier: 1.5, price: 1000, rarity: 'epic', description: '神力倍攻 x1.5' },
                        { name: '至尊护符', type: 'special', tier: 3, percentDamage: 25, percentHp: 20, price: 2000, rarity: 'legendary', description: '增加25%伤害和20%生命值' },
                        { name: '超神护符', type: 'special', tier: 4, percentDamage: 50, percentHp: 40, percentAttack: 30, price: 5000, rarity: 'transcendent', description: '全属性大幅提升' }
                    ];
                    
                    let droppedItem;
                    if (monster.level >= 50) {
                        // 高级Boss掉落高品质护符
                        droppedItem = specialEquipments[Math.floor(Math.random() * 2) + 4]; // 至尊或超神护符
                    } else if (monster.level >= 25) {
                        // 中级Boss掉落中品质护符
                        droppedItem = specialEquipments[Math.floor(Math.random() * 2) + 2]; // 攻击或神力护符
                    } else {
                        // 低级Boss掉落基础护符
                        droppedItem = specialEquipments[Math.floor(Math.random() * 2)]; // 力量或生命护符
                    }
                    
                    gameState.player.inventory.push({...droppedItem});
                    addLog(`💎 Boss掉落了特殊装备：${droppedItem.name}！`);
                    updateInventoryDisplay();
                    updateQuestProgress('collect', 'item');
                    return;
                }
            }
            
            // 精英怪物提高掉落率
            if (monster && monster.type === 'elite') {
                dropType = Math.random() * 0.8; // 精英怪物掉落率提高20%
            }
            
            // Boss怪物提高掉落率
            if (monster && monster.type === 'boss') {
                dropType = Math.random() * 0.6; // Boss怪物掉落率提高40%
            }
            
            // 称号卷轴掉落概率调整
            let scrollChance = 0.05;
            if (monster && monster.type === 'elite') scrollChance = 0.1;
            if (monster && monster.type === 'boss') scrollChance = 0.2;
            
            if (dropType < scrollChance) {
                const availableScrolls = Object.keys(titleTemplates).filter(titleId => {
                    return !gameState.player.titles.owned.find(t => t.id === titleId) && 
                           !gameState.player.titles.scrolls.find(s => s.id === titleId);
                });
                
                if (availableScrolls.length > 0) {
                    const randomTitleId = availableScrolls[Math.floor(Math.random() * availableScrolls.length)];
                    const titleTemplate = titleTemplates[randomTitleId];
                    gameState.player.titles.scrolls.push({...titleTemplate});
                    addLog(`获得了称号卷轴：${titleTemplate.name}`);
                    updateTitleDisplay();
                    return;
                }
            }
            
            if (dropType < 0.4) {
                // 40%概率掉落养成材料
                const materials = [
                    { name: '铁矿石', type: 'material', quantity: 1, price: 50, rarity: 'common' },
                    { name: '银矿石', type: 'material', quantity: 1, price: 100, rarity: 'rare' },
                    { name: '魔法水晶', type: 'material', quantity: 1, price: 100, rarity: 'uncommon' },
                    { name: '黄金矿石', type: 'material', quantity: 1, price: 200, rarity: 'epic' },
                    { name: '暗影精华', type: 'material', quantity: 1, price: 300, rarity: 'epic' },
                    { name: '龙鳞片', type: 'material', quantity: 1, price: 400, rarity: 'legendary' },
                    { name: '神圣宝石', type: 'material', quantity: 1, price: 500, rarity: 'legendary' },
                    { name: '稀有宝石', type: 'material', quantity: 1, price: 500, rarity: 'rare' },
                    // 超神品质材料
                    { name: '龙之精华', type: 'material', quantity: 1, price: 800, rarity: 'transcendent' },
                    { name: '圣光水晶', type: 'material', quantity: 1, price: 900, rarity: 'transcendent' },
                    { name: '天使之羽', type: 'material', quantity: 1, price: 1200, rarity: 'transcendent' },
                    { name: '无限水晶', type: 'material', quantity: 1, price: 1500, rarity: 'transcendent' },
                    { name: '时空碎片', type: 'material', quantity: 1, price: 2000, rarity: 'transcendent' },
                    { name: '创世水晶', type: 'material', quantity: 1, price: 1800, rarity: 'transcendent' },
                    { name: '混沌之心', type: 'material', quantity: 1, price: 2500, rarity: 'transcendent' }
                ];
                
                // 根据怪物类型调整掉落概率
                let materialRoll = Math.random();
                let droppedItem;
                
                if (monster && monster.type === 'boss') {
                    // 检查是否为超高级地区的Boss
                    const currentLocation = gameState.currentLocation;
                    const isTranscendentArea = ['dragonrealm', 'godsdomain', 'chaosrealm', 'voidrealm', 'infiniterealm'].includes(currentLocation);
                    
                    if (isTranscendentArea) {
                        // 超高级地区Boss掉落超神品质材料
                        if (materialRoll < 0.10) {
                            droppedItem = materials[5]; // 龙鳞片
                        } else if (materialRoll < 0.20) {
                            droppedItem = materials[6]; // 神圣宝石
                        } else if (materialRoll < 0.35) {
                            droppedItem = materials[8]; // 龙之精华
                        } else if (materialRoll < 0.50) {
                            droppedItem = materials[9]; // 圣光水晶
                        } else if (materialRoll < 0.65) {
                            droppedItem = materials[10]; // 天使之羽
                        } else if (materialRoll < 0.75) {
                            droppedItem = materials[11]; // 无限水晶
                        } else if (materialRoll < 0.85) {
                            droppedItem = materials[12]; // 时空碎片
                        } else if (materialRoll < 0.92) {
                            droppedItem = materials[13]; // 创世水晶
                        } else {
                            droppedItem = materials[14]; // 混沌之心
                        }
                    } else {
                        // 普通Boss怪物掉落高级材料概率更高
                        if (materialRoll < 0.15) {
                            droppedItem = materials[0]; // 铁矿石
                        } else if (materialRoll < 0.25) {
                            droppedItem = materials[1]; // 银矿石
                        } else if (materialRoll < 0.35) {
                            droppedItem = materials[2]; // 魔法水晶
                        } else if (materialRoll < 0.50) {
                            droppedItem = materials[3]; // 黄金矿石
                        } else if (materialRoll < 0.65) {
                            droppedItem = materials[4]; // 暗影精华
                        } else if (materialRoll < 0.80) {
                            droppedItem = materials[5]; // 龙鳞片
                        } else if (materialRoll < 0.90) {
                            droppedItem = materials[6]; // 神圣宝石
                        } else {
                            droppedItem = materials[7]; // 稀有宝石
                        }
                    }
                } else if (monster && monster.type === 'elite') {
                    // 精英怪物掉落中高级材料
                    if (materialRoll < 0.25) {
                        droppedItem = materials[0]; // 铁矿石
                    } else if (materialRoll < 0.40) {
                        droppedItem = materials[1]; // 银矿石
                    } else if (materialRoll < 0.55) {
                        droppedItem = materials[2]; // 魔法水晶
                    } else if (materialRoll < 0.70) {
                        droppedItem = materials[3]; // 黄金矿石
                    } else if (materialRoll < 0.80) {
                        droppedItem = materials[4]; // 暗影精华
                    } else if (materialRoll < 0.90) {
                        droppedItem = materials[5]; // 龙鳞片
                    } else {
                        droppedItem = materials[7]; // 稀有宝石
                    }
                } else {
                    // 普通怪物主要掉落基础材料
                    if (materialRoll < 0.50) {
                        droppedItem = materials[0]; // 铁矿石
                    } else if (materialRoll < 0.70) {
                        droppedItem = materials[1]; // 银矿石
                    } else if (materialRoll < 0.85) {
                        droppedItem = materials[2]; // 魔法水晶
                    } else if (materialRoll < 0.95) {
                        droppedItem = materials[3]; // 黄金矿石
                    } else {
                        droppedItem = materials[7]; // 稀有宝石
                    }
                }
                
                // Boss和精英怪物掉落更多数量
                let quantity = 1;
                if (monster && monster.type === 'elite') quantity = Math.floor(Math.random() * 2) + 1; // 1-2个
                if (monster && monster.type === 'boss') quantity = Math.floor(Math.random() * 3) + 2; // 2-4个
                
                // 检查是否已有该材料
                const existingMaterial = gameState.player.materials.find(item => item.name === droppedItem.name);
                if (existingMaterial) {
                    existingMaterial.count += quantity;
                    addLog(`获得了材料：${droppedItem.name} x${quantity} (总计: ${existingMaterial.count})`);
                } else {
                    gameState.player.materials.push({
                        name: droppedItem.name,
                        count: quantity,
                        description: getMaterialDescription(droppedItem.name)
                    });
                    addLog(`获得了材料：${droppedItem.name} x${quantity}`);
                }
                updateInventoryDisplay();
                return;
            } else if (dropType < 0.5) {
                // 药水掉落
                // 安全检查：确保equipment.potions存在
                if (!equipment.potions || !Array.isArray(equipment.potions)) {
                    console.error('装备配置中缺少potions数组，使用默认配置');
                    const defaultConfig = getDefaultEquipmentConfig();
                    equipment.potions = defaultConfig.potions;
                }
                
                let potions;
                if (monster && (monster.type === 'elite' || monster.type === 'boss')) {
                    potions = equipment.potions.filter(p => p.rarity === 'rare' || p.rarity === 'epic');
                } else {
                    potions = equipment.potions.filter(p => p.rarity === 'common');
                }
                if (potions && potions.length > 0) {
                    droppedItem = potions[Math.floor(Math.random() * potions.length)];
                } else {
                    // 如果过滤后没有药水，使用所有药水
                    droppedItem = equipment.potions[Math.floor(Math.random() * equipment.potions.length)];
                }
            } else if (dropType < 0.75) {
                // 武器或防具掉落
                // 安全检查：确保equipment.weapons和equipment.armors存在
                if (!equipment.weapons || !Array.isArray(equipment.weapons)) {
                    console.error('装备配置中缺少weapons数组，使用默认配置');
                    const defaultConfig = getDefaultEquipmentConfig();
                    equipment.weapons = defaultConfig.weapons;
                }
                if (!equipment.armors || !Array.isArray(equipment.armors)) {
                    console.error('装备配置中缺少armors数组，使用默认配置');
                    const defaultConfig = getDefaultEquipmentConfig();
                    equipment.armors = defaultConfig.armors;
                }
                
                let allEquipment;
                const currentLocation = gameState.currentLocation;
                const isTranscendentArea = ['dragonrealm', 'godsdomain', 'chaosrealm', 'voidrealm', 'infiniterealm'].includes(currentLocation);
                
                if (monster && monster.type === 'boss') {
                    if (isTranscendentArea) {
                        // 超高级地区Boss掉落超神品质装备
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'transcendent' || item.rarity === 'supreme' || item.rarity === 'legendary'
                        );
                    } else {
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'epic' || item.rarity === 'legendary'
                        );
                    }
                } else if (monster && monster.type === 'elite') {
                    if (isTranscendentArea) {
                        // 超高级地区精英怪掉落高品质装备
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'supreme' || item.rarity === 'legendary' || item.rarity === 'epic'
                        );
                    } else {
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'rare' || item.rarity === 'epic'
                        );
                    }
                } else {
                    allEquipment = [...equipment.weapons, ...equipment.armors];
                }
                if (allEquipment && allEquipment.length > 0) {
                    droppedItem = allEquipment[Math.floor(Math.random() * allEquipment.length)];
                } else {
                    // 如果过滤后没有装备，使用所有装备
                    const fallbackEquipment = [...equipment.weapons, ...equipment.armors];
                    droppedItem = fallbackEquipment[Math.floor(Math.random() * fallbackEquipment.length)];
                }
            } else if (dropType < 0.9) {
                // 饰品掉落
                let accessories;
                const currentLocation = gameState.currentLocation;
                const isTranscendentArea = ['dragonrealm', 'godsdomain', 'chaosrealm', 'voidrealm', 'infiniterealm'].includes(currentLocation);
                
                // 安全检查：确保equipment.accessories存在
                if (!equipment.accessories || !Array.isArray(equipment.accessories)) {
                    console.error('装备配置中缺少accessories数组，使用默认配置');
                    const defaultConfig = getDefaultEquipmentConfig();
                    equipment.accessories = defaultConfig.accessories;
                }
                
                if (monster && (monster.type === 'elite' || monster.type === 'boss')) {
                    if (isTranscendentArea) {
                        // 超高级地区掉落超神品质饰品
                        accessories = equipment.accessories.filter(item => 
                            item.rarity === 'transcendent' || item.rarity === 'supreme' || item.rarity === 'legendary'
                        );
                    } else {
                        accessories = equipment.accessories.filter(item => 
                            item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary'
                        );
                    }
                } else {
                    accessories = equipment.accessories;
                }
                if (accessories && accessories.length > 0) {
                    droppedItem = accessories[Math.floor(Math.random() * accessories.length)];
                } else {
                    // 如果过滤后没有饰品，使用所有饰品
                    droppedItem = equipment.accessories[Math.floor(Math.random() * equipment.accessories.length)];
                }
            } else {
                // 高级药水掉落
                // 安全检查：确保equipment.potions存在
                if (!equipment.potions || !Array.isArray(equipment.potions)) {
                    console.error('装备配置中缺少potions数组，使用默认配置');
                    const defaultConfig = getDefaultEquipmentConfig();
                    equipment.potions = defaultConfig.potions;
                }
                
                const rarePotions = equipment.potions.filter(p => p.rarity === 'rare' || p.rarity === 'epic');
                if (rarePotions && rarePotions.length > 0) {
                    droppedItem = rarePotions[Math.floor(Math.random() * rarePotions.length)];
                } else {
                    // 如果没有高级药水，使用所有药水
                    droppedItem = equipment.potions[Math.floor(Math.random() * equipment.potions.length)];
                }
            }
            
            // 检查自动回收
            if (gameState.autoRecycle && gameState.autoRecycle.enabled && shouldAutoRecycle(droppedItem)) {
                const sellPrice = Math.floor((droppedItem.price || 0) * 0.5);
                gameState.player.gold += sellPrice;
                
                // 显示金币获得飘字效果
                showFloatingText(`+${sellPrice} 金币`, 'gold');
                
                addLog(`自动回收：${droppedItem.name}，获得${sellPrice}金币`);
                updateDisplay();
            } else {
                // 确保正确复制物品属性，特别是name属性
                const copiedItem = {
                    name: droppedItem.name || '未知物品',
                    type: droppedItem.type,
                    rarity: droppedItem.rarity,
                    price: droppedItem.price,
                    description: droppedItem.description,
                    attack: droppedItem.attack,
                    defense: droppedItem.defense,
                    health: droppedItem.health,
                    mana: droppedItem.mana,
                    critRate: droppedItem.critRate,
                    critDamage: droppedItem.critDamage,
                    speed: droppedItem.speed,
                    luck: droppedItem.luck,
                    effect: droppedItem.effect,
                    requirements: droppedItem.requirements
                };
                gameState.player.inventory.push(copiedItem);
                addLog(`获得了物品：${copiedItem.name}`);
                updateInventoryDisplay();
            }
            
            // 更新任务进度
            updateQuestProgress('collect', 'item');
        }

        // 显示商店
        async function showShop() {
            await showShopPanel();
        }

        // 购买物品
        async function buyItem(type, itemName) {
            // 获取最新的装备配置，与商店显示保持一致
            let equipmentData;
            try {
                equipmentData = await configManager.getEquipmentConfig();
            } catch (error) {
                console.warn('无法加载装备配置，使用默认数据:', error);
                equipmentData = getEquipmentData();
            }
            
            let itemList;
            if (type === 'weapon') {
                itemList = equipmentData.weapons || [];
            } else if (type === 'armor') {
                itemList = equipmentData.armors || [];
            } else if (type === 'accessory') {
                itemList = equipmentData.accessories || [];
            } else if (type === 'potion') {
                itemList = equipmentData.potions || [];
            } else if (type === 'helmet') {
                itemList = equipmentData.helmets || [];
            } else if (type === 'boots') {
                itemList = equipmentData.boots || [];
            }
            
            if (!itemList || itemList.length === 0) {
                addLog(`未知的商品类型或该类型商品为空：${type}`);
                console.error('商品列表为空:', { type, itemName, equipmentData });
                return;
            }
            
            const item = itemList.find(i => i && i.name === itemName);
            
            if (!item) {
                addLog(`找不到商品：${itemName}`);
                console.error('商品查找失败:', { type, itemName, availableItems: itemList.map(i => i?.name) });
                return;
            }
            
            // 检查等级和职业要求
            const requirements = item.requirements || {};
            const requiredLevel = requirements.level || 1;
            const requiredClass = requirements.class || 'all';
            const playerLevel = gameState.player.level || 1;
            const playerClass = gameState.player.class || '';
            
            // 检查等级要求
            if (playerLevel < requiredLevel) {
                const message = `等级不足！需要等级${requiredLevel}，当前等级${playerLevel}`;
                addLog(message);
                showFloatingText(message, 'error');
                return;
            }
            
            // 检查职业要求
            if (requiredClass !== 'all' && requiredClass !== playerClass) {
                const classNames = { warrior: '战士', mage: '法师', taoist: '道士' };
                const requiredClassName = classNames[requiredClass] || requiredClass;
                const playerClassName = classNames[playerClass] || playerClass || '未选择';
                const message = `职业不符！需要${requiredClassName}，当前职业${playerClassName}`;
                addLog(message);
                showFloatingText(message, 'error');
                return;
            }
            
            const price = item.price || 0;
            if (gameState.player.gold >= price) {
                gameState.player.gold -= price;
                gameState.player.inventory.push({...item});
                addLog(`购买了${item.name}，花费${price}金币`);
                showFloatingText(`购买成功！${item.name}`, 'success');
                updateUI();
                await updateShopDisplay(); // 刷新商店显示
            } else {
                const message = `金币不足！需要${price}金币，当前只有${gameState.player.gold}金币`;
                addLog(message);
                showFloatingText(message, 'error');
            }
        }
        
        // 购买养成材料
        function buyCultivationMaterial(materialName, price) {
            if (gameState.player.gold >= price) {
                gameState.player.gold -= price;
                
                // 查找是否已有该材料
                const existingMaterial = gameState.player.materials.find(item => item.name === materialName);
                if (existingMaterial) {
                    existingMaterial.count += 1;
                } else {
                    gameState.player.materials.push({
                        name: materialName,
                        count: 1,
                        description: getMaterialDescription(materialName)
                    });
                }
                
                addLog(`购买了${materialName} x1`);
                showFloatingText(`购买成功！${materialName} x1`, 'success');
                updateUI();
                updateInventoryDisplay();
            } else {
                addLog('金币不足！');
            }
        }
        
        // 获取材料描述
        function getMaterialDescription(materialName) {
            const descriptions = {
                '铁矿石': '基础锻造材料',
                '魔法水晶': '蕴含魔力的水晶',
                '稀有宝石': '珍贵的宝石材料'
            };
            return descriptions[materialName] || '养成材料';
        }

        // 出售物品
        async function sellItem(index) {
            const item = gameState.player.inventory[index];
            const sellPrice = Math.floor(item.price * 0.5);
            
            gameState.player.gold += sellPrice;
            
            // 显示金币获得飘字效果
            showFloatingText(`+${sellPrice} 金币`, 'gold');
            
            // 更新金币收集任务进度
            updateQuestProgress('collect', 'gold', sellPrice);
            gameState.player.inventory.splice(index, 1);
            
            addLog(`出售了${item.name}，获得${sellPrice}金币`);
            updateUI();
            await showShop(); // 刷新商店显示
        }

        // 添加日志
        function addLog(message) {
            const gameLog = document.getElementById('gameLog');
            const logEntry = document.createElement('div');
            
            // 格式化消息，为不同类型的内容添加颜色
            const formattedMessage = formatLogMessage(message);
            logEntry.innerHTML = `<span class="text-gray-400">[${new Date().toLocaleTimeString()}]</span> ${formattedMessage}`;
            
            gameLog.appendChild(logEntry);
            gameLog.scrollTop = gameLog.scrollHeight;
        }
        
        // 格式化日志消息，为不同类型的内容添加颜色
        function formatLogMessage(message) {
            let formatted = message;
            
            // 首先处理复合消息格式，避免重复着色
            
            // 暴击伤害消息 - 完整处理
            formatted = formatted.replace(/(暴击！)(你|[\u4e00-\u9fa5\w]+)(对)([\u4e00-\u9fa5\w]+)(造成了)(\d+)(点伤害)/g, 
                '<span class="text-red-500 font-bold text-lg">$1</span><span class="text-yellow-400 font-bold">$2</span>$3<span class="text-red-400 font-bold">$4</span>$5<span class="text-red-500 font-bold text-lg">$6</span>$7');
            
            // 普通伤害消息 - 完整处理
            formatted = formatted.replace(/(你|[\u4e00-\u9fa5\w]+)(对)([\u4e00-\u9fa5\w]+)(造成了)(\d+)(点伤害)/g, 
                '<span class="text-yellow-400 font-bold">$1</span>$2<span class="text-red-400 font-bold">$3</span>$4<span class="text-amber-400 font-bold">$5</span>$6');
            
            // 受到伤害消息 - 完整处理
            formatted = formatted.replace(/([\u4e00-\u9fa5\w]+)(对)(你)(造成了)(\d+)(点伤害)/g, 
                '<span class="text-red-400 font-bold">$1</span>$2<span class="text-yellow-400 font-bold">$3</span>$4<span class="text-amber-400 font-bold">$5</span>$6');
            
            // 技能伤害消息 - 完整处理
            formatted = formatted.replace(/(暴击！你使用)([\u4e00-\u9fa5\w]+)(造成了)(\d+)(点伤害)/g, 
                '<span class="text-red-500 font-bold text-lg">暴击！</span><span class="text-yellow-400 font-bold">你</span>使用<span class="text-blue-400 font-bold">$2</span>$3<span class="text-red-500 font-bold text-lg">$4</span>$5');
            
            formatted = formatted.replace(/(你使用)([\u4e00-\u9fa5\w]+)(造成了)(\d+)(点伤害)/g, 
                '<span class="text-yellow-400 font-bold">你</span>使用<span class="text-blue-400 font-bold">$2</span>$3<span class="text-amber-400 font-bold">$4</span>$5');
            
            // 处理其他单独的元素（只处理未被上面规则匹配的）
            
            // 玩家名字 - 黄色 (只匹配独立的"你")
            formatted = formatted.replace(/\b你\b/g, '<span class="text-yellow-400 font-bold">你</span>');
            
            // 装备名字 - 根据稀有度显示不同颜色
            formatted = formatted.replace(/(传说|神器|史诗|传奇)([\u4e00-\u9fa5\w\s]*)(剑|刀|斧|锤|弓|杖|盾|甲|盔|靴|戒指|项链|护符|饰品|武器|防具|装备)/g, '<span class="text-orange-400 font-bold">$&</span>');
            formatted = formatted.replace(/(稀有|精良|优秀)([\u4e00-\u9fa5\w\s]*)(剑|刀|斧|锤|弓|杖|盾|甲|盔|靴|戒指|项链|护符|饰品|武器|防具|装备)/g, '<span class="text-purple-400 font-bold">$&</span>');
            formatted = formatted.replace(/([\u4e00-\u9fa5\w]*)(剑|刀|斧|锤|弓|杖|盾|甲|盔|靴|戒指|项链|护符|饰品|武器|防具|装备)/g, '<span class="text-blue-400 font-bold">$&</span>');
            
            // 物品名字 - 绿色
            formatted = formatted.replace(/(药水|药剂|卷轴|宝石|材料|矿石|水晶|精华|碎片|符文|魔法石|生命药水|魔法药水|治疗药水|恢复药水)/g, '<span class="text-green-400 font-bold">$&</span>');
            
            // 治疗/恢复 - 绿色
            formatted = formatted.replace(/(恢复了|治疗了|回复了)(\d+)(点生命|点魔法|点血量|点蓝量)/g, '$1<span class="text-emerald-500 font-bold">$2</span>$3');
            
            // 经验值 - 青色
            formatted = formatted.replace(/(获得|得到)(\d+)(经验|点经验)/g, '$1<span class="text-cyan-300 font-bold">$2</span>$3');
            
            // 金币 - 黄色
            formatted = formatted.replace(/(获得|得到|花费|消耗)(\d+)(金币)/g, '$1<span class="text-yellow-300 font-bold">$2</span>$3');
            
            // 等级提升 - 亮黄色
            formatted = formatted.replace(/(升级|等级提升|当前等级：)(\d+)/g, '$1<span class="text-yellow-200 font-bold text-lg">$2</span>');
            
            // 重要事件 - 特殊颜色
            formatted = formatted.replace(/(恭喜|成功|完成|获得称号|激活称号)/g, '<span class="text-green-300 font-bold">$&</span>');
            formatted = formatted.replace(/(失败|死亡|被击败|逃跑)/g, '<span class="text-red-300 font-bold">$&</span>');
            formatted = formatted.replace(/(警告|注意|不足)/g, '<span class="text-orange-300 font-bold">$&</span>');
            
            return formatted;
        }
        
        // 飘字效果函数
        function showFloatingText(text, type = 'success', x = null, y = null) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${type}`;
            floatingText.textContent = text;
            
            // 如果没有指定位置，使用屏幕中央偏上的位置
            if (x === null || y === null) {
                x = window.innerWidth / 2;
                y = window.innerHeight / 3;
            }
            
            floatingText.style.left = x + 'px';
            floatingText.style.top = y + 'px';
            floatingText.style.transform = 'translateX(-50%)';
            
            document.body.appendChild(floatingText);
            
            // 2秒后移除元素
            setTimeout(() => {
                if (floatingText.parentNode) {
                    floatingText.parentNode.removeChild(floatingText);
                }
            }, 2000);
        }

        // 添加浮动文本函数（兼容性函数）
        function addFloatingText(text, type = 'success', x = null, y = null) {
            showFloatingText(text, type, x, y);
        }



        // 显示养成系统面板
        // 弹窗式养成系统
        function showCultivationPanelModal() {
            document.getElementById('cultivationModal').classList.remove('hidden');
            updateCultivationDisplayModal();
            // 默认显示爆率提升的材料需求
            showUpgradeMaterials('dropRate', gameState.player.cultivation.dropRate.level);
        }
        
        function hideCultivationPanelModal() {
            document.getElementById('cultivationModal').classList.add('hidden');
        }
        
        function updateCultivationDisplayModal() {
            const cultivation = gameState.player.cultivation;
            
            // 更新爆率提升
            document.getElementById('modalDropRateLevel').textContent = cultivation.dropRate.level;
            document.getElementById('modalDropRateExp').textContent = `${cultivation.dropRate.exp}/${getRequiredExp(cultivation.dropRate.level)}`;
            document.getElementById('modalDropRateEffect').textContent = `+${cultivation.dropRate.level * 10}%`;
            
            // 更新伤害提升
            document.getElementById('modalDamageLevel').textContent = cultivation.damage.level;
            document.getElementById('modalDamageExp').textContent = `${cultivation.damage.exp}/${getRequiredExp(cultivation.damage.level)}`;
            document.getElementById('modalDamageEffect').textContent = `+${cultivation.damage.level * 5}%`;
            
            // 更新鞭尸概率
            document.getElementById('modalWhipCorpseLevel').textContent = cultivation.whipCorpse.level;
            document.getElementById('modalWhipCorpseExp').textContent = `${cultivation.whipCorpse.exp}/${getRequiredExp(cultivation.whipCorpse.level)}`;
            document.getElementById('modalWhipCorpseEffect').textContent = `${cultivation.whipCorpse.level * 5}%`;
        }

        // 更新养成系统显示
        function updateCultivationDisplay() {
            const cultivation = gameState.player.cultivation;
            
            // 更新爆率提升
            document.getElementById('dropRateLevel').textContent = cultivation.dropRate.level;
            document.getElementById('dropRateExp').textContent = `${cultivation.dropRate.exp}/${getRequiredExp(cultivation.dropRate.level)}`;
            document.getElementById('dropRateEffect').textContent = `+${cultivation.dropRate.level * 10}%`;
            
            // 更新伤害提升
            document.getElementById('damageLevel').textContent = cultivation.damage.level;
            document.getElementById('damageExp').textContent = `${cultivation.damage.exp}/${getRequiredExp(cultivation.damage.level)}`;
            document.getElementById('damageEffect').textContent = `+${cultivation.damage.level * 5}%`;
            
            // 更新鞭尸概率
            document.getElementById('whipCorpseLevel').textContent = cultivation.whipCorpse.level;
            document.getElementById('whipCorpseExp').textContent = `${cultivation.whipCorpse.exp}/${getRequiredExp(cultivation.whipCorpse.level)}`;
            document.getElementById('whipCorpseEffect').textContent = `${cultivation.whipCorpse.level * 5}%`;
        }

        // 获取升级所需经验
        function getRequiredExp(level) {
            return 100 + level * 50;
        }

        // 升级养成系统
        function upgradeCultivation(type) {
            const cultivation = gameState.player.cultivation[type];
            const requiredMaterials = getUpgradeMaterials(type, cultivation.level);
            
            // 检查材料是否足够
            let canUpgrade = true;
            for (const material of requiredMaterials) {
                const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                if (!playerMaterial || playerMaterial.count < material.quantity) {
                    canUpgrade = false;
                    break;
                }
            }
            
            if (!canUpgrade) {
                addLog('材料不足，无法升级！');
                showUpgradeMaterials(type, cultivation.level);
                return;
            }
            
            // 消耗材料
            for (const material of requiredMaterials) {
                const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                playerMaterial.count -= material.quantity;
                if (playerMaterial.count <= 0) {
                    const index = gameState.player.materials.indexOf(playerMaterial);
                    gameState.player.materials.splice(index, 1);
                }
            }
            
            // 增加经验
            cultivation.exp += 50;
            const requiredExp = getRequiredExp(cultivation.level);
            
            if (cultivation.exp >= requiredExp) {
                cultivation.level++;
                cultivation.exp -= requiredExp;
                addLog(`${getTypeName(type)}升级到${cultivation.level}级！`);
            } else {
                addLog(`${getTypeName(type)}获得50点经验`);
            }
            
            updateCultivationDisplay();
            updateCultivationDisplayModal(); // 更新弹窗显示
            updateInventoryDisplay();
            updateUI(); // 更新所有界面元素，包括受养成系统影响的属性显示
            // 显示升级后的材料需求
            showUpgradeMaterials(type, cultivation.level);
        }

        // 获取升级材料需求
        function getUpgradeMaterials(type, level) {
            const baseMaterials = [
                { name: '铁矿石', quantity: 2 + level },
                { name: '魔法水晶', quantity: 1 + Math.floor(level / 2) }
            ];
            
            if (level >= 5) {
                baseMaterials.push({ name: '稀有宝石', quantity: Math.floor(level / 5) });
            }
            
            return baseMaterials;
        }

        // 显示升级材料需求
        function showUpgradeMaterials(type, level) {
            const materials = getUpgradeMaterials(type, level);
            // 优先使用弹窗中的元素，如果不存在则使用原来的元素
            const materialsDiv = document.getElementById('modalCultivationMaterials') || document.getElementById('cultivationMaterials');
            
            if (!materialsDiv) {
                console.error('材料显示容器未找到');
                return;
            }
            
            let html = `<div class="font-bold text-white mb-2">${getTypeName(type)}升级需要：</div>`;
            materials.forEach(material => {
                const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                const hasQuantity = playerMaterial ? playerMaterial.count : 0;
                const color = hasQuantity >= material.quantity ? 'text-green-400' : 'text-red-400';
                html += `<div class="${color}">${material.name}: ${hasQuantity}/${material.quantity}</div>`;
            });
            
            materialsDiv.innerHTML = html;
        }

        // 获取类型名称
        function getTypeName(type) {
            const names = {
                'dropRate': '爆率提升',
                'damage': '伤害提升',
                'whipCorpse': '鞭尸概率'
            };
            return names[type] || type;
        }

        // 自动鞭尸判断（击败怪物时自动触发）
        async function autoWhipCorpse(monster) {
            // 检查是否有鞭尸等级
            if (gameState.player.cultivation.whipCorpse.level <= 0) {
                return;
            }
            
            const whipChance = gameState.player.cultivation.whipCorpse.level * 5; // 每级5%概率
            
            if (Math.random() * 100 < whipChance) {
                addLog('鞭尸成功！怪物再次掉落物品！');
                dropEquipment(monster); // 再次掉落
            } else {
                addLog('鞭尸失败...');
            }
        }
        
        // 手动鞭尸功能（已废弃，保留以避免报错）
        function whipCorpse() {
            // 手动鞭尸功能已被自动鞭尸替代
            addLog('鞭尸功能已改为自动触发，无需手动操作');
        }

        // 更新鞭尸按钮显示（已废弃，鞭尸改为自动触发）
        function updateWhipCorpseButton() {
            // 鞭尸按钮已被移除，此函数保留以避免报错
            // const button = document.getElementById('whipCorpseBtn');
            // if (gameState.showWhipCorpse && gameState.player.cultivation.whipCorpse.level > 0) {
            //     button.classList.remove('hidden');
            // } else {
            //     button.classList.add('hidden');
            // }
        }

        // 主线任务配置（按顺序完成）
        const mainQuestChain = [
            {
                id: 1,
                name: '初入江湖',
                description: '装备一件武器开始你的冒险',
                type: 'equip',
                target: 'weapon',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 50, gold: 20 },
                order: 1
            },
            {
                id: 2,
                name: '初试身手',
                description: '击败5只怪物',
                type: 'kill',
                target: 'any',
                targetCount: 5,
                currentCount: 0,
                rewards: { exp: 100, gold: 50 },
                order: 2
            },
            {
                id: 3,
                name: '财富积累',
                description: '收集200金币',
                type: 'collect',
                target: 'gold',
                targetCount: 200,
                currentCount: 0,
                rewards: { exp: 80, gold: 30, item: '铁剑' },
                order: 3
            },
            {
                id: 4,
                name: '森林试炼',
                description: '击败10只森林狼',
                type: 'kill',
                target: '森林狼',
                targetCount: 10,
                currentCount: 0,
                rewards: { exp: 150, gold: 80, item: '皮甲' },
                order: 4
            },
            {
                id: 5,
                name: '实力提升',
                description: '达到3级',
                type: 'level',
                target: 'level',
                targetCount: 3,
                currentCount: 0,
                rewards: { exp: 200, gold: 100, item: '强化药水' },
                order: 5
            },
            {
                id: 6,
                name: '野兽猎手',
                description: '击败8只野猪',
                type: 'kill',
                target: '野猪',
                targetCount: 8,
                currentCount: 0,
                rewards: { exp: 250, gold: 120, item: '野猪牙' },
                order: 6
            },
            {
                id: 7,
                name: '怪物清剿',
                description: '击败30只怪物',
                type: 'kill',
                target: 'any',
                targetCount: 30,
                currentCount: 0,
                rewards: { exp: 300, gold: 150, item: '精钢剑' },
                order: 7
            },
            {
                id: 8,
                name: '亡灵净化',
                description: '击败15只骷髅',
                type: 'kill',
                target: '骷髅',
                targetCount: 15,
                currentCount: 0,
                rewards: { exp: 400, gold: 200, item: '圣水' },
                order: 8
            },
            {
                id: 9,
                name: '勇者之路',
                description: '达到5级',
                type: 'level',
                target: 'level',
                targetCount: 5,
                currentCount: 0,
                rewards: { exp: 500, gold: 250, item: '银剑' },
                order: 9
            },
            {
                id: 10,
                name: '恶魔挑战',
                description: '击败3只恶魔',
                type: 'kill',
                target: '恶魔',
                targetCount: 3,
                currentCount: 0,
                rewards: { exp: 600, gold: 300, item: '恶魔之角' },
                order: 10
            },
            {
                id: 11,
                name: 'Boss挑战',
                description: '击败任意Boss怪物',
                type: 'kill',
                target: 'boss',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 800, gold: 400, item: 'Boss战利品箱' },
                order: 11
            },
            {
                id: 12,
                name: '屠龙勇士',
                description: '击败1只龙',
                type: 'kill',
                target: '龙',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 1500, gold: 800, item: '龙鳞甲' },
                order: 12
            }
        ];

        // 支线任务配置（可选完成）
        const sideQuestTemplates = {
            killStreak: {
                id: 'side_kill_streak_1',
                name: '连击大师',
                description: '连续击败30只怪物不死亡',
                type: 'killStreak',
                target: 'any',
                targetCount: 30,
                currentCount: 0,
                rewards: { exp: 500, gold: 300, item: '连击戒指' },
                level: 4
            },
            goldCollector: {
                id: 'side_gold_collector',
                name: '黄金猎人',
                description: '收集2000金币',
                type: 'collect',
                target: 'gold',
                targetCount: 2000,
                currentCount: 0,
                rewards: { exp: 400, gold: 200, item: '黄金戒指' },
                level: 3
            }
        };

        // 称号配置
        const titleTemplates = {
            noviceKiller: {
                id: 'novice_killer',
                name: '新手杀手',
                description: '击败100只怪物',
                rarity: 'common',
                effects: { attack: [2, 3], critRate: 1 },
                condition: { type: 'kill', count: 100 }
            },
            goldCollector: {
                id: 'gold_collector',
                name: '黄金收集者',
                description: '累计获得10000金币',
                rarity: 'rare',
                effects: { goldBonus: 10 },
                condition: { type: 'gold', count: 10000 }
            },
            levelMaster: {
                id: 'level_master',
                name: '等级大师',
                description: '达到10级',
                rarity: 'epic',
                effects: { hp: 50, mp: 30, attack: [5, 8] },
                condition: { type: 'level', count: 10 }
            },
            legendaryWarrior: {
                id: 'legendary_warrior',
                name: '传奇战士',
                description: '击败传奇怪物',
                rarity: 'legendary',
                effects: { attack: [10, 15], critRate: 5, critDamage: 20 },
                condition: { type: 'kill_boss', count: 1 }
            },
            dragonSlayer: {
                id: 'dragon_slayer',
                name: '屠龙者',
                description: '击败龙类怪物',
                rarity: 'mythic',
                effects: { attack: [15, 25], critRate: 10, critDamage: 30, dragonDamage: 50 },
                condition: { type: 'kill_dragon', count: 1 }
            }
        };

        // 显示任务系统面板
        function showQuestPanel() {
            // monsterArea已删除
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            // saveArea已移除
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('titleArea').classList.add('hidden');
            document.getElementById('questArea').classList.remove('hidden');
            updateQuestDisplay();
        }

        // 隐藏任务系统面板
        function hideQuestPanel() {
            document.getElementById('questArea').classList.add('hidden');
        }

        // 显示称号系统面板
        function showTitlePanel() {
            // monsterArea已删除
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            // saveArea已移除
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('questArea').classList.add('hidden');
            document.getElementById('titleArea').classList.remove('hidden');
            updateTitleDisplay();
        }

        // 隐藏称号系统面板
        function hideTitlePanel() {
            document.getElementById('titleArea').classList.add('hidden');
        }

        // 更新任务显示
        function updateQuestDisplay() {
            updateAvailableQuests();
            updateActiveQuests();
            updateCompletedQuests();
            updateMainQuestDisplay(); // 更新主线任务显示
        }
        
        // 更新主线任务显示区域
        function updateMainQuestDisplay() {
            console.log('更新主线任务显示...');
            console.log('当前任务状态:', {
                active: gameState.player.quests.active.filter(q => isMainQuest(q.id)),
                available: gameState.player.quests.available.filter(q => isMainQuest(q.id)),
                completed: gameState.player.quests.completed.filter(q => isMainQuest(q.id))
            });
            
            const titleElement = document.getElementById('mainQuestTitle');
            const descriptionElement = document.getElementById('mainQuestDescription');
            const progressElement = document.getElementById('mainQuestProgress');
            const rewardElement = document.getElementById('mainQuestReward');
            
            // 查找当前进行中的主线任务
            const activeMainQuest = gameState.player.quests.active.find(q => isMainQuest(q.id));
            
            if (activeMainQuest) {
                console.log('显示进行中的主线任务:', activeMainQuest);
                titleElement.textContent = activeMainQuest.name;
                descriptionElement.textContent = activeMainQuest.description;
                progressElement.textContent = `进度: ${Math.min(activeMainQuest.currentCount, activeMainQuest.targetCount)}/${activeMainQuest.targetCount}`;
                
                let rewardText = '';
                if (activeMainQuest.rewards.exp) rewardText += `经验+${activeMainQuest.rewards.exp}`;
                if (activeMainQuest.rewards.gold) rewardText += ` 金币+${activeMainQuest.rewards.gold}`;
                if (activeMainQuest.rewards.item) rewardText += ` ${activeMainQuest.rewards.item}`;
                rewardElement.textContent = `奖励: ${rewardText}`;
                
                // 如果任务完成，高亮显示并显示提交提示
                const isCompleted = activeMainQuest.currentCount >= activeMainQuest.targetCount;
                const displayElement = document.getElementById('mainQuestDisplay');
                const submitHintElement = document.getElementById('mainQuestSubmitHint');
                
                if (isCompleted) {
                    displayElement.classList.remove('border-yellow-500');
                    displayElement.classList.add('border-green-500');
                    progressElement.classList.remove('text-blue-400');
                    progressElement.classList.add('text-green-400');
                    submitHintElement.classList.remove('hidden');
                    submitHintElement.textContent = '点击提交任务';
                } else {
                    displayElement.classList.remove('border-green-500');
                    displayElement.classList.add('border-yellow-500');
                    progressElement.classList.remove('text-green-400');
                    progressElement.classList.add('text-blue-400');
                    submitHintElement.classList.add('hidden');
                }
            } else {
                // 查找下一个可接取的主线任务
                const availableMainQuest = gameState.player.quests.available.find(q => isMainQuest(q.id));
                const submitHintElement = document.getElementById('mainQuestSubmitHint');
                
                console.log('没有进行中的主线任务，查找可接取任务:', availableMainQuest);
                
                if (availableMainQuest) {
                    console.log('显示可接取的主线任务:', availableMainQuest);
                    titleElement.textContent = availableMainQuest.name;
                    descriptionElement.textContent = availableMainQuest.description;
                    progressElement.textContent = '点击接取任务';
                    
                    let rewardText = '';
                    if (availableMainQuest.rewards.exp) rewardText += `经验+${availableMainQuest.rewards.exp}`;
                    if (availableMainQuest.rewards.gold) rewardText += ` 金币+${availableMainQuest.rewards.gold}`;
                    if (availableMainQuest.rewards.item) rewardText += ` ${availableMainQuest.rewards.item}`;
                    rewardElement.textContent = `奖励: ${rewardText}`;
                    
                    const displayElement = document.getElementById('mainQuestDisplay');
                    displayElement.classList.remove('border-green-500');
                    displayElement.classList.add('border-yellow-500');
                    progressElement.classList.remove('text-green-400');
                    progressElement.classList.add('text-blue-400');
                    submitHintElement.classList.remove('hidden');
                    submitHintElement.textContent = '点击接取任务';
                } else {
                    // 检查是否真的所有主线任务都完成了
                    const completedMainQuests = gameState.player.quests.completed.filter(q => isMainQuest(q.id));
                    const totalMainQuests = mainQuestChainConfig ? mainQuestChainConfig.length : 0;
                    
                    console.log('没有可接取的主线任务，检查完成状态:', {
                        completedCount: completedMainQuests.length,
                        totalQuests: totalMainQuests,
                        isReallyCompleted: completedMainQuests.length >= totalMainQuests,
                        availableQuestsTotal: gameState.player.quests.available.length,
                        availableQuests: gameState.player.quests.available,
                        mainQuestChainConfig: mainQuestChainConfig
                    });
                    
                    if (completedMainQuests.length >= totalMainQuests && totalMainQuests > 0) {
                        // 确实所有主线任务都完成了
                        console.log('✅ 确认所有主线任务已完成');
                        titleElement.textContent = '主线任务';
                        descriptionElement.textContent = '恭喜！所有主线任务已完成！';
                        progressElement.textContent = '任务完成';
                        rewardElement.textContent = '感谢您的游玩！';
                        
                        const displayElement = document.getElementById('mainQuestDisplay');
                        displayElement.classList.remove('border-yellow-500');
                        displayElement.classList.add('border-green-500');
                        progressElement.classList.remove('text-blue-400');
                        progressElement.classList.add('text-green-400');
                        submitHintElement.classList.add('hidden');
                    } else {
                        // 任务系统异常，应该有可接取的任务但没有找到
                        console.error('❌ 任务系统异常：应该有可接取的主线任务但没有找到！');
                        console.error('尝试强制刷新任务系统...');
                        
                        titleElement.textContent = '主线任务';
                        descriptionElement.textContent = '任务系统正在刷新，请稍候...';
                        progressElement.textContent = '系统刷新中';
                        rewardElement.textContent = '请等待任务加载';
                        
                        const displayElement = document.getElementById('mainQuestDisplay');
                        displayElement.classList.remove('border-green-500');
                        displayElement.classList.add('border-yellow-500');
                        progressElement.classList.remove('text-green-400');
                        progressElement.classList.add('text-blue-400');
                        submitHintElement.classList.add('hidden');
                        
                        // 延迟强制刷新任务系统
                        setTimeout(() => {
                            console.log('强制重新初始化任务系统...');
                            initializeQuests();
                            updateMainQuestDisplay();
                        }, 1000);
                    }
                }
            }
        }

        // 更新可接任务
        function updateAvailableQuests() {
            const container = document.getElementById('modalAvailableQuests');
            const availableQuests = gameState.player.quests.available;
            
            if (availableQuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无可接任务</div>';
                return;
            }
            
            let html = '';
            availableQuests.forEach(quest => {
                html += `
                    <div class="bg-gray-700 p-3 rounded border border-blue-400">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold text-blue-400">${quest.name}</h5>
                                <p class="text-sm text-gray-300 mt-1">${quest.description}</p>
                                <div class="text-xs text-yellow-400 mt-2">
                                    奖励: ${quest.rewards.exp}经验 ${quest.rewards.gold}金币
                                    ${quest.rewards.item ? ` + ${quest.rewards.item}` : ''}
                                </div>
                            </div>
                            <button onclick="acceptQuest('${quest.id}')" class="btn-primary px-3 py-1 rounded text-sm ml-2">接取</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 更新进行中任务
        function updateActiveQuests() {
            const container = document.getElementById('modalActiveQuests');
            const activeQuests = gameState.player.quests.active;
            
            if (activeQuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无进行中任务</div>';
                return;
            }
            
            let html = '';
            activeQuests.forEach(quest => {
                const progress = Math.min(quest.currentCount, quest.targetCount);
                const progressPercent = (progress / quest.targetCount * 100).toFixed(1);
                const isCompleted = quest.currentCount >= quest.targetCount;
                
                html += `
                    <div class="bg-gray-700 p-3 rounded border ${isCompleted ? 'border-green-400' : 'border-yellow-400'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold ${isCompleted ? 'text-green-400' : 'text-yellow-400'}">${quest.name}</h5>
                                <p class="text-sm text-gray-300 mt-1">${quest.description}</p>
                                <div class="text-sm mt-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">进度:</span>
                                        <span class="${isCompleted ? 'text-green-400' : 'text-yellow-400'}">${progress}/${quest.targetCount} (${progressPercent}%)</span>
                                    </div>
                                </div>
                                <div class="text-xs text-yellow-400 mt-1">
                                    奖励: ${quest.rewards.exp}经验 ${quest.rewards.gold}金币
                                    ${quest.rewards.item ? ` + ${quest.rewards.item}` : ''}
                                </div>
                            </div>
                            ${isCompleted ? `<button onclick="completeQuest('${quest.id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm ml-2">完成</button>` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 更新已完成任务
        function updateCompletedQuests() {
            const container = document.getElementById('modalCompletedQuests');
            const completedQuests = gameState.player.quests.completed;
            
            if (completedQuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无已完成任务</div>';
                return;
            }
            
            let html = '';
            completedQuests.slice(-10).forEach(quest => { // 只显示最近10个
                html += `
                    <div class="bg-gray-700 p-2 rounded border border-green-400">
                        <h5 class="font-bold text-green-400 text-sm">${quest.name}</h5>
                        <p class="text-xs text-gray-300">${quest.description}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 接取任务
        function acceptQuest(questId) {
            const questIndex = gameState.player.quests.available.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = gameState.player.quests.available[questIndex];
            gameState.player.quests.available.splice(questIndex, 1);
            gameState.player.quests.active.push(quest);
            
            addLog(`接取任务: ${quest.name}`);
            updateQuestDisplay();
            
            // 立即刷新主线任务显示
            updateMainQuestDisplay();
            
            // 任务接取后自动保存游戏状态
            autoSaveGame();
        }

        // 完成任务
        function completeQuest(questId) {
            const questIndex = gameState.player.quests.active.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = gameState.player.quests.active[questIndex];
            if (quest.currentCount < quest.targetCount) return;
            
            // 发放奖励
            if (quest.rewards.exp) {
                gameState.player.exp += quest.rewards.exp;
                addLog(`获得 ${quest.rewards.exp} 经验值`);
            }
            if (quest.rewards.gold) {
                gameState.player.gold += quest.rewards.gold;
                
                // 显示金币获得飘字效果
                showFloatingText(`+${quest.rewards.gold} 金币`, 'gold');
                
                addLog(`获得 ${quest.rewards.gold} 金币`);
            }
            if (quest.rewards.item) {
                const item = findItemByName(quest.rewards.item);
                if (item) {
                    gameState.player.inventory.push({...item});
                    addLog(`获得物品: ${item.name}`);
                }
            }
            
            // 移动任务到已完成
            gameState.player.quests.active.splice(questIndex, 1);
            gameState.player.quests.completed.push(quest);
            
            // 发送任务完成事件到服务器
            sendQuestCompletedToServer({
                questId: quest.id,
                questName: quest.name,
                questType: quest.type,
                rewards: quest.rewards,
                timestamp: Date.now()
            });
            
            addLog(`完成任务: ${quest.name}`);
            showFloatingText('任务完成！', 'success');
            
            // 如果完成的是主线任务，延迟刷新任务系统以解锁下一个任务
            if (isMainQuest(quest.id)) {
                addLog(`🎯 主线任务 "${quest.name}" 已完成！`);
                showFloatingText('主线任务完成！', 'legendary');
                
                // 延迟刷新任务系统，让initializeQuests重新计算下一个任务
                setTimeout(() => {
                    initializeQuests();
                    updateQuestDisplay();
                    addLog('任务系统已刷新，检查新任务');
                }, 100);
            }
            
            checkLevelUp();
            updateUI();
            updateQuestDisplay();
            
            // 强制刷新主线任务显示
            setTimeout(() => {
                updateMainQuestDisplay();
                updateQuestDisplay();
                console.log('任务完成后UI已强制刷新');
            }, 200);
            
            // 任务完成后自动保存游戏状态
            autoSaveGame();
        }

        // 更新任务进度
        function updateQuestProgress(type, target, count = 1) {
            let hasUpdate = false;
            let completedQuests = [];
            
            gameState.player.quests.active.forEach(quest => {
                if (quest.type === type && (quest.target === target || quest.target === 'any')) {
                    quest.currentCount += count;
                    hasUpdate = true;
                    if (quest.currentCount >= quest.targetCount) {
                        addLog(`任务 "${quest.name}" 已完成！`);
                        showFloatingText('任务可提交！', 'success');
                        completedQuests.push(quest);
                    }
                }
            });
            
            // 如果有任务进度更新，立即刷新所有任务UI
            if (hasUpdate) {
                updateActiveQuests();
                updateMainQuestDisplay(); // 实时更新主线任务显示
                
                // 如果有任务完成，实时刷新任务系统
                if (completedQuests.length > 0) {
                    // 延迟一小段时间后刷新，确保UI更新完成
                    setTimeout(() => {
                        initializeQuests();
                        updateQuestDisplay(); // 完整刷新所有任务面板
                        addLog('任务系统已实时刷新');
                    }, 100);
                }
                
                // 任务进度更新后自动保存游戏状态
                autoSaveGame();
            }
        }

        // 加载主线任务配置
        let mainQuestChainConfig = null;
        
        async function loadMainQuestConfig() {
            try {
                const response = await fetch('./configs/main-quest-config-numeric.json');
                if (response.ok) {
                    const config = await response.json();
                    mainQuestChainConfig = config.data.mainQuests;
                    console.log('主线任务配置加载成功，共', mainQuestChainConfig.length, '个任务');
                    addLog(`主线任务配置已更新，共${mainQuestChainConfig.length}个任务`);
                    return true;
                } else {
                    throw new Error('配置文件加载失败');
                }
            } catch (error) {
                console.warn('主线任务配置加载失败，使用默认配置:', error);
                mainQuestChainConfig = mainQuestChain; // 使用默认配置
                return false;
            }
        }
        
        // 初始化任务系统（主线任务）
        // 辅助函数：判断是否为主线任务（支持数字ID和字符串ID）
        function isMainQuest(questId) {
            if (!questId) return false;
            // 支持数字ID（1-20）和字符串ID（main_quest_1等）
            return (typeof questId === 'number' && questId >= 1 && questId <= 20) || 
                   (typeof questId === 'string' && questId.startsWith('main_quest_'));
        }
        
        // 辅助函数：判断是否为支线任务
        function isSideQuest(questId) {
            if (!questId) return false;
            // 支线任务通常以字符串形式存在，以side_开头
            return (typeof questId === 'string' && questId.startsWith('side_'));
        }

        // 数据迁移函数：将旧格式的字符串ID转换为新格式的数字ID
        function migrateQuestIds() {
            console.log('开始检查任务ID格式迁移...');
            
            // 迁移映射表：字符串ID -> 数字ID
            const idMigrationMap = {
                'main_quest_1': 1, 'main_quest_2': 2, 'main_quest_3': 3, 'main_quest_4': 4,
                'main_quest_5': 5, 'main_quest_6': 6, 'main_quest_7': 7, 'main_quest_8': 8,
                'main_quest_9': 9, 'main_quest_10': 10, 'main_quest_11': 11, 'main_quest_12': 12,
                'main_quest_13': 13, 'main_quest_14': 14, 'main_quest_15': 15, 'main_quest_16': 16,
                'main_quest_17': 17, 'main_quest_18': 18, 'main_quest_19': 19, 'main_quest_20': 20
            };
            
            let migrationCount = 0;
            
            // 迁移completed任务
            gameState.player.quests.completed.forEach(quest => {
                if (typeof quest.id === 'string' && idMigrationMap[quest.id]) {
                    console.log(`迁移completed任务ID: ${quest.id} -> ${idMigrationMap[quest.id]}`);
                    quest.id = idMigrationMap[quest.id];
                    migrationCount++;
                }
            });
            
            // 迁移active任务
            gameState.player.quests.active.forEach(quest => {
                if (typeof quest.id === 'string' && idMigrationMap[quest.id]) {
                    console.log(`迁移active任务ID: ${quest.id} -> ${idMigrationMap[quest.id]}`);
                    quest.id = idMigrationMap[quest.id];
                    migrationCount++;
                }
            });
            
            // 迁移available任务
            gameState.player.quests.available.forEach(quest => {
                if (typeof quest.id === 'string' && idMigrationMap[quest.id]) {
                    console.log(`迁移available任务ID: ${quest.id} -> ${idMigrationMap[quest.id]}`);
                    quest.id = idMigrationMap[quest.id];
                    migrationCount++;
                }
            });
            
            if (migrationCount > 0) {
                console.log(`✅ 任务ID迁移完成，共迁移${migrationCount}个任务`);
                addLog(`任务ID格式已更新，迁移了${migrationCount}个任务`);
                // 保存迁移后的数据
                saveGame();
            } else {
                console.log('无需迁移任务ID');
            }
        }

        async function initializeQuests() {
            console.log('开始初始化任务系统...');
            
            // 执行数据迁移
            migrateQuestIds();
            
            // 如果还没有加载配置，先加载
            if (!mainQuestChainConfig) {
                console.log('主线任务配置未加载，正在加载...');
                const loadSuccess = await loadMainQuestConfig();
                if (!loadSuccess || !mainQuestChainConfig) {
                    console.warn('配置加载失败，使用默认配置');
                    mainQuestChainConfig = mainQuestChain;
                }
            }
            
            console.log('主线任务配置状态:', {
                configExists: !!mainQuestChainConfig,
                configLength: mainQuestChainConfig ? mainQuestChainConfig.length : 0,
                firstQuest: mainQuestChainConfig ? mainQuestChainConfig[0] : null
            });
            
            // 详细输出当前任务状态
            console.log('当前玩家任务状态详情:', {
                available: gameState.player.quests.available.map(q => ({ id: q.id, name: q.name })),
                active: gameState.player.quests.active.map(q => ({ id: q.id, name: q.name, progress: `${q.currentCount}/${q.targetCount}` })),
                completed: gameState.player.quests.completed.map(q => ({ id: q.id, name: q.name }))
            });
            
            // 清空现有可接任务
            gameState.player.quests.available = [];
            
            // 详细检查completed数组中的每个任务
            console.log('=== 详细检查completed数组 ===');
            gameState.player.quests.completed.forEach((quest, index) => {
                console.log(`completed[${index}]:`, {
                    quest: quest,
                    hasId: !!quest.id,
                    id: quest.id,
                    name: quest.name,
                    type: quest.type,
                    idType: typeof quest.id,
                    isMainQuest: quest.id ? isMainQuest(quest.id) : 'NO_ID'
                });
            });
            
            // 找到下一个可接取的主线任务
            const completedMainQuests = gameState.player.quests.completed.filter(q => isMainQuest(q.id));
            const activeMainQuests = gameState.player.quests.active.filter(q => isMainQuest(q.id));
            
            // 详细输出已完成的主线任务
            console.log('已完成的主线任务详情:', completedMainQuests.map(q => ({ id: q.id, name: q.name })));
            console.log('进行中的主线任务详情:', activeMainQuests.map(q => ({ id: q.id, name: q.name, progress: `${q.currentCount}/${q.targetCount}` })));
            
            // 计算已完成的主线任务数量
            const completedCount = completedMainQuests.length;
            const nextQuestIndex = completedCount; // 下一个任务的索引
            
            console.log('任务状态分析:', {
                completedCount,
                nextQuestIndex,
                activeMainQuestsCount: activeMainQuests.length,
                hasMoreQuests: nextQuestIndex < mainQuestChainConfig.length,
                nextQuestWouldBe: nextQuestIndex < mainQuestChainConfig.length ? mainQuestChainConfig[nextQuestIndex] : null
            });
            
            // 确保配置存在且有任务
            if (!mainQuestChainConfig || mainQuestChainConfig.length === 0) {
                console.error('主线任务配置为空，强制使用默认配置');
                mainQuestChainConfig = mainQuestChain;
            }
            
            // 检查是否需要添加主线任务
            console.log('检查是否需要添加主线任务:', {
                nextQuestIndex,
                configLength: mainQuestChainConfig.length,
                hasMoreQuests: nextQuestIndex < mainQuestChainConfig.length,
                activeMainQuestsCount: activeMainQuests.length,
                shouldAddQuest: nextQuestIndex < mainQuestChainConfig.length && activeMainQuests.length === 0
            });
            
            // 如果还有主线任务未完成，且当前没有进行中的主线任务
            if (nextQuestIndex < mainQuestChainConfig.length && activeMainQuests.length === 0) {
                const nextQuest = {...mainQuestChainConfig[nextQuestIndex]};
                
                // 确保任务有正确的初始状态
                nextQuest.currentCount = 0;
                
                // 检查这个任务是否已经在completed或active中
                const alreadyCompleted = gameState.player.quests.completed.some(q => q.id === nextQuest.id);
                const alreadyActive = gameState.player.quests.active.some(q => q.id === nextQuest.id);
                
                console.log('准备添加任务检查:', {
                    questId: nextQuest.id,
                    questName: nextQuest.name,
                    alreadyCompleted,
                    alreadyActive,
                    shouldAdd: !alreadyCompleted && !alreadyActive
                });
                
                if (!alreadyCompleted && !alreadyActive) {
                    gameState.player.quests.available.push(nextQuest);
                    console.log('✅ 成功添加新的主线任务:', nextQuest);
                    addLog(`新的主线任务可接取: ${nextQuest.name}`);
                } else {
                    console.log('❌ 跳过添加任务，原因:', {
                        alreadyCompleted: alreadyCompleted ? '任务已完成' : false,
                        alreadyActive: alreadyActive ? '任务正在进行' : false
                    });
                }
            } else {
                console.log('没有可添加的主线任务:', {
                    reason: nextQuestIndex >= mainQuestChainConfig.length ? '所有任务已完成' : '有进行中的主线任务',
                    nextQuestIndex,
                    configLength: mainQuestChainConfig.length,
                    activeMainQuestsCount: activeMainQuests.length
                });
            }
            
            // 添加支线任务（如果玩家等级足够）
            const playerLevel = gameState.player.level;
            Object.values(sideQuestTemplates).forEach(questTemplate => {
                if (questTemplate.level <= playerLevel) {
                    const isActive = gameState.player.quests.active.some(q => q.id === questTemplate.id);
                    const isCompleted = gameState.player.quests.completed.some(q => q.id === questTemplate.id);
                    
                    if (!isActive && !isCompleted) {
                        gameState.player.quests.available.push({...questTemplate});
                    }
                }
            });
            
            const mainQuestCount = gameState.player.quests.available.filter(q => isMainQuest(q.id)).length;
            const sideQuestCount = gameState.player.quests.available.filter(q => isSideQuest(q.id)).length;
            
            console.log('任务初始化完成:', {
                mainQuestCount,
                sideQuestCount,
                availableQuests: gameState.player.quests.available.map(q => ({ id: q.id, name: q.name }))
            });
            
            addLog(`任务系统已刷新 - 主线任务: ${mainQuestCount}个, 支线任务: ${sideQuestCount}个`);
        }

        // 自动任务管理系统
        function autoQuestManager() {
            // 已禁用自动接取主线任务，改为手动点击接取
            // autoAcceptMainQuest(); // 已禁用自动接取功能
            
            // 不再自动完成任务，需要玩家手动点击提交
            // autoCompleteQuests(); // 已禁用自动完成功能
        }
        
        // 自动接取主线任务
        function autoAcceptMainQuest() {
            const availableMainQuest = gameState.player.quests.available.find(q => isMainQuest(q.id));
            if (availableMainQuest) {
                // 检查是否已有进行中的主线任务
                const activeMainQuest = gameState.player.quests.active.find(q => isMainQuest(q.id));
                if (!activeMainQuest) {
                    // 自动接取主线任务
                    acceptQuest(availableMainQuest.id);
                    addLog(`🤖 自动接取主线任务: ${availableMainQuest.name}`);
                    showFloatingText('自动接取任务！', 'info');
                }
            }
        }
        
        // 自动完成已达成条件的任务
        function autoCompleteQuests() {
            const completableQuests = gameState.player.quests.active.filter(quest => 
                quest.currentCount >= quest.targetCount
            );
            
            completableQuests.forEach(quest => {
                completeQuest(quest.id);
                addLog(`🤖 自动完成任务: ${quest.name}`);
                showFloatingText('自动完成任务！', 'success');
            });
        }

        // 处理主线任务点击事件
        function handleMainQuestClick() {
            // 查找当前进行中的主线任务
            const activeMainQuest = gameState.player.quests.active.find(q => isMainQuest(q.id));
            
            if (activeMainQuest) {
                const isCompleted = activeMainQuest.currentCount >= activeMainQuest.targetCount;
                
                if (isCompleted) {
                    // 任务已完成，可以提交
                    completeQuest(activeMainQuest.id);
                    addLog(`✅ 手动提交主线任务: ${activeMainQuest.name}`);
                    showFloatingText('任务提交成功！', 'success');
                } else {
                    // 任务未完成，显示提示
                    addLog(`❌ 任务 "${activeMainQuest.name}" 尚未完成，当前进度: ${activeMainQuest.currentCount}/${activeMainQuest.targetCount}`);
                    showFloatingText('任务未完成！', 'warning');
                }
            } else {
                // 查找可接取的主线任务
                const availableMainQuest = gameState.player.quests.available.find(q => isMainQuest(q.id));
                if (availableMainQuest) {
                    // 自动接取主线任务
                    acceptQuest(availableMainQuest.id);
                    addLog(`📋 手动接取主线任务: ${availableMainQuest.name}`);
                    showFloatingText('任务接取成功！', 'info');
                } else {
                    addLog('🎉 所有主线任务已完成！');
                    showFloatingText('主线已完成！', 'legendary');
                }
            }
        }

        // 根据装备名称查找装备
        function findItemByName(itemName) {
            // 在武器中查找
            let item = equipment.weapons.find(w => w.name === itemName);
            if (item) return {...item, type: 'weapon'};
            
            // 在防具中查找
            item = equipment.armors.find(a => a.name === itemName);
            if (item) return {...item, type: 'armor'};
            
            // 在饰品中查找
            item = equipment.accessories.find(a => a.name === itemName);
            if (item) return {...item, type: 'accessory'};
            
            return null;
        }

        // 更新称号显示
        function updateTitleDisplay() {
            updateCurrentTitle();
            updateOwnedTitles();
            updateTitleScrolls();
            updateTitleFragments();
        }

        // 更新当前称号
        function updateCurrentTitle() {
            const container = document.getElementById('modalCurrentTitle');
            const effectContainer = document.getElementById('modalTitleEffect');
            const activeTitle = gameState.player.titles.active;
            
            if (!activeTitle) {
                container.innerHTML = '<div class="text-gray-400">未激活称号</div>';
                effectContainer.innerHTML = '';
                return;
            }
            
            const rarityColors = {
                common: 'text-gray-300',
                rare: 'text-blue-400',
                epic: 'text-purple-400',
                legendary: 'text-orange-400',
                mythic: 'text-red-400'
            };
            
            container.innerHTML = `
                <div class="${rarityColors[activeTitle.rarity]} font-bold text-lg">${activeTitle.name}</div>
                <div class="text-sm text-gray-300 mt-1">${activeTitle.description}</div>
            `;
            
            // 显示称号效果
            let effectHtml = '<div class="font-bold text-green-400 mb-2">称号效果:</div>';
            const effects = activeTitle.effects;
            
            if (effects.attack) {
                effectHtml += `<div class="text-red-400">攻击力: +${effects.attack[0]}-${effects.attack[1]}</div>`;
            }
            if (effects.hp) {
                effectHtml += `<div class="text-green-400">生命值: +${effects.hp}</div>`;
            }
            if (effects.mp) {
                effectHtml += `<div class="text-blue-400">魔法值: +${effects.mp}</div>`;
            }
            if (effects.critRate) {
                effectHtml += `<div class="text-yellow-400">暴击率: +${effects.critRate}%</div>`;
            }
            if (effects.critDamage) {
                effectHtml += `<div class="text-yellow-400">暴击伤害: +${effects.critDamage}%</div>`;
            }
            if (effects.goldBonus) {
                effectHtml += `<div class="text-yellow-400">金币获取: +${effects.goldBonus}%</div>`;
            }
            if (effects.dragonDamage) {
                effectHtml += `<div class="text-red-400">对龙伤害: +${effects.dragonDamage}%</div>`;
            }
            
            effectContainer.innerHTML = effectHtml;
        }

        // 更新拥有的称号
        function updateOwnedTitles() {
            const container = document.getElementById('modalOwnedTitles');
            const ownedTitles = gameState.player.titles.owned;
            
            if (ownedTitles.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无称号</div>';
                return;
            }
            
            const rarityColors = {
                common: 'border-gray-400 text-gray-300',
                rare: 'border-blue-400 text-blue-400',
                epic: 'border-purple-400 text-purple-400',
                legendary: 'border-orange-400 text-orange-400',
                mythic: 'border-red-400 text-red-400'
            };
            
            let html = '';
            ownedTitles.forEach(title => {
                const isActive = gameState.player.titles.active && gameState.player.titles.active.id === title.id;
                // 安全检查稀有度，如果不存在则使用common作为默认值
                const rarity = title.rarity && rarityColors[title.rarity] ? title.rarity : 'common';
                const colorClasses = rarityColors[rarity];
                const textColor = colorClasses.split(' ')[1] || 'text-gray-300';
                
                html += `
                    <div class="bg-gray-700 p-3 rounded border ${colorClasses} ${isActive ? 'bg-gray-600' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold ${textColor}">${title.name} ${isActive ? '(已激活)' : ''}</h5>
                                <p class="text-sm text-gray-300 mt-1">${title.description}</p>
                            </div>
                            ${!isActive ? `<button onclick="activateTitle('${title.id}')" class="btn-primary px-3 py-1 rounded text-sm ml-2">激活</button>` : 
                                         `<button onclick="deactivateTitle()" class="btn-secondary px-3 py-1 rounded text-sm ml-2">取消</button>`}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 更新称号卷轴
        function updateTitleScrolls() {
            const container = document.getElementById('modalTitleScrolls');
            const scrolls = gameState.player.titles.scrolls;
            
            if (scrolls.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无称号卷轴</div>';
                return;
            }
            
            const rarityColors = {
                common: 'border-gray-400 text-gray-300',
                rare: 'border-blue-400 text-blue-400',
                epic: 'border-purple-400 text-purple-400',
                legendary: 'border-orange-400 text-orange-400',
                mythic: 'border-red-400 text-red-400'
            };
            
            let html = '';
            scrolls.forEach((scroll, index) => {
                // 安全检查稀有度，如果不存在则使用common作为默认值
                const rarity = scroll.rarity && rarityColors[scroll.rarity] ? scroll.rarity : 'common';
                const colorClasses = rarityColors[rarity];
                const textColor = colorClasses.split(' ')[1] || 'text-gray-300';
                
                html += `
                    <div class="bg-gray-700 p-3 rounded border ${colorClasses}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold ${textColor}">${scroll.name}卷轴</h5>
                                <p class="text-sm text-gray-300 mt-1">${scroll.description}</p>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button onclick="useTitleScroll(${index})" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">使用</button>
                                <button onclick="decomposeTitleScroll(${index})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">分解</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 激活称号
        function activateTitle(titleId) {
            const title = gameState.player.titles.owned.find(t => t.id === titleId);
            if (!title) return;
            
            gameState.player.titles.active = title;
            addLog(`激活称号: ${title.name}`);
            showFloatingText('称号激活！', 'success');
            
            updateTitleDisplay();
            updateDisplay(); // 更新属性显示
            updatePlayerTitleOnMap(); // 更新地图上的称号显示
        }

        // 取消激活称号
        function deactivateTitle() {
            if (!gameState.player.titles.active) return;
            
            const titleName = gameState.player.titles.active.name;
            gameState.player.titles.active = null;
            addLog(`取消激活称号: ${titleName}`);
            
            updateTitleDisplay();
            updateDisplay(); // 更新属性显示
            updatePlayerTitleOnMap(); // 更新地图上的称号显示
        }

        // 使用称号卷轴
        function useTitleScroll(index) {
            const scroll = gameState.player.titles.scrolls[index];
            if (!scroll) return;
            
            // 检查是否已拥有该称号
            const alreadyOwned = gameState.player.titles.owned.find(t => t.id === scroll.id);
            if (alreadyOwned) {
                addLog('你已经拥有这个称号了！');
                return;
            }
            
            // 添加称号到拥有列表
            gameState.player.titles.owned.push({...scroll});
            gameState.player.titles.scrolls.splice(index, 1);
            
            addLog(`获得称号: ${scroll.name}`);
            showFloatingText('获得新称号！', 'craft');
            
            updateTitleDisplay();
            updateInventoryDisplay();
        }
        
        // 分解称号卷轴
        function decomposeTitleScroll(index) {
            const scroll = gameState.player.titles.scrolls[index];
            if (!scroll) return;
            
            // 根据稀有度确定分解获得的碎片数量
            const fragmentsMap = {
                common: 1,
                rare: 2,
                epic: 3,
                legendary: 4,
                mythic: 5
            };
            
            const fragments = fragmentsMap[scroll.rarity] || 1;
            gameState.player.titles.fragments += fragments;
            gameState.player.titles.scrolls.splice(index, 1);
            
            addLog(`分解 ${scroll.name}卷轴，获得 ${fragments} 个称号碎片`);
            showFloatingText(`+${fragments} 称号碎片`, 'craft');
            
            updateTitleDisplay();
         }
         
         // 更新称号碎片显示
         function updateTitleFragments() {
             const fragmentsElement = document.getElementById('modalTitleFragments');
             if (fragmentsElement) {
                 const fragments = gameState.player.titles.fragments || 0;
                 fragmentsElement.textContent = fragments;
             }
             
             updateSpecialTitles();
         }
         
         // 特殊称号模板
         const specialTitleTemplates = {
             fragmentCollector: {
                 id: 'fragmentCollector',
                 name: '碎片收集者',
                 description: '通过收集称号碎片获得的特殊称号',
                 rarity: 'epic',
                 cost: 10,
                 effects: {
                     goldBonus: 15,
                     critRate: 5
                 }
             },
             fragmentMaster: {
                 id: 'fragmentMaster',
                 name: '碎片大师',
                 description: '称号碎片的终极掌控者',
                 rarity: 'legendary',
                 cost: 25,
                 effects: {
                     goldBonus: 25,
                     critRate: 8,
                     critDamage: 20
                 }
             },
             fragmentLord: {
                 id: 'fragmentLord',
                 name: '碎片领主',
                 description: '传说中的碎片之王',
                 rarity: 'mythic',
                 cost: 50,
                 effects: {
                     goldBonus: 40,
                     critRate: 12,
                     critDamage: 35,
                     attack: [10, 15]
                 }
             }
         };
         
         // 更新特殊称号显示
         function updateSpecialTitles() {
             const container = document.getElementById('modalSpecialTitles');
             const fragments = gameState.player.titles.fragments;
             
             const rarityColors = {
                 epic: 'border-purple-400 text-purple-400',
                 legendary: 'border-orange-400 text-orange-400',
                 mythic: 'border-red-400 text-red-400'
             };
             
             let html = '';
             Object.values(specialTitleTemplates).forEach(template => {
                 const alreadyOwned = gameState.player.titles.owned.find(t => t.id === template.id);
                 const canAfford = fragments >= template.cost;
                 const colorClasses = rarityColors[template.rarity];
                 const textColor = colorClasses.split(' ')[1];
                 
                 if (!alreadyOwned) {
                     html += `
                         <div class="bg-gray-700 p-2 rounded border ${colorClasses} ${!canAfford ? 'opacity-50' : ''}">
                             <div class="flex justify-between items-center">
                                 <div class="flex-1">
                                     <h6 class="font-bold ${textColor} text-sm">${template.name}</h6>
                                     <p class="text-xs text-gray-300">${template.description}</p>
                                     <p class="text-xs text-yellow-400">需要: ${template.cost} 碎片</p>
                                 </div>
                                 <button onclick="exchangeSpecialTitle('${template.id}')" 
                                         class="${canAfford ? 'bg-cyan-600 hover:bg-cyan-700' : 'bg-gray-600 cursor-not-allowed'} text-white px-2 py-1 rounded text-xs" 
                                         ${!canAfford ? 'disabled' : ''}>兑换</button>
                             </div>
                         </div>
                     `;
                 } else {
                     html += `
                         <div class="bg-gray-700 p-2 rounded border ${colorClasses} opacity-50">
                             <div class="text-center">
                                 <h6 class="font-bold ${textColor} text-sm">${template.name}</h6>
                                 <p class="text-xs text-green-400">已拥有</p>
                             </div>
                         </div>
                     `;
                 }
             });
             
             if (html === '') {
                 html = '<div class="text-gray-400 text-center py-2 text-sm">暂无可兑换称号</div>';
             }
             
             container.innerHTML = html;
         }
         
         // 兑换特殊称号
         function exchangeSpecialTitle(templateId) {
             const template = specialTitleTemplates[templateId];
             if (!template) return;
             
             const fragments = gameState.player.titles.fragments;
             if (fragments < template.cost) {
                 addLog('称号碎片不足！');
                 return;
             }
             
             const alreadyOwned = gameState.player.titles.owned.find(t => t.id === template.id);
             if (alreadyOwned) {
                 addLog('你已经拥有这个称号了！');
                 return;
             }
             
             gameState.player.titles.fragments -= template.cost;
             gameState.player.titles.owned.push({...template});
             
             addLog(`兑换成功！获得称号: ${template.name}`);
             showFloatingText('获得特殊称号！', 'craft');
             
             updateTitleDisplay();
         }
 
         // 检查称号条件
        function checkTitleConditions() {
            Object.values(titleTemplates).forEach(titleTemplate => {
                // 检查是否已拥有
                const alreadyOwned = gameState.player.titles.owned.find(t => t.id === titleTemplate.id);
                if (alreadyOwned) return;
                
                // 检查是否已有卷轴
                const hasScroll = gameState.player.titles.scrolls.find(s => s.id === titleTemplate.id);
                if (hasScroll) return;
                
                let conditionMet = false;
                const condition = titleTemplate.condition;
                
                switch (condition.type) {
                    case 'kill':
                        // 这里需要添加击杀计数统计
                        break;
                    case 'gold':
                        // 这里需要添加金币累计统计
                        break;
                    case 'level':
                        conditionMet = gameState.player.level >= condition.count;
                        break;
                }
                
                if (conditionMet) {
                    gameState.player.titles.scrolls.push({...titleTemplate});
                    addLog(`获得称号卷轴: ${titleTemplate.name}`);
                    showFloatingText('获得称号卷轴！', 'craft');
                }
            });
        }

        // 获取称号属性加成
        function getTitleBonus() {
            const activeTitle = gameState.player.titles.active;
            if (!activeTitle) return {};
            
            return activeTitle.effects || {};
        }





        // 弹窗式属性面板
        function showAttributePanelModal() {
            document.getElementById('attributeModal').classList.remove('hidden');
            updateAttributeDisplayModal();
        }
        
        function hideAttributePanelModal() {
            document.getElementById('attributeModal').classList.add('hidden');
        }
        
        function updateAttributeDisplayModal() {
            const player = gameState.player;
            
            // 基础属性
            document.getElementById('modalAttrClass').textContent = classes[player.class].name;
            document.getElementById('modalAttrLevel').textContent = player.level;
            
            // 计算包含百分比加成的最大生命值和魔法值
            const specialBonus = calculateSpecialEquipmentBonus();
            const setBonus = calculateSetBonus();
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            document.getElementById('modalAttrHp').textContent = `${player.hp}/${totalMaxHp}`;
            document.getElementById('modalAttrMp').textContent = `${player.mp}/${totalMaxMp}`;
            document.getElementById('modalAttrExp').textContent = `${player.exp}/${player.maxExp}`;
            document.getElementById('modalAttrGold').textContent = player.gold;
            
            // 计算总攻击力
            let totalAttackMin = player.attack[0];
            let totalAttackMax = player.attack[1];
            if (player.equipment.weapon) {
                totalAttackMin += player.equipment.weapon.attack[0];
                totalAttackMax += player.equipment.weapon.attack[1];
            }
            
            // 应用特殊装备百分比攻击加成
            totalAttackMin *= (1 + specialBonus.percentAttack / 100);
            totalAttackMax *= (1 + specialBonus.percentAttack / 100);
            
            // 取整
            totalAttackMin = Math.floor(totalAttackMin);
            totalAttackMax = Math.floor(totalAttackMax);
            
            // 计算总防御力
            let totalDefense = player.defense;
            if (player.equipment.armor) {
                totalDefense += player.equipment.armor.defense;
            }
            
            // 计算总暴击率和暴击伤害
            let totalCritRate = player.critRate || 0;
            let totalCritDamage = player.critDamage || 150;
            let totalMagicPower = 0;
            
            // 装备加成
            if (player.equipment.weapon) {
                totalCritRate += player.equipment.weapon.critRate || 0;
                totalCritDamage += player.equipment.weapon.critDamage || 0;
                totalMagicPower += player.equipment.weapon.magicPower || 0;
            }
            if (player.equipment.armor) {
                totalCritRate += player.equipment.armor.critRate || 0;
                totalCritDamage += player.equipment.armor.critDamage || 0;
                totalMagicPower += player.equipment.armor.magicPower || 0;
            }
            if (player.equipment.ring) {
                totalCritRate += player.equipment.ring.critRate || 0;
                totalCritDamage += player.equipment.ring.critDamage || 0;
                totalMagicPower += player.equipment.ring.magicPower || 0;
                if (player.equipment.ring.attack) {
                    totalAttackMin += player.equipment.ring.attack[0];
                    totalAttackMax += player.equipment.ring.attack[1];
                }
                if (player.equipment.ring.defense) {
                    totalDefense += player.equipment.ring.defense;
                }
            }
            if (player.equipment.necklace) {
                totalCritRate += player.equipment.necklace.critRate || 0;
                totalCritDamage += player.equipment.necklace.critDamage || 0;
                totalMagicPower += player.equipment.necklace.magicPower || 0;
                if (player.equipment.necklace.attack) {
                    totalAttackMin += player.equipment.necklace.attack[0];
                    totalAttackMax += player.equipment.necklace.attack[1];
                }
                if (player.equipment.necklace.defense) {
                    totalDefense += player.equipment.necklace.defense;
                }
            }
            
            // 战斗属性
            document.getElementById('modalAttrAttack').textContent = `${totalAttackMin}-${totalAttackMax}`;
            document.getElementById('modalAttrDefense').textContent = totalDefense;
            document.getElementById('modalAttrCritRate').textContent = `${totalCritRate}%`;
            document.getElementById('modalAttrCritDamage').textContent = `${totalCritDamage}%`;
            document.getElementById('modalAttrMagicPower').textContent = totalMagicPower;
            
            // 装备加成详情
            const equipmentBonus = document.getElementById('modalEquipmentBonus');
            let bonusText = '';
            
            if (player.equipment.weapon) {
                const weapon = player.equipment.weapon;
                bonusText += `<div class="mb-2"><span class="text-yellow-400">${weapon.name}:</span> 攻击力+${weapon.attack[0]}-${weapon.attack[1]}`;
                if (weapon.critRate) bonusText += `, 暴击率+${weapon.critRate}%`;
                if (weapon.critDamage) bonusText += `, 暴击伤害+${weapon.critDamage}%`;
                if (weapon.magicPower) bonusText += `, 法术强度+${weapon.magicPower}`;
                bonusText += `</div>`;
            }
            
            if (player.equipment.armor) {
                const armor = player.equipment.armor;
                bonusText += `<div class="mb-2"><span class="text-blue-400">${armor.name}:</span> 防御力+${armor.defense}`;
                if (armor.hp) bonusText += `, 生命值+${armor.hp}`;
                if (armor.mp) bonusText += `, 魔法值+${armor.mp}`;
                if (armor.critRate) bonusText += `, 暴击率+${armor.critRate}%`;
                if (armor.critDamage) bonusText += `, 暴击伤害+${armor.critDamage}%`;
                if (armor.magicPower) bonusText += `, 法术强度+${armor.magicPower}`;
                bonusText += `</div>`;
            }
            
            if (player.equipment.ring) {
                const ring = player.equipment.ring;
                bonusText += `<div class="mb-2"><span class="text-green-400">${ring.name}:</span>`;
                if (ring.attack) bonusText += ` 攻击力+${ring.attack[0]}-${ring.attack[1]},`;
                if (ring.hp) bonusText += ` 生命值+${ring.hp},`;
                if (ring.mp) bonusText += ` 魔法值+${ring.mp},`;
                if (ring.defense) bonusText += ` 防御力+${ring.defense},`;
                if (ring.critRate) bonusText += ` 暴击率+${ring.critRate}%,`;
                if (ring.critDamage) bonusText += ` 暴击伤害+${ring.critDamage}%,`;
                if (ring.magicPower) bonusText += ` 法术强度+${ring.magicPower},`;
                bonusText = bonusText.replace(/,$/, ''); // 移除最后的逗号
                bonusText += `</div>`;
            }
            
            if (player.equipment.necklace) {
                const necklace = player.equipment.necklace;
                bonusText += `<div class="mb-2"><span class="text-purple-400">${necklace.name}:</span>`;
                if (necklace.attack) bonusText += ` 攻击力+${necklace.attack[0]}-${necklace.attack[1]},`;
                if (necklace.hp) bonusText += ` 生命值+${necklace.hp},`;
                if (necklace.mp) bonusText += ` 魔法值+${necklace.mp},`;
                if (necklace.defense) bonusText += ` 防御力+${necklace.defense},`;
                if (necklace.critRate) bonusText += ` 暴击率+${necklace.critRate}%,`;
                if (necklace.critDamage) bonusText += ` 暴击伤害+${necklace.critDamage}%,`;
                if (necklace.magicPower) bonusText += ` 法术强度+${necklace.magicPower},`;
                bonusText = bonusText.replace(/,$/, ''); // 移除最后的逗号
                bonusText += `</div>`;
            }
            
            // 添加特殊装备加成显示
            ['special1', 'special2', 'special3', 'special4'].forEach((slot, index) => {
                const equipment = player.equipment[slot];
                if (equipment) {
                    bonusText += `<div class="mb-2"><span class="text-orange-400">${equipment.name}:</span>`;
                    if (equipment.percentDamage) bonusText += ` 伤害+${equipment.percentDamage}%,`;
                    if (equipment.percentHp) bonusText += ` 生命+${equipment.percentHp}%,`;
                    if (equipment.percentMp) bonusText += ` 魔法+${equipment.percentMp}%,`;
                    if (equipment.percentAttack) bonusText += ` 攻击+${equipment.percentAttack}%,`;
                    if (equipment.divineMultiplier) bonusText += ` 神力倍攻x${equipment.divineMultiplier},`;
                    bonusText = bonusText.replace(/,$/, ''); // 移除最后的逗号
                    bonusText += `</div>`;
                }
            });
            
            if (bonusText === '') {
                bonusText = '<div>当前无装备加成</div>';
            }
            
            equipmentBonus.innerHTML = bonusText;
        }

        // 初始化游戏
        function initGame() {
            // 检查URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const isGuestMode = urlParams.get('mode') === 'guest';
            const isExternalLogin = urlParams.get('external_login') === 'true';
            
            if (isGuestMode) {
                // 游客模式：使用本地存储
                console.log('游客模式：使用本地存储');
                initializeGameData();
                loadLocalGameState();
                showGameArea();
            } else if (isExternalLogin) {
                // 外部登录模式：直接进入角色选择
                console.log('外部登录模式：直接进入角色选择');
                initializeGameData();
                initializeNetworkGame();
                showExternalCharacterSelectScreen();
            } else {
                // 检查是否已经通过内置登录系统登录
                if (currentAccount && currentCharacterSlot !== null) {
                    // 已通过内置系统登录并选择角色，直接初始化游戏
                    console.log('已通过内置系统登录，直接初始化游戏');
                    initializeGameData();
                    loadLocalGameState();
                    showGameArea();
                } else {
                    // 检查是否有外部token（从login.html跳转过来）
                    const token = localStorage.getItem('gameToken');
                    if (token) {
                        // 有外部token，使用联网模式，但需要先进行角色选择
                        console.log('外部登录模式：需要进行角色选择');
                        initializeGameData();
                        initializeNetworkGame();
                        // 显示角色选择界面，而不是直接进入游戏
                        showExternalLoginCharacterSelect();
                    } else {
                        // 没有外部token，显示内置登录界面
                        console.log('显示内置登录界面');
                        initializeGameData();
                        showStartScreen();
                    }
                }
            }
        }

        // 初始化游戏数据
        function initializeGameData() {
            // 从配置文件加载所有数据
            classes = getClassData();
            monsters = getMonsterData();
            equipment = getEquipmentData();
            craftingRecipes = getCraftingRecipeData();
            
            // 如果需要，可以从配置文件重新初始化gameState
            const initialState = getInitialGameState();
            if (initialState && initialState.player) {
                // 只更新初始物品和材料，保留其他状态
                if (gameState.player.inventory.length === 0) {
                    gameState.player.inventory = [...(initialState.player.inventory || [])];
                }
                if (gameState.player.materials.length === 0) {
                    gameState.player.materials = [...(initialState.player.materials || [])];
                }
            }
        }
        
        // 加载本地游戏状态（游客模式）
        function loadLocalGameState() {
            const savedState = localStorage.getItem('gameState');
            if (savedState) {
                try {
                    gameState = JSON.parse(savedState);
                    console.log('已加载本地游戏状态');
                } catch (error) {
                    console.error('加载本地游戏状态失败:', error);
                    gameState = getInitialGameState();
                }
            } else {
                gameState = getInitialGameState();
            }
            updateDisplay();
        }
        
        // 初始化网络游戏
        function initializeNetworkGame() {
            console.log('联网模式：初始化网络功能');
            
            // 设置网络事件监听器
            setupNetworkEventListeners();
            
            // 等待网络认证完成后加载游戏状态
            if (networkManager.isAuthenticated) {
                // 已认证，直接加载
                console.log('网络管理器已认证，直接加载游戏状态');
                loadNetworkGameState();
            } else {
                console.log('等待网络认证完成...');
                // 等待认证完成或失败
                let authTimeout = setTimeout(() => {
                    console.warn('认证超时，使用本地模式');
                    if (typeof addLog === 'function') {
                        addLog('网络连接超时，切换到本地模式');
                    }
                    // 认证超时时使用本地游戏状态
                    loadLocalGameState();
                }, 10000); // 10秒超时
                
                // 认证成功处理
                const handleAuthenticated = (data) => {
                    console.log('认证成功，加载游戏状态');
                    clearTimeout(authTimeout);
                    loadNetworkGameState(data.gameState);
                    // 移除临时监听器
                    networkManager.off('authenticated', handleAuthenticated);
                    networkManager.off('auth_error', handleAuthError);
                };
                
                // 认证失败处理
                const handleAuthError = (data) => {
                    console.error('认证失败:', data);
                    clearTimeout(authTimeout);
                    // 移除临时监听器
                    networkManager.off('authenticated', handleAuthenticated);
                    networkManager.off('auth_error', handleAuthError);
                    // 认证失败时使用本地游戏状态，不重定向
                    console.log('认证失败，使用本地游戏状态');
                    if (typeof addLog === 'function') {
                        addLog('网络认证失败，使用本地模式');
                    }
                    loadLocalGameState();
                };
                
                networkManager.on('authenticated', handleAuthenticated);
                networkManager.on('auth_error', handleAuthError);
            }
        }
        
        // 设置网络事件监听器
        function setupNetworkEventListeners() {
            // 移除之前的监听器，避免重复注册
            networkManager.removeAllListeners('authenticated');
            networkManager.removeAllListeners('disconnected');
            networkManager.removeAllListeners('sync_success');
            networkManager.removeAllListeners('force_disconnect');
            networkManager.removeAllListeners('auth_error');
            
            // 认证成功
            networkManager.on('authenticated', (data) => {
                console.log('网络认证成功');
                if (typeof addLog === 'function') {
                    addLog('已连接到服务器，游戏数据将自动同步');
                }
            });
            
            // 连接断开
            networkManager.on('disconnected', (reason) => {
                console.log('与服务器断开连接:', reason);
                if (typeof addLog === 'function') {
                    addLog('与服务器断开连接，游戏数据将保存到本地');
                }
            });
            
            // 同步成功
            networkManager.on('sync_success', (data) => {
                console.log('游戏状态同步成功');
            });
            
            // 强制断开连接
            networkManager.on('force_disconnect', (data) => {
                console.warn('账号在其他地方登录，即将返回登录页面');
                alert('您的账号在其他地方登录，即将返回登录页面');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            });
            
            // 认证失败 - 不自动重定向，让用户选择
            networkManager.on('auth_error', (data) => {
                console.error('认证失败:', data.message);
                if (typeof addLog === 'function') {
                    addLog('网络认证失败: ' + (data.message || '未知错误'));
                }
                // 不自动重定向，让用户可以继续使用本地模式或手动重新登录
                console.warn('认证失败，继续使用本地模式:', data.message);
            });
        }
        
        // 加载网络游戏状态
        function loadNetworkGameState(serverGameState) {
            if (serverGameState) {
                gameState = serverGameState;
                console.log('已从服务器加载游戏状态');
                addLog('游戏数据已从服务器加载');
            } else {
                // 使用默认状态
                gameState = getInitialGameState();
                console.log('使用默认游戏状态');
            }
            updateDisplay();
        }
        
        // 同步游戏状态到服务器
        function syncGameStateToServer() {
            if (networkManager && networkManager.isAuthenticated) {
                networkManager.syncGameState(gameState);
            }
        }
        
        // 发送战斗结果到服务器
        function sendBattleResultToServer(result) {
            if (networkManager && networkManager.isAuthenticated) {
                networkManager.sendBattleResult(result);
            }
        }
        
        // 发送任务完成事件到服务器
        function sendQuestCompletedToServer(questData) {
            if (networkManager && networkManager.isAuthenticated) {
                networkManager.sendQuestCompleted(questData);
            }
        }
        
        // 发送物品合成事件到服务器
        function sendItemCraftedToServer(itemData) {
            if (networkManager && networkManager.isAuthenticated) {
                networkManager.sendItemCrafted(itemData);
            }
        }

        // 弹窗式装备合成（已移至树状图合成功能）
        
        // 弹窗式任务系统
        function showQuestPanelModal() {
            document.getElementById('questModal').classList.remove('hidden');
            updateQuestDisplayModal();
        }
        
        function hideQuestPanelModal() {
            document.getElementById('questModal').classList.add('hidden');
        }
        
        function updateQuestDisplayModal() {
            updateQuestDisplay();
        }
        
        // 弹窗式称号系统
        function showTitlePanelModal() {
            document.getElementById('titleModal').classList.remove('hidden');
            updateTitleDisplayModal();
        }
        
        function hideTitlePanelModal() {
            document.getElementById('titleModal').classList.add('hidden');
        }
        
        function updateTitleDisplayModal() {
            updateTitleDisplay();
        }

        // 旧的合成函数已被树状图合成功能替代

        // 使用现有的equipment数据结构（已在第1354行定义）
        
        // 获取稀有度样式类
        function getRarityClass(rarity) {
            switch(rarity) {
                case 'common': return 'border-gray-400 text-gray-400';
                case 'rare': return 'border-blue-400 text-blue-400';
                case 'epic': return 'border-purple-400 text-purple-400';
                case 'legendary': return 'border-orange-400 text-orange-400';
                case 'mythic': return 'border-red-400 text-red-400';
                case 'supreme': return 'border-pink-400 text-pink-400';
                case 'transcendent': return 'border-yellow-400 text-yellow-400';
                default: return 'border-gray-400 text-gray-400';
            }
        }
        
        // 获取物品描述
        // 删除重复的getItemDescription函数，使用第一个更完整的版本
        
        // 购买物品
        // 删除重复的buyItem函数，使用第一个版本
        
        // 重复的useItem函数已删除，使用第一个完整版本
        
        // 计算玩家属性函数
        function calculatePlayerStats() {
            if (!gameState || !gameState.player) return;
            
            const player = gameState.player;
            const equipment = player.equipment;
            
            // 重置计算属性（保留基础属性）
            let totalAttack = player.baseAttack || [15, 25];
            let totalDefense = player.baseDefense || 8;
            let totalHp = player.baseMaxHp || 120;
            let totalMp = player.baseMaxMp || 30;
            let totalCritRate = 0;
            let totalCritDamage = 0;
            let totalMagicPower = 0;
            
            // 遍历所有装备槽位
            Object.values(equipment).forEach(item => {
                if (!item) return;
                
                // 攻击力
                if (item.attack) {
                    if (Array.isArray(item.attack)) {
                        totalAttack[0] += item.attack[0];
                        totalAttack[1] += item.attack[1];
                    } else {
                        totalAttack[0] += item.attack;
                        totalAttack[1] += item.attack;
                    }
                }
                
                // 防御力
                if (item.defense) {
                    totalDefense += item.defense;
                }
                
                // 生命值
                if (item.hp) {
                    totalHp += item.hp;
                }
                
                // 魔法值
                if (item.mp) {
                    totalMp += item.mp;
                }
                
                // 暴击率
                if (item.critRate) {
                    totalCritRate += item.critRate;
                }
                
                // 暴击伤害
                if (item.critDamage) {
                    totalCritDamage += item.critDamage;
                }
                
                // 法术强度
                if (item.magicPower) {
                    totalMagicPower += item.magicPower;
                }
            });
            
            // 更新玩家属性
            player.attack = totalAttack;
            player.defense = totalDefense;
            player.maxHp = totalHp;
            player.maxMp = totalMp;
            player.critRate = totalCritRate;
            player.critDamage = totalCritDamage;
            player.magicPower = totalMagicPower;
            
            // 确保当前血量和魔法值不超过最大值
            if (player.hp > player.maxHp) {
                player.hp = player.maxHp;
            }
            if (player.mp > player.maxMp) {
                player.mp = player.maxMp;
            }
        }
        
        // 页面加载完成后初始化
        window.onload = async function() {
            // 确保配置管理器已初始化
            if (!configManager) {
                try {
                    configManager = new ConfigManager();
                    await configManager.preloadAll();
                    console.log('配置管理器初始化完成');
                } catch (error) {
                    console.warn('配置管理器初始化失败，使用默认配置:', error);
                    configManager = new ConfigManager();
                }
            }
            
            initGame();
            
            // 延迟初始化其他系统，等待游戏状态加载完成
            setTimeout(async () => {
                // 初始化任务和称号系统
                await initializeQuests();
                checkTitleConditions();
                // 初始化自动回收显示
                updateAutoRecycleDisplay();
                
                // 启动自动刷新怪物系统
                startAutoRefreshMonsters();
                
                // 如果自动回收已启用，启动定时器
                if (gameState && gameState.autoRecycle && gameState.autoRecycle.enabled) {
                    startAutoRecycleTimer();
                    addLog('自动回收定时检查已启动（每5秒检查一次）');
                }
                
                // 启动定时自动保存/同步功能（每30秒一次）
                setInterval(function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const isGuestMode = urlParams.get('mode') === 'guest';
                    
                    if (isGuestMode) {
                        // 游客模式：保存到本地存储
                        localStorage.setItem('gameState', JSON.stringify(gameState));
                    } else {
                        // 联网模式：同步到服务器
                        syncGameStateToServer();
                    }
                }, 30000);
            }, 1000);
            
            // 原有的定时保存代码（保持兼容性）
            setInterval(function() {
                // 只有在游戏开始后才进行自动保存（角色创建界面隐藏且游戏界面显示）
                if (gameState && gameState.player && 
                    document.getElementById('characterCreation').classList.contains('hidden') &&
                    !document.getElementById('gameInterface').classList.contains('hidden')) {
                    autoSaveGame();
                }
            }, 30000); // 30秒 = 30000毫秒
            
            // 启动自动任务管理系统（每3秒检查一次）
            setInterval(function() {
                if (gameState && gameState.player && 
                    document.getElementById('characterCreation').classList.contains('hidden') &&
                    !document.getElementById('gameInterface').classList.contains('hidden')) {
                    autoQuestManager();
                }
            }, 3000); // 3秒检查一次
        };
        
        // 自动保存游戏状态
        function autoSaveGame() {
            try {
                if (gameState && gameState.player) {
                    const saveData = {
                        player: gameState.player,
                        currentLocation: gameState.currentLocation || 1,
                        timestamp: new Date().toLocaleString(),
                        version: '1.0'
                    };
                    
                    // 保存到localStorage（自动保存）
                    localStorage.setItem('legendSave_auto', JSON.stringify(saveData));
                    
                    // 同时保存到账号系统中
                    if (currentAccount && currentCharacterSlot !== null) {
                        const accounts = getAccountData();
                        if (accounts[currentAccount] && accounts[currentAccount].characters[currentCharacterSlot]) {
                            // 更新角色的游戏数据
                            accounts[currentAccount].characters[currentCharacterSlot].gameData = gameState;
                            accounts[currentAccount].characters[currentCharacterSlot].level = gameState.player.level;
                            saveAccountData(accounts);
                            console.log('游戏数据已同步到账号系统');
                        }
                    }
                    
                    console.log('自动保存成功:', new Date().toLocaleTimeString());
                }
            } catch (error) {
                console.error('自动保存失败:', error);
            }
        }
        
        // 新增的弹出界面功能函数
        // 功能按钮对应的函数
        function showMapArea() {
            showMapPanel();
        }
        
        function showInventory() {
            showInventoryPanel();
        }
        
        function showMoreOptions() {
            showMoreFunctions();
        }
        
        function showMapPanel() {
            document.getElementById('mapModal').classList.remove('hidden');
            updateAutoRecycleDisplay();
        }
        
        function hideMapPanel() {
            document.getElementById('mapModal').classList.add('hidden');
        }
        
        function toggleAutoRecycle() {
            // 确保autoRecycle对象存在
            if (!gameState.autoRecycle) {
                gameState.autoRecycle = {
                    enabled: false,
                    maxQuality: 'common'
                };
            }
            
            gameState.autoRecycle.enabled = !gameState.autoRecycle.enabled;
            updateAutoRecycleDisplay();
            addLog(`自动回收已${gameState.autoRecycle.enabled ? '启用' : '禁用'}`);
            
            // 根据自动回收状态启动或停止定时器
            if (gameState.autoRecycle.enabled) {
                startAutoRecycleTimer();
                addLog('自动回收定时检查已启动（每5秒检查一次）');
            } else {
                stopAutoRecycleTimer();
                addLog('自动回收定时检查已停止');
            }
        }
        
        function setAutoRecycleQuality(quality) {
            // 确保autoRecycle对象存在
            if (!gameState.autoRecycle) {
                gameState.autoRecycle = {
                    enabled: false,
                    maxQuality: 'common'
                };
            }
            
            gameState.autoRecycle.maxQuality = quality;
            updateAutoRecycleDisplay();
            addLog(`自动回收品质设置为：${quality}`);
        }
        
        function updateAutoRecycleDisplay() {
            // 确保autoRecycle对象存在
            if (!gameState.autoRecycle) {
                gameState.autoRecycle = {
                    enabled: false,
                    maxQuality: 'common'
                };
            }
            
            const mapToggleButton = document.getElementById('autoRecycleToggleMap');
            const mapToggleText = document.getElementById('autoRecycleTextMap');
            const mapQualitySelect = document.getElementById('autoRecycleQualityMap');
            
            // 更新地图视图中的自动回收按钮
            if (mapToggleButton && mapToggleText) {
                mapToggleText.textContent = gameState.autoRecycle.enabled ? '自动回收(开)' : '自动回收(关)';
                mapToggleButton.className = gameState.autoRecycle.enabled ? 
                    'bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg border border-green-500 transition-all duration-200 flex items-center space-x-2' : 
                    'bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 transition-all duration-200 flex items-center space-x-2';
            }
            
            // 更新地图视图中的品质选择下拉菜单
            if (mapQualitySelect) {
                mapQualitySelect.value = gameState.autoRecycle.maxQuality;
            }
        }
        
        function shouldAutoRecycle(item) {
            if (!item || !item.rarity) return false;
            
            // 确保autoRecycle对象存在
            if (!gameState.autoRecycle) {
                gameState.autoRecycle = {
                    enabled: false,
                    maxQuality: 'common'
                };
            }
            
            const qualityOrder = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'supreme', 'transcendent'];
            const itemQualityIndex = qualityOrder.indexOf(item.rarity);
            const maxQualityIndex = qualityOrder.indexOf(gameState.autoRecycle.maxQuality);
            
            // 如果物品品质等级小于等于设定的最大回收品质等级，则回收
            return itemQualityIndex <= maxQualityIndex && itemQualityIndex !== -1;
        }
        
        // 检查背包中的物品是否需要自动回收
        function checkInventoryAutoRecycle() {
            // 确保autoRecycle对象存在
            if (!gameState.autoRecycle) {
                gameState.autoRecycle = {
                    enabled: false,
                    maxQuality: 'common'
                };
            }
            
            if (!gameState.autoRecycle.enabled) return;
            
            let recycledItems = [];
            let totalGold = 0;
            
            // 从后往前遍历，避免删除元素时索引问题
            for (let i = gameState.player.inventory.length - 1; i >= 0; i--) {
                const item = gameState.player.inventory[i];
                if (shouldAutoRecycle(item)) {
                    const sellPrice = Math.floor((item.price || 0) * 0.5);
                    gameState.player.gold += sellPrice;
                    totalGold += sellPrice;
                    recycledItems.push(item.name);
                    gameState.player.inventory.splice(i, 1);
                }
            }
            
            if (recycledItems.length > 0) {
                // 显示金币获得飘字效果
                showFloatingText(`+${totalGold} 金币`, 'gold');
                
                addLog(`自动回收：${recycledItems.join('、')}，共获得${totalGold}金币`);
                updateDisplay();
                updateInventoryDisplay();
            }
        }
        
        // 启动自动回收定时器
        let autoRecycleTimer = null;
        
        function startAutoRecycleTimer() {
            if (autoRecycleTimer) {
                clearInterval(autoRecycleTimer);
            }
            // 每5秒检查一次背包
            autoRecycleTimer = setInterval(checkInventoryAutoRecycle, 5000);
        }
        
        function stopAutoRecycleTimer() {
            if (autoRecycleTimer) {
                clearInterval(autoRecycleTimer);
                autoRecycleTimer = null;
            }
        }
        
        // 合成树节点数据
        const craftingTreeData = {
            weapons: {
                id: 'weapons',
                name: '武器',
                type: 'category',
                children: {
                    'iron_sword': {
                        id: 'iron_sword',
                        name: '铁剑',
                        type: 'equipment',
                        rarity: 'common',
                        materials: [{ name: '铁矿石', count: 3 }],
                        result: { name: '铁剑', type: 'weapon', attack: [15, 25], rarity: 'common', price: 100 },
                        children: {
                            'steel_sword': {
                                id: 'steel_sword',
                                name: '钢剑',
                                type: 'equipment',
                                rarity: 'uncommon',
                                materials: [{ name: '铁剑', count: 1 }, { name: '银矿石', count: 2 }],
                                result: { name: '钢剑', type: 'weapon', attack: [25, 35], rarity: 'uncommon', price: 200 },
                                children: {
                                    'magic_sword': {
                                        id: 'magic_sword',
                                        name: '魔法剑',
                                        type: 'equipment',
                                        rarity: 'rare',
                                        materials: [{ name: '钢剑', count: 1 }, { name: '魔法水晶', count: 3 }],
                                        result: { name: '魔法剑', type: 'weapon', attack: [35, 50], rarity: 'rare', price: 400 },
                                        children: {
                                            'legendary_blade': {
                                                id: 'legendary_blade',
                                                name: '传说之刃',
                                                type: 'equipment',
                                                rarity: 'legendary',
                                                materials: [{ name: '魔法剑', count: 1 }, { name: '稀有宝石', count: 2 }, { name: '黄金矿石', count: 3 }],
                                                result: { name: '传说之刃', type: 'weapon', attack: [60, 80], rarity: 'legendary', price: 1000 }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    },
                    'iron_dagger': {
                        id: 'iron_dagger',
                        name: '铁匕首',
                        type: 'equipment',
                        rarity: 'common',
                        materials: [{ name: '铁矿石', count: 2 }],
                        result: { name: '铁匕首', type: 'weapon', attack: [10, 20], rarity: 'common', price: 60 },
                        children: {
                            'poison_dagger': {
                                id: 'poison_dagger',
                                name: '毒刃',
                                type: 'equipment',
                                rarity: 'rare',
                                materials: [{ name: '铁匕首', count: 1 }, { name: '魔法水晶', count: 2 }],
                                result: { name: '毒刃', type: 'weapon', attack: [25, 40], rarity: 'rare', price: 350 }
                            }
                        }
                    }
                }
            },
            armors: {
                id: 'armors',
                name: '防具',
                type: 'category',
                children: {
                    'leather_armor': {
                        id: 'leather_armor',
                        name: '皮甲',
                        type: 'equipment',
                        rarity: 'common',
                        materials: [{ name: '铁矿石', count: 2 }],
                        result: { name: '皮甲', type: 'armor', defense: 8, rarity: 'common', price: 80 },
                        children: {
                            'chain_armor': {
                                id: 'chain_armor',
                                name: '锁子甲',
                                type: 'equipment',
                                rarity: 'uncommon',
                                materials: [{ name: '皮甲', count: 1 }, { name: '银矿石', count: 2 }],
                                result: { name: '锁子甲', type: 'armor', defense: 15, rarity: 'uncommon', price: 160 },
                                children: {
                                    'plate_armor': {
                                        id: 'plate_armor',
                                        name: '板甲',
                                        type: 'equipment',
                                        rarity: 'rare',
                                        materials: [{ name: '锁子甲', count: 1 }, { name: '黄金矿石', count: 2 }],
                                        result: { name: '板甲', type: 'armor', defense: 25, rarity: 'rare', price: 320 },
                                        children: {
                                            'dragon_armor': {
                                                id: 'dragon_armor',
                                                name: '龙鳞甲',
                                                type: 'equipment',
                                                rarity: 'epic',
                                                materials: [{ name: '板甲', count: 1 }, { name: '稀有宝石', count: 3 }, { name: '魔法水晶', count: 2 }],
                                                result: { name: '龙鳞甲', type: 'armor', defense: 40, rarity: 'epic', price: 800 }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    },
                    'iron_helmet': {
                        id: 'iron_helmet',
                        name: '铁盔',
                        type: 'equipment',
                        rarity: 'common',
                        materials: [{ name: '铁矿石', count: 1 }],
                        result: { name: '铁盔', type: 'helmet', defense: 3, rarity: 'common', price: 40 },
                        children: {
                            'steel_helmet': {
                                id: 'steel_helmet',
                                name: '钢盔',
                                type: 'equipment',
                                rarity: 'uncommon',
                                materials: [{ name: '铁盔', count: 1 }, { name: '银矿石', count: 1 }],
                                result: { name: '钢盔', type: 'helmet', defense: 6, rarity: 'uncommon', price: 80 }
                            }
                        }
                    }
                }
            },
            accessories: {
                id: 'accessories',
                name: '饰品',
                type: 'category',
                children: {
                    'power_ring': {
                        id: 'power_ring',
                        name: '力量戒指',
                        type: 'equipment',
                        rarity: 'rare',
                        materials: [{ name: '黄金矿石', count: 2 }, { name: '稀有宝石', count: 1 }],
                        result: { name: '力量戒指', type: 'ring', attack: [5, 10], rarity: 'rare', price: 300 },
                        children: {
                            'master_ring': {
                                id: 'master_ring',
                                name: '大师戒指',
                                type: 'equipment',
                                rarity: 'epic',
                                materials: [{ name: '力量戒指', count: 1 }, { name: '魔法水晶', count: 3 }],
                                result: { name: '大师戒指', type: 'ring', attack: [10, 20], rarity: 'epic', price: 600 }
                            }
                        }
                    },
                    'magic_necklace': {
                        id: 'magic_necklace',
                        name: '魔法项链',
                        type: 'equipment',
                        rarity: 'uncommon',
                        materials: [{ name: '银矿石', count: 2 }, { name: '魔法水晶', count: 1 }],
                        result: { name: '魔法项链', type: 'necklace', defense: 5, rarity: 'uncommon', price: 150 },
                        children: {
                            'arcane_pendant': {
                                id: 'arcane_pendant',
                                name: '奥术吊坠',
                                type: 'equipment',
                                rarity: 'rare',
                                materials: [{ name: '魔法项链', count: 1 }, { name: '稀有宝石', count: 1 }],
                                result: { name: '奥术吊坠', type: 'necklace', defense: 8, attack: [3, 8], rarity: 'rare', price: 400 }
                            }
                        }
                    }
                }
            },
            specials: {
                id: 'specials',
                name: '护符',
                type: 'category',
                children: {
                    'power_charm': {
                        id: 'power_charm',
                        name: '力量护符',
                        type: 'equipment',
                        rarity: 'rare',
                        materials: [{ name: '铁矿石', count: 2 }, { name: '魔法水晶', count: 1 }],
                        result: { name: '力量护符', type: 'special', tier: 1, percentDamage: 10, rarity: 'rare', price: 500 },
                        children: {
                            'enhanced_power_charm': {
                                id: 'enhanced_power_charm',
                                name: '强化力量护符',
                                type: 'equipment',
                                rarity: 'epic',
                                materials: [{ name: '力量护符', count: 1 }, { name: '黄金矿石', count: 3 }, { name: '暗影精华', count: 1 }],
                                result: { name: '强化力量护符', type: 'special', tier: 2, percentDamage: 20, rarity: 'epic', price: 1200 },
                                children: {
                                    'divine_power_charm': {
                                        id: 'divine_power_charm',
                                        name: '神力护符',
                                        type: 'equipment',
                                        rarity: 'legendary',
                                        materials: [{ name: '强化力量护符', count: 1 }, { name: '强化攻击护符', count: 1 }, { name: '神圣宝石', count: 2 }, { name: '龙鳞片', count: 3 }],
                                        result: { name: '神力护符', type: 'special', tier: 3, percentDamage: 35, divineMultiplier: 2, rarity: 'legendary', price: 3000 }
                                    }
                                }
                            }
                        }
                    },
                    'life_charm': {
                        id: 'life_charm',
                        name: '生命护符',
                        type: 'equipment',
                        rarity: 'rare',
                        materials: [{ name: '银矿石', count: 2 }, { name: '魔法水晶', count: 1 }],
                        result: { name: '生命护符', type: 'special', tier: 1, percentHp: 15, rarity: 'rare', price: 500 },
                        children: {
                            'enhanced_life_charm': {
                                id: 'enhanced_life_charm',
                                name: '强化生命护符',
                                type: 'equipment',
                                rarity: 'epic',
                                materials: [{ name: '生命护符', count: 1 }, { name: '黄金矿石', count: 3 }, { name: '魔法水晶', count: 2 }],
                                result: { name: '强化生命护符', type: 'special', tier: 2, percentHp: 25, rarity: 'epic', price: 1200 },
                                children: {
                                    'eternal_charm': {
                                        id: 'eternal_charm',
                                        name: '永恒护符',
                                        type: 'equipment',
                                        rarity: 'legendary',
                                        materials: [{ name: '强化生命护符', count: 1 }, { name: '强化攻击护符', count: 1 }, { name: '神圣宝石', count: 3 }, { name: '暗影精华', count: 2 }],
                                        result: { name: '永恒护符', type: 'special', tier: 3, percentHp: 40, percentAttack: 30, rarity: 'legendary', price: 3000 }
                                    }
                                }
                            }
                        }
                    },
                    'attack_charm': {
                        id: 'attack_charm',
                        name: '攻击护符',
                        type: 'equipment',
                        rarity: 'rare',
                        materials: [{ name: '铁矿石', count: 3 }, { name: '银矿石', count: 1 }],
                        result: { name: '攻击护符', type: 'special', tier: 1, percentAttack: 12, rarity: 'rare', price: 500 },
                        children: {
                            'enhanced_attack_charm': {
                                id: 'enhanced_attack_charm',
                                name: '强化攻击护符',
                                type: 'equipment',
                                rarity: 'epic',
                                materials: [{ name: '攻击护符', count: 1 }, { name: '银矿石', count: 5 }, { name: '暗影精华', count: 1 }],
                                result: { name: '强化攻击护符', type: 'special', tier: 2, percentAttack: 22, rarity: 'epic', price: 1200 }
                            }
                        }
                    },
                    'dragon_god_charm': {
                        id: 'dragon_god_charm',
                        name: '龙神护符',
                        type: 'equipment',
                        rarity: 'transcendent',
                        materials: [{ name: '神力护符', count: 1 }, { name: '永恒护符', count: 1 }, { name: '神圣宝石', count: 8 }, { name: '龙鳞片', count: 10 }, { name: '龙之精华', count: 5 }],
                        result: { name: '龙神护符', type: 'special', tier: 4, percentDamage: 60, percentHp: 50, dragonPower: 100, divineMultiplier: 3, rarity: 'transcendent', price: 8000 }
                    }
                }
            }
        };
        
        // 合成树相关函数
        function showCraftPanelModal() {
            document.getElementById('craftModal').classList.remove('hidden');
            initializeCraftTree();
        }
        
        function hideCraftPanelModal() {
            document.getElementById('craftModal').classList.add('hidden');
        }
        
        function initializeCraftTree() {
            updateCraftTree();
        }
        
        function updateCraftTree() {
            const typeFilter = document.getElementById('craftTreeFilter').value;
            const qualityFilter = document.getElementById('craftQualityFilter').value;
            
            // 清空SVG
            const svg = document.getElementById('craftTreeSvg');
            svg.innerHTML = '';
            
            // 根据过滤条件获取数据
            let filteredData = {};
            if (typeFilter === 'all') {
                filteredData = craftingTreeData;
            } else {
                const typeMap = {
                    'weapon': 'weapons',
                    'armor': 'armors',
                    'accessory': 'accessories',
                    'special': 'specials'
                };
                if (craftingTreeData[typeMap[typeFilter]]) {
                    filteredData[typeMap[typeFilter]] = craftingTreeData[typeMap[typeFilter]];
                }
            }
            
            // 绘制树状图
            drawCraftTree(svg, filteredData, qualityFilter);
        }
        
        function drawCraftTree(svg, data, qualityFilter) {
            const nodeWidth = 120;
            const nodeHeight = 60;
            const levelSpacing = 200;
            const nodeSpacing = 80;
            
            // 清空SVG
            svg.innerHTML = '';
            
            // 构建材料依赖关系图
            const allItems = new Map();
            const materialDependencies = new Map();
            
            // 收集所有物品和依赖关系
            Object.values(data).forEach(category => {
                if (category.type === 'category') {
                    Object.values(category.children).forEach(item => {
                        collectItemsRecursively(item, allItems, materialDependencies);
                    });
                }
            });
            
            // 过滤物品
            const filteredItems = new Map();
            allItems.forEach((item, name) => {
                if (qualityFilter === 'all' || item.rarity === qualityFilter) {
                    filteredItems.set(name, item);
                }
            });
            
            // 计算层级布局
             const levels = calculateItemLevels(filteredItems, materialDependencies);
             const positions = calculateNodePositions(levels, filteredItems, nodeWidth, nodeHeight, levelSpacing, nodeSpacing);
            
            // 绘制所有连线（在节点之前绘制，避免覆盖）
            drawAllConnections(svg, filteredItems, materialDependencies, positions, nodeWidth, nodeHeight);
            
            // 绘制所有节点
            filteredItems.forEach((item, name) => {
                const pos = positions.get(name);
                if (pos) {
                    drawCraftNode(svg, item, pos.x, pos.y, nodeWidth, nodeHeight);
                }
            });
            
            // 动态调整SVG的viewBox以适应所有节点
            if (positions.size > 0) {
                let maxX = 0, maxY = 0;
                positions.forEach(pos => {
                    maxX = Math.max(maxX, pos.x + nodeWidth);
                    maxY = Math.max(maxY, pos.y + nodeHeight);
                });
                svg.setAttribute('viewBox', `0 0 ${maxX + 50} ${maxY + 50}`);
            }
        }
        
        function collectItemsRecursively(item, allItems, materialDependencies) {
            if (!allItems.has(item.name)) {
                allItems.set(item.name, item);
                
                // 记录材料依赖关系
                if (item.materials && item.materials.length > 0) {
                    materialDependencies.set(item.name, item.materials.map(m => m.name));
                }
                
                // 递归处理子项
                if (item.children) {
                    Object.values(item.children).forEach(child => {
                        collectItemsRecursively(child, allItems, materialDependencies);
                    });
                }
            }
        }
        
        function calculateItemLevels(items, dependencies) {
            const levels = new Map();
            const visited = new Set();
            const visiting = new Set();
            
            function calculateLevel(itemName) {
                if (visiting.has(itemName)) {
                    return 0; // 循环依赖，设为基础层级
                }
                if (visited.has(itemName)) {
                    return levels.get(itemName);
                }
                
                visiting.add(itemName);
                
                let maxLevel = 0;
                const deps = dependencies.get(itemName);
                if (deps) {
                    deps.forEach(depName => {
                        if (items.has(depName)) {
                            const depLevel = calculateLevel(depName);
                            maxLevel = Math.max(maxLevel, depLevel + 1);
                        }
                    });
                }
                
                visiting.delete(itemName);
                visited.add(itemName);
                levels.set(itemName, maxLevel);
                return maxLevel;
            }
            
            items.forEach((item, name) => {
                calculateLevel(name);
            });
            
            return levels;
        }
        
        function calculateNodePositions(levels, items, nodeWidth, nodeHeight, levelSpacing, nodeSpacing) {
            const positions = new Map();
            const levelGroups = new Map();
            
            // 按层级分组
            levels.forEach((level, itemName) => {
                if (!levelGroups.has(level)) {
                    levelGroups.set(level, []);
                }
                levelGroups.get(level).push(itemName);
            });
            
            // 计算每层的位置
            levelGroups.forEach((itemsInLevel, level) => {
                const x = 50 + level * levelSpacing;
                let currentY = 50; // 从顶部开始
                
                itemsInLevel.forEach((itemName, index) => {
                    const y = currentY + index * nodeSpacing;
                    positions.set(itemName, { x, y });
                });
            });
            
            return positions;
        }
        
        function drawAllConnections(svg, items, dependencies, positions, nodeWidth, nodeHeight) {
            dependencies.forEach((deps, itemName) => {
                const targetPos = positions.get(itemName);
                if (!targetPos) return;
                
                deps.forEach(depName => {
                    const sourcePos = positions.get(depName);
                    if (sourcePos && items.has(depName)) {
                        drawConnection(svg, sourcePos, targetPos, nodeWidth, nodeHeight);
                    }
                });
            });
        }
        
        function drawConnection(svg, sourcePos, targetPos, nodeWidth, nodeHeight) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', sourcePos.x + nodeWidth);
            line.setAttribute('y1', sourcePos.y + nodeHeight / 2);
            line.setAttribute('x2', targetPos.x);
            line.setAttribute('y2', targetPos.y + nodeHeight / 2);
            line.setAttribute('stroke', '#6b7280');
            line.setAttribute('stroke-width', '2');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            svg.appendChild(line);
        }
        
        function drawCraftNode(svg, item, x, y, nodeWidth, nodeHeight) {
            // 创建节点组
            const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            nodeGroup.setAttribute('transform', `translate(${x}, ${y})`);
            nodeGroup.style.cursor = 'pointer';
            
            // 节点矩形
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', nodeWidth);
            rect.setAttribute('height', nodeHeight);
            rect.setAttribute('rx', '8');
            rect.setAttribute('fill', getRarityColor(item.rarity));
            rect.setAttribute('stroke', '#6b7280');
            rect.setAttribute('stroke-width', '2');
            
            // 节点文本
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', nodeWidth / 2);
            text.setAttribute('y', nodeHeight / 2 + 5);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#ffffff');
            text.setAttribute('font-size', '12');
            text.setAttribute('font-weight', 'bold');
            text.textContent = item.name;
            
            // 点击事件
            nodeGroup.addEventListener('click', () => selectCraftNode(item));
            
            nodeGroup.appendChild(rect);
            nodeGroup.appendChild(text);
            svg.appendChild(nodeGroup);
            
            // 添加箭头标记定义（如果还没有）
            if (!svg.querySelector('#arrowhead')) {
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', 'arrowhead');
                marker.setAttribute('markerWidth', '10');
                marker.setAttribute('markerHeight', '7');
                marker.setAttribute('refX', '9');
                marker.setAttribute('refY', '3.5');
                marker.setAttribute('orient', 'auto');
                
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
                polygon.setAttribute('fill', '#6b7280');
                
                marker.appendChild(polygon);
                defs.appendChild(marker);
                svg.appendChild(defs);
            }
        }
        

        
        function getRarityColor(rarity) {
            const colors = {
                'common': '#6b7280',
                'uncommon': '#10b981',
                'rare': '#3b82f6',
                'epic': '#8b5cf6',
                'legendary': '#f59e0b',
                'supreme': '#ef4444',
                'transcendent': '#ec4899'
            };
            return colors[rarity] || '#6b7280';
        }
        
        function selectCraftNode(node) {
            gameState.craftingTree.selectedNode = node;
            showCraftDetails(node);
        }
        
        function showCraftDetails(node) {
            const detailsPanel = document.getElementById('craftDetailsPanel');
            const materialsList = document.getElementById('craftMaterialsList');
            const resultPreview = document.getElementById('craftResultPreview');
            const executeButton = document.getElementById('craftExecuteButton');
            
            // 显示详情面板
            detailsPanel.classList.remove('hidden');
            
            // 显示所需材料
            materialsList.innerHTML = '';
            let canCraft = true;
            
            node.materials.forEach(material => {
                const materialDiv = document.createElement('div');
                materialDiv.className = 'flex justify-between items-center p-2 bg-gray-700 rounded';
                
                // 检查玩家是否有足够材料
                const playerMaterial = gameState.player.materials.find(m => m.name === material.name);
                const hasEnough = playerMaterial && playerMaterial.count >= material.count;
                if (!hasEnough) canCraft = false;
                
                materialDiv.innerHTML = `
                    <span class="${hasEnough ? 'text-green-400' : 'text-red-400'}">${material.name}</span>
                    <span class="${hasEnough ? 'text-green-400' : 'text-red-400'}">
                        ${playerMaterial ? playerMaterial.count : 0}/${material.count}
                    </span>
                `;
                
                materialsList.appendChild(materialDiv);
            });
            
            // 显示合成结果
            resultPreview.innerHTML = `
                <div class="text-center">
                    <div class="font-bold text-${getRarityTextColor(node.rarity)}">${node.result.name}</div>
                    <div class="text-sm text-gray-300 mt-1">${getItemDescription(node.result)}</div>
                    <div class="text-xs text-yellow-400 mt-1">价值: ${node.result.price || 0}金币</div>
                </div>
            `;
            
            // 设置合成按钮状态
            executeButton.disabled = !canCraft;
            executeButton.textContent = canCraft ? '合成装备' : '材料不足';
        }
        
        function getRarityTextColor(rarity) {
            const colors = {
                'common': 'gray-400',
                'uncommon': 'green-400',
                'rare': 'blue-400',
                'epic': 'purple-400',
                'legendary': 'yellow-400',
                'supreme': 'red-400',
                'transcendent': 'pink-400'
            };
            return colors[rarity] || 'gray-400';
        }
        
        function executeCraft() {
            const selectedNode = gameState.craftingTree.selectedNode;
            if (!selectedNode) return;
            
            // 检查材料
            let canCraft = true;
            selectedNode.materials.forEach(material => {
                const playerMaterial = gameState.player.materials.find(m => m.name === material.name);
                if (!playerMaterial || playerMaterial.count < material.count) {
                    canCraft = false;
                }
            });
            
            if (!canCraft) {
                addLog('材料不足，无法合成');
                return;
            }
            
            // 消耗材料
            selectedNode.materials.forEach(material => {
                const playerMaterial = gameState.player.materials.find(m => m.name === material.name);
                playerMaterial.count -= material.count;
                if (playerMaterial.count <= 0) {
                    const index = gameState.player.materials.indexOf(playerMaterial);
                    gameState.player.materials.splice(index, 1);
                }
            });
            
            // 添加合成结果到背包
            gameState.player.inventory.push({...selectedNode.result});
            
            // 发送物品合成事件到服务器
            sendItemCraftedToServer({
                itemName: selectedNode.result.name,
                itemType: selectedNode.result.type,
                itemRarity: selectedNode.result.rarity,
                materials: selectedNode.materials,
                timestamp: Date.now()
            });
            
            addLog(`成功合成：${selectedNode.result.name}`);
            updateInventoryDisplay();
            showCraftDetails(selectedNode); // 刷新详情面板
            
            // 同步游戏状态到服务器
            syncGameStateToServer();
        }
        
        function resetCraftTreeView() {
            gameState.craftingTree.viewOffset = { x: 0, y: 0 };
            gameState.craftingTree.zoomLevel = 1;
            updateCraftTree();
        }
        
        function showInventoryPanel() {
            document.getElementById('inventoryModal').classList.remove('hidden');
            updateInventoryDisplay();
        }
        
        function hideInventoryPanel() {
            document.getElementById('inventoryModal').classList.add('hidden');
        }
        
        async function showShopPanel() {
            document.getElementById('shopModal').classList.remove('hidden');
            await updateShopDisplay();
        }
        
        function hideShopPanel() {
            document.getElementById('shopModal').classList.add('hidden');
        }
        
        function showAvatarPanel() {
            document.getElementById('avatarModal').classList.remove('hidden');
        }
        
        function hideAvatarPanel() {
            document.getElementById('avatarModal').classList.add('hidden');
        }
        
        function showMoreFunctions() {
            document.getElementById('moreFunctionsModal').classList.remove('hidden');
        }
        
        function hideMoreFunctions() {
            document.getElementById('moreFunctionsModal').classList.add('hidden');
        }
        
        // 刷新主线任务配置
        async function refreshMainQuestConfig() {
            try {
                addLog('正在刷新主线任务配置...');
                showFloatingText('刷新配置中...', 'info');
                
                // 重新加载配置
                const success = await loadMainQuestConfig();
                
                if (success) {
                    // 重新初始化任务系统
                    await initializeQuests();
                    
                    addLog('主线任务配置刷新成功！');
                    showFloatingText('配置刷新成功！', 'success');
                    
                    // 更新任务UI
                    updateActiveQuests();
                    updateAvailableQuests();
                } else {
                    addLog('主线任务配置刷新失败，使用默认配置');
                    showFloatingText('配置刷新失败', 'error');
                }
                
                // 关闭更多功能面板
                hideMoreFunctions();
                
            } catch (error) {
                console.error('刷新主线任务配置时出错:', error);
                addLog('主线任务配置刷新出错: ' + error.message);
                showFloatingText('配置刷新出错', 'error');
            }
        }
        
        function updateInventoryDisplay() {
            const equipmentContainer = document.getElementById('modalEquipmentSlots');
            const inventoryContainer = document.getElementById('modalInventoryItems');
            
            // 更新装备槽位显示并添加点击事件
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace', 'special1', 'special2', 'special3', 'special4'];
            equipmentSlots.forEach(slotType => {
                const element = document.getElementById('modal' + slotType.charAt(0).toUpperCase() + slotType.slice(1));
                const equipment = gameState.player.equipment[slotType];
                const slotContainer = element.parentElement.parentElement; // 获取外层的equipment-slot容器
                
                if (equipment) {
                    element.textContent = equipment.name;
                    // 添加点击事件用于卸下装备
                    slotContainer.style.cursor = 'pointer';
                    slotContainer.style.border = '2px solid #3b82f6';
                    // 添加data属性用于事件委托（模态框中的装备槽）
                    slotContainer.setAttribute('data-modal-slot-key', slotType);
                } else {
                    element.textContent = '无';
                    // 清除点击事件和样式
                    slotContainer.style.cursor = 'default';
                    slotContainer.style.border = '';
                    slotContainer.removeAttribute('data-modal-slot-key');
                }
            });
            
            // 更新背包物品显示
            inventoryContainer.innerHTML = '';
            
            // 异步处理背包物品显示
            (async () => {
                for (let index = 0; index < gameState.player.inventory.length; index++) {
                    const item = gameState.player.inventory[index];
                    
                    // 解析物品数据
                    const resolvedItem = await resolveItemData(item);
                    
                    // 确保物品名称不为空
                    const itemName = resolvedItem.name || '未知物品';
                    if (!resolvedItem.name || resolvedItem.name === '未知物品') {
                        console.warn('发现物品名称为空的物品:', item);
                    }
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-2 rounded border cursor-pointer hover:border-yellow-400 ${getRarityClass(resolvedItem.rarity || 'common')}`;
                    itemDiv.innerHTML = `
                        <div class="text-sm font-bold ${getRarityClass(resolvedItem.rarity || 'common').split(' ')[1]}">${itemName}</div>
                        <div class="text-xs text-gray-400">${getItemDescription(resolvedItem)}</div>
                        <div class="text-xs text-green-400 mt-1">点击使用</div>
                    `;
                    itemDiv.onclick = () => useItem(index);
                    inventoryContainer.appendChild(itemDiv);
                }
            })();
        }
        
        async function updateShopDisplay() {
            const shopContainer = document.getElementById('modalShopItems');
            shopContainer.innerHTML = '';
            
            if (gameState.shopMode === 'buy') {
                // 购买模式
                // 获取最新的装备配置
                let equipmentData;
                try {
                    equipmentData = await configManager.getEquipmentConfig();
                } catch (error) {
                    console.warn('无法加载装备配置，使用默认数据:', error);
                    equipmentData = getEquipmentData();
                }
                
                // 显示武器
                (equipmentData.weapons || []).forEach(weapon => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${weapon.rarity || 'common'}`;
                    
                    // 检查等级和职业要求
                    const requirements = weapon.requirements || {};
                    const requiredLevel = requirements.level || 1;
                    const requiredClass = requirements.class || 'all';
                    const playerLevel = gameState.player.level || 1;
                    const playerClass = gameState.player.class || '';
                    
                    const levelMet = playerLevel >= requiredLevel;
                    const classMet = requiredClass === 'all' || requiredClass === playerClass;
                    
                    let requirementText = `需要等级: ${requiredLevel}`;
                    if (requiredClass !== 'all') {
                        const classNames = { warrior: '战士', mage: '法师', taoist: '道士' };
                        requirementText += ` (${classNames[requiredClass] || requiredClass})`;
                    }
                    
                    const requirementColor = (levelMet && classMet) ? 'text-green-400' : 'text-red-400';
                    
                    // 处理攻击力显示
                    let attackDisplay = '未知';
                    if (weapon.attack) {
                        if (Array.isArray(weapon.attack)) {
                            attackDisplay = weapon.attack[0] + '-' + weapon.attack[1];
                        } else if (typeof weapon.attack === 'string' && weapon.attack.includes(',')) {
                            const attackParts = weapon.attack.split(',').map(v => parseFloat(v.trim()));
                            attackDisplay = attackParts[0] + '-' + attackParts[1];
                        } else {
                            const val = parseFloat(weapon.attack) || 0;
                            attackDisplay = val + '-' + val;
                        }
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="font-bold">${weapon.name || '未知武器'}</div>
                        <div class="text-sm text-gray-300">攻击: ${attackDisplay}</div>
                        <div class="text-sm ${requirementColor}">${requirementText}</div>
                        <div class="text-sm text-yellow-400">价格: ${weapon.price || 0}金币</div>
                        <button onclick="buyItem('weapon', '${weapon.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopContainer.appendChild(itemDiv);
                });
                
                // 显示防具
                (equipmentData.armors || []).forEach(armor => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${armor.rarity || 'common'}`;
                    
                    // 检查等级和职业要求
                    const requirements = armor.requirements || {};
                    const requiredLevel = requirements.level || 1;
                    const requiredClass = requirements.class || 'all';
                    const playerLevel = gameState.player.level || 1;
                    const playerClass = gameState.player.class || '';
                    
                    const levelMet = playerLevel >= requiredLevel;
                    const classMet = requiredClass === 'all' || requiredClass === playerClass;
                    
                    let requirementText = `需要等级: ${requiredLevel}`;
                    if (requiredClass !== 'all') {
                        const classNames = { warrior: '战士', mage: '法师', taoist: '道士' };
                        requirementText += ` (${classNames[requiredClass] || requiredClass})`;
                    }
                    
                    const requirementColor = (levelMet && classMet) ? 'text-green-400' : 'text-red-400';
                    
                    itemDiv.innerHTML = `
                        <div class="font-bold">${armor.name || '未知防具'}</div>
                        <div class="text-sm text-gray-300">防御: ${armor.defense || 0}</div>
                        <div class="text-sm ${requirementColor}">${requirementText}</div>
                        <div class="text-sm text-yellow-400">价格: ${armor.price || 0}金币</div>
                        <button onclick="buyItem('armor', '${armor.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopContainer.appendChild(itemDiv);
                });
                
                // 显示饰品
                (equipmentData.accessories || []).forEach(accessory => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${accessory.rarity || 'common'}`;
                    
                    // 检查等级和职业要求
                    const requirements = accessory.requirements || {};
                    const requiredLevel = requirements.level || 1;
                    const requiredClass = requirements.class || 'all';
                    const playerLevel = gameState.player.level || 1;
                    const playerClass = gameState.player.class || '';
                    
                    const levelMet = playerLevel >= requiredLevel;
                    const classMet = requiredClass === 'all' || requiredClass === playerClass;
                    
                    let requirementText = `需要等级: ${requiredLevel}`;
                    if (requiredClass !== 'all') {
                        const classNames = { warrior: '战士', mage: '法师', taoist: '道士' };
                        requirementText += ` (${classNames[requiredClass] || requiredClass})`;
                    }
                    
                    const requirementColor = (levelMet && classMet) ? 'text-green-400' : 'text-red-400';
                    
                    itemDiv.innerHTML = `
                        <div class="font-bold">${accessory.name || '未知饰品'}</div>
                        <div class="text-sm text-gray-300">${getItemDescription(accessory)}</div>
                        <div class="text-sm ${requirementColor}">${requirementText}</div>
                        <div class="text-sm text-yellow-400">价格: ${accessory.price || 0}金币</div>
                        <button onclick="buyItem('accessory', '${accessory.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopContainer.appendChild(itemDiv);
                });
                
                // 显示药水
                (equipmentData.potions || []).forEach(potion => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${potion.rarity || 'common'}`;
                    
                    // 检查等级和职业要求（药水通常没有要求，但为了一致性检查）
                    const requirements = potion.requirements || {};
                    const requiredLevel = requirements.level || 1;
                    const requiredClass = requirements.class || 'all';
                    const playerLevel = gameState.player.level || 1;
                    const playerClass = gameState.player.class || '';
                    
                    const levelMet = playerLevel >= requiredLevel;
                    const classMet = requiredClass === 'all' || requiredClass === playerClass;
                    
                    let requirementHtml = '';
                    if (requiredLevel > 1 || requiredClass !== 'all') {
                        let requirementText = `需要等级: ${requiredLevel}`;
                        if (requiredClass !== 'all') {
                            const classNames = { warrior: '战士', mage: '法师', taoist: '道士' };
                            requirementText += ` (${classNames[requiredClass] || requiredClass})`;
                        }
                        const requirementColor = (levelMet && classMet) ? 'text-green-400' : 'text-red-400';
                        requirementHtml = `<div class="text-sm ${requirementColor}">${requirementText}</div>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="font-bold">${potion.name || '未知药水'}</div>
                        <div class="text-sm text-gray-300">${getItemDescription(potion)}</div>
                        ${requirementHtml}
                        <div class="text-sm text-yellow-400">价格: ${potion.price || 0}金币</div>
                        <button onclick="buyItem('potion', '${potion.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopContainer.appendChild(itemDiv);
                });
                
                // 显示养成材料
                const cultivationMaterials = [
                    { name: '铁矿石', price: 10, description: '基础合成材料' },
                    { name: '银矿石', price: 30, description: '稀有合成材料' },
                    { name: '魔法水晶', price: 50, description: '魔法装备合成材料' },
                    { name: '黄金矿石', price: 80, description: '史诗合成材料' },
                    { name: '暗影精华', price: 120, description: '高级合成材料' },
                    { name: '龙鳞片', price: 200, description: '传说合成材料' },
                    { name: '神圣宝石', price: 300, description: '顶级合成材料' },
                    { name: '稀有宝石', price: 150, description: '用于高级合成的珍贵材料' }
                ];
                
                cultivationMaterials.forEach(material => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-gray-800 p-3 rounded border-2 border-purple-600';
                    itemDiv.innerHTML = `
                        <div class="font-bold text-purple-400">${material.name}</div>
                        <div class="text-sm text-gray-300">${material.description}</div>
                        <div class="text-sm text-yellow-400">价格: ${material.price}金币</div>
                        <button onclick="buyCultivationMaterial('${material.name}', ${material.price})" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopContainer.appendChild(itemDiv);
                });
            } else {
                // 出售模式
                if (gameState.player.inventory.length === 0) {
                    shopContainer.innerHTML = '<div class="text-gray-400 text-center py-8 col-span-2">背包中没有可出售的物品</div>';
                    return;
                }
                
                gameState.player.inventory.forEach((item, index) => {
                    const sellPrice = Math.floor((item.price || 0) * 0.5); // 出售价格为购买价格的50%
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${item.rarity || 'common'}`;
                    itemDiv.innerHTML = `
                        <div class="font-bold">${item.name || '未知物品'}</div>
                        <div class="text-sm text-gray-300">${getItemDescription(item)}</div>
                        <div class="text-sm text-yellow-400">出售价格: ${sellPrice}金币</div>
                        <button onclick="sellItem(${index})" class="btn-primary px-3 py-1 rounded text-sm mt-2">出售</button>
                    `;
                    shopContainer.appendChild(itemDiv);
                });
            }
        }
        
        function changeAvatar(avatarType) {
            const avatarSvg = document.getElementById('playerAvatar');
            
            // 根据头像类型更新SVG
            switch(avatarType) {
                case 'warrior':
                    avatarSvg.innerHTML = `
                        <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                        <rect x="18" y="18" width="12" height="4" fill="#8B4513"/>
                        <rect x="22" y="22" width="2" height="2" fill="#000"/>
                        <rect x="24" y="22" width="2" height="2" fill="#000"/>
                        <rect x="16" y="16" width="16" height="2" fill="#C0C0C0"/>
                    `;
                    break;
                case 'mage':
                    avatarSvg.innerHTML = `
                        <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                        <rect x="18" y="18" width="12" height="4" fill="#4169E1"/>
                        <rect x="22" y="22" width="2" height="2" fill="#000"/>
                        <rect x="24" y="22" width="2" height="2" fill="#000"/>
                        <rect x="20" y="16" width="8" height="2" fill="#8B4513"/>
                    `;
                    break;
                case 'taoist':
                    avatarSvg.innerHTML = `
                        <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                        <rect x="18" y="18" width="12" height="4" fill="#228B22"/>
                        <rect x="22" y="22" width="2" height="2" fill="#000"/>
                        <rect x="24" y="22" width="2" height="2" fill="#000"/>
                        <rect x="19" y="16" width="10" height="2" fill="#8B4513"/>
                    `;
                    break;
            }
            hideAvatarPanel();
        }
        
        // 解析物品数据 - 根据字符串ID获取完整物品信息
        async function resolveItemData(item) {
            // 如果已经有完整的物品信息，直接返回
            if (item.name && item.name !== '未知物品') {
                return item;
            }
            
            // ID映射表
            const idMapping = {
                'health_potion_small': 2001,
                'health_potion_medium': 2002,
                'health_potion_large': 2003,
                'mana_potion_small': 2004,
                'mana_potion_medium': 2005,
                'mana_potion_large': 2006,
                'iron_ore': 2101,
                'silver_ore': 2102,
                'gold_ore': 2103,
                'magic_crystal': 2104,
                'dragon_scale': 2105,
                'holy_gem': 2106,
                'rare_gem': 2107,
                'shadow_essence': 2108
            };
            
            const numericId = idMapping[item.id];
            if (!numericId) {
                console.warn('未知的物品ID:', item.id);
                return { ...item, name: '未知物品', description: '未知物品' };
            }
            
            try {
                // 获取物品配置
                const itemConfig = await configManager.getItemConfig();
                
                // 在药水中查找
                let foundItem = itemConfig.potions?.find(p => p.id === numericId);
                
                // 在材料中查找
                if (!foundItem) {
                    foundItem = itemConfig.materials?.find(m => m.id === numericId);
                }
                
                if (foundItem) {
                    return {
                        ...item,
                        name: foundItem.name,
                        description: foundItem.description || getItemDescription(foundItem),
                        price: foundItem.price,
                        rarity: foundItem.rarity || 'common',
                        type: foundItem.type,
                        effect: foundItem.effect
                    };
                }
            } catch (error) {
                console.warn('获取物品配置失败:', error);
            }
            
            return { ...item, name: '未知物品', description: '未知物品' };
        }
        
        // 更新玩家信息显示
        function updatePlayerInfo() {
            const player = gameState.player;
            
            // 计算包含装备和套装加成的最大血量和魔法值
            const specialBonus = calculateSpecialEquipmentBonus();
            const setBonus = calculateSetBonus();
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            // 更新顶部导航栏信息
            document.getElementById('playerClass').textContent = player.class || '未选择职业';
            document.getElementById('playerLevel').textContent = player.level || 1;
            
            // 更新生命值
            document.getElementById('hpText').textContent = `${Math.floor(player.hp)}/${totalMaxHp}`;
            const hpPercent = (player.hp / totalMaxHp) * 100;
            document.getElementById('hpBar').style.width = `${hpPercent}%`;
            
            // 更新魔法值
            document.getElementById('mpText').textContent = `${Math.floor(player.mp)}/${totalMaxMp}`;
            const mpPercent = (player.mp / totalMaxMp) * 100;
            document.getElementById('mpBar').style.width = `${mpPercent}%`;
            
            // 更新金币 - 确保显示为纯数字，移除任何格式化字符
            const goldValue = parseInt(player.gold) || 0;
            document.getElementById('playerGold').textContent = goldValue;
            
            // 更新经验值
            const exp = player.exp || 0;
            const maxExp = player.maxExp || 100;
            document.getElementById('playerExp').textContent = `${exp}/${maxExp}`;
            const expPercent = (exp / maxExp) * 100;
            document.getElementById('expBar').style.width = `${expPercent}%`;
        }
        
        // 地图怪物管理
        let mapMonsters = [];
        let playerPosition = { x: 50, y: 50 }; // 玩家在地图上的位置百分比
        
        // 自动战斗系统
        let autoFightEnabled = false;
        let autoFightInterval = null;
        let autoFightSearchInterval = null;
        
        // 自动刷新怪物系统
        let autoRefreshEnabled = true; // 默认开启自动刷新
        let autoRefreshInterval = null;
        
        // 启动自动刷新怪物系统
        function startAutoRefreshMonsters() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshEnabled = true;
            autoRefreshInterval = setInterval(async () => {
                if (autoRefreshEnabled && !gameState.inBattle) {
                    await checkAndRefreshMonsters();
                }
            }, 5000); // 每5秒检查一次
            
            console.log('Auto refresh monsters system started');
        }
        
        // 停止自动刷新怪物系统
        function stopAutoRefreshMonsters() {
            autoRefreshEnabled = false;
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            console.log('Auto refresh monsters system stopped');
        }
        
        // 生成地图怪物
        // 怪物实例ID计数器
        let monsterInstanceCounter = 0;
        
        async function generateMapMonsters() {
            console.log('generateMapMonsters called');
            const gameMap = document.getElementById('gameMap');
            const monstersContainer = document.getElementById('monstersOnMap');
            
            // 清空现有怪物
            monstersContainer.innerHTML = '';
            mapMonsters = [];
            // 重置怪物实例计数器
            monsterInstanceCounter = 0;
            
            // 根据当前位置生成怪物
            const currentLocation = gameState.currentLocation || 1;
            console.log('Current location:', currentLocation);
            console.log('ConfigManager available:', !!configManager);
            console.log('ConfigManager initialized:', configManager && configManager.isInitialized());
            
            try {
                // 从配置表获取地图信息
                const mapInfo = await configManager.getMapById(currentLocation);
                console.log('Map info:', mapInfo);
                if (!mapInfo) {
                    console.warn(`Map ${currentLocation} not found in config, using default`);
                    return;
                }
                
                // 从配置表获取该地图的怪物列表
                const availableMonsters = await configManager.getMonstersByMap(currentLocation);
                console.log('Available monsters:', availableMonsters);
                if (!availableMonsters || availableMonsters.length === 0) {
                    // 检查是否为安全区域
                    if (mapInfo.type === 'safe' || mapInfo.monsterSpawnRate === 0) {
                        console.log(`Map ${currentLocation} is a safe zone, no monsters will spawn`);
                    } else {
                        console.warn(`No monsters found for map ${currentLocation}`);
                    }
                    return;
                }
                
                // 获取配置（优先使用临时配置）
                const tempConfig = gameState.tempMapConfig && gameState.tempMapConfig[currentLocation];
                const spawnRate = tempConfig?.monsterSpawnRate ?? mapInfo.monsterSpawnRate ?? 0.8;
                const maxMonstersConfig = tempConfig?.maxMonsters ?? mapInfo.maxMonsters ?? 6;
                const allowedTypesConfig = tempConfig?.allowedMonsterTypes ?? mapInfo.allowedMonsterTypes;
                
                console.log('Using config:', { spawnRate, maxMonstersConfig, allowedTypesConfig, tempConfig });
                
                // 检查怪物生成率
                if (Math.random() > spawnRate) {
                    console.log(`Monster spawn failed due to spawn rate (${spawnRate})`);
                    return;
                }
                
                // 根据地图配置生成怪物数量
                const minMonsters = Math.max(1, Math.floor(maxMonstersConfig * 0.3)); // 最小数量为最大数量的30%
                const maxMonsters = maxMonstersConfig;
                const monsterCount = Math.floor(Math.random() * (maxMonsters - minMonsters + 1)) + minMonsters;
                
                // 根据地图允许的怪物类型过滤怪物
                let filteredMonsters = availableMonsters;
                if (allowedTypesConfig && allowedTypesConfig.length > 0) {
                    // 如果是临时配置，按怪物ID过滤；如果是原始配置，按怪物类型过滤
                    if (tempConfig) {
                        filteredMonsters = availableMonsters.filter(monster => 
                            allowedTypesConfig.includes(monster.id)
                        );
                        console.log(`Filtered monsters by ID ${allowedTypesConfig}:`, filteredMonsters.length);
                    } else {
                        filteredMonsters = availableMonsters.filter(monster => 
                            allowedTypesConfig.includes(monster.type)
                        );
                        console.log(`Filtered monsters by type ${allowedTypesConfig}:`, filteredMonsters.length);
                    }
                }
                
                if (filteredMonsters.length === 0) {
                    console.warn(`No monsters match allowed types for map ${currentLocation}`);
                    return;
                }
                
                // 创建权重数组用于随机选择怪物
                const weightedMonsters = [];
                filteredMonsters.forEach(monster => {
                    const weight = monster.spawnWeight || 1;
                    for (let w = 0; w < weight; w++) {
                        weightedMonsters.push(monster);
                    }
                });
                
                for (let i = 0; i < monsterCount; i++) {
                    // 根据权重随机选择怪物模板
                    const monsterTemplate = weightedMonsters[Math.floor(Math.random() * weightedMonsters.length)];
                    // 计算随机金币值
                    let goldValue;
                    if (typeof monsterTemplate.gold === 'string' && monsterTemplate.gold.includes(',')) {
                        // 逗号分隔的字符串格式，如 "5,12"
                        const goldParts = monsterTemplate.gold.split(',').map(v => parseFloat(v.trim()));
                        const minGold = goldParts[0];
                        const maxGold = goldParts[1];
                        goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                    } else if (Array.isArray(monsterTemplate.gold)) {
                        const minGold = monsterTemplate.gold[0];
                        const maxGold = monsterTemplate.gold[1];
                        goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                    } else {
                        goldValue = parseFloat(monsterTemplate.gold) || 0;
                    }
                    
                    // 处理攻击力字段，将字符串格式转换为数组格式
                    let attackValue;
                    if (typeof monsterTemplate.attack === 'string' && monsterTemplate.attack.includes(',')) {
                        // 逗号分隔的字符串格式，如 "3,6"
                        const attackParts = monsterTemplate.attack.split(',').map(v => parseFloat(v.trim()));
                        attackValue = [attackParts[0], attackParts[1]];
                    } else if (Array.isArray(monsterTemplate.attack)) {
                        // 已经是数组格式
                        attackValue = monsterTemplate.attack;
                    } else {
                        // 单个数值，转换为范围
                        const val = parseFloat(monsterTemplate.attack) || 0;
                        attackValue = [val, val];
                    }
                    
                    const monsterData = {
                        id: `monster_${++monsterInstanceCounter}`, // 使用简单的递增ID
                        templateId: monsterTemplate.id, // 保存原始模板ID用于引用
                        name: monsterTemplate.name,
                        hp: monsterTemplate.hp,
                        maxHp: monsterTemplate.hp,
                        x: Math.random() * 80 + 10, // 10%-90%的位置
                        y: Math.random() * 80 + 10,
                        attack: attackValue,
                        defense: monsterTemplate.defense,
                        exp: monsterTemplate.exp,
                        gold: goldValue
                    };
                    
                    console.log('Generated monster data (config):', monsterData);
                    mapMonsters.push(monsterData);
                     
                     // 创建怪物DOM元素
                const monsterElement = document.createElement('div');
                monsterElement.id = monsterData.id;
                monsterElement.className = 'absolute cursor-pointer hover:scale-110 transition-transform';
                monsterElement.style.left = `${monsterData.x}%`;
                monsterElement.style.top = `${monsterData.y}%`;
                monsterElement.style.transform = 'translate(-50%, -50%)';
                
                monsterElement.innerHTML = `
                    <div class="relative">
                        <div class="w-8 h-8 bg-orange-600 rounded-full border border-orange-400 flex items-center justify-center">
                            <span class="text-white text-xs font-bold">怪</span>
                        </div>
                        <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-xs text-red-400 font-bold whitespace-nowrap">
                            ${monsterData.name}
                        </div>
                        <div class="monster-hp-container absolute" style="top: -12px; left: -12px; width: 56px; height: 56px; pointer-events: none;">
                            <svg class="absolute inset-0 w-full h-full" style="transform: rotate(-90deg);">
                                <circle cx="50%" cy="50%" r="20" fill="none" stroke="rgba(75, 85, 99, 0.5)" stroke-width="2"/>
                                <circle class="monster-hp-circle" cx="50%" cy="50%" r="20" fill="none" stroke="#ef4444" stroke-width="2" 
                                        stroke-linecap="round" stroke-dasharray="${2 * Math.PI * 20}" stroke-dashoffset="${(1 - monsterData.hp / monsterData.maxHp) * 2 * Math.PI * 20}" 
                                        style="transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;"/>
                            </svg>
                            <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-white font-bold text-center whitespace-nowrap monster-hp-text">
                                ${monsterData.hp}/${monsterData.maxHp}
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加data属性用于事件委托
                monsterElement.setAttribute('data-monster-id', monsterData.id);
                
                    monstersContainer.appendChild(monsterElement);
                }
            } catch (error) {
                console.error('Error generating map monsters:', error);
                // 如果配置表加载失败，使用默认逻辑
                const locationMonsters = monsters[currentLocation] || monsters.village;
                if (locationMonsters && locationMonsters.length > 0) {
                    const monsterCount = Math.floor(Math.random() * 4) + 3;
                    for (let i = 0; i < monsterCount; i++) {
                        const monsterTemplate = locationMonsters[Math.floor(Math.random() * locationMonsters.length)];
                        // 计算随机金币值
                        let goldValue;
                        if (typeof monsterTemplate.gold === 'string' && monsterTemplate.gold.includes(',')) {
                            // 逗号分隔的字符串格式，如 "5,12"
                            const goldParts = monsterTemplate.gold.split(',').map(v => parseFloat(v.trim()));
                            const minGold = goldParts[0];
                            const maxGold = goldParts[1];
                            goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                        } else if (Array.isArray(monsterTemplate.gold)) {
                            const minGold = monsterTemplate.gold[0];
                            const maxGold = monsterTemplate.gold[1];
                            goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                        } else {
                            goldValue = parseFloat(monsterTemplate.gold) || 0;
                        }
                        
                        // 处理攻击力字段，将字符串格式转换为数组格式
                        let attackValue;
                        if (typeof monsterTemplate.attack === 'string' && monsterTemplate.attack.includes(',')) {
                            // 逗号分隔的字符串格式，如 "3,6"
                            const attackParts = monsterTemplate.attack.split(',').map(v => parseFloat(v.trim()));
                            attackValue = [attackParts[0], attackParts[1]];
                        } else if (Array.isArray(monsterTemplate.attack)) {
                            // 已经是数组格式
                            attackValue = monsterTemplate.attack;
                        } else {
                            // 单个数值，转换为范围
                            const val = parseFloat(monsterTemplate.attack) || 0;
                            attackValue = [val, val];
                        }
                        
                        const monsterData = {
                            id: `monster_${++monsterInstanceCounter}`, // 使用简单的递增ID
                            templateId: monsterTemplate.id || monsterTemplate.name, // 保存原始模板ID用于引用
                            name: monsterTemplate.name,
                            hp: monsterTemplate.hp,
                            maxHp: monsterTemplate.hp,
                            x: Math.random() * 80 + 10,
                            y: Math.random() * 80 + 10,
                            attack: attackValue,
                            defense: monsterTemplate.defense,
                            exp: monsterTemplate.exp,
                            gold: goldValue
                        };
                        
                        console.log('Generated monster data (default):', monsterData);
                        mapMonsters.push(monsterData);
                        
                        // 创建怪物DOM元素
                        const monsterElement = document.createElement('div');
                        monsterElement.id = monsterData.id;
                        monsterElement.className = 'absolute cursor-pointer hover:scale-110 transition-transform';
                        monsterElement.style.left = `${monsterData.x}%`;
                        monsterElement.style.top = `${monsterData.y}%`;
                        monsterElement.style.transform = 'translate(-50%, -50%)';
                        
                        monsterElement.innerHTML = `
                            <div class="relative">
                                <div class="w-8 h-8 bg-orange-600 rounded-full border border-orange-400 flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">怪</span>
                                </div>
                                <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-xs text-red-400 font-bold whitespace-nowrap">
                                    ${monsterData.name}
                                </div>
                                <div class="monster-hp-container absolute" style="top: -12px; left: -12px; width: 56px; height: 56px; pointer-events: none;">
                                    <svg class="absolute inset-0 w-full h-full" style="transform: rotate(-90deg);">
                                        <circle cx="50%" cy="50%" r="20" fill="none" stroke="rgba(75, 85, 99, 0.5)" stroke-width="2"/>
                                        <circle class="monster-hp-circle" cx="50%" cy="50%" r="20" fill="none" stroke="#ef4444" stroke-width="2" 
                                                stroke-linecap="round" stroke-dasharray="${2 * Math.PI * 20}" stroke-dashoffset="${(1 - monsterData.hp / monsterData.maxHp) * 2 * Math.PI * 20}" 
                                                style="transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;"/>
                                    </svg>
                                    <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-white font-bold text-center whitespace-nowrap monster-hp-text">
                                        ${monsterData.hp}/${monsterData.maxHp}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // 添加data属性用于事件委托
                        monsterElement.setAttribute('data-monster-id', monsterData.id);
                        monstersContainer.appendChild(monsterElement);
                    }
                }
            }
            
            console.log('Final mapMonsters array:', mapMonsters);
            console.log('Total monsters generated:', mapMonsters.length);
            
            // 重新初始化怪物事件委托，确保新生成的怪物能响应点击事件
            initializeMonsterEventDelegation();
        }
        
        // 手动刷新怪物函数
        function refreshMapMonsters() {
            // 检查是否在战斗中
            if (gameState.inBattle) {
                addLog('战斗中无法刷新怪物！');
                return;
            }
            
            console.log('Manual monster refresh triggered');
            addLog('正在刷新地图怪物...');
            
            // 添加按钮冷却效果
            const refreshBtn = document.getElementById('refreshMonstersBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.style.opacity = '0.5';
                refreshBtn.innerHTML = '<span>⏳</span><span class="text-xs font-bold">刷新中...</span>';
                
                // 3秒后恢复按钮
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.style.opacity = '1';
                    refreshBtn.innerHTML = '<span>🔄</span><span class="text-xs font-bold">刷新怪物</span>';
                }, 3000);
            }
            
            // 执行怪物生成
            generateMapMonsters();
            
            // 延迟显示完成消息
            setTimeout(() => {
                const monsterCount = mapMonsters.length;
                if (monsterCount > 0) {
                    addLog(`成功刷新了${monsterCount}只怪物！`);
                } else {
                    addLog('当前地图没有刷新出怪物');
                }
            }, 100);
        }
        
        // 测试函数：手动刷新怪物（保留用于调试）
        function testRefreshMonsters() {
            console.log('Test monster refresh triggered');
            refreshMapMonsters();
        }
        
        // 显示地图配置弹窗
        function showMapConfig() {
            const modal = document.getElementById('mapConfigModal');
            if (modal) {
                modal.classList.remove('hidden');
                updateMapConfigDisplay();
                loadAllowedMonsterTypes();
            }
        }
        
        // 隐藏地图配置弹窗
        function hideMapConfig() {
            const modal = document.getElementById('mapConfigModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // 更新地图配置显示
        async function updateMapConfigDisplay() {
            try {
                const mapConfig = await configManager.getMapById(gameState.currentMapId);
                
                if (mapConfig) {
                    document.getElementById('currentMapName').textContent = mapConfig.name || '-';
                    document.getElementById('currentMapLevel').textContent = mapConfig.level || '-';
                    document.getElementById('currentMapType').textContent = mapConfig.type || '-';
                    document.getElementById('currentMonsterSpawnRate').textContent = mapConfig.monsterSpawnRate || '-';
                    document.getElementById('currentMaxMonsters').textContent = mapConfig.maxMonsters || '-';
                    document.getElementById('currentMonsterCount').textContent = mapMonsters.length;
                    
                    // 设置输入框的当前值
                    document.getElementById('monsterSpawnRateInput').value = mapConfig.monsterSpawnRate || 0.8;
                    document.getElementById('maxMonstersInput').value = mapConfig.maxMonsters || 10;
                } else {
                    // 如果没有配置，显示默认值
                    document.getElementById('currentMapName').textContent = '未知地图';
                    document.getElementById('currentMapLevel').textContent = '1';
                    document.getElementById('currentMapType').textContent = '普通';
                    document.getElementById('currentMonsterSpawnRate').textContent = '0.8';
                    document.getElementById('currentMaxMonsters').textContent = '10';
                    document.getElementById('currentMonsterCount').textContent = mapMonsters.length;
                    
                    document.getElementById('monsterSpawnRateInput').value = 0.8;
                    document.getElementById('maxMonstersInput').value = 10;
                }
                
                // 更新自动刷新状态显示
                updateAutoRefreshDisplay();
            } catch (error) {
                console.error('Error updating map config display:', error);
                addLog('获取地图配置失败');
            }
        }
        
        // 切换自动刷新怪物功能
        function toggleAutoRefreshMonsters() {
            if (autoRefreshEnabled) {
                stopAutoRefreshMonsters();
                addLog('自动刷新怪物已关闭');
            } else {
                startAutoRefreshMonsters();
                addLog('自动刷新怪物已开启');
            }
            updateAutoRefreshDisplay();
        }
        
        // 更新自动刷新状态显示
        function updateAutoRefreshDisplay() {
            const toggleButton = document.getElementById('autoRefreshToggle');
            const statusText = document.getElementById('autoRefreshStatus');
            
            if (toggleButton && statusText) {
                if (autoRefreshEnabled) {
                    toggleButton.className = 'px-4 py-2 rounded-lg font-bold transition-all duration-200 bg-green-600 hover:bg-green-500 text-white';
                    statusText.textContent = '开启';
                } else {
                    toggleButton.className = 'px-4 py-2 rounded-lg font-bold transition-all duration-200 bg-gray-600 hover:bg-gray-500 text-white';
                    statusText.textContent = '关闭';
                }
            }
        }
        
        // 加载允许的怪物类型
        async function loadAllowedMonsterTypes() {
            try {
                const mapConfig = await configManager.getMapById(gameState.currentMapId);
                const monsterTemplates = await configManager.getMonstersByMap(gameState.currentMapId);
                const container = document.getElementById('allowedMonsterTypes');
                
                if (!container) return;
                
                container.innerHTML = '';
                
                if (monsterTemplates && monsterTemplates.length > 0) {
                    const allowedTypes = mapConfig?.allowedMonsterTypes || [];
                    
                    monsterTemplates.forEach(monster => {
                        const isChecked = allowedTypes.length === 0 || allowedTypes.includes(monster.id);
                        
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'flex items-center space-x-2';
                        checkboxDiv.innerHTML = `
                            <input type="checkbox" id="monster_${monster.id}" value="${monster.id}" 
                                   ${isChecked ? 'checked' : ''} class="text-blue-600">
                            <label for="monster_${monster.id}" class="text-sm text-gray-300 cursor-pointer">
                                ${monster.name} (Lv.${monster.level})
                            </label>
                        `;
                        container.appendChild(checkboxDiv);
                    });
                } else {
                    container.innerHTML = '<div class="text-gray-400 text-sm">当前地图没有可用的怪物类型</div>';
                }
            } catch (error) {
                console.error('Error loading monster types:', error);
                const container = document.getElementById('allowedMonsterTypes');
                if (container) {
                    container.innerHTML = '<div class="text-red-400 text-sm">加载怪物类型失败</div>';
                }
            }
        }
        
        // 应用怪物配置
        function applyMonsterConfig() {
            const spawnRate = parseFloat(document.getElementById('monsterSpawnRateInput').value);
            const maxMonsters = parseInt(document.getElementById('maxMonstersInput').value);
            
            if (isNaN(spawnRate) || spawnRate < 0 || spawnRate > 1) {
                addLog('怪物生成率必须在0-1之间！');
                return;
            }
            
            if (isNaN(maxMonsters) || maxMonsters < 1 || maxMonsters > 50) {
                addLog('最大怪物数量必须在1-50之间！');
                return;
            }
            
            // 获取选中的怪物类型
            const selectedTypes = [];
            const checkboxes = document.querySelectorAll('#allowedMonsterTypes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedTypes.push(checkbox.value);
            });
            
            if (selectedTypes.length === 0) {
                addLog('至少需要选择一种怪物类型！');
                return;
            }
            
            // 临时保存配置到游戏状态（实际游戏中可能需要保存到服务器）
            if (!gameState.tempMapConfig) {
                gameState.tempMapConfig = {};
            }
            
            gameState.tempMapConfig[gameState.currentMapId] = {
                monsterSpawnRate: spawnRate,
                maxMonsters: maxMonsters,
                allowedMonsterTypes: selectedTypes
            };
            
            addLog(`配置已应用：生成率${spawnRate}，最大数量${maxMonsters}，怪物类型${selectedTypes.length}种`);
            updateMapConfigDisplay();
        }
        
        // 重置怪物配置
        async function resetMonsterConfig() {
            try {
                const mapConfig = await configManager.getMapById(gameState.currentMapId);
                
                if (mapConfig) {
                    document.getElementById('monsterSpawnRateInput').value = mapConfig.monsterSpawnRate || 0.8;
                    document.getElementById('maxMonstersInput').value = mapConfig.maxMonsters || 10;
                } else {
                    document.getElementById('monsterSpawnRateInput').value = 0.8;
                    document.getElementById('maxMonstersInput').value = 10;
                }
                
                // 清除临时配置
                if (gameState.tempMapConfig && gameState.tempMapConfig[gameState.currentMapId]) {
                    delete gameState.tempMapConfig[gameState.currentMapId];
                }
                
                // 重新加载怪物类型
                loadAllowedMonsterTypes();
                updateMapConfigDisplay();
                
                addLog('配置已重置为默认值');
            } catch (error) {
                console.error('Error resetting config:', error);
                addLog('重置配置失败');
            }
        }
        
        // 全选怪物类型
        function selectAllMonsterTypes() {
            const checkboxes = document.querySelectorAll('#allowedMonsterTypes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        // 全不选怪物类型
        function deselectAllMonsterTypes() {
            const checkboxes = document.querySelectorAll('#allowedMonsterTypes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // 测试怪物生成
        function testMonsterGeneration() {
            const spawnRate = parseFloat(document.getElementById('monsterSpawnRateInput').value) || 0.8;
            const maxMonsters = parseInt(document.getElementById('maxMonstersInput').value) || 10;
            
            // 获取选中的怪物类型
            const selectedTypes = [];
            const checkboxes = document.querySelectorAll('#allowedMonsterTypes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedTypes.push(checkbox.value);
            });
            
            if (selectedTypes.length === 0) {
                addLog('请先选择要测试的怪物类型！');
                return;
            }
            
            // 计算预期生成数量
            const minMonsters = Math.max(1, Math.floor(maxMonsters * 0.3));
            const expectedCount = Math.floor(Math.random() * (maxMonsters - minMonsters + 1)) + minMonsters;
            const actualCount = Math.random() < spawnRate ? expectedCount : Math.floor(expectedCount * 0.5);
            
            addLog(`测试结果：配置最大${maxMonsters}只，预期生成${expectedCount}只，实际可能生成${actualCount}只`);
            addLog(`生成率：${spawnRate}，允许类型：${selectedTypes.length}种`);
        }
        
        // 移动到怪物位置并开始地图战斗
        function moveToMonsterAndFight(monster) {
            // 首先检查怪物是否仍然存在于mapMonsters数组中
            const existingMonster = mapMonsters.find(m => m.id === monster.id);
            if (!existingMonster) {
                console.log('Monster no longer exists in mapMonsters array, aborting moveToMonsterAndFight');
                addLog(`${monster.name}已经被消灭，无法攻击`);
                return;
            }
            
            // 如果已经在战斗中，不允许开始新战斗
            if (gameState.inBattle) {
                addLog('你正在战斗中，无法攻击其他怪物！');
                return;
            }
            
            // 添加战斗表现 - 怪物闪烁效果
            const monsterElement = document.getElementById(existingMonster.id);
            if (monsterElement) {
                monsterElement.style.animation = 'pulse 0.5s ease-in-out 3';
                // 添加战斗状态样式
                monsterElement.classList.add('in-battle');
            }
            
            // 设置固定战斗距离
            const fixedDistance = 8; // 固定距离8个单位
            
            // 计算玩家当前与怪物的方向
            const dx = playerPosition.x - existingMonster.x;
            const dy = playerPosition.y - existingMonster.y;
            const currentDistance = Math.sqrt(dx * dx + dy * dy);
            
            // 确定移动方向角度
            let angle;
            if (currentDistance > 0.1) {
                // 使用当前玩家与怪物的方向向量
                angle = Math.atan2(dy, dx);
            } else {
                // 如果玩家与怪物位置重叠，选择一个默认方向（向右）
                angle = 0;
            }
            
            // 计算玩家的目标位置，确保与怪物保持固定距离
            const newX = existingMonster.x + Math.cos(angle) * fixedDistance;
            const newY = existingMonster.y + Math.sin(angle) * fixedDistance;
            
            // 确保玩家位置在地图边界内
            playerPosition.x = Math.max(5, Math.min(95, newX));
            playerPosition.y = Math.max(5, Math.min(95, newY));
            
            // 获取玩家元素并计算当前位置
            const playerElement = document.getElementById('playerOnMap');
            const currentX = parseFloat(playerElement.style.left) || 50;
            const currentY = parseFloat(playerElement.style.top) || 50;
            
            // 计算移动距离，用于确定动画时间
            const moveDistance = Math.sqrt(
                Math.pow(playerPosition.x - currentX, 2) +
                Math.pow(playerPosition.y - currentY, 2)
            );
            
            // 根据移动距离动态计算动画时间（最少0.5秒，最多2秒）
            const animationTime = Math.max(0.5, Math.min(2.0, moveDistance / 20));
            
            // 移动玩家图标并添加移动动画
            playerElement.style.transition = `all ${animationTime}s ease-in-out`;
            playerElement.style.left = `${playerPosition.x}%`;
            playerElement.style.top = `${playerPosition.y}%`;
            
            // 添加战斗音效提示
            addLog(`正在接近${existingMonster.name}...`);
            
            // 根据动画时间动态延迟开始战斗（增加200毫秒缓冲）
            const battleDelay = (animationTime * 1000) + 200;
            setTimeout(() => {
                // 再次检查怪物是否仍然存在于mapMonsters数组中
                const currentExistingMonster = mapMonsters.find(m => m.id === existingMonster.id);
                if (!currentExistingMonster) {
                    console.log('Monster no longer exists in mapMonsters array, battle cancelled');
                    addLog(`${existingMonster.name}已经被消灭，取消战斗`);
                    // 移除怪物的战斗状态样式
                    const monsterElement = document.getElementById(existingMonster.id);
                    if (monsterElement) {
                        monsterElement.classList.remove('in-battle');
                    }
                    return;
                }
                
                // 检查战斗状态，确保没有其他战斗在进行且怪物仍然存活
                if (!gameState.inBattle && currentExistingMonster.hp > 0) {
                    const monsterElement = document.getElementById(existingMonster.id);
                    // 确保怪物元素仍然存在
                    if (monsterElement) {
                        startMapBattle(currentExistingMonster); // 使用最新的怪物对象
                        
                        // 自动开始自动战斗
                        setTimeout(() => {
                            if (gameState.inBattle && !gameState.autoBattle) {
                                startAutoBattle();
                            }
                        }, 100);
                    } else {
                        console.log('Monster element not found, battle cancelled');
                        addLog(`${existingMonster.name}已经不存在，取消战斗`);
                    }
                } else {
                    console.log('Battle cancelled - already in battle or monster dead', {
                        inBattle: gameState.inBattle,
                        monsterHp: currentExistingMonster.hp
                    });
                    addLog('战斗已取消');
                    // 移除怪物的战斗状态样式
                    const monsterElement = document.getElementById(existingMonster.id);
                    if (monsterElement) {
                        monsterElement.classList.remove('in-battle');
                    }
                }
            }, battleDelay);
        }
        
        // 更新地图显示
        function updateMapDisplay() {
            console.log('updateMapDisplay called');
            // 更新玩家名称显示
            const playerNameElement = document.getElementById('playerNameOnMap');
            if (playerNameElement) {
                playerNameElement.textContent = gameState.player.class || '玩家';
            }
            
            // 更新称号显示
            updatePlayerTitleOnMap();
            
            // 更新地图上所有怪物的血量显示
            updateMapMonstersHP();
            
            // 移除自动生成怪物的逻辑，由endBattle函数统一管理
            console.log('Current monsters count:', mapMonsters.length);
        }
        
        // 更新地图上玩家称号显示
        function updatePlayerTitleOnMap() {
            const titleElement = document.getElementById('playerTitleOnMap');
            const titleTextElement = document.getElementById('playerTitleText');
            
            if (!titleElement || !titleTextElement) return;
            
            const activeTitle = gameState.player.titles.active;
            
            if (activeTitle) {
                // 根据称号稀有度设置不同的颜色和效果
                const rarityStyles = {
                    common: {
                        textColor: 'text-gray-300',
                        borderColor: 'border-gray-400',
                        bgGradient: 'from-gray-400/20 to-gray-500/20'
                    },
                    rare: {
                        textColor: 'text-blue-300',
                        borderColor: 'border-blue-400',
                        bgGradient: 'from-blue-400/20 to-blue-500/20'
                    },
                    epic: {
                        textColor: 'text-purple-300',
                        borderColor: 'border-purple-400',
                        bgGradient: 'from-purple-400/20 to-purple-500/20'
                    },
                    legendary: {
                        textColor: 'text-orange-300',
                        borderColor: 'border-orange-400',
                        bgGradient: 'from-orange-400/20 to-orange-500/20'
                    },
                    mythic: {
                        textColor: 'text-red-300',
                        borderColor: 'border-red-400',
                        bgGradient: 'from-red-400/20 to-red-500/20'
                    }
                };
                
                const rarity = activeTitle.rarity || 'common';
                const style = rarityStyles[rarity] || rarityStyles.common;
                
                // 更新称号文本
                titleTextElement.textContent = activeTitle.name;
                titleTextElement.className = `${style.textColor} font-bold drop-shadow-lg`;
                
                // 更新容器样式
                const container = titleElement.querySelector('div');
                if (container) {
                    container.className = `relative px-2 py-1 rounded-lg border-2 ${style.borderColor} shadow-lg backdrop-blur-sm`;
                    
                    // 更新背景渐变
                    const bgElement = container.querySelector('.absolute.inset-0');
                    if (bgElement) {
                        bgElement.className = `absolute inset-0 bg-gradient-to-r ${style.bgGradient} rounded-lg animate-pulse`;
                    }
                }
                
                // 显示称号
                titleElement.classList.remove('hidden');
            } else {
                // 隐藏称号
                titleElement.classList.add('hidden');
            }
        }
        
        // 更新地图上怪物的血量显示
        function updateMapMonstersHP() {
            mapMonsters.forEach(monster => {
                const monsterElement = document.getElementById(monster.id);
                if (monsterElement) {
                    const hpCircle = monsterElement.querySelector('.monster-hp-circle');
                    const hpText = monsterElement.querySelector('.monster-hp-text');
                    
                    if (hpCircle) {
                        const hpPercentage = Math.min(100, Math.max(0, (monster.hp / monster.maxHp) * 100));
                        const circumference = 2 * Math.PI * 20;
                        const strokeDashoffset = (1 - hpPercentage / 100) * circumference;
                        hpCircle.style.strokeDashoffset = strokeDashoffset;
                        
                        // 怪物血条默认为红色，根据血量百分比调整亮度
                        if (hpPercentage > 60) {
                            hpCircle.style.stroke = '#ef4444'; // 红色
                        } else if (hpPercentage > 30) {
                            hpCircle.style.stroke = '#dc2626'; // 深红色
                        } else {
                            hpCircle.style.stroke = '#991b1b'; // 暗红色
                        }
                    }
                    
                    if (hpText) {
                        hpText.textContent = `${Math.floor(monster.hp)}/${Math.floor(monster.maxHp)}`;
                    }
                    
                    // 怪物死亡状态由攻击函数处理，这里不重复处理
                }
            });
        }
        
        // 检查并处理当前战斗怪物的死亡状态
        function checkCurrentMonsterDeath() {
            console.log('checkCurrentMonsterDeath called', {
                hasCurrentMonster: !!gameState.currentMonster,
                monsterHp: gameState.currentMonster?.hp,
                currentMapMonsterId: gameState.currentMapMonsterId,
                inBattle: gameState.inBattle,
                autoBattle: gameState.autoBattle
            });
            
            if (gameState.currentMonster && gameState.currentMonster.hp <= 0) {
                console.log('Monster is dead, immediately stopping auto battle and processing death...');
                
                // 立即停止自动战斗和清除定时器
                gameState.autoBattle = false;
                if (gameState.battleInterval) {
                    console.log('checkCurrentMonsterDeath: Clearing battleInterval:', gameState.battleInterval);
                    clearTimeout(gameState.battleInterval);
                    gameState.battleInterval = null;
                }
                
                // 如果是地图战斗模式
                if (gameState.currentMapMonsterId) {
                    const monsterElement = document.getElementById(gameState.currentMapMonsterId);
                    console.log('Map battle mode, monster element found:', !!monsterElement);
                    if (monsterElement) {
                        // 立即调用endBattle，确保怪物被移除
                        endBattle();
                        return true;
                    }
                }
                // 如果不是地图战斗模式，也要调用endBattle
                console.log('Non-map battle mode or no monster element, calling endBattle');
                endBattle();
                return true;
            }
            console.log('Monster not dead or no current monster');
            return false;
        }
        
        // 自动战斗功能
        async function toggleAutoFight() {
            if (autoFightEnabled) {
                stopAutoFight();
            } else {
                await startAutoFight();
            }
        }
        
        async function startAutoFight() {
            autoFightEnabled = true;
            
            // 更新按钮状态
            const toggleBtn = document.getElementById('autoFightToggle');
            const iconElement = document.getElementById('autoFightIcon');
            const textElement = document.getElementById('autoFightText');
            
            if (toggleBtn) {
                toggleBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg border border-red-500 transition-all duration-200 flex items-center space-x-2';
            }
            if (iconElement) {
                iconElement.textContent = '⏹️';
            }
            if (textElement) {
                textElement.textContent = '停止自动';
            }
            
            addLog('开启自动战斗模式');
            
            // 开始自动寻找怪物
            await autoFightSearchLoop();
        }
        
        function stopAutoFight() {
            autoFightEnabled = false;
            
            // 清除定时器
            if (autoFightInterval) {
                clearTimeout(autoFightInterval);
                autoFightInterval = null;
            }
            if (autoFightSearchInterval) {
                clearTimeout(autoFightSearchInterval);
                autoFightSearchInterval = null;
            }
            
            // 更新按钮状态
            const toggleBtn = document.getElementById('autoFightToggle');
            const iconElement = document.getElementById('autoFightIcon');
            const textElement = document.getElementById('autoFightText');
            
            if (toggleBtn) {
                toggleBtn.className = 'bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 transition-all duration-200 flex items-center space-x-2';
            }
            if (iconElement) {
                iconElement.textContent = '⚔️';
            }
            if (textElement) {
                textElement.textContent = '自动战斗';
            }
            
            addLog('关闭自动战斗模式');
        }
        
        async function autoFightSearchLoop() {
            if (!autoFightEnabled) {
                return;
            }
            
            // 检查并自动刷新怪物
            await checkAndRefreshMonsters();
            
            // 如果当前不在战斗中，寻找最近的怪物
            if (!gameState.inBattle) {
                const nearestMonster = findNearestMonster();
                if (nearestMonster) {
                    console.log('Auto fight: Found nearest monster:', nearestMonster.name);
                    moveToMonsterAndFight(nearestMonster);
                } else {
                    console.log('Auto fight: No alive monsters found');
                }
            }
            
            // 继续搜索循环
            if (autoFightEnabled) {
                autoFightSearchInterval = setTimeout(autoFightSearchLoop, 2000); // 每2秒检查一次
            }
        }
        
        // 生成额外怪物的函数（不清空现有怪物）
        async function generateAdditionalMonsters(count) {
            if (count <= 0) {
                console.log('No additional monsters needed');
                return;
            }
            
            console.log(`generateAdditionalMonsters called with count: ${count}`);
            const monstersContainer = document.getElementById('monstersOnMap');
            
            // 根据当前位置生成怪物
            const currentLocation = gameState.currentLocation || 1;
            
            try {
                // 从配置表获取地图信息
                const mapInfo = await configManager.getMapById(currentLocation);
                if (!mapInfo) {
                    console.warn(`Map ${currentLocation} not found in config, using default`);
                    return;
                }
                
                // 从配置表获取该地图的怪物列表
                const availableMonsters = await configManager.getMonstersByMap(currentLocation);
                if (!availableMonsters || availableMonsters.length === 0) {
                    console.warn(`No monsters found for map ${currentLocation}`);
                    return;
                }
                
                // 获取配置（优先使用临时配置）
                const tempConfig = gameState.tempMapConfig && gameState.tempMapConfig[currentLocation];
                const allowedTypesConfig = tempConfig?.allowedMonsterTypes ?? mapInfo.allowedMonsterTypes;
                
                // 根据地图允许的怪物类型过滤怪物
                let filteredMonsters = availableMonsters;
                if (allowedTypesConfig && allowedTypesConfig.length > 0) {
                    if (tempConfig) {
                        filteredMonsters = availableMonsters.filter(monster => 
                            allowedTypesConfig.includes(monster.id)
                        );
                    } else {
                        filteredMonsters = availableMonsters.filter(monster => 
                            allowedTypesConfig.includes(monster.type)
                        );
                    }
                }
                
                if (filteredMonsters.length === 0) {
                    console.warn(`No monsters match allowed types for map ${currentLocation}`);
                    return;
                }
                
                // 创建权重数组用于随机选择怪物
                const weightedMonsters = [];
                filteredMonsters.forEach(monster => {
                    const weight = monster.spawnWeight || 1;
                    for (let w = 0; w < weight; w++) {
                        weightedMonsters.push(monster);
                    }
                });
                
                for (let i = 0; i < count; i++) {
                    // 根据权重随机选择怪物模板
                    const monsterTemplate = weightedMonsters[Math.floor(Math.random() * weightedMonsters.length)];
                    
                    // 计算随机金币值
                    let goldValue;
                    if (typeof monsterTemplate.gold === 'string' && monsterTemplate.gold.includes(',')) {
                        // 逗号分隔的字符串格式，如 "5,12"
                        const goldParts = monsterTemplate.gold.split(',').map(v => parseFloat(v.trim()));
                        const minGold = goldParts[0];
                        const maxGold = goldParts[1];
                        goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                    } else if (Array.isArray(monsterTemplate.gold)) {
                        const minGold = monsterTemplate.gold[0];
                        const maxGold = monsterTemplate.gold[1];
                        goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                    } else {
                        goldValue = parseFloat(monsterTemplate.gold) || 0;
                    }
                    
                    // 处理attack字段转换
                    let attackValue;
                    if (typeof monsterTemplate.attack === 'string' && monsterTemplate.attack.includes(',')) {
                        // 将逗号分隔的字符串转换为数组
                        const attackParts = monsterTemplate.attack.split(',').map(v => parseFloat(v.trim()));
                        attackValue = attackParts.length >= 2 ? [attackParts[0], attackParts[1]] : [attackParts[0] || 0, attackParts[0] || 0];
                    } else if (Array.isArray(monsterTemplate.attack)) {
                        // 已经是数组格式
                        attackValue = monsterTemplate.attack;
                    } else {
                        // 单个数值，转换为[value, value]格式
                        const val = parseFloat(monsterTemplate.attack) || 0;
                        attackValue = [val, val];
                    }
                    
                    const monsterData = {
                        id: `monster_${++monsterInstanceCounter}`,
                        templateId: monsterTemplate.id,
                        name: monsterTemplate.name,
                        hp: monsterTemplate.hp,
                        maxHp: monsterTemplate.hp,
                        x: Math.random() * 80 + 10,
                        y: Math.random() * 80 + 10,
                        attack: attackValue,
                        defense: monsterTemplate.defense,
                        exp: monsterTemplate.exp,
                        gold: goldValue
                    };
                    
                    console.log('Generated additional monster:', monsterData);
                    mapMonsters.push(monsterData);
                    
                    // 创建怪物DOM元素
                    const monsterElement = document.createElement('div');
                    monsterElement.id = monsterData.id;
                    monsterElement.className = 'absolute cursor-pointer hover:scale-110 transition-transform';
                    monsterElement.style.left = `${monsterData.x}%`;
                    monsterElement.style.top = `${monsterData.y}%`;
                    monsterElement.style.transform = 'translate(-50%, -50%)';
                    
                    monsterElement.innerHTML = `
                        <div class="relative">
                            <div class="w-8 h-8 bg-orange-600 rounded-full border border-orange-400 flex items-center justify-center">
                                <span class="text-white text-xs font-bold">怪</span>
                            </div>
                            <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-xs text-red-400 font-bold whitespace-nowrap">
                                ${monsterData.name}
                            </div>
                            <div class="monster-hp-container absolute" style="top: -12px; left: -12px; width: 56px; height: 56px; pointer-events: none;">
                                <svg class="absolute inset-0 w-full h-full" style="transform: rotate(-90deg);">
                                    <circle cx="50%" cy="50%" r="20" fill="none" stroke="rgba(75, 85, 99, 0.5)" stroke-width="2"/>
                                    <circle class="monster-hp-circle" cx="50%" cy="50%" r="20" fill="none" stroke="#ef4444" stroke-width="2" 
                                            stroke-linecap="round" stroke-dasharray="${2 * Math.PI * 20}" stroke-dashoffset="${(1 - monsterData.hp / monsterData.maxHp) * 2 * Math.PI * 20}" 
                                            style="transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;"/>
                                </svg>
                                <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-white font-bold text-center whitespace-nowrap monster-hp-text">
                                    ${monsterData.hp}/${monsterData.maxHp}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 添加data属性用于事件委托
                    monsterElement.setAttribute('data-monster-id', monsterData.id);
                    monstersContainer.appendChild(monsterElement);
                }
            } catch (error) {
                console.error('Error generating additional monsters:', error);
                // 如果配置表加载失败，使用默认逻辑
                const locationMonsters = monsters[currentLocation] || monsters.village;
                if (locationMonsters && locationMonsters.length > 0) {
                    for (let i = 0; i < count; i++) {
                        const monsterTemplate = locationMonsters[Math.floor(Math.random() * locationMonsters.length)];
                        
                        // 计算随机金币值
                        let goldValue;
                        if (typeof monsterTemplate.gold === 'string' && monsterTemplate.gold.includes(',')) {
                            // 逗号分隔的字符串格式，如 "5,12"
                            const goldParts = monsterTemplate.gold.split(',').map(v => parseFloat(v.trim()));
                            const minGold = goldParts[0];
                            const maxGold = goldParts[1];
                            goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                        } else if (Array.isArray(monsterTemplate.gold)) {
                            const minGold = monsterTemplate.gold[0];
                            const maxGold = monsterTemplate.gold[1];
                            goldValue = Math.floor(Math.random() * (maxGold - minGold + 1)) + minGold;
                        } else {
                            goldValue = parseFloat(monsterTemplate.gold) || 0;
                        }
                        
                        // 处理attack字段转换
                        let attackValue;
                        if (typeof monsterTemplate.attack === 'string' && monsterTemplate.attack.includes(',')) {
                            // 将逗号分隔的字符串转换为数组
                            const attackParts = monsterTemplate.attack.split(',').map(v => parseFloat(v.trim()));
                            attackValue = attackParts.length >= 2 ? [attackParts[0], attackParts[1]] : [attackParts[0] || 0, attackParts[0] || 0];
                        } else if (Array.isArray(monsterTemplate.attack)) {
                            // 已经是数组格式
                            attackValue = monsterTemplate.attack;
                        } else {
                            // 单个数值，转换为[value, value]格式
                            const val = parseFloat(monsterTemplate.attack) || 0;
                            attackValue = [val, val];
                        }
                        
                        const monsterData = {
                            id: `monster_${++monsterInstanceCounter}`,
                            templateId: monsterTemplate.id || monsterTemplate.name,
                            name: monsterTemplate.name,
                            hp: monsterTemplate.hp,
                            maxHp: monsterTemplate.hp,
                            x: Math.random() * 80 + 10,
                            y: Math.random() * 80 + 10,
                            attack: attackValue,
                            defense: monsterTemplate.defense,
                            exp: monsterTemplate.exp,
                            gold: goldValue
                        };
                        
                        console.log('Generated additional monster (fallback):', monsterData);
                        mapMonsters.push(monsterData);
                        
                        // 创建怪物DOM元素
                        const monsterElement = document.createElement('div');
                        monsterElement.id = monsterData.id;
                        monsterElement.className = 'absolute cursor-pointer hover:scale-110 transition-transform';
                        monsterElement.style.left = `${monsterData.x}%`;
                        monsterElement.style.top = `${monsterData.y}%`;
                        monsterElement.style.transform = 'translate(-50%, -50%)';
                        
                        monsterElement.innerHTML = `
                            <div class="relative">
                                <div class="w-8 h-8 bg-orange-600 rounded-full border border-orange-400 flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">怪</span>
                                </div>
                                <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-xs text-red-400 font-bold whitespace-nowrap">
                                    ${monsterData.name}
                                </div>
                                <div class="monster-hp-container absolute" style="top: -12px; left: -12px; width: 56px; height: 56px; pointer-events: none;">
                                    <svg class="absolute inset-0 w-full h-full" style="transform: rotate(-90deg);">
                                        <circle cx="50%" cy="50%" r="20" fill="none" stroke="rgba(75, 85, 99, 0.5)" stroke-width="2"/>
                                        <circle class="monster-hp-circle" cx="50%" cy="50%" r="20" fill="none" stroke="#ef4444" stroke-width="2" 
                                                stroke-linecap="round" stroke-dasharray="${2 * Math.PI * 20}" stroke-dashoffset="${(1 - monsterData.hp / monsterData.maxHp) * 2 * Math.PI * 20}" 
                                                style="transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;"/>
                                    </svg>
                                    <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-white font-bold text-center whitespace-nowrap monster-hp-text">
                                        ${monsterData.hp}/${monsterData.maxHp}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // 添加data属性用于事件委托
                        monsterElement.setAttribute('data-monster-id', monsterData.id);
                        monstersContainer.appendChild(monsterElement);
                    }
                }
            }
        }
        
        // 自动检查并刷新怪物的函数
        async function checkAndRefreshMonsters() {
            try {
                // 获取当前地图配置
                const currentLocation = gameState.currentLocation || 1;
                const currentMapInfo = await configManager.getMapById(currentLocation) || {};
                const tempConfig = gameState.tempMapConfig && gameState.tempMapConfig[currentLocation];
                
                // 使用临时配置或默认配置
                const maxMonsters = tempConfig?.maxMonsters ?? currentMapInfo.maxMonsters ?? 5;
                const minMonsters = Math.max(1, Math.floor(maxMonsters * 0.3)); // 最少保持30%的怪物数量
                
                // 计算活着的怪物数量
                const aliveMonsters = mapMonsters.filter(monster => monster.hp > 0);
                const aliveCount = aliveMonsters.length;
                
                console.log(`Monster check: ${aliveCount}/${maxMonsters} alive monsters`);
                
                // 如果活着的怪物数量少于最小值，自动刷新
                if (aliveCount < minMonsters) {
                    console.log(`Auto refreshing monsters: ${aliveCount} < ${minMonsters}`);
                    
                    // 显示自动刷新提示
                    console.log('怪物数量不足，自动刷新中...');
                    
                    try {
                        const needToGenerate = maxMonsters - aliveCount;
                        await generateAdditionalMonsters(needToGenerate);
                        const newAliveCount = mapMonsters.filter(monster => monster.hp > 0).length;
                        console.log(`Auto refresh completed: ${needToGenerate} monsters added, total: ${newAliveCount}`);
                        
                        // 延迟显示刷新结果
                        setTimeout(() => {
                            console.log(`自动刷新完成！补充了 ${needToGenerate} 只怪物，当前总数: ${newAliveCount}`);
                        }, 500);
                    } catch (error) {
                        console.error('Auto refresh monsters failed:', error);
                        console.log('自动刷新怪物失败');
                    }
                }
            } catch (error) {
                console.error('Error in checkAndRefreshMonsters:', error);
                // 如果获取地图配置失败，使用默认值
                const maxMonsters = 5;
                const minMonsters = Math.max(1, Math.floor(maxMonsters * 0.3));
                
                // 计算活着的怪物数量
                const aliveMonsters = mapMonsters.filter(monster => monster.hp > 0);
                const aliveCount = aliveMonsters.length;
                
                // 如果活着的怪物数量少于最小值，自动刷新
                if (aliveCount < minMonsters) {
                    console.log(`Auto refreshing monsters (fallback): ${aliveCount} < ${minMonsters}`);
                    console.log('怪物数量不足，自动刷新中...');
                    
                    try {
                        const needToGenerate = maxMonsters - aliveCount;
                        await generateAdditionalMonsters(needToGenerate);
                        const newAliveCount = mapMonsters.filter(monster => monster.hp > 0).length;
                        console.log(`Auto refresh completed (fallback): ${needToGenerate} monsters added, total: ${newAliveCount}`);
                        
                        setTimeout(() => {
                            console.log(`自动刷新完成！补充了 ${needToGenerate} 只怪物，当前总数: ${newAliveCount}`);
                        }, 500);
                    } catch (refreshError) {
                        console.error('Auto refresh monsters failed (fallback):', refreshError);
                        console.log('自动刷新怪物失败');
                    }
                }
            }
        }
        
        function findNearestMonster() {
            if (mapMonsters.length === 0) {
                return null;
            }
            
            let nearestMonster = null;
            let minDistance = Infinity;
            
            mapMonsters.forEach(monster => {
                if (monster.hp > 0) { // 只考虑活着的怪物
                    const dx = playerPosition.x - monster.x;
                    const dy = playerPosition.y - monster.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestMonster = monster;
                    }
                }
            });
            
            return nearestMonster;
        }
    </script>
    
    <!-- 弹出界面模态框 -->
    
    <!-- 地图面板 -->
    <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideMapPanel()">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">地图选择</h3>
                <button onclick="hideMapPanel()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            

            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="goToLocation('village'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">新手村</button>
                <button onclick="goToLocation('forest'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">森林</button>
                <button onclick="goToLocation('cave'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">洞穴</button>
                <button onclick="goToLocation('desert'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">沙漠</button>
                <button onclick="goToLocation('swamp'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">沼泽</button>
                <button onclick="goToLocation('mountain'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">雪山</button>
                <button onclick="goToLocation('dungeon'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">地牢</button>
                <button onclick="goToLocation('volcano'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">火山</button>
                <button onclick="goToLocation('abyss'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">深渊</button>
                <button onclick="goToLocation('heaven'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">天界</button>
                <button onclick="goToLocation('ocean'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">海洋</button>
                <button onclick="goToLocation('glacier'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">冰川</button>
                <button onclick="goToLocation('tomb'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">古墓</button>
                <button onclick="goToLocation('magicforest'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">魔法森林</button>
                <button onclick="goToLocation('starfield'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">星空</button>
                <button onclick="goToLocation('laboratory'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">实验室</button>
                <button onclick="goToLocation('shadowrealm'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">影之领域</button>
                <button onclick="goToLocation('crystalcave'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">水晶洞穴</button>
                <button onclick="goToLocation('dragonrealm'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">龙之领域</button>
                <button onclick="goToLocation('godsdomain'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">神之领域</button>
                <button onclick="goToLocation('chaosrealm'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">混沌领域</button>
                <button onclick="goToLocation('voidrealm'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">虚空领域</button>
                <button onclick="goToLocation('infiniterealm'); hideMapPanel()" class="btn-secondary px-4 py-3 rounded text-sm">无限领域</button>
                <button onclick="testRefreshMonsters()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded text-sm">刷新怪物</button>
            </div>
        </div>
    </div>
    
    <!-- 背包装备面板 -->
    <div id="inventoryModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideInventoryPanel()">
        <div class="bg-gray-900 rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">背包与装备</h3>
                <button onclick="hideInventoryPanel()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 装备栏 -->
                <div>
                    <h4 class="text-lg font-bold text-blue-400 mb-3">当前装备</h4>
                    <div id="modalEquipmentSlots" class="grid grid-cols-2 gap-3">
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">武器</div>
                                <div id="modalWeapon" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">头盔</div>
                                <div id="modalHelmet" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">衣服</div>
                                <div id="modalArmor" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">鞋子</div>
                                <div id="modalBoots" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">戒指</div>
                                <div id="modalRing" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">项链</div>
                                <div id="modalNecklace" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">护符1</div>
                                <div id="modalSpecial1" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">护符2</div>
                                <div id="modalSpecial2" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">护符3</div>
                                <div id="modalSpecial3" class="text-white font-bold">无</div>
                            </div>
                        </div>
                        <div class="equipment-slot rounded p-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-400">护符4</div>
                                <div id="modalSpecial4" class="text-white font-bold">无</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 背包 -->
                <div>
                    <h4 class="text-lg font-bold text-green-400 mb-3">背包物品</h4>
                    <div id="modalInventoryItems" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto">
                        <!-- 背包物品将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 商店面板 -->
    <div id="shopModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideShopPanel()">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">商店</h3>
                <button onclick="hideShopPanel()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <!-- 购买/出售切换按钮 -->
            <div class="flex mb-4 bg-gray-800 rounded-lg p-1">
                <button id="buyModeBtn" onclick="setShopMode('buy')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white">购买</button>
                <button id="sellModeBtn" onclick="setShopMode('sell')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-400 hover:text-white">出售</button>
            </div>
            <div id="modalShopItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <!-- 商店物品将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 头像选择弹窗 -->
    <div id="avatarModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideAvatarPanel()">
        <div class="bg-gray-900 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">选择头像</h3>
                <button onclick="hideAvatarPanel()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center cursor-pointer hover:bg-gray-800 p-3 rounded" onclick="changeAvatar('warrior')">
                    <div class="w-16 h-16 mx-auto mb-2 border-2 border-red-500 rounded-full bg-gray-800 flex items-center justify-center">
                        <svg width="32" height="32" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                            <rect x="18" y="18" width="12" height="4" fill="#8B4513"/>
                            <rect x="22" y="22" width="2" height="2" fill="#000"/>
                            <rect x="24" y="22" width="2" height="2" fill="#000"/>
                            <rect x="16" y="16" width="16" height="2" fill="#C0C0C0"/>
                        </svg>
                    </div>
                    <div class="text-white text-sm">战士</div>
                </div>
                <div class="text-center cursor-pointer hover:bg-gray-800 p-3 rounded" onclick="changeAvatar('mage')">
                    <div class="w-16 h-16 mx-auto mb-2 border-2 border-blue-500 rounded-full bg-gray-800 flex items-center justify-center">
                        <svg width="32" height="32" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                            <rect x="18" y="18" width="12" height="4" fill="#4169E1"/>
                            <rect x="22" y="22" width="2" height="2" fill="#000"/>
                            <rect x="24" y="22" width="2" height="2" fill="#000"/>
                            <rect x="20" y="16" width="8" height="2" fill="#8B4513"/>
                        </svg>
                    </div>
                    <div class="text-white text-sm">法师</div>
                </div>
                <div class="text-center cursor-pointer hover:bg-gray-800 p-3 rounded" onclick="changeAvatar('taoist')">
                    <div class="w-16 h-16 mx-auto mb-2 border-2 border-green-500 rounded-full bg-gray-800 flex items-center justify-center">
                        <svg width="32" height="32" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/>
                            <rect x="18" y="18" width="12" height="4" fill="#228B22"/>
                            <rect x="22" y="22" width="2" height="2" fill="#000"/>
                            <rect x="24" y="22" width="2" height="2" fill="#000"/>
                            <rect x="19" y="16" width="10" height="2" fill="#8B4513"/>
                        </svg>
                    </div>
                    <div class="text-white text-sm">道士</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 更多功能面板 (已废弃，功能按钮已移至主界面) -->
    <div id="moreFunctionsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">更多功能</h3>
                <button onclick="hideMoreFunctions()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="text-center text-gray-400">
                    <p>功能按钮已移至主界面，请直接使用上方的功能按钮。</p>
                </div>
                <div class="border-t border-gray-600 pt-4">
                    <h4 class="text-lg font-bold text-blue-400 mb-3">在线功能</h4>
                    <button onclick="window.open('leaderboard.html', '_blank')" class="btn-primary px-4 py-2 rounded w-full mb-2">
                        🏆 查看排行榜
                    </button>
                    <p class="text-xs text-gray-400">查看服务器排行榜和在线玩家</p>
                </div>
                <div class="border-t border-gray-600 pt-4 mt-4">
                    <h4 class="text-lg font-bold text-green-400 mb-3">任务系统管理</h4>
                    <button onclick="refreshMainQuestConfig()" class="btn-primary px-4 py-2 rounded w-full mb-2">
                        刷新主线任务配置
                    </button>
                    <p class="text-xs text-gray-400">重新加载主线任务配置文件，获取最新的任务内容</p>
                </div>
            </div>
        </div>
    </div>



    <!-- 属性面板弹窗 -->
    <div id="attributeModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">属性面板</h3>
                <button onclick="hideAttributePanelModal()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-lg font-bold text-blue-400 mb-3">基础属性</h4>
                    <div class="space-y-2 text-sm">
                        <div>职业: <span id="modalAttrClass" class="text-yellow-400">-</span></div>
                        <div>等级: <span id="modalAttrLevel" class="text-yellow-400">-</span></div>
                        <div>生命值: <span id="modalAttrHp" class="text-red-400">-</span></div>
                        <div>魔法值: <span id="modalAttrMp" class="text-blue-400">-</span></div>
                        <div>经验值: <span id="modalAttrExp" class="text-green-400">-</span></div>
                        <div>金币: <span id="modalAttrGold" class="text-yellow-400">-</span></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-red-400 mb-3">战斗属性</h4>
                    <div class="space-y-2 text-sm">
                        <div>攻击力: <span id="modalAttrAttack" class="text-red-400">-</span></div>
                        <div>防御力: <span id="modalAttrDefense" class="text-blue-400">-</span></div>
                        <div>暴击率: <span id="modalAttrCritRate" class="text-orange-400">-</span></div>
                        <div>暴击伤害: <span id="modalAttrCritDamage" class="text-orange-400">-</span></div>
                        <div>法术强度: <span id="modalAttrMagicPower" class="text-purple-400">-</span></div>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-lg font-bold text-green-400 mb-3">装备加成</h4>
                <div id="modalEquipmentBonus" class="text-sm text-gray-300">
                    <!-- 装备加成详情 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 养成系统弹窗 -->
    <div id="cultivationModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">养成系统</h3>
                <button onclick="hideCultivationPanelModal()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <!-- 爆率提升 -->
                <div class="bg-gray-800 p-4 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-green-400">爆率提升</h4>
                        <button onclick="upgradeCultivation('dropRate')" class="btn-primary px-3 py-1 rounded text-sm">升级</button>
                    </div>
                    <div class="text-sm space-y-1">
                        <div>等级: <span id="modalDropRateLevel" class="text-yellow-400">0</span></div>
                        <div>经验: <span id="modalDropRateExp" class="text-blue-400">0/100</span></div>
                        <div>效果: <span id="modalDropRateEffect" class="text-green-400">+0%</span></div>
                    </div>
                </div>
                <!-- 伤害提升 -->
                <div class="bg-gray-800 p-4 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-red-400">伤害提升</h4>
                        <button onclick="upgradeCultivation('damage')" class="btn-primary px-3 py-1 rounded text-sm">升级</button>
                    </div>
                    <div class="text-sm space-y-1">
                        <div>等级: <span id="modalDamageLevel" class="text-yellow-400">0</span></div>
                        <div>经验: <span id="modalDamageExp" class="text-blue-400">0/100</span></div>
                        <div>效果: <span id="modalDamageEffect" class="text-red-400">+0%</span></div>
                    </div>
                </div>
                <!-- 鞭尸概率 -->
                <div class="bg-gray-800 p-4 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-purple-400">鞭尸概率</h4>
                        <button onclick="upgradeCultivation('whipCorpse')" class="btn-primary px-3 py-1 rounded text-sm">升级</button>
                    </div>
                    <div class="text-sm space-y-1">
                        <div>等级: <span id="modalWhipCorpseLevel" class="text-yellow-400">0</span></div>
                        <div>经验: <span id="modalWhipCorpseExp" class="text-blue-400">0/100</span></div>
                        <div>效果: <span id="modalWhipCorpseEffect" class="text-purple-400">0%</span></div>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <div id="modalCultivationMaterials" class="text-sm">
                    <!-- 升级材料需求 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 装备合成弹窗 -->
    <div id="craftModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">装备合成树</h3>
                <button onclick="hideCraftPanelModal()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <!-- 控制面板 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-300">装备类型:</label>
                        <select id="craftTreeFilter" onchange="updateCraftTree()" class="bg-gray-700 text-white px-3 py-1 rounded">
                            <option value="all">全部</option>
                            <option value="weapon">武器</option>
                            <option value="armor">防具</option>
                            <option value="accessory">饰品</option>
                            <option value="special">护符</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-300">品质过滤:</label>
                        <select id="craftQualityFilter" onchange="updateCraftTree()" class="bg-gray-700 text-white px-3 py-1 rounded">
                            <option value="all">全部品质</option>
                            <option value="common">普通</option>
                            <option value="uncommon">优秀</option>
                            <option value="rare">稀有</option>
                            <option value="epic">史诗</option>
                            <option value="legendary">传说</option>
                            <option value="supreme">至尊</option>
                            <option value="transcendent">超神</option>
                        </select>
                    </div>
                    <button onclick="resetCraftTreeView()" class="btn-primary px-3 py-1 rounded text-sm">重置视图</button>
                </div>
            </div>
            
            <!-- 树状图容器 -->
            <div class="bg-gray-800 rounded-lg p-4 h-96 overflow-auto relative">
                <div id="craftTreeContainer" class="w-full h-full relative">
                    <svg id="craftTreeSvg" class="w-full h-full">
                        <!-- 树状图将在这里绘制 -->
                    </svg>
                </div>
            </div>
            
            <!-- 合成详情面板 -->
            <div id="craftDetailsPanel" class="bg-gray-800 rounded-lg p-4 mt-4 hidden">
                <h4 class="text-lg font-bold text-green-400 mb-3">合成详情</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h5 class="text-md font-bold text-yellow-400 mb-2">所需材料</h5>
                        <div id="craftMaterialsList" class="space-y-2 text-sm max-h-32 overflow-y-auto">
                            <!-- 所需材料列表 -->
                        </div>
                    </div>
                    <div>
                        <h5 class="text-md font-bold text-yellow-400 mb-2">合成结果</h5>
                        <div id="craftResultPreview" class="bg-gray-700 rounded p-3 mb-3">
                            <!-- 合成结果预览 -->
                        </div>
                        <button id="craftExecuteButton" onclick="executeCraft()" class="btn-primary px-4 py-2 rounded w-full" disabled>合成装备</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务系统弹窗 -->
    <div id="questModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">任务系统</h3>
                <button onclick="hideQuestPanelModal()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- 可接任务 -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-blue-400 mb-3">可接任务</h4>
                    <div id="modalAvailableQuests" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- 可接任务列表 -->
                    </div>
                </div>
                
                <!-- 进行中任务 -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-yellow-400 mb-3">进行中任务</h4>
                    <div id="modalActiveQuests" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- 进行中任务列表 -->
                    </div>
                </div>
            </div>
            
            <!-- 已完成任务 -->
            <div class="mt-4 bg-gray-800 rounded-lg p-4">
                <h4 class="text-lg font-bold text-green-400 mb-3">已完成任务</h4>
                <div id="modalCompletedQuests" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- 已完成任务列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 称号系统弹窗 -->
    <div id="titleModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" onclick="if(event.target === this) hideTitlePanelModal()">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">称号系统</h3>
                <button onclick="hideTitlePanelModal()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- 当前称号 -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gold mb-3">当前称号</h4>
                    <div id="modalCurrentTitle" class="text-center p-4 border-2 border-gold rounded-lg">
                        <div class="text-gray-400">未激活称号</div>
                    </div>
                    <div id="modalTitleEffect" class="mt-3 text-sm text-gray-300">
                        <!-- 称号效果显示 -->
                    </div>
                </div>
                
                <!-- 拥有的称号 -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-blue-400 mb-3">拥有的称号</h4>
                    <div id="modalOwnedTitles" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- 拥有的称号列表 -->
                    </div>
                </div>
            </div>
            
            <!-- 称号卷轴 -->
            <div class="mt-4 bg-gray-800 rounded-lg p-4">
                <h4 class="text-lg font-bold text-orange-400 mb-3">称号卷轴</h4>
                <div id="modalTitleScrolls" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- 称号卷轴列表 -->
                </div>
            </div>
            
            <!-- 称号碎片 -->
            <div class="mt-4 bg-gray-800 rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-bold text-purple-400">称号碎片</h4>
                    <div class="text-sm text-purple-300">
                        拥有: <span id="modalTitleFragments" class="text-yellow-400">0</span> 个
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 特殊称号兑换 -->
                    <div>
                        <h5 class="text-md font-bold text-cyan-400 mb-2">特殊称号兑换</h5>
                        <div id="modalSpecialTitles" class="space-y-2 max-h-32 overflow-y-auto">
                            <!-- 特殊称号列表 -->
                        </div>
                    </div>
                    <!-- 碎片获取说明 -->
                    <div>
                        <h5 class="text-md font-bold text-green-400 mb-2">获取方式</h5>
                        <div class="text-sm text-gray-300 space-y-1">
                            <div>• 分解多余的称号卷轴</div>
                            <div>• 每个卷轴可分解为 <span class="text-yellow-400">1-3</span> 个碎片</div>
                            <div>• 稀有度越高分解碎片越多</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 排行榜弹窗 -->
    <div id="rankingModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">🏆 排行榜</h3>
                <button onclick="hideRankingPanelModal()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <!-- 排行榜标签 -->
            <div class="flex space-x-2 mb-4">
                <button id="levelRankTab" onclick="switchRankingTab('level')" class="btn-primary px-4 py-2 rounded">等级排行</button>
                <button id="goldRankTab" onclick="switchRankingTab('gold')" class="btn-secondary px-4 py-2 rounded">财富排行</button>
                <button id="killRankTab" onclick="switchRankingTab('kills')" class="btn-secondary px-4 py-2 rounded">击杀排行</button>
                <button id="onlineRankTab" onclick="switchRankingTab('online')" class="btn-secondary px-4 py-2 rounded">在线玩家</button>
            </div>
            
            <!-- 排行榜内容 -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div id="rankingContent" class="space-y-2">
                    <div class="text-center text-gray-400 py-8">正在加载排行榜数据...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 地图配置弹窗 -->
    <div id="mapConfigModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">地图配置</h3>
                <button onclick="hideMapConfig()" class="text-white hover:text-red-400 text-2xl">&times;</button>
            </div>
            
            <!-- 当前地图信息 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <h4 class="text-lg font-bold text-blue-400 mb-3">当前地图信息</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm space-y-2">
                            <div>地图名称: <span id="currentMapName" class="text-yellow-400">-</span></div>
                            <div>地图等级: <span id="currentMapLevel" class="text-green-400">-</span></div>
                            <div>地图类型: <span id="currentMapType" class="text-purple-400">-</span></div>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm space-y-2">
                            <div>怪物生成率: <span id="currentMonsterSpawnRate" class="text-red-400">-</span></div>
                            <div>最大怪物数: <span id="currentMaxMonsters" class="text-orange-400">-</span></div>
                            <div>当前怪物数: <span id="currentMonsterCount" class="text-cyan-400">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 怪物配置 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <h4 class="text-lg font-bold text-green-400 mb-3">怪物刷新配置</h4>
                
                <!-- 自动刷新开关 -->
                <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="text-md font-bold text-cyan-400 mb-1">自动刷新怪物</h5>
                            <p class="text-sm text-gray-300">当怪物数量不足时自动补充（每5秒检查一次）</p>
                        </div>
                        <button id="autoRefreshToggle" onclick="toggleAutoRefreshMonsters()" 
                                class="px-4 py-2 rounded-lg font-bold transition-all duration-200">
                            <span id="autoRefreshStatus">开启</span>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">怪物生成率 (0-1)</label>
                        <input type="number" id="monsterSpawnRateInput" min="0" max="1" step="0.1" 
                               class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="0.8">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">最大怪物数量</label>
                        <input type="number" id="maxMonstersInput" min="1" max="50" 
                               class="w-full bg-gray-700 text-white px-3 py-2 rounded" placeholder="10">
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="applyMonsterConfig()" class="btn-primary px-4 py-2 rounded mr-2">应用配置</button>
                    <button onclick="resetMonsterConfig()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">重置为默认</button>
                </div>
            </div>
            
            <!-- 允许的怪物类型 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <h4 class="text-lg font-bold text-purple-400 mb-3">允许的怪物类型</h4>
                <div id="allowedMonsterTypes" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                    <!-- 怪物类型复选框将在这里动态生成 -->
                </div>
                <div class="mt-4">
                    <button onclick="selectAllMonsterTypes()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm mr-2">全选</button>
                    <button onclick="deselectAllMonsterTypes()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm">全不选</button>
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex justify-between items-center">
                <div>
                    <button onclick="refreshMapMonsters()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded mr-2">立即刷新怪物</button>
                    <button onclick="testMonsterGeneration()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded">测试生成</button>
                </div>
                <button onclick="hideMapConfig()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 排行榜相关函数
        let currentRankingTab = 'level';
        
        function getClassName(classType) {
            const classNames = {
                'warrior': '战士',
                'mage': '法师',
                'taoist': '道士'
            };
            return classNames[classType] || classType || '未知';
        }
        
        function showRankingPanelModal() {
            document.getElementById('rankingModal').classList.remove('hidden');
            switchRankingTab('level'); // 默认显示等级排行
        }
        
        function hideRankingPanelModal() {
            document.getElementById('rankingModal').classList.add('hidden');
        }
        
        function switchRankingTab(tabType) {
            currentRankingTab = tabType;
            
            // 更新标签样式
            const tabs = ['levelRankTab', 'goldRankTab', 'killRankTab', 'onlineRankTab'];
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.className = tab.className.replace('btn-primary', 'btn-secondary');
                }
            });
            
            const activeTab = document.getElementById(tabType + 'RankTab');
            if (activeTab) {
                activeTab.className = activeTab.className.replace('btn-secondary', 'btn-primary');
            }
            
            // 加载对应的排行榜数据
            loadRankingData(tabType);
        }
        
        async function loadRankingData(type) {
            const content = document.getElementById('rankingContent');
            content.innerHTML = '<div class="text-center text-gray-400 py-8">正在加载排行榜数据...</div>';
            
            try {
                // 检查网络连接
                if (!networkManager || !networkManager.isConnected()) {
                    content.innerHTML = '<div class="text-center text-gray-400 py-8">未连接到服务器</div>';
                    return;
                }
                
                let rankingData = [];
                
                if (type === 'online') {
                    // 获取在线玩家数据
                    networkManager.getOnlinePlayers();
                    // 监听在线玩家数据
                    networkManager.on('online_players', (data) => {
                        const onlineData = data.players.map((player, index) => ({
                            name: player.username,
                            level: player.gameState?.player?.level || 1,
                            class: getClassName(player.gameState?.player?.class),
                            status: '在线'
                        }));
                        displayRankingData(onlineData, type);
                    });
                } else {
                    // 获取排行榜数据
                    const result = await networkManager.getRankings(type, 10);
                    if (result.success) {
                        const rankings = result.rankings || [];
                        rankingData = rankings.map((player, index) => {
                            const playerData = player.gameState?.player || {};
                            const playerStats = player.stats || {};
                            
                            let displayData = {
                                rank: index + 1,
                                name: player.username,
                                class: getClassName(playerData.class)
                            };
                            
                            switch(type) {
                                case 'level':
                                    displayData.level = playerData.level || 1;
                                    break;
                                case 'gold':
                                    displayData.gold = playerData.gold || 0;
                                    break;
                                case 'kills':
                                    displayData.kills = playerStats.monstersKilled || 0;
                                    break;
                            }
                            
                            return displayData;
                        });
                        
                        displayRankingData(rankingData, type);
                    } else {
                        content.innerHTML = '<div class="text-center text-gray-400 py-8">获取排行榜数据失败</div>';
                    }
                }
            } catch (error) {
                console.error('加载排行榜数据失败:', error);
                content.innerHTML = '<div class="text-center text-gray-400 py-8">加载数据时出错</div>';
            }
        }
        
        function displayRankingData(data, type) {
            const content = document.getElementById('rankingContent');
            
            if (!data || data.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 py-8">暂无排行榜数据</div>';
                return;
            }
            
            let html = '';
            
            data.forEach((player, index) => {
                const isCurrentPlayer = player.name === (gameState.player.name || '当前玩家');
                const bgClass = isCurrentPlayer ? 'bg-blue-800' : 'bg-gray-700';
                const rankColor = index < 3 ? ['text-yellow-400', 'text-gray-300', 'text-orange-400'][index] : 'text-white';
                
                html += `
                    <div class="${bgClass} rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            ${type !== 'online' ? `<div class="${rankColor} font-bold text-lg w-8">#${player.rank || index + 1}</div>` : ''}
                            <div>
                                <div class="text-white font-bold">${player.name}</div>
                                <div class="text-sm text-gray-300">${player.class}</div>
                            </div>
                        </div>
                        <div class="text-right">
                `;
                
                switch(type) {
                    case 'level':
                        html += `<div class="text-green-400 font-bold">${player.level}级</div>`;
                        break;
                    case 'gold':
                        html += `<div class="text-yellow-400 font-bold">${player.gold.toLocaleString()}金币</div>`;
                        break;
                    case 'kills':
                        html += `<div class="text-red-400 font-bold">${player.kills.toLocaleString()}击杀</div>`;
                        break;
                    case 'online':
                        html += `
                            <div class="text-green-400 font-bold">${player.level}级</div>
                            <div class="text-xs text-green-300">${player.status}</div>
                        `;
                        break;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }
        
        // 移动端标签切换功能
        function switchMobileTab(tabType) {
            const questTab = document.getElementById('mobileQuestTab');
            const setTab = document.getElementById('mobileSetTab');
            const questButton = document.querySelector('.mobile-tab-button[onclick="switchMobileTab(\'quest\')"]');
            const setButton = document.querySelector('.mobile-tab-button[onclick="switchMobileTab(\'set\')"]');
            const desktopContent = document.querySelector('.desktop-quest-set-content');
            
            if (tabType === 'quest') {
                questTab.classList.remove('hidden');
                setTab.classList.add('hidden');
                questButton.classList.add('active');
                setButton.classList.remove('active');
                desktopContent.classList.add('hidden');
            } else if (tabType === 'set') {
                questTab.classList.add('hidden');
                setTab.classList.remove('hidden');
                questButton.classList.remove('active');
                setButton.classList.add('active');
                desktopContent.classList.add('hidden');
            }
        }
        
        // 同步移动端和桌面端的任务数据
        function syncQuestData() {
            const mainQuestTitle = document.getElementById('mainQuestTitle');
            const mainQuestDescription = document.getElementById('mainQuestDescription');
            const mainQuestProgress = document.getElementById('mainQuestProgress');
            const mainQuestReward = document.getElementById('mainQuestReward');
            const mainQuestSubmitHint = document.getElementById('mainQuestSubmitHint');
            
            const mainQuestTitleMobile = document.getElementById('mainQuestTitleMobile');
            const mainQuestDescriptionMobile = document.getElementById('mainQuestDescriptionMobile');
            const mainQuestProgressMobile = document.getElementById('mainQuestProgressMobile');
            const mainQuestRewardMobile = document.getElementById('mainQuestRewardMobile');
            const mainQuestSubmitHintMobile = document.getElementById('mainQuestSubmitHintMobile');
            
            if (mainQuestTitle && mainQuestTitleMobile) {
                mainQuestTitleMobile.textContent = mainQuestTitle.textContent;
            }
            if (mainQuestDescription && mainQuestDescriptionMobile) {
                mainQuestDescriptionMobile.textContent = mainQuestDescription.textContent;
            }
            if (mainQuestProgress && mainQuestProgressMobile) {
                mainQuestProgressMobile.textContent = mainQuestProgress.textContent;
            }
            if (mainQuestReward && mainQuestRewardMobile) {
                mainQuestRewardMobile.textContent = mainQuestReward.textContent;
            }
            if (mainQuestSubmitHint && mainQuestSubmitHintMobile) {
                if (mainQuestSubmitHint.classList.contains('hidden')) {
                    mainQuestSubmitHintMobile.classList.add('hidden');
                } else {
                    mainQuestSubmitHintMobile.classList.remove('hidden');
                }
            }
        }
        
        // 同步套装效果数据
        function syncSetBonusData() {
            const setBonusContent = document.getElementById('setBonusContent');
            const setBonusContentMobile = document.getElementById('setBonusContentMobile');
            
            if (setBonusContent && setBonusContentMobile) {
                setBonusContentMobile.innerHTML = setBonusContent.innerHTML;
            }
        }
        
        // 定期同步数据
        setInterval(() => {
            syncQuestData();
            syncSetBonusData();
        }, 1000);
        
        // 页面加载完成后初始化移动端显示
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否为移动端
            if (window.innerWidth <= 768) {
                const tabButtons = document.querySelector('.mobile-tab-buttons');
                const desktopContent = document.querySelector('.desktop-quest-set-content');
                
                if (tabButtons) {
                    tabButtons.classList.remove('hidden');
                }
                if (desktopContent) {
                    desktopContent.classList.add('hidden');
                }
                
                // 默认显示任务标签
                switchMobileTab('quest');
            }
        });
    </script>

</body>
</html>