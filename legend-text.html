<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字版传奇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .game-container {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .stat-bar {
            background: linear-gradient(90deg, #ff4444 0%, #ff6666 100%);
            transition: width 0.3s ease;
        }
        
        .mp-bar {
            background: linear-gradient(90deg, #4444ff 0%, #6666ff 100%);
            transition: width 0.3s ease;
        }
        
        .exp-bar {
            background: linear-gradient(90deg, #44ff44 0%, #66ff66 100%);
            transition: width 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            border: 2px solid #ffd700;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #666 0%, #888 100%);
            color: #fff;
            border: 2px solid #666;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #888 0%, #666 100%);
            box-shadow: 0 0 10px rgba(136, 136, 136, 0.5);
        }
        
        .equipment-slot {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .equipment-slot:hover {
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ffd700;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .monster-card {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff4444;
            transition: all 0.3s ease;
        }
        
        .monster-card:hover {
            background: rgba(255, 0, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }
        
        .elite-monster {
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        .elite-monster:hover {
            background: rgba(255, 215, 0, 0.25);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }
        
        .boss-monster {
            background: rgba(255, 0, 128, 0.15);
            border: 2px solid #ff0080;
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
            animation: bossGlow 2s ease-in-out infinite alternate;
        }
        
        .boss-monster:hover {
            background: rgba(255, 0, 128, 0.25);
            box-shadow: 0 0 25px rgba(255, 0, 128, 0.7);
            transform: translateY(-3px);
        }
        
        @keyframes bossGlow {
            from {
                box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 0, 128, 0.8);
            }
        }
        
        .skill-btn {
            background: rgba(68, 68, 255, 0.2);
            border: 2px solid #4444ff;
            transition: all 0.3s ease;
        }
        
        .skill-btn:hover {
            background: rgba(68, 68, 255, 0.3);
            box-shadow: 0 0 10px rgba(68, 68, 255, 0.5);
        }
        
        .item-common { color: #ffffff; }
        .item-rare { color: #0099ff; }
        .item-epic { color: #9933ff; }
        .item-legendary { color: #ff9900; }
        .item-mythic { color: #ff0080; text-shadow: 0 0 5px #ff0080; }
        .item-supreme { color: #00ffff; text-shadow: 0 0 8px #00ffff; animation: glow 2s ease-in-out infinite alternate; }
        .item-transcendent { color: #ff6600; text-shadow: 0 0 10px #ff6600, 0 0 15px #ff3300; animation: transcendentGlow 1.5s ease-in-out infinite alternate; }
        
        @keyframes glow {
            from { text-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff; }
            to { text-shadow: 0 0 12px #00ffff, 0 0 16px #00ffff, 0 0 20px #00ffff; }
        }
        
        @keyframes transcendentGlow {
            from { text-shadow: 0 0 10px #ff6600, 0 0 15px #ff3300, 0 0 20px #ff0000; }
            to { text-shadow: 0 0 15px #ff6600, 0 0 20px #ff3300, 0 0 25px #ff0000, 0 0 30px #ffaa00; }
        }
        
        .set-bonus {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border: 1px solid #ffd700;
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
        }
        
        .set-bonus-text {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 3px #ffa500;
        }
        
        .set-bonus-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .set-bonus-title {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            color: #000;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border-radius: 6px 6px 0 0;
            margin: -2px -2px 8px -2px;
        }
        
        .set-item {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 4px;
            padding: 6px;
            margin: 4px 0;
        }
        
        .set-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* 飘字效果样式 */
        .damage-text {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 2s ease-out forwards;
        }
        
        .damage-normal {
            color: #ff6b6b;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .damage-crit {
            color: #ffd700;
            font-size: 24px;
            text-shadow: 0 0 8px #ffd700, 1px 1px 2px rgba(0, 0, 0, 0.8);
            animation: critFloat 2s ease-out forwards;
        }
        
        .damage-heal {
            color: #4ade80;
            text-shadow: 0 0 5px #4ade80, 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-20px) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px) scale(0.8);
            }
        }
        
        @keyframes critFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1.2);
            }
            20% {
                transform: translateY(-10px) scale(1.4);
            }
            50% {
                opacity: 1;
                transform: translateY(-25px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
        }
         
         .set-count {
            color: #ffed4e;
            font-size: 12px;
        }
        
        .set-effect {
            color: #90ee90;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .set-next {
            color: #888;
            font-size: 11px;
            font-style: italic;
            margin-left: 8px;
        }
        
        /* 飘字效果样式 */
        .floating-text {
            position: fixed;
            z-index: 9999;
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }
        
        @keyframes critFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1.2);
            }
            20% {
                transform: translateY(-10px) scale(1.4);
            }
            50% {
                opacity: 1;
                transform: translateY(-35px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-70px) scale(0.9);
            }
        }
        
        .floating-text.success {
            color: #10b981;
        }
        
        .floating-text.craft {
            color: #f59e0b;
        }
        
        /* 角色动画样式 */
        .character-sprite {
            width: 48px;
            height: 48px;
            position: relative;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .character-idle {
            animation: idle 2s ease-in-out infinite;
        }
        
        .character-attack {
            animation: attack 0.6s ease-out;
        }
        
        .character-hurt {
            animation: hurt 0.4s ease-out;
        }
        
        .character-skill {
            animation: skill 1s ease-out;
        }
        
        @keyframes idle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }
        
        @keyframes attack {
            0% { transform: translateX(0) scale(1); }
            30% { transform: translateX(10px) scale(1.1); }
            60% { transform: translateX(-5px) scale(1.05); }
            100% { transform: translateX(0) scale(1); }
        }
        
        @keyframes hurt {
            0% { transform: translateX(0); filter: brightness(1); }
            25% { transform: translateX(-8px); filter: brightness(1.5) hue-rotate(0deg); }
            50% { transform: translateX(8px); filter: brightness(1.5) hue-rotate(180deg); }
            75% { transform: translateX(-4px); filter: brightness(1.2); }
            100% { transform: translateX(0); filter: brightness(1); }
        }
        
        @keyframes skill {
            0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
            25% { transform: scale(1.2) rotate(-5deg); filter: brightness(1.3) hue-rotate(60deg); }
            50% { transform: scale(1.1) rotate(5deg); filter: brightness(1.5) hue-rotate(120deg); }
            75% { transform: scale(1.15) rotate(-3deg); filter: brightness(1.2) hue-rotate(180deg); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
        }
        
        /* 移动端优化样式 */
        @media (max-width: 768px) {
            .max-w-7xl {
                max-width: 100%;
                padding: 0 8px;
            }
            
            .game-container {
                margin-bottom: 12px;
                padding: 12px;
            }
            
            .grid {
                gap: 8px;
            }
            
            .btn-primary, .btn-secondary, .skill-btn {
                min-height: 44px;
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .equipment-slot {
                min-height: 50px;
                font-size: 12px;
            }
            
            .text-4xl {
                font-size: 2rem;
            }
            
            .character-sprite {
                width: 40px;
                height: 40px;
            }
            
            .floating-text {
                font-size: 16px;
            }
            
            .log-area {
                max-height: 150px;
                font-size: 12px;
            }
            
            .monster-card {
                padding: 8px;
            }
            
            .space-y-2 > * + * {
                margin-top: 8px;
            }
            
            .space-y-3 > * + * {
                margin-top: 12px;
            }
            
            .grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-1.lg\:grid-cols-4 {
                grid-template-columns: 1fr;
            }
            
            .lg\:col-span-1 {
                grid-column: span 1;
            }
            
            .lg\:col-span-3 {
                grid-column: span 1;
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover, .btn-secondary:hover, .skill-btn:hover {
                transform: scale(0.98);
            }
            
            .btn-primary:active, .btn-secondary:active, .skill-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }
            
            .monster-card:hover {
                transform: none;
            }
            
            .equipment-slot:hover {
                background: rgba(255, 215, 0, 0.1);
                box-shadow: none;
            }
            
            /* 防止双击缩放 */
            button {
                touch-action: manipulation;
                user-select: none;
            }
            
            /* 移动端飘字优化 */
            .floating-text {
                font-size: 18px;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            }
            
            /* 战斗动画区域移动端优化 */
            #battleAnimationArea {
                height: 120px;
            }
            
            #damageTextContainer {
                overflow: visible;
                z-index: 1000;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <!-- 游戏标题 -->
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-yellow-400 mb-2">文字版传奇</h1>
            <p class="text-gray-300">重温经典，再创辉煌</p>
        </div>

        <!-- 角色创建界面 -->
        <div id="characterCreation" class="game-container rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">创建角色</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-white mb-3">战士</h3>
                    <div class="bg-gray-800 p-4 rounded border-2 border-red-500">
                        <p class="text-gray-300 mb-2">高血量，高防御</p>
                        <p class="text-sm text-gray-400">生命: 120 | 魔法: 30</p>
                        <p class="text-sm text-gray-400">攻击: 15-25 | 防御: 8</p>
                        <button onclick="createCharacter('warrior')" class="btn-primary px-4 py-2 rounded mt-3">选择战士</button>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-xl font-bold text-white mb-3">法师</h3>
                    <div class="bg-gray-800 p-4 rounded border-2 border-blue-500">
                        <p class="text-gray-300 mb-2">高魔法，强技能</p>
                        <p class="text-sm text-gray-400">生命: 80 | 魔法: 100</p>
                        <p class="text-sm text-gray-400">攻击: 10-20 | 防御: 3</p>
                        <button onclick="createCharacter('mage')" class="btn-primary px-4 py-2 rounded mt-3">选择法师</button>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-xl font-bold text-white mb-3">道士</h3>
                    <div class="bg-gray-800 p-4 rounded border-2 border-green-500">
                        <p class="text-gray-300 mb-2">平衡发展，召唤</p>
                        <p class="text-sm text-gray-400">生命: 100 | 魔法: 70</p>
                        <p class="text-sm text-gray-400">攻击: 12-22 | 防御: 5</p>
                        <button onclick="createCharacter('taoist')" class="btn-primary px-4 py-2 rounded mt-3">选择道士</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主游戏界面 -->
        <div id="gameInterface" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- 角色信息面板 -->
                <div class="lg:col-span-1">
                    <div class="game-container rounded-lg p-4 mb-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">角色信息</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-300">职业:</span>
                                <span id="playerClass" class="text-white"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">等级:</span>
                                <span id="playerLevel" class="text-white">1</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">金币:</span>
                                <span id="playerGold" class="text-yellow-400">100</span>
                            </div>
                        </div>
                        
                        <!-- 血量条 -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-red-400">生命值</span>
                                <span id="hpText" class="text-white">100/100</span>
                            </div>
                            <div class="bg-gray-700 rounded h-4 mt-1">
                                <div id="hpBar" class="stat-bar h-full rounded" style="width: 100%"></div>
                            </div>
                        </div>
                        
                        <!-- 魔法条 -->
                        <div class="mt-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-blue-400">魔法值</span>
                                <span id="mpText" class="text-white">50/50</span>
                            </div>
                            <div class="bg-gray-700 rounded h-4 mt-1">
                                <div id="mpBar" class="mp-bar h-full rounded" style="width: 100%"></div>
                            </div>
                        </div>
                        
                        <!-- 经验条 -->
                        <div class="mt-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-green-400">经验值</span>
                                <span id="expText" class="text-white">0/100</span>
                            </div>
                            <div class="bg-gray-700 rounded h-4 mt-1">
                                <div id="expBar" class="exp-bar h-full rounded" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 装备面板 -->
                    <div class="game-container rounded-lg p-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">装备</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="equipment-slot rounded p-2">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">武器</div>
                                    <div id="weapon" class="text-sm text-white">无</div>
                                </div>
                            </div>
                            <div class="equipment-slot rounded p-2">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">头盔</div>
                                    <div id="helmet" class="text-sm text-white">无</div>
                                </div>
                            </div>
                            <div class="equipment-slot rounded p-2">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">衣服</div>
                                    <div id="armor" class="text-sm text-white">无</div>
                                </div>
                            </div>
                            <div class="equipment-slot rounded p-2">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">鞋子</div>
                                    <div id="boots" class="text-sm text-white">无</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="equipment-slot rounded p-2">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">戒指</div>
                                    <div id="ring" class="text-sm text-white">无</div>
                                </div>
                            </div>
                            <div class="equipment-slot rounded p-2">
                                <div class="text-center">
                                    <div class="text-xs text-gray-400">项链</div>
                                    <div id="necklace" class="text-sm text-white">无</div>
                                </div>
                            </div>
                        </div>
                        <!-- 特殊装备槽位 -->
                        <div class="mb-2">
                            <div class="text-xs text-yellow-400 mb-1">特殊装备</div>
                            <div class="grid grid-cols-2 gap-1">
                                <div class="equipment-slot rounded p-1" style="background: rgba(255, 165, 0, 0.1); border-color: #ffa500;">
                                    <div class="text-center">
                                        <div class="text-xs text-orange-400">护符1</div>
                                        <div id="special1" class="text-xs text-white">无</div>
                                    </div>
                                </div>
                                <div class="equipment-slot rounded p-1" style="background: rgba(255, 165, 0, 0.1); border-color: #ffa500;">
                                    <div class="text-center">
                                        <div class="text-xs text-orange-400">护符2</div>
                                        <div id="special2" class="text-xs text-white">无</div>
                                    </div>
                                </div>
                                <div class="equipment-slot rounded p-1" style="background: rgba(255, 165, 0, 0.1); border-color: #ffa500;">
                                    <div class="text-center">
                                        <div class="text-xs text-orange-400">护符3</div>
                                        <div id="special3" class="text-xs text-white">无</div>
                                    </div>
                                </div>
                                <div class="equipment-slot rounded p-1" style="background: rgba(255, 165, 0, 0.1); border-color: #ffa500;">
                                    <div class="text-center">
                                        <div class="text-xs text-orange-400">护符4</div>
                                        <div id="special4" class="text-xs text-white">无</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 套装效果面板 -->
                    <div id="setBonusPanel" class="set-bonus-panel p-4 mt-4 hidden">
                        <div class="set-bonus-title">套装效果</div>
                        <div id="setBonusContent" class="space-y-2">
                            <!-- 套装效果将在这里显示 -->
                        </div>
                    </div>
                </div>
                
                <!-- 主要游戏区域 -->
                <div class="lg:col-span-2">
                    <!-- 地图区域 -->
                    <div class="game-container rounded-lg p-4 mb-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">当前位置: <span id="currentLocation">新手村</span></h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <button onclick="goToLocation('village')" class="btn-secondary px-3 py-2 rounded text-sm">新手村</button>
                            <button onclick="goToLocation('forest')" class="btn-secondary px-3 py-2 rounded text-sm">森林</button>
                            <button onclick="goToLocation('cave')" class="btn-secondary px-3 py-2 rounded text-sm">洞穴</button>
                            <button onclick="goToLocation('desert')" class="btn-secondary px-3 py-2 rounded text-sm">沙漠</button>
                            <button onclick="goToLocation('swamp')" class="btn-secondary px-3 py-2 rounded text-sm">沼泽</button>
                            <button onclick="goToLocation('mountain')" class="btn-secondary px-3 py-2 rounded text-sm">雪山</button>
                            <button onclick="goToLocation('dungeon')" class="btn-secondary px-3 py-2 rounded text-sm">地牢</button>
                            <button onclick="goToLocation('volcano')" class="btn-secondary px-3 py-2 rounded text-sm">火山</button>
                            <button onclick="goToLocation('abyss')" class="btn-secondary px-3 py-2 rounded text-sm">深渊</button>
                            <button onclick="goToLocation('heaven')" class="btn-secondary px-3 py-2 rounded text-sm">天界</button>
                            <button onclick="goToLocation('ocean')" class="btn-secondary px-3 py-2 rounded text-sm">海洋</button>
                            <button onclick="goToLocation('glacier')" class="btn-secondary px-3 py-2 rounded text-sm">冰川</button>
                            <button onclick="goToLocation('tomb')" class="btn-secondary px-3 py-2 rounded text-sm">古墓</button>
                            <button onclick="goToLocation('magicforest')" class="btn-secondary px-3 py-2 rounded text-sm">魔法森林</button>
                            <button onclick="goToLocation('starfield')" class="btn-secondary px-3 py-2 rounded text-sm">星空</button>
                            <button onclick="goToLocation('laboratory')" class="btn-secondary px-3 py-2 rounded text-sm">实验室</button>
                            <button onclick="goToLocation('shadowrealm')" class="btn-secondary px-3 py-2 rounded text-sm">影之领域</button>
                            <button onclick="goToLocation('crystalcave')" class="btn-secondary px-3 py-2 rounded text-sm">水晶洞穴</button>
                            <button onclick="goToLocation('dragonrealm')" class="btn-secondary px-3 py-2 rounded text-sm">龙之领域</button>
                            <button onclick="goToLocation('godsdomain')" class="btn-secondary px-3 py-2 rounded text-sm">神之领域</button>
                            <button onclick="goToLocation('chaosrealm')" class="btn-secondary px-3 py-2 rounded text-sm">混沌领域</button>
                            <button onclick="goToLocation('voidrealm')" class="btn-secondary px-3 py-2 rounded text-sm">虚空领域</button>
                            <button onclick="goToLocation('infiniterealm')" class="btn-secondary px-3 py-2 rounded text-sm">无限领域</button>
                            <button onclick="goToLocation('shop')" class="btn-secondary px-3 py-2 rounded text-sm">商店</button>
                        </div>
                        
                        <!-- 存档功能 -->
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="saveGame()" class="btn-primary px-4 py-2 rounded text-sm">保存游戏</button>
                            <button onclick="loadGame()" class="btn-primary px-4 py-2 rounded text-sm">加载游戏</button>
                            <button onclick="showSaveSlots()" class="btn-secondary px-4 py-2 rounded text-sm">存档管理</button>
                            <button onclick="showAttributePanel()" class="btn-secondary px-4 py-2 rounded text-sm">属性面板</button>
                            <button onclick="showCraftPanel()" class="btn-secondary px-4 py-2 rounded text-sm">装备合成</button>
                            <button onclick="showCultivationPanel()" class="btn-secondary px-4 py-2 rounded text-sm">养成系统</button>
                            <button onclick="showQuestPanel()" class="btn-secondary px-4 py-2 rounded text-sm">任务系统</button>
                            <button onclick="showTitlePanel()" class="btn-secondary px-4 py-2 rounded text-sm">称号系统</button>
                        </div>
                    </div>
                    
                    <!-- 怪物区域 -->
                    <div id="monsterArea" class="game-container rounded-lg p-4 mb-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">遇到的怪物</h3>
                        <div id="monsterList" class="space-y-3">
                            <!-- 怪物将在这里动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 战斗区域 -->
                    <div id="battleArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <h3 class="text-xl font-bold text-red-400 mb-3">战斗中</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">你</h4>
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="text-sm text-gray-300">生命: <span id="battlePlayerHp">100/100</span></div>
                                    <div class="text-sm text-gray-300">魔法: <span id="battlePlayerMp">50/50</span></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white mb-2">敌人</h4>
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="text-sm text-gray-300">名称: <span id="battleMonsterName">骷髅</span></div>
                                    <div class="text-sm text-gray-300">生命: <span id="battleMonsterHp">50/50</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 战斗动画区域 -->
                        <div class="mt-4 mb-4">
                            <div id="battleAnimationArea" class="bg-gray-800 rounded-lg p-4 relative overflow-hidden" style="height: 120px;">
                                <div class="absolute bottom-4 left-8">
                                    <div id="playerFighter" class="character-sprite character-idle">
                                        <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                            <!-- 玩家角色 - 法师 -->
                                            <rect x="20" y="35" width="8" height="10" fill="#8B4513"/> <!-- 腿 -->
                                            <rect x="18" y="25" width="12" height="15" fill="#4169E1"/> <!-- 身体/袍子 -->
                                            <rect x="16" y="30" width="4" height="8" fill="#FDBCB4"/> <!-- 左臂 -->
                                            <rect x="28" y="30" width="4" height="8" fill="#FDBCB4"/> <!-- 右臂 -->
                                            <rect x="20" y="20" width="8" height="8" fill="#FDBCB4"/> <!-- 头 -->
                                            <rect x="18" y="18" width="12" height="4" fill="#8B4513"/> <!-- 帽子 -->
                                            <rect x="22" y="22" width="2" height="2" fill="#000"/> <!-- 左眼 -->
                                            <rect x="24" y="22" width="2" height="2" fill="#000"/> <!-- 右眼 -->
                                            <rect x="30" y="28" width="8" height="2" fill="#8B4513"/> <!-- 法杖 -->
                                            <rect x="36" y="26" width="4" height="4" fill="#FFD700"/> <!-- 法杖顶部 -->
                                        </svg>
                                    </div>
                                    <div class="text-xs text-center text-blue-400 mt-1">玩家</div>
                                </div>
                                <div class="absolute bottom-4 right-8">
                                    <div id="monsterFighter" class="character-sprite character-idle">
                                        <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                            <!-- 怪物角色 - 骷髅 -->
                                            <rect x="20" y="35" width="8" height="10" fill="#F5F5DC"/> <!-- 腿骨 -->
                                            <rect x="18" y="25" width="12" height="15" fill="#F5F5DC"/> <!-- 身体骨架 -->
                                            <rect x="16" y="30" width="4" height="8" fill="#F5F5DC"/> <!-- 左臂骨 -->
                                            <rect x="28" y="30" width="4" height="8" fill="#F5F5DC"/> <!-- 右臂骨 -->
                                            <rect x="20" y="20" width="8" height="8" fill="#F5F5DC"/> <!-- 头骨 -->
                                            <rect x="22" y="22" width="2" height="2" fill="#FF0000"/> <!-- 左眼窝 -->
                                            <rect x="24" y="22" width="2" height="2" fill="#FF0000"/> <!-- 右眼窝 -->
                                            <rect x="22" y="25" width="4" height="1" fill="#000"/> <!-- 嘴 -->
                                            <rect x="30" y="28" width="8" height="2" fill="#8B4513"/> <!-- 武器 -->
                                        </svg>
                                    </div>
                                    <div class="text-xs text-center text-red-400 mt-1">怪物</div>
                                </div>
                                <!-- 攻击特效 -->
                                <div id="attackEffect" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl opacity-0 transition-all duration-500">
                                    ⚡
                                </div>
                                <!-- 飘字容器 -->
                                <div id="damageTextContainer" class="absolute inset-0 pointer-events-none" style="z-index: 100; overflow: visible;">
                                    <!-- 飘字将在这里动态生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="mb-3">
                                <button id="autoBattleBtn" onclick="toggleAutoBattle()" class="btn-primary px-6 py-2 rounded mr-2">开始自动战斗</button>
                                <button onclick="flee()" class="btn-secondary px-4 py-2 rounded">逃跑</button>
                                <button id="whipCorpseBtn" onclick="whipCorpse()" class="btn-secondary px-4 py-2 rounded ml-2 hidden">鞭尸</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="useSkill('fireball')" class="skill-btn px-4 py-2 rounded text-white">火球术 (10MP)</button>
                                <button onclick="useSkill('heal')" class="skill-btn px-4 py-2 rounded text-white">治疗术 (15MP)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 商店区域 -->
                    <div id="shopArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-yellow-400">商店</h3>
                            <div class="space-x-2">
                                <button id="buyTab" onclick="switchShopTab('buy')" class="btn-primary px-4 py-2 rounded">购买</button>
                                <button id="sellTab" onclick="switchShopTab('sell')" class="btn-secondary px-4 py-2 rounded">出售</button>
                            </div>
                        </div>
                        <div id="shopItems" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- 商店物品将在这里动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 存档管理区域 -->
                    <div id="saveArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-yellow-400">存档管理</h3>
                            <button onclick="hideSaveSlots()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        <div id="saveSlots" class="space-y-3">
                            <!-- 存档槽位将在这里动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 合成系统区域 -->
                    <div id="craftArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-purple-400">装备合成</h3>
                            <button onclick="hideCraftPanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <!-- 合成配方选择 -->
                        <div class="mb-4">
                            <h4 class="text-lg font-bold text-blue-400 mb-3">合成配方</h4>
                            <div id="craftRecipes" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <!-- 合成配方将在这里动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 合成详情 -->
                        <div id="craftDetails" class="bg-gray-800 rounded-lg p-4 hidden">
                            <h4 class="text-lg font-bold text-green-400 mb-3">合成详情</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="text-md font-bold text-yellow-400 mb-2">所需材料</h5>
                                    <div id="craftMaterials" class="space-y-2 text-sm">
                                        <!-- 所需材料列表 -->
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-md font-bold text-yellow-400 mb-2">合成结果</h5>
                                    <div id="craftResult" class="bg-gray-700 rounded p-3">
                                        <!-- 合成结果预览 -->
                                    </div>
                                    <button id="craftButton" onclick="performCraft()" class="btn-primary px-4 py-2 rounded mt-3 w-full" disabled>合成</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 任务系统区域 -->
                    <div id="questArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-green-400">任务系统</h3>
                            <button onclick="hideQuestPanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- 可接任务 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">可接任务</h4>
                                <div id="availableQuests" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- 可接任务列表 -->
                                </div>
                            </div>
                            
                            <!-- 进行中任务 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-yellow-400 mb-3">进行中任务</h4>
                                <div id="activeQuests" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- 进行中任务列表 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 已完成任务 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-green-400 mb-3">已完成任务</h4>
                            <div id="completedQuests" class="space-y-2 max-h-40 overflow-y-auto">
                                <!-- 已完成任务列表 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 称号系统区域 -->
                    <div id="titleArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-purple-400">称号系统</h3>
                            <button onclick="hideTitlePanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- 当前称号 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-gold mb-3">当前称号</h4>
                                <div id="currentTitle" class="text-center p-4 border-2 border-gold rounded-lg">
                                    <div class="text-gray-400">未激活称号</div>
                                </div>
                                <div id="titleEffect" class="mt-3 text-sm text-gray-300">
                                    <!-- 称号效果显示 -->
                                </div>
                            </div>
                            
                            <!-- 拥有的称号 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">拥有的称号</h4>
                                <div id="ownedTitles" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- 拥有的称号列表 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 称号卷轴 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-orange-400 mb-3">称号卷轴</h4>
                            <div id="titleScrolls" class="space-y-2 max-h-40 overflow-y-auto">
                                <!-- 称号卷轴列表 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 属性面板区域 -->
                    <div id="attributeArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-yellow-400">角色属性</h3>
                            <button onclick="hideAttributePanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 基础属性 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">基础属性</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">职业:</span>
                                        <span id="attrClass" class="text-white">战士</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="attrLevel" class="text-white">1</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">生命值:</span>
                                        <span id="attrHp" class="text-white">100/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">魔法值:</span>
                                        <span id="attrMp" class="text-white">50/50</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验值:</span>
                                        <span id="attrExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">金币:</span>
                                        <span id="attrGold" class="text-white">100</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 战斗属性 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-red-400 mb-3">战斗属性</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">攻击力:</span>
                                        <span id="attrAttack" class="text-white">10-20</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">防御力:</span>
                                        <span id="attrDefense" class="text-white">5</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">暴击率:</span>
                                        <span id="attrCritRate" class="text-yellow-400">5%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">暴击伤害:</span>
                                        <span id="attrCritDamage" class="text-yellow-400">150%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">法术强度:</span>
                                        <span id="attrMagicPower" class="text-blue-400">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 装备加成详情 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-green-400 mb-3">装备加成</h4>
                            <div id="equipmentBonus" class="text-sm text-gray-300">
                                <div>当前无装备加成</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 养成系统区域 -->
                    <div id="cultivationArea" class="game-container rounded-lg p-4 mb-4 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-purple-400">养成系统</h3>
                            <button onclick="hideCultivationPanel()" class="btn-secondary px-3 py-1 rounded text-sm">关闭</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 爆率提升 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-yellow-400 mb-3">爆率提升</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="dropRateLevel" class="text-white">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验:</span>
                                        <span id="dropRateExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">效果:</span>
                                        <span id="dropRateEffect" class="text-green-400">+0%</span>
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="upgradeCultivation('dropRate')" class="btn-primary px-4 py-2 rounded w-full text-sm">升级 (消耗材料)</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 伤害提升 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-red-400 mb-3">伤害提升</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="damageLevel" class="text-white">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验:</span>
                                        <span id="damageExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">效果:</span>
                                        <span id="damageEffect" class="text-green-400">+0%</span>
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="upgradeCultivation('damage')" class="btn-primary px-4 py-2 rounded w-full text-sm">升级 (消耗材料)</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 鞭尸概率 -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-lg font-bold text-blue-400 mb-3">鞭尸概率</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">等级:</span>
                                        <span id="whipCorpseLevel" class="text-white">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">经验:</span>
                                        <span id="whipCorpseExp" class="text-white">0/100</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">效果:</span>
                                        <span id="whipCorpseEffect" class="text-green-400">0%</span>
                                    </div>
                                    <div class="mt-3">
                                        <button onclick="upgradeCultivation('whipCorpse')" class="btn-primary px-4 py-2 rounded w-full text-sm">升级 (消耗材料)</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 升级材料需求 -->
                        <div class="mt-4 bg-gray-800 rounded-lg p-4">
                            <h4 class="text-lg font-bold text-orange-400 mb-3">升级材料需求</h4>
                            <div id="cultivationMaterials" class="text-sm text-gray-300">
                                <div>选择要升级的养成项目查看材料需求</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 背包和日志 -->
                <div class="lg:col-span-1">
                    <!-- 背包 -->
                    <div class="game-container rounded-lg p-4 mb-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">背包</h3>
                        <div id="inventory" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- 背包物品将在这里显示 -->
                        </div>
                    </div>
                    
                    <!-- 游戏日志 -->
                    <div class="game-container rounded-lg p-4">
                        <h3 class="text-xl font-bold text-yellow-400 mb-3">游戏日志</h3>
                        <div id="gameLog" class="log-area p-3 text-sm text-gray-300">
                            <div>欢迎来到传奇世界！</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        let gameState = {
            player: {
                class: '',
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                exp: 0,
                maxExp: 100,
                gold: 100,
                attack: [10, 20],
                defense: 5,
                equipment: {
                    weapon: null,
                    helmet: null,
                    armor: null,
                    boots: null,
                    ring: null,
                    necklace: null,
                    special1: null,
                    special2: null,
                    special3: null,
                    special4: null
                },
                inventory: [],
                materials: [], // 养成材料存储
                // 养成系统
                cultivation: {
                    dropRate: { level: 0, exp: 0 },      // 爆率提升
                    damage: { level: 0, exp: 0 },        // 伤害提升
                    whipCorpse: { level: 0, exp: 0 }     // 鞭尸概率
                },
                // 任务系统
                quests: {
                    active: [],      // 当前进行中的任务
                    completed: [],   // 已完成的任务
                    available: []    // 可接取的任务
                },
                // 称号系统
                titles: {
                    owned: [],       // 拥有的称号
                    active: null,    // 当前激活的称号
                    scrolls: []      // 称号卷轴
                }
            },
            currentLocation: 'village',
            inBattle: false,
            currentMonster: null,
            shopMode: 'buy',
            autoBattle: false,
            battleInterval: null,
            showWhipCorpse: false  // 是否显示鞭尸按钮
        };

        // 切换商店标签页
        function switchShopTab(mode) {
            gameState.shopMode = mode;
            
            // 更新按钮样式
            const buyTab = document.getElementById('buyTab');
            const sellTab = document.getElementById('sellTab');
            
            if (mode === 'buy') {
                buyTab.className = 'btn-primary px-4 py-2 rounded';
                sellTab.className = 'btn-secondary px-4 py-2 rounded';
            } else {
                buyTab.className = 'btn-secondary px-4 py-2 rounded';
                sellTab.className = 'btn-primary px-4 py-2 rounded';
            }
            
            showShop();
        }

        // 职业配置
        const classes = {
            warrior: {
                name: '战士',
                hp: 120,
                mp: 30,
                attack: [15, 25],
                defense: 8,
                critRate: 5, // 暴击率5%
                critDamage: 150, // 暴击伤害150%
                skills: {
                    basicSword: { name: '基本剑术', level: 0, maxLevel: 3, mpCost: 0, description: '提升攻击命中率' },
                    attackSword: { name: '攻杀剑术', level: 0, maxLevel: 3, mpCost: 5, description: '强力攻击技能' },
                    halfMoon: { name: '半月弯刀', level: 0, maxLevel: 3, mpCost: 8, description: '扇形范围攻击' },
                    wildSlash: { name: '野蛮冲撞', level: 0, maxLevel: 3, mpCost: 12, description: '冲撞击退敌人' }
                }
            },
            mage: {
                name: '法师',
                hp: 80,
                mp: 100,
                attack: [10, 20],
                defense: 3,
                critRate: 8, // 暴击率8%
                critDamage: 180, // 暴击伤害180%
                skills: {
                    fireball: { name: '火球术', level: 0, maxLevel: 3, mpCost: 10, description: '发射火球攻击敌人' },
                    heal: { name: '治愈术', level: 0, maxLevel: 3, mpCost: 15, description: '恢复生命值' },
                    lightning: { name: '雷电术', level: 0, maxLevel: 3, mpCost: 18, description: '召唤雷电攻击' },
                    magicShield: { name: '魔法盾', level: 0, maxLevel: 3, mpCost: 25, description: '魔法护盾减免伤害' }
                }
            },
            taoist: {
                name: '道士',
                hp: 100,
                mp: 70,
                attack: [12, 22],
                defense: 5,
                critRate: 6, // 暴击率6%
                critDamage: 160, // 暴击伤害160%
                skills: {
                    heal: { name: '治愈术', level: 0, maxLevel: 3, mpCost: 15, description: '恢复生命值' },
                    poison: { name: '施毒术', level: 0, maxLevel: 3, mpCost: 8, description: '给敌人施加毒素' },
                    soulFire: { name: '灵魂火符', level: 0, maxLevel: 3, mpCost: 12, description: '远程火符攻击' },
                    summon: { name: '召唤骷髅', level: 0, maxLevel: 3, mpCost: 30, description: '召唤骷髅战士' }
                }
            }
        };

        // 怪物配置
        const monsters = {
            village: [
                { name: '小鸡', hp: 20, attack: [3, 8], exp: 10, gold: 5, level: 1, type: 'normal' },
                { name: '小鹿', hp: 30, attack: [5, 10], exp: 15, gold: 8, level: 1, type: 'normal' },
                { name: '精英野兔', hp: 60, attack: [8, 15], exp: 30, gold: 20, level: 2, type: 'elite', dropRate: 1.5 },
                { name: '村长的宠物熊', hp: 150, attack: [15, 25], exp: 80, gold: 60, level: 3, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            forest: [
                { name: '森林狼', hp: 50, attack: [8, 15], exp: 25, gold: 15, level: 2, type: 'normal' },
                { name: '野猪', hp: 70, attack: [10, 18], exp: 35, gold: 20, level: 3, type: 'normal' },
                { name: '精英狼王', hp: 120, attack: [18, 28], exp: 60, gold: 45, level: 4, type: 'elite', dropRate: 1.5 },
                { name: '森林守护者', hp: 280, attack: [25, 40], exp: 150, gold: 120, level: 6, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            cave: [
                { name: '骷髅', hp: 80, attack: [12, 20], exp: 40, gold: 25, level: 3, type: 'normal' },
                { name: '僵尸', hp: 100, attack: [15, 25], exp: 50, gold: 30, level: 4, type: 'normal' },
                { name: '精英骷髅战士', hp: 180, attack: [22, 35], exp: 80, gold: 60, level: 5, type: 'elite', dropRate: 1.5 },
                { name: '亡灵领主', hp: 350, attack: [30, 50], exp: 200, gold: 150, level: 7, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            desert: [
                { name: '沙漠蝎', hp: 120, attack: [18, 30], exp: 60, gold: 40, level: 5, type: 'normal' },
                { name: '沙虫', hp: 150, attack: [20, 35], exp: 75, gold: 50, level: 6, type: 'normal' },
                { name: '精英沙漠毒蝎', hp: 220, attack: [28, 45], exp: 120, gold: 80, level: 7, type: 'elite', dropRate: 1.5 },
                { name: '沙漠霸主', hp: 450, attack: [35, 60], exp: 280, gold: 200, level: 9, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            dungeon: [
                { name: '恶魔', hp: 200, attack: [25, 40], exp: 100, gold: 80, level: 8, type: 'normal' },
                { name: '龙', hp: 300, attack: [30, 50], exp: 150, gold: 120, level: 10, type: 'normal' },
                { name: '精英恶魔督军', hp: 380, attack: [35, 55], exp: 200, gold: 160, level: 11, type: 'elite', dropRate: 1.5 },
                { name: '地牢魔王', hp: 800, attack: [50, 80], exp: 450, gold: 350, level: 15, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            mountain: [
                { name: '雪狼', hp: 180, attack: [22, 38], exp: 85, gold: 65, level: 7, type: 'normal' },
                { name: '冰霜巨人', hp: 250, attack: [28, 45], exp: 120, gold: 90, level: 9, type: 'normal' },
                { name: '雪怪', hp: 160, attack: [20, 35], exp: 70, gold: 55, level: 6, type: 'normal' },
                { name: '精英冰霜泰坦', hp: 420, attack: [40, 65], exp: 220, gold: 180, level: 12, type: 'elite', dropRate: 1.5 },
                { name: '雪山之王', hp: 900, attack: [55, 90], exp: 500, gold: 400, level: 16, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            swamp: [
                { name: '毒蛇', hp: 90, attack: [15, 25], exp: 45, gold: 35, level: 4, type: 'normal' },
                { name: '沼泽巨鳄', hp: 220, attack: [25, 42], exp: 110, gold: 85, level: 8, type: 'normal' },
                { name: '腐尸怪', hp: 140, attack: [18, 32], exp: 65, gold: 45, level: 5, type: 'normal' },
                { name: '精英毒沼蟒', hp: 350, attack: [32, 52], exp: 180, gold: 140, level: 10, type: 'elite', dropRate: 1.5 },
                { name: '沼泽霸主', hp: 750, attack: [45, 75], exp: 400, gold: 320, level: 14, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            volcano: [
                { name: '火元素', hp: 280, attack: [30, 48], exp: 140, gold: 110, level: 11, type: 'normal' },
                { name: '熔岩兽', hp: 320, attack: [35, 55], exp: 180, gold: 140, level: 12, type: 'normal' },
                { name: '炎魔', hp: 400, attack: [40, 65], exp: 220, gold: 180, level: 15, type: 'normal' },
                { name: '精英熔岩巨人', hp: 650, attack: [55, 85], exp: 350, gold: 280, level: 17, type: 'elite', dropRate: 1.5 },
                { name: '火山之神', hp: 1200, attack: [70, 110], exp: 700, gold: 550, level: 20, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            abyss: [
                { name: '暗影刺客', hp: 350, attack: [38, 60], exp: 200, gold: 160, level: 13, type: 'normal' },
                { name: '深渊领主', hp: 500, attack: [45, 75], exp: 300, gold: 250, level: 18, type: 'normal' },
                { name: '虚空恶魔', hp: 600, attack: [50, 85], exp: 400, gold: 320, level: 20, type: 'normal' },
                { name: '精英深渊魔将', hp: 850, attack: [65, 100], exp: 550, gold: 450, level: 22, type: 'elite', dropRate: 1.5 },
                { name: '深渊魔帝', hp: 1500, attack: [80, 130], exp: 900, gold: 700, level: 25, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            heaven: [
                { name: '堕落天使', hp: 450, attack: [42, 70], exp: 250, gold: 200, level: 16, type: 'normal' },
                { name: '光明守护者', hp: 550, attack: [48, 80], exp: 350, gold: 280, level: 19, type: 'normal' },
                { name: '天界战神', hp: 800, attack: [60, 100], exp: 500, gold: 400, level: 25, type: 'normal' },
                { name: '精英大天使', hp: 1100, attack: [75, 120], exp: 650, gold: 520, level: 27, type: 'elite', dropRate: 1.5 },
                { name: '天界至尊', hp: 1800, attack: [90, 150], exp: 1200, gold: 900, level: 30, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            ocean: [
                { name: '海盗', hp: 110, attack: [16, 28], exp: 55, gold: 42, level: 5, type: 'normal' },
                { name: '海妖', hp: 190, attack: [24, 40], exp: 95, gold: 75, level: 8, type: 'normal' },
                { name: '深海巨兽', hp: 380, attack: [36, 58], exp: 190, gold: 150, level: 14, type: 'normal' },
                { name: '精英海盗船长', hp: 280, attack: [30, 48], exp: 140, gold: 110, level: 9, type: 'elite', dropRate: 1.5 },
                { name: '海神波塞冬', hp: 850, attack: [52, 88], exp: 480, gold: 380, level: 18, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            glacier: [
                { name: '冰晶蜘蛛', hp: 130, attack: [19, 32], exp: 65, gold: 48, level: 6, type: 'normal' },
                { name: '极地熊王', hp: 270, attack: [32, 50], exp: 135, gold: 105, level: 11, type: 'normal' },
                { name: '冰龙', hp: 520, attack: [46, 78], exp: 320, gold: 260, level: 19, type: 'normal' },
                { name: '精英冰霜女王', hp: 450, attack: [42, 68], exp: 250, gold: 200, level: 15, type: 'elite', dropRate: 1.5 },
                { name: '永恒冰神', hp: 1000, attack: [65, 105], exp: 600, gold: 480, level: 22, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            tomb: [
                { name: '木乃伊', hp: 95, attack: [14, 24], exp: 48, gold: 38, level: 4, type: 'normal' },
                { name: '法老守卫', hp: 210, attack: [26, 44], exp: 105, gold: 82, level: 9, type: 'normal' },
                { name: '古代法老', hp: 420, attack: [38, 62], exp: 210, gold: 170, level: 16, type: 'normal' },
                { name: '精英法老祭司', hp: 350, attack: [35, 58], exp: 180, gold: 140, level: 12, type: 'elite', dropRate: 1.5 },
                { name: '不朽法老王', hp: 900, attack: [58, 95], exp: 520, gold: 420, level: 19, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            magicforest: [
                { name: '精灵射手', hp: 85, attack: [13, 22], exp: 42, gold: 32, level: 3, type: 'normal' },
                { name: '树人长老', hp: 240, attack: [29, 47], exp: 120, gold: 95, level: 10, type: 'normal' },
                { name: '森林之王', hp: 460, attack: [41, 68], exp: 230, gold: 185, level: 17, type: 'normal' },
                { name: '精英自然守护者', hp: 380, attack: [38, 62], exp: 200, gold: 160, level: 14, type: 'elite', dropRate: 1.5 },
                { name: '世界树之灵', hp: 950, attack: [62, 100], exp: 580, gold: 460, level: 21, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            starfield: [
                { name: '星灵', hp: 340, attack: [34, 56], exp: 170, gold: 135, level: 12, type: 'normal' },
                { name: '虚空行者', hp: 480, attack: [44, 72], exp: 280, gold: 220, level: 18, type: 'normal' },
                { name: '宇宙主宰', hp: 750, attack: [58, 95], exp: 480, gold: 380, level: 24, type: 'normal' },
                { name: '精英星际战士', hp: 650, attack: [55, 88], exp: 380, gold: 300, level: 20, type: 'elite', dropRate: 1.5 },
                { name: '宇宙创世神', hp: 1600, attack: [85, 140], exp: 1000, gold: 800, level: 28, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            laboratory: [
                { name: '变异体', hp: 120, attack: [17, 30], exp: 58, gold: 45, level: 5, type: 'normal' },
                { name: '机械守卫', hp: 200, attack: [25, 42], exp: 100, gold: 78, level: 8, type: 'normal' },
                { name: '终极兵器', hp: 600, attack: [52, 88], exp: 380, gold: 300, level: 21, type: 'normal' },
                { name: '精英机械领主', hp: 480, attack: [48, 78], exp: 280, gold: 220, level: 16, type: 'elite', dropRate: 1.5 },
                { name: '人工智能主脑', hp: 1100, attack: [68, 110], exp: 650, gold: 520, level: 24, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            shadowrealm: [
                { name: '影子武士', hp: 160, attack: [21, 36], exp: 78, gold: 60, level: 7, type: 'normal' },
                { name: '暗影领主', hp: 320, attack: [33, 55], exp: 160, gold: 125, level: 13, type: 'normal' },
                { name: '黑暗之神', hp: 680, attack: [55, 92], exp: 420, gold: 340, level: 23, type: 'normal' },
                { name: '精英暗影执行者', hp: 550, attack: [50, 82], exp: 320, gold: 260, level: 18, type: 'elite', dropRate: 1.5 },
                { name: '虚无之主', hp: 1400, attack: [78, 125], exp: 850, gold: 680, level: 26, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            crystalcave: [
                { name: '水晶蝙蝠', hp: 75, attack: [12, 20], exp: 38, gold: 28, level: 3, type: 'normal' },
                { name: '水晶巨人', hp: 290, attack: [31, 52], exp: 145, gold: 115, level: 12, type: 'normal' },
                { name: '水晶龙王', hp: 550, attack: [47, 80], exp: 350, gold: 280, level: 20, type: 'normal' },
                { name: '精英水晶守护者', hp: 420, attack: [40, 65], exp: 230, gold: 180, level: 15, type: 'elite', dropRate: 1.5 },
                { name: '水晶位面之王', hp: 1050, attack: [63, 102], exp: 620, gold: 500, level: 23, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            // 超高级地区
            dragonrealm: [
                { name: '幼龙', hp: 800, attack: [65, 110], exp: 450, gold: 360, level: 25, type: 'normal' },
                { name: '成年巨龙', hp: 1200, attack: [85, 140], exp: 680, gold: 540, level: 30, type: 'normal' },
                { name: '远古龙王', hp: 1800, attack: [120, 200], exp: 1200, gold: 950, level: 35, type: 'normal' },
                { name: '精英龙族长老', hp: 2200, attack: [140, 230], exp: 1500, gold: 1200, level: 38, type: 'elite', dropRate: 1.5 },
                { name: '龙神巴哈姆特', hp: 3500, attack: [200, 320], exp: 2500, gold: 2000, level: 45, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            godsdomain: [
                { name: '神界守卫', hp: 1500, attack: [100, 160], exp: 800, gold: 640, level: 32, type: 'normal' },
                { name: '天使长', hp: 2000, attack: [130, 210], exp: 1100, gold: 880, level: 36, type: 'normal' },
                { name: '神界战神', hp: 2800, attack: [170, 280], exp: 1600, gold: 1280, level: 40, type: 'normal' },
                { name: '精英神界执法者', hp: 3200, attack: [190, 310], exp: 1900, gold: 1520, level: 42, type: 'elite', dropRate: 1.5 },
                { name: '至高神王', hp: 5000, attack: [250, 400], exp: 3500, gold: 2800, level: 50, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            chaosrealm: [
                { name: '混沌恶魔', hp: 2200, attack: [140, 230], exp: 1300, gold: 1040, level: 38, type: 'normal' },
                { name: '混沌领主', hp: 3000, attack: [180, 300], exp: 1800, gold: 1440, level: 42, type: 'normal' },
                { name: '混沌毁灭者', hp: 4000, attack: [220, 360], exp: 2400, gold: 1920, level: 46, type: 'normal' },
                { name: '精英混沌支配者', hp: 4500, attack: [250, 410], exp: 2800, gold: 2240, level: 48, type: 'elite', dropRate: 1.5 },
                { name: '混沌之源', hp: 6500, attack: [300, 480], exp: 4500, gold: 3600, level: 55, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            voidrealm: [
                { name: '虚空游荡者', hp: 2800, attack: [170, 280], exp: 1600, gold: 1280, level: 40, type: 'normal' },
                { name: '虚空吞噬者', hp: 3800, attack: [210, 350], exp: 2200, gold: 1760, level: 44, type: 'normal' },
                { name: '虚空主宰', hp: 5200, attack: [260, 420], exp: 3000, gold: 2400, level: 48, type: 'normal' },
                { name: '精英虚空统治者', hp: 6000, attack: [290, 470], exp: 3500, gold: 2800, level: 50, type: 'elite', dropRate: 1.5 },
                { name: '虚无之神', hp: 8000, attack: [350, 550], exp: 5500, gold: 4400, level: 60, type: 'boss', dropRate: 3.0, bossLoot: true }
            ],
            infiniterealm: [
                { name: '无限守护者', hp: 5000, attack: [250, 400], exp: 2800, gold: 2240, level: 45, type: 'normal' },
                { name: '无限执行者', hp: 7000, attack: [320, 520], exp: 4000, gold: 3200, level: 50, type: 'normal' },
                { name: '无限主宰', hp: 10000, attack: [400, 650], exp: 6000, gold: 4800, level: 55, type: 'normal' },
                { name: '精英无限统治者', hp: 12000, attack: [450, 750], exp: 7500, gold: 6000, level: 58, type: 'elite', dropRate: 1.5 },
                { name: '无限之神', hp: 15000, attack: [500, 800], exp: 10000, gold: 8000, level: 65, type: 'boss', dropRate: 3.0, bossLoot: true }
            ]
        };

        // 装备配置
        const equipment = {
            weapons: [
                { name: '木剑', attack: [5, 10], critRate: 0, critDamage: 0, price: 50, rarity: 'common' },
                { name: '铁剑', attack: [10, 18], critRate: 2, critDamage: 10, price: 150, rarity: 'common' },
                { name: '银剑', attack: [15, 25], critRate: 3, critDamage: 15, price: 300, rarity: 'rare' },
                { name: '黄金剑', attack: [20, 35], critRate: 5, critDamage: 25, price: 600, rarity: 'epic' },
                { name: '屠龙刀', attack: [30, 50], critRate: 8, critDamage: 40, price: 1500, rarity: 'legendary' },
                { name: '法师之杖', attack: [8, 15], critRate: 6, critDamage: 30, magicPower: 20, price: 400, rarity: 'rare', class: 'mage' },
                { name: '道士法杖', attack: [10, 18], critRate: 4, critDamage: 20, magicPower: 15, price: 350, rarity: 'rare', class: 'taoist' },
                // 神话品质武器
                { name: '天神之剑', attack: [45, 75], critRate: 15, critDamage: 60, price: 5000, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔刃', attack: [50, 80], critRate: 12, critDamage: 80, vampiric: 15, price: 6000, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法杖', attack: [35, 60], critRate: 20, critDamage: 70, magicPower: 50, price: 5500, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道杖', attack: [40, 65], critRate: 18, critDamage: 65, magicPower: 40, healBonus: 25, price: 5200, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质武器
                { name: '混沌之刃', attack: [70, 120], critRate: 25, critDamage: 100, chaosStrike: 20, price: 15000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法杖', attack: [60, 100], critRate: 30, critDamage: 90, magicPower: 80, voidPower: 30, price: 14000, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质武器
                { name: '龙神之剑', attack: [120, 200], critRate: 35, critDamage: 150, dragonPower: 50, price: 30000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣剑', attack: [100, 180], critRate: 40, critDamage: 140, holyPower: 60, price: 32000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限之刃', attack: [150, 250], critRate: 45, critDamage: 200, infinitePower: 80, price: 50000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神杖', attack: [80, 150], critRate: 50, critDamage: 180, magicPower: 120, creationPower: 100, price: 45000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            armors: [
                { name: '布衣', defense: 2, hp: 0, mp: 0, price: 30, rarity: 'common' },
                { name: '皮甲', defense: 5, hp: 10, mp: 0, price: 100, rarity: 'common' },
                { name: '铁甲', defense: 8, hp: 20, mp: 0, critRate: 1, price: 250, rarity: 'rare' },
                { name: '银甲', defense: 12, hp: 30, mp: 10, critRate: 2, price: 500, rarity: 'epic' },
                { name: '龙鳞甲', defense: 20, hp: 50, mp: 20, critRate: 4, critDamage: 15, price: 1200, rarity: 'legendary' },
                { name: '法师长袍', defense: 6, hp: 15, mp: 40, magicPower: 25, price: 300, rarity: 'rare', class: 'mage' },
                { name: '道士袍', defense: 8, hp: 25, mp: 30, magicPower: 15, price: 280, rarity: 'rare', class: 'taoist' },
                // 神话品质防具
                { name: '天神战甲', defense: 35, hp: 100, mp: 50, critRate: 8, critDamage: 25, price: 4500, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔甲', defense: 40, hp: 120, mp: 40, vampiric: 10, damageReduction: 15, price: 5000, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法袍', defense: 25, hp: 80, mp: 150, magicPower: 60, spellVamp: 20, price: 4800, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道袍', defense: 30, hp: 100, mp: 120, magicPower: 45, healBonus: 30, price: 4600, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质防具
                { name: '混沌战甲', defense: 60, hp: 200, mp: 80, critRate: 15, chaosShield: 25, price: 12000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法袍', defense: 45, hp: 150, mp: 250, magicPower: 100, voidShield: 30, price: 11000, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质防具
                { name: '龙神战甲', defense: 100, hp: 400, mp: 150, critRate: 25, dragonShield: 40, price: 25000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣甲', defense: 80, hp: 350, mp: 200, holyShield: 50, price: 27000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限战甲', defense: 120, hp: 500, mp: 250, infiniteShield: 60, price: 40000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神袍', defense: 70, hp: 300, mp: 400, magicPower: 150, creationShield: 70, price: 38000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            helmets: [
                { name: '布帽', defense: 1, hp: 0, mp: 0, price: 20, rarity: 'common' },
                { name: '皮帽', defense: 3, hp: 5, mp: 0, price: 80, rarity: 'common' },
                { name: '铁盔', defense: 6, hp: 15, mp: 0, critRate: 1, price: 200, rarity: 'rare' },
                { name: '银盔', defense: 10, hp: 25, mp: 8, critRate: 2, price: 400, rarity: 'epic' },
                { name: '龙鳞盔', defense: 15, hp: 40, mp: 15, critRate: 3, critDamage: 10, price: 1000, rarity: 'legendary' },
                { name: '法师帽', defense: 4, hp: 10, mp: 30, magicPower: 20, price: 250, rarity: 'rare', class: 'mage' },
                { name: '道士冠', defense: 6, hp: 20, mp: 25, magicPower: 12, price: 230, rarity: 'rare', class: 'taoist' },
                // 神话品质头盔
                { name: '天神头盔', defense: 25, hp: 80, mp: 40, critRate: 6, critDamage: 20, price: 3500, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔盔', defense: 30, hp: 100, mp: 30, vampiric: 8, damageReduction: 12, price: 4000, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法冠', defense: 20, hp: 60, mp: 120, magicPower: 50, spellVamp: 15, price: 3800, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道冠', defense: 25, hp: 80, mp: 100, magicPower: 35, healBonus: 25, price: 3600, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质头盔
                { name: '混沌头盔', defense: 45, hp: 150, mp: 60, critRate: 12, chaosShield: 20, price: 10000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法冠', defense: 35, hp: 120, mp: 200, magicPower: 80, voidShield: 25, price: 9000, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质头盔
                { name: '龙神头盔', defense: 80, hp: 320, mp: 120, critRate: 20, dragonShield: 30, price: 20000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣盔', defense: 65, hp: 280, mp: 160, holyShield: 40, price: 22000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限头盔', defense: 100, hp: 400, mp: 200, infiniteShield: 50, price: 32000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神冠', defense: 55, hp: 240, mp: 320, magicPower: 120, creationShield: 60, price: 30000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            boots: [
                { name: '布鞋', defense: 1, hp: 0, mp: 0, price: 15, rarity: 'common' },
                { name: '皮靴', defense: 2, hp: 5, mp: 0, price: 60, rarity: 'common' },
                { name: '铁靴', defense: 5, hp: 10, mp: 0, critRate: 1, price: 150, rarity: 'rare' },
                { name: '银靴', defense: 8, hp: 20, mp: 5, critRate: 2, price: 300, rarity: 'epic' },
                { name: '龙鳞靴', defense: 12, hp: 30, mp: 10, critRate: 3, critDamage: 8, price: 800, rarity: 'legendary' },
                { name: '法师靴', defense: 3, hp: 8, mp: 20, magicPower: 15, price: 200, rarity: 'rare', class: 'mage' },
                { name: '道士靴', defense: 4, hp: 15, mp: 15, magicPower: 10, price: 180, rarity: 'rare', class: 'taoist' },
                // 神话品质鞋子
                { name: '天神战靴', defense: 20, hp: 60, mp: 30, critRate: 5, critDamage: 15, price: 2800, rarity: 'mythic', setName: '天神套装' },
                { name: '深渊魔靴', defense: 25, hp: 80, mp: 25, vampiric: 6, damageReduction: 10, price: 3200, rarity: 'mythic', setName: '深渊套装' },
                { name: '创世法靴', defense: 15, hp: 50, mp: 80, magicPower: 40, spellVamp: 12, price: 3000, rarity: 'mythic', class: 'mage', setName: '创世套装' },
                { name: '永恒道靴', defense: 18, hp: 60, mp: 70, magicPower: 30, healBonus: 20, price: 2900, rarity: 'mythic', class: 'taoist', setName: '永恒套装' },
                // 至尊品质鞋子
                { name: '混沌战靴', defense: 35, hp: 120, mp: 50, critRate: 10, chaosShield: 15, price: 8000, rarity: 'supreme', setName: '混沌套装' },
                { name: '虚空法靴', defense: 28, hp: 100, mp: 150, magicPower: 60, voidShield: 20, price: 7500, rarity: 'supreme', class: 'mage', setName: '虚空套装' },
                // 超神品质鞋子
                { name: '龙神战靴', defense: 60, hp: 250, mp: 100, critRate: 15, dragonShield: 25, price: 16000, rarity: 'transcendent', setName: '龙神套装' },
                { name: '神域圣靴', defense: 50, hp: 220, mp: 120, holyShield: 30, price: 18000, rarity: 'transcendent', setName: '神域套装' },
                { name: '无限战靴', defense: 80, hp: 320, mp: 150, infiniteShield: 40, price: 25000, rarity: 'transcendent', setName: '无限套装' },
                { name: '创世神靴', defense: 40, hp: 200, mp: 250, magicPower: 100, creationShield: 50, price: 24000, rarity: 'transcendent', class: 'mage', setName: '创世神套装' }
            ],
            accessories: [
                { name: '力量戒指', attack: [2, 5], critRate: 3, price: 200, rarity: 'rare', type: 'ring' },
                { name: '敏捷戒指', critRate: 5, critDamage: 10, price: 250, rarity: 'rare', type: 'ring' },
                { name: '智慧戒指', mp: 20, magicPower: 15, price: 220, rarity: 'rare', type: 'ring' },
                { name: '生命项链', hp: 40, defense: 3, price: 300, rarity: 'epic', type: 'necklace' },
                { name: '暴击项链', critRate: 8, critDamage: 20, price: 400, rarity: 'epic', type: 'necklace' },
                // 神话品质饰品
                { name: '天神之戒', attack: [15, 25], critRate: 10, critDamage: 30, hp: 40, price: 3500, rarity: 'mythic', type: 'ring', setName: '天神套装' },
                { name: '天神项链', defense: 10, hp: 60, mp: 30, critRate: 8, price: 3800, rarity: 'mythic', type: 'necklace', setName: '天神套装' },
                { name: '深渊魔戒', attack: [18, 30], vampiric: 12, shadowStrike: 15, hp: 35, price: 4000, rarity: 'mythic', type: 'ring', setName: '深渊套装' },
                { name: '深渊项链', defense: 8, hp: 50, vampiric: 10, damageReduction: 10, price: 4200, rarity: 'mythic', type: 'necklace', setName: '深渊套装' },
                { name: '创世法环', attack: [12, 20], mp: 60, magicPower: 40, spellCrit: 20, price: 3800, rarity: 'mythic', type: 'ring', class: 'mage', setName: '创世套装' },
                { name: '创世项链', defense: 6, mp: 80, magicPower: 35, spellVamp: 15, price: 4000, rarity: 'mythic', type: 'necklace', class: 'mage', setName: '创世套装' },
                { name: '永恒符印', attack: [14, 22], hp: 30, mp: 40, healPower: 35, price: 3600, rarity: 'mythic', type: 'ring', class: 'taoist', setName: '永恒套装' },
                { name: '永恒项链', defense: 8, hp: 45, mp: 50, healBonus: 25, price: 3900, rarity: 'mythic', type: 'necklace', class: 'taoist', setName: '永恒套装' },
                // 至尊品质饰品
                { name: '混沌之环', attack: [25, 40], critRate: 20, chaosBonus: 30, hp: 60, price: 10000, rarity: 'supreme', type: 'ring', setName: '混沌套装' },
                { name: '混沌项链', defense: 15, hp: 80, chaosShield: 20, price: 10500, rarity: 'supreme', type: 'necklace', setName: '混沌套装' },
                { name: '虚空法印', attack: [20, 35], mp: 100, magicPower: 70, voidMastery: 40, price: 9500, rarity: 'supreme', type: 'ring', class: 'mage', setName: '虚空套装' },
                { name: '虚空项链', defense: 12, mp: 120, voidShield: 25, price: 10000, rarity: 'supreme', type: 'necklace', class: 'mage', setName: '虚空套装' },
                // 超神品质饰品
                { name: '龙神之戒', attack: [40, 70], critRate: 30, dragonPower: 50, hp: 120, price: 20000, rarity: 'transcendent', type: 'ring', setName: '龙神套装' },
                { name: '龙神项链', defense: 25, hp: 150, dragonShield: 35, price: 22000, rarity: 'transcendent', type: 'necklace', setName: '龙神套装' },
                { name: '神域圣环', attack: [35, 60], critRate: 35, holyPower: 60, hp: 100, price: 21000, rarity: 'transcendent', type: 'ring', setName: '神域套装' },
                { name: '神域项链', defense: 20, hp: 130, holyShield: 40, price: 23000, rarity: 'transcendent', type: 'necklace', setName: '神域套装' },
                { name: '无限法印', attack: [50, 90], critRate: 40, infinitePower: 80, hp: 200, price: 35000, rarity: 'transcendent', type: 'ring', setName: '无限套装' },
                { name: '无限项链', defense: 30, hp: 250, infiniteShield: 50, price: 37000, rarity: 'transcendent', type: 'necklace', setName: '无限套装' },
                { name: '创世神印', attack: [30, 55], mp: 200, magicPower: 120, creationPower: 100, price: 33000, rarity: 'transcendent', type: 'ring', class: 'mage', setName: '创世神套装' },
                { name: '创世项链', defense: 18, mp: 250, creationShield: 60, price: 35000, rarity: 'transcendent', type: 'necklace', class: 'mage', setName: '创世神套装' }
            ],
            potions: [
                { name: '小血瓶', type: 'hp', heal: 50, price: 20, rarity: 'common' },
                { name: '中血瓶', type: 'hp', heal: 100, price: 50, rarity: 'common' },
                { name: '大血瓶', type: 'hp', heal: 200, price: 120, rarity: 'rare' },
                { name: '小蓝瓶', type: 'mp', heal: 30, price: 15, rarity: 'common' },
                { name: '中蓝瓶', type: 'mp', heal: 60, price: 40, rarity: 'common' },
                { name: '大蓝瓶', type: 'mp', heal: 120, price: 100, rarity: 'rare' }
            ],
            materials: [
                { name: '铁矿石', rarity: 'common', price: 10, description: '基础合成材料' },
                { name: '银矿石', rarity: 'rare', price: 30, description: '稀有合成材料' },
                { name: '黄金矿石', rarity: 'epic', price: 80, description: '史诗合成材料' },
                { name: '龙鳞片', rarity: 'legendary', price: 200, description: '传说合成材料' },
                { name: '魔法水晶', rarity: 'rare', price: 50, description: '魔法装备合成材料' },
                { name: '暗影精华', rarity: 'epic', price: 120, description: '高级合成材料' },
                { name: '神圣宝石', rarity: 'legendary', price: 300, description: '顶级合成材料' },
                // 超神品质合成材料
                { name: '龙之精华', rarity: 'transcendent', price: 800, description: '龙族力量的结晶' },
                { name: '圣光水晶', rarity: 'transcendent', price: 900, description: '神圣力量的载体' },
                { name: '天使之羽', rarity: 'transcendent', price: 1200, description: '天使遗留的神圣羽毛' },
                { name: '无限水晶', rarity: 'transcendent', price: 1500, description: '蕴含无限力量的水晶' },
                { name: '时空碎片', rarity: 'transcendent', price: 2000, description: '时空裂缝中的神秘碎片' },
                { name: '创世水晶', rarity: 'transcendent', price: 1800, description: '创世之力的凝聚' },
                { name: '混沌之心', rarity: 'transcendent', price: 2500, description: '混沌力量的核心' }
            ],
            specialEquipment: [
                // 初级四格装备
                { name: '力量护符', type: 'special', tier: 1, percentDamage: 10, price: 500, rarity: 'rare', description: '增加10%伤害' },
                { name: '生命护符', type: 'special', tier: 1, percentHp: 15, price: 500, rarity: 'rare', description: '增加15%生命值' },
                { name: '攻击护符', type: 'special', tier: 1, percentAttack: 12, price: 500, rarity: 'rare', description: '增加12%攻击力' },
                // 中级四格装备
                { name: '强化力量护符', type: 'special', tier: 2, percentDamage: 20, price: 1200, rarity: 'epic', description: '增加20%伤害' },
                { name: '强化生命护符', type: 'special', tier: 2, percentHp: 25, price: 1200, rarity: 'epic', description: '增加25%生命值' },
                { name: '强化攻击护符', type: 'special', tier: 2, percentAttack: 22, price: 1200, rarity: 'epic', description: '增加22%攻击力' },
                // 高级四格装备
                { name: '神力护符', type: 'special', tier: 3, percentDamage: 35, divineMultiplier: 2, price: 3000, rarity: 'legendary', description: '增加35%伤害，神力倍攻x2' },
                { name: '永恒护符', type: 'special', tier: 3, percentHp: 40, percentAttack: 30, price: 3000, rarity: 'legendary', description: '增加40%生命值，30%攻击力' },
                // 超神品质特殊装备
                { name: '龙神护符', type: 'special', tier: 4, percentDamage: 60, percentHp: 50, dragonPower: 100, divineMultiplier: 3, price: 8000, rarity: 'transcendent', description: '增加60%伤害，50%生命值，龙神之力+100，神力倍攻x3' },
                { name: '神域圣符', type: 'special', tier: 4, percentAttack: 55, percentHp: 45, holyPower: 120, divineMultiplier: 3, price: 8500, rarity: 'transcendent', description: '增加55%攻击力，45%生命值，神圣之力+120，神力倍攻x3' },
                { name: '无限符印', type: 'special', tier: 4, percentDamage: 80, percentAttack: 60, infinitePower: 150, divineMultiplier: 4, price: 15000, rarity: 'transcendent', description: '增加80%伤害，60%攻击力，无限之力+150，神力倍攻x4' },
                { name: '创世神符', type: 'special', tier: 4, percentDamage: 70, percentMp: 80, magicPower: 200, creationPower: 180, divineMultiplier: 4, price: 14000, rarity: 'transcendent', description: '增加70%伤害，80%魔法值，法术强度+200，创世之力+180，神力倍攻x4' }
            ]
        };

        // 合成配方
        const craftingRecipes = {
            // 初级四格装备合成
            '力量护符': {
                materials: [{ name: '铁矿石', count: 5 }, { name: '魔法水晶', count: 2 }],
                gold: 200,
                result: '力量护符'
            },
            '生命护符': {
                materials: [{ name: '铁矿石', count: 4 }, { name: '银矿石', count: 2 }],
                gold: 200,
                result: '生命护符'
            },
            '攻击护符': {
                materials: [{ name: '银矿石', count: 3 }, { name: '魔法水晶', count: 1 }],
                gold: 200,
                result: '攻击护符'
            },
            // 中级四格装备合成
            '强化力量护符': {
                materials: [{ name: '力量护符', count: 1 }, { name: '黄金矿石', count: 3 }, { name: '暗影精华', count: 1 }],
                gold: 500,
                result: '强化力量护符'
            },
            '强化生命护符': {
                materials: [{ name: '生命护符', count: 1 }, { name: '黄金矿石', count: 3 }, { name: '魔法水晶', count: 2 }],
                gold: 500,
                result: '强化生命护符'
            },
            '强化攻击护符': {
                materials: [{ name: '攻击护符', count: 1 }, { name: '银矿石', count: 5 }, { name: '暗影精华', count: 1 }],
                gold: 500,
                result: '强化攻击护符'
            },
            // 高级四格装备合成
            '神力护符': {
                materials: [{ name: '强化力量护符', count: 1 }, { name: '强化攻击护符', count: 1 }, { name: '神圣宝石', count: 2 }, { name: '龙鳞片', count: 3 }],
                gold: 1500,
                result: '神力护符'
            },
            '永恒护符': {
                materials: [{ name: '强化生命护符', count: 1 }, { name: '强化攻击护符', count: 1 }, { name: '神圣宝石', count: 3 }, { name: '暗影精华', count: 2 }],
                gold: 1500,
                result: '永恒护符'
            },
            // 超神品质特殊装备合成
            '龙神护符': {
                materials: [{ name: '神力护符', count: 1 }, { name: '永恒护符', count: 1 }, { name: '神圣宝石', count: 8 }, { name: '龙鳞片', count: 10 }, { name: '龙之精华', count: 5 }],
                gold: 5000,
                result: '龙神护符'
            },
            '神域圣符': {
                materials: [{ name: '神力护符', count: 1 }, { name: '永恒护符', count: 1 }, { name: '神圣宝石', count: 10 }, { name: '圣光水晶', count: 8 }, { name: '天使之羽', count: 3 }],
                gold: 5500,
                result: '神域圣符'
            },
            '无限符印': {
                materials: [{ name: '龙神护符', count: 1 }, { name: '神域圣符', count: 1 }, { name: '神圣宝石', count: 15 }, { name: '无限水晶', count: 10 }, { name: '时空碎片', count: 5 }],
                gold: 10000,
                result: '无限符印'
            },
            '创世神符': {
                materials: [{ name: '龙神护符', count: 1 }, { name: '神域圣符', count: 1 }, { name: '神圣宝石', count: 12 }, { name: '创世水晶', count: 8 }, { name: '混沌之心', count: 3 }],
                gold: 9500,
                result: '创世神符'
            },
            // 神话品质装备合成
            '天神之剑': {
                materials: [{ name: '屠龙刀', count: 1 }, { name: '神圣宝石', count: 5 }, { name: '龙鳞片', count: 8 }],
                gold: 3000,
                result: '天神之剑'
            },
            '深渊魔刃': {
                materials: [{ name: '屠龙刀', count: 1 }, { name: '暗影精华', count: 10 }, { name: '神圣宝石', count: 3 }],
                gold: 3200,
                result: '深渊魔刃'
            },
            '创世法杖': {
                materials: [{ name: '法师之杖', count: 1 }, { name: '魔法水晶', count: 15 }, { name: '神圣宝石', count: 4 }],
                gold: 3100,
                result: '创世法杖'
            },
            '永恒道杖': {
                materials: [{ name: '法师之杖', count: 1 }, { name: '神圣宝石', count: 4 }, { name: '龙鳞片', count: 6 }],
                gold: 3000,
                result: '永恒道杖'
            },
            '天神战甲': {
                materials: [{ name: '钢铁战甲', count: 1 }, { name: '神圣宝石', count: 4 }, { name: '龙鳞片', count: 10 }],
                gold: 2800,
                result: '天神战甲'
            },
            '深渊魔甲': {
                materials: [{ name: '钢铁战甲', count: 1 }, { name: '暗影精华', count: 12 }, { name: '神圣宝石', count: 3 }],
                gold: 3000,
                result: '深渊魔甲'
            },
            '创世法袍': {
                materials: [{ name: '法师长袍', count: 1 }, { name: '魔法水晶', count: 12 }, { name: '神圣宝石', count: 3 }],
                gold: 2900,
                result: '创世法袍'
            },
            '永恒道袍': {
                materials: [{ name: '法师长袍', count: 1 }, { name: '神圣宝石', count: 3 }, { name: '龙鳞片', count: 8 }],
                gold: 2800,
                result: '永恒道袍'
            },
            // 至尊品质装备合成
            '混沌之刃': {
                materials: [{ name: '天神之剑', count: 1 }, { name: '深渊魔刃', count: 1 }, { name: '神圣宝石', count: 15 }],
                gold: 8000,
                result: '混沌之刃'
            },
            '虚空法杖': {
                materials: [{ name: '创世法杖', count: 1 }, { name: '永恒道杖', count: 1 }, { name: '神圣宝石', count: 12 }],
                gold: 7500,
                result: '虚空法杖'
            },
            '混沌战甲': {
                materials: [{ name: '天神战甲', count: 1 }, { name: '深渊魔甲', count: 1 }, { name: '神圣宝石', count: 10 }],
                gold: 7000,
                result: '混沌战甲'
            },
            '虚空法袍': {
                materials: [{ name: '创世法袍', count: 1 }, { name: '永恒道袍', count: 1 }, { name: '神圣宝石', count: 8 }],
                gold: 6500,
                result: '虚空法袍'
            }
        };

        // 创建角色
        function createCharacter(className) {
            const classConfig = classes[className];
            gameState.player.class = className;
            gameState.player.hp = classConfig.hp;
            gameState.player.maxHp = classConfig.hp;
            gameState.player.mp = classConfig.mp;
            gameState.player.maxMp = classConfig.mp;
            gameState.player.attack = [...classConfig.attack];
            gameState.player.defense = classConfig.defense;
            
            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');
            
            updateUI();
            addLog(`你选择了${classConfig.name}职业，开始你的传奇之旅！`);
        }

        // 更新UI
        function updateUI() {
            const player = gameState.player;
            
            document.getElementById('playerClass').textContent = classes[player.class].name;
            document.getElementById('playerLevel').textContent = player.level;
            document.getElementById('playerGold').textContent = player.gold;
            
            // 计算特殊装备的百分比生命值加成
            const specialBonus = calculateSpecialEquipmentBonus();
            // 计算套装效果
            const setBonus = calculateSetBonus();
            
            // 应用套装和特殊装备生命值、魔法值加成
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            // 确保当前血量和魔法值不超过最大值
            if (player.hp > totalMaxHp) {
                player.hp = totalMaxHp;
            }
            if (player.mp > totalMaxMp) {
                player.mp = totalMaxMp;
            }
            
            // 更新血量条
            const hpPercent = (player.hp / totalMaxHp) * 100;
            document.getElementById('hpBar').style.width = hpPercent + '%';
            document.getElementById('hpText').textContent = `${player.hp}/${totalMaxHp}`;
            
            // 更新魔法条
            const mpPercent = (player.mp / totalMaxMp) * 100;
            document.getElementById('mpBar').style.width = mpPercent + '%';
            document.getElementById('mpText').textContent = `${player.mp}/${totalMaxMp}`;
            
            // 更新经验条
            const expPercent = (player.exp / player.maxExp) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
            document.getElementById('expText').textContent = `${player.exp}/${player.maxExp}`;
            
            // 更新装备
            updateEquipmentDisplay();
            updateInventoryDisplay();
            
            // 更新养成系统显示
            updateCultivationDisplay();
            
            // 显示套装效果
            updateSetBonusDisplay(setBonus);
        }
        
        // 更新套装效果显示
        function updateSetBonusDisplay(setBonus) {
            const setBonusPanel = document.getElementById('setBonusPanel');
            const setBonusContent = document.getElementById('setBonusContent');
            
            // 重新统计激活的套装
            const player = gameState.player;
            const setCount = {};
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.setName) {
                    setCount[item.setName] = (setCount[item.setName] || 0) + 1;
                }
            });
            
            const activeSets = {};
            Object.keys(setCount).forEach(setName => {
                const count = setCount[setName];
                if (count > 0) {
                    activeSets[setName] = count;
                }
            });
            
            // 如果没有激活的套装，隐藏面板
            if (Object.keys(activeSets).length === 0) {
                setBonusPanel.classList.add('hidden');
                return;
            }
            
            // 显示面板
            setBonusPanel.classList.remove('hidden');
            setBonusContent.innerHTML = '';
            
            // 为每个激活的套装创建显示
            Object.keys(activeSets).forEach(setName => {
                const count = activeSets[setName];
                const setDiv = document.createElement('div');
                setDiv.className = 'set-item';
                
                // 根据套装名称设置效果描述
                let setInfo = {
                    name: setName,
                    count: count,
                    twoSetBonus: '',
                    fourSetBonus: ''
                };
                
                if (setName === '天神套装') {
                    setInfo.twoSetBonus = '攻击力+20，防御力+15';
                    setInfo.fourSetBonus = '生命值+100，神圣之力：攻击力+30';
                } else if (setName === '深渊套装') {
                    setInfo.twoSetBonus = '攻击力+25，吸血+15%';
                    setInfo.fourSetBonus = '伤害减免+20%，暴击率+15%';
                } else if (setName === '创世套装') {
                    setInfo.twoSetBonus = '法术强度+40，魔法值+80';
                    setInfo.fourSetBonus = '法术暴击+20%，创世之力：法术强度+50';
                } else if (setName === '永恒套装') {
                    setInfo.twoSetBonus = '生命值+120，吸血+20%';
                    setInfo.fourSetBonus = '永恒重生：生命值+120，吸血+20%';
                } else if (setName === '混沌套装') {
                    setInfo.twoSetBonus = '攻击力+40，暴击率+20%';
                    setInfo.fourSetBonus = '暴击伤害+50%，伤害减免+25%';
                } else if (setName === '虚空套装') {
                    setInfo.twoSetBonus = '法术强度+60，法术暴击+25%';
                    setInfo.fourSetBonus = '虚空掌控+30%，法术吸血+25%';
                } else if (setName === '龙神套装') {
                    setInfo.twoSetBonus = '攻击力+80，暴击率+30%';
                    setInfo.fourSetBonus = '暴击伤害+100%，生命值+300';
                } else if (setName === '神域套装') {
                    setInfo.twoSetBonus = '防御力+50，生命值+250';
                    setInfo.fourSetBonus = '暴击率+35%，伤害减免+40%';
                } else if (setName === '无限套装') {
                    setInfo.twoSetBonus = '攻击力+120，生命值+400';
                    setInfo.fourSetBonus = '暴击率+50%，暴击伤害+150%';
                } else if (setName === '创世神套装') {
                    setInfo.twoSetBonus = '法术强度+150，魔法值+300';
                    setInfo.fourSetBonus = '暴击率+60%，法术强度+200';
                }
                
                let bonusText = `<div class="set-name">${setInfo.name}</div>`;
                bonusText += `<div class="set-count">(${setInfo.count}/4)</div>`;
                
                if (setInfo.count >= 2) {
                    bonusText += `<div class="set-effect">✓ 2件套: ${setInfo.twoSetBonus}</div>`;
                }
                
                if (setInfo.count >= 4) {
                    bonusText += `<div class="set-effect">✓ 4件套: ${setInfo.fourSetBonus}</div>`;
                } else if (setInfo.count >= 2) {
                    bonusText += `<div class="set-next">○ 4件套: ${setInfo.fourSetBonus}</div>`;
                }
                
                if (setInfo.count < 2) {
                    bonusText += `<div class="set-next">○ 2件套: ${setInfo.twoSetBonus}</div>`;
                }
                
                setDiv.innerHTML = bonusText;
                setBonusContent.appendChild(setDiv);
            });
        }

        // 更新装备显示
        function updateEquipmentDisplay() {
            const equipment = gameState.player.equipment;
            
            // 更新装备显示并添加卸下功能
            const equipmentSlots = [
                { id: 'weapon', key: 'weapon', name: '武器' },
                { id: 'helmet', key: 'helmet', name: '头盔' },
                { id: 'armor', key: 'armor', name: '护甲' },
                { id: 'boots', key: 'boots', name: '靴子' },
                { id: 'ring', key: 'ring', name: '戒指' },
                { id: 'necklace', key: 'necklace', name: '项链' },
                { id: 'special1', key: 'special1', name: '护符1' },
                { id: 'special2', key: 'special2', name: '护符2' },
                { id: 'special3', key: 'special3', name: '护符3' },
                { id: 'special4', key: 'special4', name: '护符4' }
            ];
            
            equipmentSlots.forEach(slot => {
                const element = document.getElementById(slot.id);
                const item = equipment[slot.key];
                
                if (item) {
                    // 创建装备名称的HTML，包含稀有度颜色和套装信息
                    let equipmentHTML = `<span class="item-${item.rarity}">${item.name}</span>`;
                    if (item.setName) {
                        equipmentHTML += `<br><span class="set-bonus-text text-xs">[${item.setName}]</span>`;
                    }
                    
                    element.innerHTML = equipmentHTML;
                    element.style.cursor = 'pointer';
                    element.title = `点击卸下${slot.name}`;
                    
                    // 移除之前的事件监听器
                    element.onclick = null;
                    
                    // 添加卸下装备的点击事件
                    element.onclick = () => unequipItem(slot.key, slot.name);
                } else {
                    element.innerHTML = '无';
                    element.style.cursor = 'default';
                    element.style.color = '#9ca3af'; // 灰色
                    element.title = '';
                    element.onclick = null;
                }
            });
        }
        
        // 卸下装备函数
        function unequipItem(slotKey, slotName) {
            const equipment = gameState.player.equipment;
            const item = equipment[slotKey];
            
            if (!item) {
                addLog(`${slotName}槽位没有装备`);
                return;
            }
            
            // 检查背包是否有空间
            if (gameState.player.inventory.length >= 50) {
                addLog('背包已满，无法卸下装备');
                return;
            }
            
            // 将装备放回背包
            gameState.player.inventory.push(item);
            equipment[slotKey] = null;
            
            addLog(`卸下了${item.name}`);
            
            // 更新UI
            updateUI();
            
            // 显示浮动文本
            showFloatingText(`卸下 ${item.name}`, '#60a5fa');
        }

        // 更新背包显示
        function updateInventoryDisplay() {
            const inventory = document.getElementById('inventory');
            inventory.innerHTML = '';
            
            // 显示普通物品
            gameState.player.inventory.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700 item-${item.rarity}`;
                itemDiv.innerHTML = `
                    <div class="text-sm font-bold">${item.name}</div>
                    <div class="text-xs text-gray-400">${getItemDescription(item)}</div>
                `;
                itemDiv.onclick = () => useItem(index);
                inventory.appendChild(itemDiv);
            });
            
            // 显示材料
            gameState.player.materials.forEach((material, index) => {
                const materialDiv = document.createElement('div');
                materialDiv.className = 'p-2 bg-blue-800 rounded border border-blue-600';
                materialDiv.innerHTML = `
                    <div class="text-sm font-bold text-blue-200">${material.name}</div>
                    <div class="text-xs text-blue-300">数量: ${material.count}</div>
                    <div class="text-xs text-gray-400">${material.description || '养成材料'}</div>
                `;
                inventory.appendChild(materialDiv);
            });
        }

        // 获取物品描述
        function getItemDescription(item) {
            let desc = [];
            
            if (item.attack && !item.type) {
                desc.push(`攻击: ${item.attack[0]}-${item.attack[1]}`);
                if (item.defense) desc.push(`防御: ${item.defense}`);
                if (item.hp) desc.push(`生命: +${item.hp}`);
                if (item.mp) desc.push(`魔法: +${item.mp}`);
                if (item.critRate) desc.push(`暴击率: +${item.critRate}%`);
                if (item.critDamage) desc.push(`暴击伤害: +${item.critDamage}%`);
                if (item.magicPower) desc.push(`法术强度: +${item.magicPower}`);
                if (item.vampiric) desc.push(`吸血: +${item.vampiric}%`);
                if (item.healBonus) desc.push(`治疗加成: +${item.healBonus}%`);
                if (item.chaosStrike) desc.push(`混沌打击: +${item.chaosStrike}%`);
                if (item.voidPower) desc.push(`虚空之力: +${item.voidPower}%`);
            } else if (item.defense && !item.type) {
                desc.push(`防御: ${item.defense}`);
                if (item.hp) desc.push(`生命: +${item.hp}`);
                if (item.mp) desc.push(`魔法: +${item.mp}`);
                if (item.critRate) desc.push(`暴击率: +${item.critRate}%`);
                if (item.critDamage) desc.push(`暴击伤害: +${item.critDamage}%`);
                if (item.magicPower) desc.push(`法术强度: +${item.magicPower}`);
                if (item.vampiric) desc.push(`吸血: +${item.vampiric}%`);
                if (item.damageReduction) desc.push(`伤害减免: +${item.damageReduction}%`);
                if (item.spellVamp) desc.push(`法术吸血: +${item.spellVamp}%`);
                if (item.healBonus) desc.push(`治疗加成: +${item.healBonus}%`);
                if (item.chaosShield) desc.push(`混沌护盾: +${item.chaosShield}%`);
                if (item.voidShield) desc.push(`虚空护盾: +${item.voidShield}%`);
            } else if (item.type === 'ring' || item.type === 'necklace') {
                if (item.attack) desc.push(`攻击: ${item.attack[0]}-${item.attack[1]}`);
                if (item.defense) desc.push(`防御: ${item.defense}`);
                if (item.hp) desc.push(`生命: +${item.hp}`);
                if (item.mp) desc.push(`魔法: +${item.mp}`);
                if (item.critRate) desc.push(`暴击率: +${item.critRate}%`);
                if (item.critDamage) desc.push(`暴击伤害: +${item.critDamage}%`);
                if (item.magicPower) desc.push(`法术强度: +${item.magicPower}`);
                if (item.vampiric) desc.push(`吸血: +${item.vampiric}%`);
                if (item.shadowStrike) desc.push(`暗影打击: +${item.shadowStrike}%`);
                if (item.spellCrit) desc.push(`法术暴击: +${item.spellCrit}%`);
                if (item.healPower) desc.push(`治疗强度: +${item.healPower}%`);
                if (item.chaosBonus) desc.push(`混沌加成: +${item.chaosBonus}%`);
                if (item.voidMastery) desc.push(`虚空掌控: +${item.voidMastery}%`);
                if (item.spellVamp) desc.push(`法术吸血: +${item.spellVamp}%`);
                if (item.damageReduction) desc.push(`伤害减免: +${item.damageReduction}%`);
                if (item.voidShield) desc.push(`虚空护盾: +${item.voidShield}%`);
            } else if (item.type === 'special') {
                if (item.percentDamage) desc.push(`伤害: +${item.percentDamage}%`);
                if (item.percentHp) desc.push(`生命: +${item.percentHp}%`);
                if (item.percentAttack) desc.push(`攻击: +${item.percentAttack}%`);
                if (item.divineMultiplier) desc.push(`神力倍攻: x${item.divineMultiplier}`);
            } else if (item.type === 'hp') {
                return `恢复生命: ${item.heal}`;
            } else if (item.type === 'mp') {
                return `恢复魔法: ${item.heal}`;
            } else if (item.description) {
                return item.description;
            }
            
            let result = desc.join(', ');
            
            // 添加套装信息
            if (item.setName) {
                result += `\n<span class="set-bonus-text">[${item.setName}]</span>`;
            }
            
            return result || '';
        }

        // 使用物品
        function useItem(index) {
            const item = gameState.player.inventory[index];
            let isEquipment = false;
            
            // 优先检查type属性，避免戒指项链被误判为武器
            if (item.type === 'ring') {
                // 戒指
                if (gameState.player.equipment.ring) {
                    gameState.player.inventory.push(gameState.player.equipment.ring);
                }
                gameState.player.equipment.ring = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'necklace') {
                // 项链
                if (gameState.player.equipment.necklace) {
                    gameState.player.inventory.push(gameState.player.equipment.necklace);
                }
                gameState.player.equipment.necklace = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'helmet') {
                // 头盔
                if (gameState.player.equipment.helmet) {
                    gameState.player.inventory.push(gameState.player.equipment.helmet);
                }
                gameState.player.equipment.helmet = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'boots') {
                // 鞋子
                if (gameState.player.equipment.boots) {
                    gameState.player.inventory.push(gameState.player.equipment.boots);
                }
                gameState.player.equipment.boots = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'special') {
                // 特殊装备（护符）
                let equipped = false;
                for (let i = 1; i <= 4; i++) {
                    if (!gameState.player.equipment[`special${i}`]) {
                        gameState.player.equipment[`special${i}`] = item;
                        addLog(`装备了${item.name}到护符槽${i}`);
                        gameState.player.inventory.splice(index, 1);
                        equipped = true;
                        isEquipment = true;
                        break;
                    }
                }
                if (!equipped) {
                    addLog('特殊装备槽位已满，无法装备');
                    return;
                }
            } else if (item.attack && !item.type) {
                // 武器（没有type属性但有attack属性）
                if (gameState.player.equipment.weapon) {
                    gameState.player.inventory.push(gameState.player.equipment.weapon);
                }
                gameState.player.equipment.weapon = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.defense && !item.type) {
                // 防具（没有type属性但有defense属性）
                if (gameState.player.equipment.armor) {
                    gameState.player.inventory.push(gameState.player.equipment.armor);
                }
                gameState.player.equipment.armor = item;
                addLog(`装备了${item.name}`);
                gameState.player.inventory.splice(index, 1);
                isEquipment = true;
            } else if (item.type === 'hp') {
                // 血瓶
                const specialBonus = calculateSpecialEquipmentBonus();
                const setBonus = calculateSetBonus();
                const totalMaxHp = Math.floor(gameState.player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
                const healAmount = Math.min(item.heal, totalMaxHp - gameState.player.hp);
                gameState.player.hp += healAmount;
                addLog(`使用了${item.name}，恢复了${healAmount}点生命值`);
                gameState.player.inventory.splice(index, 1);
            } else if (item.type === 'mp') {
                // 蓝瓶
                const specialBonus = calculateSpecialEquipmentBonus();
                const setBonus = calculateSetBonus();
                const totalMaxMp = Math.floor(gameState.player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
                const healAmount = Math.min(item.heal, totalMaxMp - gameState.player.mp);
                gameState.player.mp += healAmount;
                addLog(`使用了${item.name}，恢复了${healAmount}点魔法值`);
                gameState.player.inventory.splice(index, 1);
            }
            
            // 如果装备了物品，更新任务进度
            if (isEquipment) {
                updateQuestProgress('equip', item.type);
                updateQuestProgress('equip', 'any');
                // 检查称号条件
                checkTitleConditions();
            }
            
            updateUI();
        }

        // 前往位置
        function goToLocation(location) {
            gameState.currentLocation = location;
            
            // 隐藏所有区域
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('monsterArea').classList.remove('hidden');
            
            const locationNames = {
                village: '新手村',
                forest: '森林',
                cave: '洞穴',
                desert: '沙漠',
                swamp: '沼泽',
                mountain: '雪山',
                dungeon: '地牢',
                volcano: '火山',
                abyss: '深渊',
                heaven: '天界',
                ocean: '海洋',
                glacier: '冰川',
                tomb: '古墓',
                magicforest: '魔法森林',
                starfield: '星空',
                laboratory: '实验室',
                shadowrealm: '影之领域',
                crystalcave: '水晶洞穴',
                dragonrealm: '龙之领域',
                godsdomain: '神之领域',
                chaosrealm: '混沌领域',
                voidrealm: '虚空领域',
                infiniterealm: '无限领域',
                shop: '商店'
            };
            
            document.getElementById('currentLocation').textContent = locationNames[location];
            
            if (location === 'shop') {
                showShop();
            } else {
                generateMonsters(location);
            }
            
            addLog(`你来到了${locationNames[location]}`);
        }

        // 生成怪物
        function generateMonsters(location) {
            const monsterList = document.getElementById('monsterList');
            monsterList.innerHTML = '';
            
            if (monsters[location]) {
                monsters[location].forEach(monsterTemplate => {
                    let spawnChance = 0.7; // 默认70%概率
                    
                    // 根据怪物类型调整出现概率
                    if (monsterTemplate.type === 'elite') {
                        spawnChance = 0.15; // 精英怪物15%概率
                    } else if (monsterTemplate.type === 'boss') {
                        spawnChance = 0.05; // Boss怪物5%概率
                    }
                    
                    if (Math.random() < spawnChance) {
                        const monsterDiv = document.createElement('div');
                        monsterDiv.className = 'monster-card p-3 rounded cursor-pointer';
                        
                        // 为Boss和精英怪物添加特殊样式
                        if (monsterTemplate.type === 'boss') {
                            monsterDiv.classList.add('boss-monster');
                        } else if (monsterTemplate.type === 'elite') {
                            monsterDiv.classList.add('elite-monster');
                        }
                        
                        monsterDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-white">${monsterTemplate.name}</div>
                                    <div class="text-sm text-gray-300">等级: ${monsterTemplate.level}</div>
                                    <div class="text-sm text-gray-300">生命: ${monsterTemplate.hp}</div>
                                    ${monsterTemplate.type === 'boss' ? '<div class="text-sm text-red-400">👑 Boss</div>' : ''}
                                    ${monsterTemplate.type === 'elite' ? '<div class="text-sm text-yellow-400">⭐ 精英</div>' : ''}
                                </div>
                                <button class="btn-primary px-3 py-1 rounded text-sm">攻击</button>
                            </div>
                        `;
                        monsterDiv.onclick = () => startBattle(monsterTemplate);
                        monsterList.appendChild(monsterDiv);
                    }
                });
            }
            
            if (monsterList.children.length === 0) {
                monsterList.innerHTML = '<div class="text-gray-400 text-center py-4">这里很安全，没有怪物</div>';
            }
        }

        // 开始战斗
        function startBattle(monsterTemplate) {
            gameState.inBattle = true;
            gameState.currentMonster = {
                ...monsterTemplate,
                maxHp: monsterTemplate.hp
            };
            
            // 重置自动战斗状态
            gameState.autoBattle = false;
            if (gameState.battleInterval) {
                clearTimeout(gameState.battleInterval);
                gameState.battleInterval = null;
            }
            
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('battleArea').classList.remove('hidden');
            
            // 重置自动战斗按钮
            document.getElementById('autoBattleBtn').textContent = '开始自动战斗';
            document.getElementById('autoBattleBtn').className = 'btn-primary px-6 py-2 rounded mr-2';
            
            updateBattleUI();
            addLog(`遭遇了${monsterTemplate.name}！战斗开始！`);
        }

        // 更新战斗UI
        function updateBattleUI() {
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            document.getElementById('battlePlayerHp').textContent = `${player.hp}/${player.maxHp}`;
            document.getElementById('battlePlayerMp').textContent = `${player.mp}/${player.maxMp}`;
            document.getElementById('battleMonsterName').textContent = monster.name;
            document.getElementById('battleMonsterHp').textContent = `${monster.hp}/${monster.maxHp}`;
            
            // 更新玩家小人图标
            const playerFighter = document.getElementById('playerFighter');
            if (player.class === 'warrior') {
                playerFighter.textContent = '⚔️';
            } else if (player.class === 'mage') {
                playerFighter.textContent = '🧙‍♂️';
            } else if (player.class === 'taoist') {
                playerFighter.textContent = '🧙‍♀️';
            }
            
            // 更新怪物小人图标
            const monsterFighter = document.getElementById('monsterFighter');
            switch(monster.name) {
                case '小鸡':
                    monsterFighter.textContent = '🐔';
                    break;
                case '小鹿':
                    monsterFighter.textContent = '🦌';
                    break;
                case '史莱姆':
                    monsterFighter.textContent = '🟢';
                    break;
                case '哥布林':
                    monsterFighter.textContent = '👺';
                    break;
                case '森林狼':
                    monsterFighter.textContent = '🐺';
                    break;
                case '野猪':
                    monsterFighter.textContent = '🐗';
                    break;
                case '骷髅':
                    monsterFighter.textContent = '💀';
                    break;
                case '僵尸':
                    monsterFighter.textContent = '🧟';
                    break;
                case '沙漠蝎':
                    monsterFighter.textContent = '🦂';
                    break;
                case '沙虫':
                    monsterFighter.textContent = '🪱';
                    break;
                case '恶魔':
                    monsterFighter.textContent = '👹';
                    break;
                case '龙':
                    monsterFighter.textContent = '🐉';
                    break;
                case '雪狼':
                    monsterFighter.textContent = '🐺';
                    break;
                case '冰霜巨人':
                    monsterFighter.textContent = '🧊';
                    break;
                case '雪怪':
                    monsterFighter.textContent = '❄️';
                    break;
                case '毒蛇':
                    monsterFighter.textContent = '🐍';
                    break;
                case '沼泽巨鳄':
                    monsterFighter.textContent = '🐊';
                    break;
                case '腐尸怪':
                    monsterFighter.textContent = '🧟‍♂️';
                    break;
                case '火元素':
                    monsterFighter.textContent = '🔥';
                    break;
                case '熔岩兽':
                    monsterFighter.textContent = '🌋';
                    break;
                case '炎魔':
                    monsterFighter.textContent = '👹';
                    break;
                case '暗影刺客':
                    monsterFighter.textContent = '🥷';
                    break;
                case '深渊领主':
                    monsterFighter.textContent = '👺';
                    break;
                case '虚空恶魔':
                    monsterFighter.textContent = '👻';
                    break;
                case '堕落天使':
                    monsterFighter.textContent = '😈';
                    break;
                case '光明守护者':
                    monsterFighter.textContent = '👼';
                    break;
                case '天界战神':
                    monsterFighter.textContent = '⚡';
                    break;
                // 新增怪物图标
                case '海盗':
                    monsterFighter.textContent = '🏴‍☠️';
                    break;
                case '海妖':
                    monsterFighter.textContent = '🧜‍♀️';
                    break;
                case '深海巨兽':
                    monsterFighter.textContent = '🐙';
                    break;
                case '冰晶蜘蛛':
                    monsterFighter.textContent = '🕷️';
                    break;
                case '极地熊王':
                    monsterFighter.textContent = '🐻‍❄️';
                    break;
                case '冰龙':
                    monsterFighter.textContent = '🐲';
                    break;
                case '木乃伊':
                    monsterFighter.textContent = '🧟‍♂️';
                    break;
                case '法老守卫':
                    monsterFighter.textContent = '🛡️';
                    break;
                case '古代法老':
                    monsterFighter.textContent = '👑';
                    break;
                case '精灵射手':
                    monsterFighter.textContent = '🧝‍♀️';
                    break;
                case '树人长老':
                    monsterFighter.textContent = '🌳';
                    break;
                case '森林之王':
                    monsterFighter.textContent = '🦌';
                    break;
                case '星灵':
                    monsterFighter.textContent = '✨';
                    break;
                case '虚空行者':
                    monsterFighter.textContent = '🌌';
                    break;
                case '宇宙主宰':
                    monsterFighter.textContent = '🌟';
                    break;
                case '变异体':
                    monsterFighter.textContent = '🧬';
                    break;
                case '机械守卫':
                    monsterFighter.textContent = '🤖';
                    break;
                case '终极兵器':
                    monsterFighter.textContent = '⚙️';
                    break;
                case '影子武士':
                    monsterFighter.textContent = '🥷';
                    break;
                case '暗影领主':
                    monsterFighter.textContent = '👤';
                    break;
                case '黑暗之神':
                    monsterFighter.textContent = '🌑';
                    break;
                case '水晶蝙蝠':
                    monsterFighter.textContent = '🦇';
                    break;
                case '水晶巨人':
                    monsterFighter.textContent = '💎';
                    break;
                case '水晶龙王':
                    monsterFighter.textContent = '💠';
                    break;
                // Boss和精英怪物图标
                case '精英野兔':
                    monsterFighter.textContent = '🐰';
                    break;
                case '村长的宠物熊':
                    monsterFighter.textContent = '🐻';
                    break;
                case '精英狼王':
                    monsterFighter.textContent = '🐺';
                    break;
                case '森林守护者':
                    monsterFighter.textContent = '🌲';
                    break;
                case '精英骷髅战士':
                    monsterFighter.textContent = '⚔️';
                    break;
                case '亡灵领主':
                    monsterFighter.textContent = '👑';
                    break;
                case '精英沙漠毒蝎':
                    monsterFighter.textContent = '🦂';
                    break;
                case '沙漠霸主':
                    monsterFighter.textContent = '🏜️';
                    break;
                case '精英恶魔督军':
                    monsterFighter.textContent = '👺';
                    break;
                case '地牢魔王':
                    monsterFighter.textContent = '👹';
                    break;
                case '精英冰霜泰坦':
                    monsterFighter.textContent = '🧊';
                    break;
                case '雪山之王':
                    monsterFighter.textContent = '⛰️';
                    break;
                case '精英毒沼蟒':
                    monsterFighter.textContent = '🐍';
                    break;
                case '沼泽霸主':
                    monsterFighter.textContent = '🐊';
                    break;
                case '精英熔岩巨人':
                    monsterFighter.textContent = '🌋';
                    break;
                case '火山之神':
                    monsterFighter.textContent = '🔥';
                    break;
                case '精英深渊魔将':
                    monsterFighter.textContent = '👺';
                    break;
                case '深渊魔帝':
                    monsterFighter.textContent = '😈';
                    break;
                case '精英大天使':
                    monsterFighter.textContent = '👼';
                    break;
                case '天界至尊':
                    monsterFighter.textContent = '✨';
                    break;
                case '精英海盗船长':
                    monsterFighter.textContent = '🏴‍☠️';
                    break;
                case '海神波塞冬':
                    monsterFighter.textContent = '🔱';
                    break;
                case '精英冰霜女王':
                    monsterFighter.textContent = '❄️';
                    break;
                case '永恒冰神':
                    monsterFighter.textContent = '🧊';
                    break;
                case '精英法老祭司':
                    monsterFighter.textContent = '🏺';
                    break;
                case '不朽法老王':
                    monsterFighter.textContent = '👑';
                    break;
                case '精英自然守护者':
                    monsterFighter.textContent = '🌿';
                    break;
                case '世界树之灵':
                    monsterFighter.textContent = '🌳';
                    break;
                case '精英星际战士':
                    monsterFighter.textContent = '🚀';
                    break;
                case '宇宙创世神':
                    monsterFighter.textContent = '🌌';
                    break;
                case '精英机械领主':
                    monsterFighter.textContent = '🤖';
                    break;
                case '人工智能主脑':
                    monsterFighter.textContent = '🧠';
                    break;
                case '精英暗影执行者':
                    monsterFighter.textContent = '🥷';
                    break;
                case '虚无之主':
                    monsterFighter.textContent = '🌑';
                    break;
                case '精英水晶守护者':
                    monsterFighter.textContent = '💎';
                    break;
                case '水晶位面之王':
                    monsterFighter.textContent = '💠';
                    break;
                default:
                    monsterFighter.textContent = '👹';
            }
        }

        // 攻击
        // 自动战斗控制
        function toggleAutoBattle() {
            if (gameState.autoBattle) {
                stopAutoBattle();
            } else {
                startAutoBattle();
            }
        }

        function startAutoBattle() {
            if (!gameState.inBattle) return;
            
            gameState.autoBattle = true;
            document.getElementById('autoBattleBtn').textContent = '停止自动战斗';
            document.getElementById('autoBattleBtn').className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded mr-2';
            
            addLog('开始自动战斗...');
            autoBattleLoop();
        }

        function stopAutoBattle() {
            gameState.autoBattle = false;
            if (gameState.battleInterval) {
                clearTimeout(gameState.battleInterval);
                gameState.battleInterval = null;
            }
            
            document.getElementById('autoBattleBtn').textContent = '开始自动战斗';
            document.getElementById('autoBattleBtn').className = 'btn-primary px-6 py-2 rounded mr-2';
            
            addLog('停止自动战斗');
        }

        function autoBattleLoop() {
            if (!gameState.autoBattle || !gameState.inBattle) return;
            
            // 执行一轮攻击
            playerAutoAttack();
            
            // 如果战斗还在继续，设置下一轮
            if (gameState.inBattle && gameState.autoBattle && gameState.currentMonster && gameState.currentMonster.hp > 0) {
                gameState.battleInterval = setTimeout(() => {
                    // 再次检查战斗状态和怪物状态
                    if (gameState.inBattle && gameState.autoBattle && gameState.currentMonster && gameState.currentMonster.hp > 0) {
                        monsterAttack();
                        // 怪物攻击后再次检查状态
                        if (gameState.inBattle && gameState.autoBattle && gameState.currentMonster && gameState.currentMonster.hp > 0) {
                            gameState.battleInterval = setTimeout(autoBattleLoop, 1500);
                        }
                    }
                }, 1000);
            }
        }

        // 战斗动画函数
        function playPlayerAttackAnimation() {
            const playerFighter = document.getElementById('playerFighter');
            const attackEffect = document.getElementById('attackEffect');
            
            // 移除旧动画类并添加攻击动画类
            playerFighter.className = 'character-sprite character-attack';
            
            // 显示攻击特效
            setTimeout(() => {
                attackEffect.style.opacity = '1';
                attackEffect.textContent = '⚔️';
            }, 150);
            
            // 恢复到待机状态
            setTimeout(() => {
                playerFighter.className = 'character-sprite character-idle';
                attackEffect.style.opacity = '0';
            }, 600);
        }
        
        function playMonsterAttackAnimation() {
            const monsterFighter = document.getElementById('monsterFighter');
            const attackEffect = document.getElementById('attackEffect');
            
            // 移除旧动画类并添加攻击动画类
            monsterFighter.className = 'character-sprite character-attack';
            
            // 显示攻击特效
            setTimeout(() => {
                attackEffect.style.opacity = '1';
                attackEffect.textContent = '💥';
            }, 150);
            
            // 恢复到待机状态
            setTimeout(() => {
                monsterFighter.className = 'character-sprite character-idle';
                attackEffect.style.opacity = '0';
            }, 600);
        }
        
        function playSkillAnimation(skillType) {
            const playerFighter = document.getElementById('playerFighter');
            const attackEffect = document.getElementById('attackEffect');
            
            // 移除旧动画类并添加技能动画类
            playerFighter.className = 'character-sprite character-skill';
            
            // 显示技能特效
            setTimeout(() => {
                attackEffect.style.opacity = '1';
                if (skillType === 'fireball') {
                    attackEffect.textContent = '🔥';
                } else if (skillType === 'heal') {
                    attackEffect.textContent = '✨';
                }
            }, 150);
            
            // 恢复到待机状态
            setTimeout(() => {
                playerFighter.className = 'character-sprite character-idle';
                attackEffect.style.opacity = '0';
            }, 1000);
        }
        
        function playHurtAnimation(target) {
            const element = document.getElementById(target === 'player' ? 'playerFighter' : 'monsterFighter');
            
            // 移除旧动画类并添加受伤动画类
            element.className = 'character-sprite character-hurt';
            
            // 恢复到待机状态
            setTimeout(() => {
                element.className = 'character-sprite character-idle';
            }, 400);
        }

        // 飘字效果函数
        function showDamageText(damage, isCrit, isHeal, target) {
            const container = document.getElementById('damageTextContainer');
            if (!container) {
                console.error('damageTextContainer not found');
                return;
            }
            
            // 调试信息
            console.log(`显示飘字: ${damage}, 暴击: ${isCrit}, 治疗: ${isHeal}, 目标: ${target}`);
            
            const damageText = document.createElement('div');
            
            // 设置飘字内容
            damageText.textContent = Math.floor(damage);
            
            // 设置基础样式
            damageText.className = 'floating-text';
            damageText.style.position = 'absolute';
            damageText.style.fontWeight = 'bold';
            damageText.style.fontSize = '18px';
            damageText.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
            damageText.style.pointerEvents = 'none';
            damageText.style.zIndex = '1000';
            
            // 设置飘字样式
            if (isHeal) {
                damageText.style.color = '#10b981'; // 绿色治疗
                damageText.textContent = '+' + Math.floor(damage);
                damageText.style.animation = 'floatUp 2s ease-out forwards';
            } else if (isCrit) {
                damageText.style.color = '#ef4444'; // 红色暴击
                damageText.style.fontSize = '24px';
                damageText.style.animation = 'critFloat 2s ease-out forwards';
                damageText.textContent = Math.floor(damage) + '!';
            } else {
                damageText.style.color = '#fbbf24'; // 黄色普通伤害
                damageText.style.animation = 'floatUp 2s ease-out forwards';
            }
            
            // 简化位置计算 - 使用固定位置区域
            let x, y;
            if (target === 'player') {
                // 玩家区域 - 左侧
                x = 100 + Math.random() * 80;
                y = 150 + Math.random() * 60;
            } else {
                // 怪物区域 - 右侧
                x = 300 + Math.random() * 80;
                y = 150 + Math.random() * 60;
            }
            
            damageText.style.left = x + 'px';
            damageText.style.top = y + 'px';
            
            // 添加到容器
            container.appendChild(damageText);
            
            // 动画结束后移除元素
            setTimeout(() => {
                if (damageText.parentNode) {
                    damageText.parentNode.removeChild(damageText);
                }
            }, 2000);
        }

        // 计算特殊装备加成
        function calculateSpecialEquipmentBonus() {
            const player = gameState.player;
            let bonus = {
                percentDamage: 0,
                percentHp: 0,
                percentMp: 0,
                percentAttack: 0,
                divineMultiplier: 1
            };
            
            // 检查所有特殊装备槽位
            ['special1', 'special2', 'special3', 'special4'].forEach(slot => {
                const equipment = player.equipment[slot];
                if (equipment) {
                    bonus.percentDamage += equipment.percentDamage || 0;
                    bonus.percentHp += equipment.percentHp || 0;
                    bonus.percentMp += equipment.percentMp || 0;
                    bonus.percentAttack += equipment.percentAttack || 0;
                    if (equipment.divineMultiplier) {
                        bonus.divineMultiplier *= equipment.divineMultiplier;
                    }
                }
            });
            
            return bonus;
        }

        // 计算套装效果
        function calculateSetBonus() {
            const player = gameState.player;
            const setCount = {};
            const setBonus = {
                attack: 0,
                defense: 0,
                hp: 0,
                mp: 0,
                critRate: 0,
                critDamage: 0,
                magicPower: 0,
                vampiric: 0,
                damageReduction: 0,
                specialEffects: []
            };
            
            // 统计套装件数
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.setName) {
                    setCount[item.setName] = (setCount[item.setName] || 0) + 1;
                }
            });
            
            // 计算套装效果
            Object.keys(setCount).forEach(setName => {
                const count = setCount[setName];
                
                if (setName === '天神套装') {
                    if (count >= 2) {
                        setBonus.attack += 20;
                        setBonus.critRate += 10;
                        setBonus.specialEffects.push('天神祝福：攻击力+20，暴击率+10%');
                    }
                    if (count >= 4) {
                        setBonus.hp += 100;
                        setBonus.critDamage += 30;
                        setBonus.specialEffects.push('天神庇护：生命值+100，暴击伤害+30%');
                    }
                } else if (setName === '深渊套装') {
                    if (count >= 2) {
                        setBonus.vampiric += 15;
                        setBonus.attack += 25;
                        setBonus.specialEffects.push('深渊之力：吸血+15%，攻击力+25');
                    }
                    if (count >= 4) {
                        setBonus.damageReduction += 20;
                        setBonus.critRate += 15;
                        setBonus.specialEffects.push('深渊统治：伤害减免+20%，暴击率+15%');
                    }
                } else if (setName === '创世套装') {
                    if (count >= 2) {
                        setBonus.magicPower += 40;
                        setBonus.mp += 80;
                        setBonus.specialEffects.push('创世之智：法术强度+40，魔法值+80');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 20;
                        setBonus.magicPower += 60;
                        setBonus.specialEffects.push('创世掌控：暴击率+20%，法术强度+60');
                    }
                } else if (setName === '永恒套装') {
                    if (count >= 2) {
                        setBonus.hp += 80;
                        setBonus.defense += 15;
                        setBonus.specialEffects.push('永恒守护：生命值+80，防御力+15');
                    }
                    if (count >= 4) {
                        setBonus.hp += 120;
                        setBonus.vampiric += 20;
                        setBonus.specialEffects.push('永恒重生：生命值+120，吸血+20%');
                    }
                } else if (setName === '混沌套装') {
                    if (count >= 2) {
                        setBonus.attack += 40;
                        setBonus.critRate += 20;
                        setBonus.specialEffects.push('混沌之力：攻击力+40，暴击率+20%');
                    }
                    if (count >= 4) {
                        setBonus.critDamage += 50;
                        setBonus.damageReduction += 25;
                        setBonus.specialEffects.push('混沌主宰：暴击伤害+50%，伤害减免+25%');
                    }
                } else if (setName === '虚空套装') {
                    if (count >= 2) {
                        setBonus.magicPower += 60;
                        setBonus.critRate += 25;
                        setBonus.specialEffects.push('虚空掌控：法术强度+60，暴击率+25%');
                    }
                    if (count >= 4) {
                        setBonus.magicPower += 80;
                        setBonus.mp += 150;
                        setBonus.specialEffects.push('虚空主宰：法术强度+80，魔法值+150');
                    }
                } else if (setName === '龙神套装') {
                    if (count >= 2) {
                        setBonus.attack += 80;
                        setBonus.critRate += 30;
                        setBonus.specialEffects.push('龙神之力：攻击力+80，暴击率+30%');
                    }
                    if (count >= 4) {
                        setBonus.critDamage += 100;
                        setBonus.hp += 300;
                        setBonus.specialEffects.push('龙神统治：暴击伤害+100%，生命值+300');
                    }
                } else if (setName === '神域套装') {
                    if (count >= 2) {
                        setBonus.defense += 50;
                        setBonus.hp += 250;
                        setBonus.specialEffects.push('神域庇护：防御力+50，生命值+250');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 35;
                        setBonus.damageReduction += 40;
                        setBonus.specialEffects.push('神域审判：暴击率+35%，伤害减免+40%');
                    }
                } else if (setName === '无限套装') {
                    if (count >= 2) {
                        setBonus.attack += 120;
                        setBonus.hp += 400;
                        setBonus.specialEffects.push('无限之力：攻击力+120，生命值+400');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 50;
                        setBonus.critDamage += 150;
                        setBonus.specialEffects.push('无限主宰：暴击率+50%，暴击伤害+150%');
                    }
                } else if (setName === '创世神套装') {
                    if (count >= 2) {
                        setBonus.magicPower += 150;
                        setBonus.mp += 300;
                        setBonus.specialEffects.push('创世神力：法术强度+150，魔法值+300');
                    }
                    if (count >= 4) {
                        setBonus.critRate += 60;
                        setBonus.magicPower += 200;
                        setBonus.specialEffects.push('创世主宰：暴击率+60%，法术强度+200');
                    }
                }
            });
            
            return setBonus;
        }

        function playerAutoAttack() {
            if (!gameState.inBattle) return;
            
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            // 播放攻击动画
            playPlayerAttackAnimation();
            
            // 计算玩家攻击力
            let playerAttack = player.attack[0] + Math.random() * (player.attack[1] - player.attack[0]);
            if (player.equipment.weapon) {
                playerAttack += player.equipment.weapon.attack[0] + Math.random() * (player.equipment.weapon.attack[1] - player.equipment.weapon.attack[0]);
            }
            
            // 获取特殊装备加成
            const specialBonus = calculateSpecialEquipmentBonus();
            
            // 应用百分比攻击加成
            playerAttack *= (1 + specialBonus.percentAttack / 100);
            
            // 计算套装效果
            const setBonus = calculateSetBonus();
            
            // 计算暴击
            let critRate = player.critRate || 0;
            let critDamage = player.critDamage || 150;
            
            // 装备暴击加成
            const equipmentSlots = ['weapon', 'helmet', 'armor', 'boots', 'ring', 'necklace'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item) {
                    critRate += item.critRate || 0;
                    critDamage += item.critDamage || 0;
                }
            });
            
            // 应用套装暴击加成
            critRate += setBonus.critRate;
            critDamage += setBonus.critDamage;
            
            let isCrit = Math.random() * 100 < critRate;
            let finalDamage = Math.floor(playerAttack);
            
            // 应用套装攻击加成
            finalDamage += setBonus.attack;
            
            if (isCrit) {
                finalDamage = Math.floor(finalDamage * (critDamage / 100));
            }
            
            // 应用百分比伤害加成
            finalDamage *= (1 + specialBonus.percentDamage / 100);
            
            // 应用神力倍攻
            finalDamage *= specialBonus.divineMultiplier;
            
            // 应用养成系统伤害加成
            const cultivationDamageBonus = gameState.player.cultivation.damage.level * 5; // 每级5%伤害加成
            finalDamage *= (1 + cultivationDamageBonus / 100);
            
            finalDamage = Math.floor(finalDamage);
            
            // 延迟伤害计算，配合动画
            setTimeout(() => {
                monster.hp -= finalDamage;
                gameState.player.lastDamageDealt = finalDamage; // 记录造成的伤害用于吸血计算
                playHurtAnimation('monster');
                
                // 显示飘字效果
                showDamageText(finalDamage, isCrit, false, 'monster');
                
                if (isCrit) {
                    addLog(`暴击！你对${monster.name}造成了${finalDamage}点伤害`);
                } else {
                    addLog(`你对${monster.name}造成了${finalDamage}点伤害`);
                }
                
                if (monster.hp <= 0) {
                    // 怪物死亡
                    const expGain = monster.exp;
                    const goldGain = monster.gold;
                    
                    gameState.player.exp += expGain;
                    gameState.player.gold += goldGain;
                    
                    // 更新金币收集任务进度
                    updateQuestProgress('collect', 'gold', goldGain);
                    
                    addLog(`${monster.name}被击败了！获得${expGain}经验和${goldGain}金币`);
                    
                    // 更新任务进度
                    updateQuestProgress('kill', monster.name);
                    updateQuestProgress('kill', 'any');
                    
                    // 检查升级
                    checkLevelUp();
                    
                    // 随机掉落装备（应用养成系统爆率加成）
                    const cultivationDropBonus = gameState.player.cultivation.dropRate.level * 10; // 每级10%爆率加成
                    const finalDropRate = 0.6 + (cultivationDropBonus / 100);
                    if (Math.random() < finalDropRate) {
                        dropEquipment(gameState.currentMonster);
                    }
                    
                    // 显示鞭尸按钮（如果有鞭尸等级）
                    if (gameState.player.cultivation.whipCorpse.level > 0) {
                        gameState.showWhipCorpse = true;
                        updateWhipCorpseButton();
                    }
                    
                    // 检查称号条件
                    checkTitleConditions();
                    
                    // 保存击败的怪物信息用于鞭尸
                    gameState.lastDefeatedMonster = {...gameState.currentMonster};
                    
                    endBattle();
                    return;
                }
                
                updateBattleUI();
            }, 300);
        }

        // 手动攻击（保留给技能使用）
        function attack() {
            if (!gameState.inBattle) return;
            playerAutoAttack();
            
            // 如果不是自动战斗模式，怪物反击
            if (!gameState.autoBattle) {
                setTimeout(() => {
                    monsterAttack();
                }, 1000);
            }
        }

        // 怪物攻击
        function monsterAttack() {
            const player = gameState.player;
            const monster = gameState.currentMonster;
            
            // 播放怪物攻击动画
            playMonsterAttackAnimation();
            
            let monsterAttack = monster.attack[0] + Math.random() * (monster.attack[1] - monster.attack[0]);
            
            // 计算防御
            let defense = player.defense;
            const equipmentSlots = ['helmet', 'armor', 'boots'];
            equipmentSlots.forEach(slot => {
                const item = player.equipment[slot];
                if (item && item.defense) {
                    defense += item.defense;
                }
            });
            
            // 计算套装效果
            const setBonus = calculateSetBonus();
            
            // 应用套装防御加成
            defense += setBonus.defense;
            
            let damage = Math.max(1, Math.floor(monsterAttack - defense));
            
            // 应用套装伤害减免
            if (setBonus.damageReduction > 0) {
                damage = Math.floor(damage * (1 - setBonus.damageReduction / 100));
                damage = Math.max(1, damage); // 确保至少造成1点伤害
            }
            
            // 应用套装吸血效果
            if (setBonus.vampiric > 0 && gameState.player.lastDamageDealt > 0) {
                const vampiricHeal = Math.floor(gameState.player.lastDamageDealt * setBonus.vampiric / 100);
                const specialBonus = calculateSpecialEquipmentBonus();
                const totalMaxHp = Math.floor(gameState.player.maxHp * (1 + specialBonus.percentHp / 100)) + setBonus.hp;
                gameState.player.hp = Math.min(totalMaxHp, gameState.player.hp + vampiricHeal);
                if (vampiricHeal > 0) {
                    addLog(`吸血效果恢复了${vampiricHeal}点生命`);
                }
            }
            
            // 延迟伤害计算，配合动画
            setTimeout(() => {
                player.hp -= damage;
                playHurtAnimation('player');
                
                // 显示飘字效果
                showDamageText(damage, false, false, 'player');
                
                addLog(`${monster.name}对你造成了${damage}点伤害`);
                
                if (player.hp <= 0) {
                    // 玩家死亡
                    player.hp = 0;
                    addLog('你被击败了！');
                    endBattle();
                    // 这里可以添加复活逻辑
                    setTimeout(() => {
                        player.hp = player.maxHp;
                        addLog('你在新手村复活了');
                        goToLocation('village');
                    }, 2000);
                }
                
                updateBattleUI();
                updateUI();
            }, 300);
        }

        // 使用技能
        function useSkill(skillName) {
            if (!gameState.inBattle) return;
            
            const player = gameState.player;
            
            if (skillName === 'fireball' && player.mp >= 10) {
                player.mp -= 10;
                
                // 播放火球术动画
                playSkillAnimation('fireball');
                
                let damage = 20 + Math.random() * 15;
                
                // 获取特殊装备加成
                const specialBonus = calculateSpecialEquipmentBonus();
                
                // 计算套装效果
                const setBonus = calculateSetBonus();
                
                // 计算技能暴击
                let critRate = player.critRate || 0;
                let critDamage = player.critDamage || 150;
                
                // 装备暴击加成
                if (player.equipment.weapon) {
                    critRate += player.equipment.weapon.critRate || 0;
                    critDamage += player.equipment.weapon.critDamage || 0;
                }
                if (player.equipment.armor) {
                    critRate += player.equipment.armor.critRate || 0;
                    critDamage += player.equipment.armor.critDamage || 0;
                }
                if (player.equipment.accessory) {
                    critRate += player.equipment.accessory.critRate || 0;
                    critDamage += player.equipment.accessory.critDamage || 0;
                }
                
                // 应用套装暴击加成
                critRate += setBonus.critRate;
                critDamage += setBonus.critDamage;
                
                let isCrit = Math.random() * 100 < critRate;
                let finalDamage = Math.floor(damage);
                
                // 应用套装法术强度加成
                finalDamage += setBonus.magicPower;
                
                if (isCrit) {
                    finalDamage = Math.floor(finalDamage * (critDamage / 100));
                }
                
                // 应用百分比伤害加成
                finalDamage *= (1 + specialBonus.percentDamage / 100);
                
                // 应用神力倍攻
                finalDamage *= specialBonus.divineMultiplier;
                
                // 应用养成系统伤害加成
                const cultivationDamageBonus = gameState.player.cultivation.damage.level * 5; // 每级5%伤害加成
                finalDamage *= (1 + cultivationDamageBonus / 100);
                
                finalDamage = Math.floor(finalDamage);
                
                // 延迟伤害计算，配合动画
                setTimeout(() => {
                    gameState.currentMonster.hp -= finalDamage;
                    playHurtAnimation('monster');
                    
                    // 显示飘字效果
                    showDamageText(finalDamage, isCrit, false, 'monster');
                    
                    if (isCrit) {
                        addLog(`暴击！你使用火球术造成了${finalDamage}点伤害`);
                    } else {
                        addLog(`你使用火球术造成了${finalDamage}点伤害`);
                    }
                    
                    if (gameState.currentMonster.hp <= 0) {
                        const expGain = gameState.currentMonster.exp;
                        const goldGain = gameState.currentMonster.gold;
                        
                        gameState.player.exp += expGain;
                        gameState.player.gold += goldGain;
                        
                        // 更新金币收集任务进度
                        updateQuestProgress('collect', 'gold', goldGain);
                        
                        addLog(`${gameState.currentMonster.name}被击败了！获得${expGain}经验和${goldGain}金币`);
                        
                        // 更新任务进度
                        updateQuestProgress('kill', gameState.currentMonster.name);
                        updateQuestProgress('kill', 'any');
                        
                        checkLevelUp();
                        
                        // 随机掉落装备（应用养成系统爆率加成）
                        const cultivationDropBonus = gameState.player.cultivation.dropRate.level * 10; // 每级10%爆率加成
                        const finalDropRate = 0.6 + (cultivationDropBonus / 100);
                        if (Math.random() < finalDropRate) {
                            dropEquipment(gameState.currentMonster);
                        }
                        
                        // 显示鞭尸按钮（如果有鞭尸等级）
                        if (gameState.player.cultivation.whipCorpse.level > 0) {
                            gameState.showWhipCorpse = true;
                            updateWhipCorpseButton();
                        }
                        
                        // 检查称号条件
                        checkTitleConditions();
                        
                        // 保存击败的怪物信息用于鞭尸
                        gameState.lastDefeatedMonster = {...gameState.currentMonster};
                        
                        endBattle();
                        return;
                    }
                    
                    updateBattleUI();
                    
                    // 只在非自动战斗模式下触发怪物反击
                    if (!gameState.autoBattle) {
                        setTimeout(() => {
                            monsterAttack();
                        }, 500);
                    }
                }, 400);
                
            } else if (skillName === 'heal' && player.mp >= 15) {
                player.mp -= 15;
                
                // 播放治疗术动画
                playSkillAnimation('heal');
                
                const healAmount = 30 + Math.random() * 20;
                
                // 延迟治疗效果，配合动画
                setTimeout(() => {
                    const specialBonus = calculateSpecialEquipmentBonus();
                    const setBonus = calculateSetBonus();
                    const totalMaxHp = Math.floor(player.maxHp * (1 + specialBonus.percentHp / 100) + setBonus.hp);
                    const actualHeal = Math.min(Math.floor(healAmount), totalMaxHp - player.hp);
                    player.hp = Math.min(totalMaxHp, player.hp + Math.floor(healAmount));
                    
                    // 显示治疗飘字效果
                    showDamageText(actualHeal, false, true, 'player');
                    
                    addLog(`你使用治疗术恢复了${Math.floor(healAmount)}点生命`);
                    updateBattleUI();
                }, 400);
                
                // 治疗术不触发怪物攻击
                
            } else {
                addLog('魔法值不足！');
                return;
            }
            
            updateUI();
        }

        // 逃跑
        function flee() {
            if (Math.random() < 0.7) {
                addLog('你成功逃跑了！');
                endBattle();
            } else {
                addLog('逃跑失败！');
                setTimeout(() => {
                    monsterAttack();
                }, 1000);
            }
        }

        // 结束战斗
        function endBattle() {
            gameState.inBattle = false;
            gameState.currentMonster = null;
            
            // 停止自动战斗
            if (gameState.autoBattle) {
                stopAutoBattle();
            }
            
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('monsterArea').classList.remove('hidden');
            
            generateMonsters(gameState.currentLocation);
        }

        // 检查升级
        function checkLevelUp() {
            const player = gameState.player;
            
            while (player.exp >= player.maxExp) {
                player.exp -= player.maxExp;
                player.level++;
                player.maxExp = player.level * 100;
                
                // 升级属性提升
                const hpIncrease = 20;
                const mpIncrease = 10;
                
                player.maxHp += hpIncrease;
                player.maxMp += mpIncrease;
                
                // 计算包含装备和套装加成的最大血量和魔法值
                const specialBonus = calculateSpecialEquipmentBonus();
                const setBonus = calculateSetBonus();
                const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
                const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
                
                player.hp = totalMaxHp; // 升级回满血
                player.mp = totalMaxMp; // 升级回满蓝
                
                addLog(`恭喜升级！当前等级：${player.level}`);
                addLog(`生命值增加${hpIncrease}，魔法值增加${mpIncrease}`);
                
                // 更新任务进度
                updateQuestProgress('level', 'level');
                
                // 检查称号条件
                checkTitleConditions();
                
                // 自动保存
                saveGame();
            }
            
            updateUI();
        }

        // 掉落装备
        function dropEquipment(monster = null) {
            let dropType = Math.random();
            let droppedItem;
            
            // Boss怪物特殊掉落
            if (monster && monster.type === 'boss' && monster.bossLoot) {
                // Boss有80%概率掉落特殊装备
                if (Math.random() < 0.8) {
                    const bossLoot = monster.bossLoot;
                    const lootKeys = Object.keys(bossLoot);
                    const randomLootType = lootKeys[Math.floor(Math.random() * lootKeys.length)];
                    const lootItems = bossLoot[randomLootType];
                    droppedItem = lootItems[Math.floor(Math.random() * lootItems.length)];
                    
                    gameState.player.inventory.push({...droppedItem});
                    addLog(`💎 Boss掉落了稀有物品：${droppedItem.name}！`);
                    updateInventoryDisplay();
                    updateQuestProgress('collect', 'item');
                    return;
                }
            }
            
            // 精英怪物提高掉落率
            if (monster && monster.type === 'elite') {
                dropType = Math.random() * 0.8; // 精英怪物掉落率提高20%
            }
            
            // Boss怪物提高掉落率
            if (monster && monster.type === 'boss') {
                dropType = Math.random() * 0.6; // Boss怪物掉落率提高40%
            }
            
            // 称号卷轴掉落概率调整
            let scrollChance = 0.05;
            if (monster && monster.type === 'elite') scrollChance = 0.1;
            if (monster && monster.type === 'boss') scrollChance = 0.2;
            
            if (dropType < scrollChance) {
                const availableScrolls = Object.keys(titleTemplates).filter(titleId => {
                    return !gameState.player.titles.owned.includes(titleId) && 
                           !gameState.player.titles.scrolls.includes(titleId);
                });
                
                if (availableScrolls.length > 0) {
                    const randomTitleId = availableScrolls[Math.floor(Math.random() * availableScrolls.length)];
                    gameState.player.titles.scrolls.push(randomTitleId);
                    addLog(`获得了称号卷轴：${titleTemplates[randomTitleId].name}`);
                    updateTitleDisplay();
                    return;
                }
            }
            
            if (dropType < 0.4) {
                // 40%概率掉落养成材料
                const materials = [
                    { name: '铁矿石', type: 'material', quantity: 1, price: 50, rarity: 'common' },
                    { name: '银矿石', type: 'material', quantity: 1, price: 100, rarity: 'rare' },
                    { name: '魔法水晶', type: 'material', quantity: 1, price: 100, rarity: 'uncommon' },
                    { name: '黄金矿石', type: 'material', quantity: 1, price: 200, rarity: 'epic' },
                    { name: '暗影精华', type: 'material', quantity: 1, price: 300, rarity: 'epic' },
                    { name: '龙鳞片', type: 'material', quantity: 1, price: 400, rarity: 'legendary' },
                    { name: '神圣宝石', type: 'material', quantity: 1, price: 500, rarity: 'legendary' },
                    { name: '稀有宝石', type: 'material', quantity: 1, price: 500, rarity: 'rare' },
                    // 超神品质材料
                    { name: '龙之精华', type: 'material', quantity: 1, price: 800, rarity: 'transcendent' },
                    { name: '圣光水晶', type: 'material', quantity: 1, price: 900, rarity: 'transcendent' },
                    { name: '天使之羽', type: 'material', quantity: 1, price: 1200, rarity: 'transcendent' },
                    { name: '无限水晶', type: 'material', quantity: 1, price: 1500, rarity: 'transcendent' },
                    { name: '时空碎片', type: 'material', quantity: 1, price: 2000, rarity: 'transcendent' },
                    { name: '创世水晶', type: 'material', quantity: 1, price: 1800, rarity: 'transcendent' },
                    { name: '混沌之心', type: 'material', quantity: 1, price: 2500, rarity: 'transcendent' }
                ];
                
                // 根据怪物类型调整掉落概率
                let materialRoll = Math.random();
                let droppedItem;
                
                if (monster && monster.type === 'boss') {
                    // 检查是否为超高级地区的Boss
                    const currentLocation = gameState.currentLocation;
                    const isTranscendentArea = ['dragonrealm', 'godsdomain', 'chaosrealm', 'voidrealm', 'infiniterealm'].includes(currentLocation);
                    
                    if (isTranscendentArea) {
                        // 超高级地区Boss掉落超神品质材料
                        if (materialRoll < 0.10) {
                            droppedItem = materials[5]; // 龙鳞片
                        } else if (materialRoll < 0.20) {
                            droppedItem = materials[6]; // 神圣宝石
                        } else if (materialRoll < 0.35) {
                            droppedItem = materials[8]; // 龙之精华
                        } else if (materialRoll < 0.50) {
                            droppedItem = materials[9]; // 圣光水晶
                        } else if (materialRoll < 0.65) {
                            droppedItem = materials[10]; // 天使之羽
                        } else if (materialRoll < 0.75) {
                            droppedItem = materials[11]; // 无限水晶
                        } else if (materialRoll < 0.85) {
                            droppedItem = materials[12]; // 时空碎片
                        } else if (materialRoll < 0.92) {
                            droppedItem = materials[13]; // 创世水晶
                        } else {
                            droppedItem = materials[14]; // 混沌之心
                        }
                    } else {
                        // 普通Boss怪物掉落高级材料概率更高
                        if (materialRoll < 0.15) {
                            droppedItem = materials[0]; // 铁矿石
                        } else if (materialRoll < 0.25) {
                            droppedItem = materials[1]; // 银矿石
                        } else if (materialRoll < 0.35) {
                            droppedItem = materials[2]; // 魔法水晶
                        } else if (materialRoll < 0.50) {
                            droppedItem = materials[3]; // 黄金矿石
                        } else if (materialRoll < 0.65) {
                            droppedItem = materials[4]; // 暗影精华
                        } else if (materialRoll < 0.80) {
                            droppedItem = materials[5]; // 龙鳞片
                        } else if (materialRoll < 0.90) {
                            droppedItem = materials[6]; // 神圣宝石
                        } else {
                            droppedItem = materials[7]; // 稀有宝石
                        }
                    }
                } else if (monster && monster.type === 'elite') {
                    // 精英怪物掉落中高级材料
                    if (materialRoll < 0.25) {
                        droppedItem = materials[0]; // 铁矿石
                    } else if (materialRoll < 0.40) {
                        droppedItem = materials[1]; // 银矿石
                    } else if (materialRoll < 0.55) {
                        droppedItem = materials[2]; // 魔法水晶
                    } else if (materialRoll < 0.70) {
                        droppedItem = materials[3]; // 黄金矿石
                    } else if (materialRoll < 0.80) {
                        droppedItem = materials[4]; // 暗影精华
                    } else if (materialRoll < 0.90) {
                        droppedItem = materials[5]; // 龙鳞片
                    } else {
                        droppedItem = materials[7]; // 稀有宝石
                    }
                } else {
                    // 普通怪物主要掉落基础材料
                    if (materialRoll < 0.50) {
                        droppedItem = materials[0]; // 铁矿石
                    } else if (materialRoll < 0.70) {
                        droppedItem = materials[1]; // 银矿石
                    } else if (materialRoll < 0.85) {
                        droppedItem = materials[2]; // 魔法水晶
                    } else if (materialRoll < 0.95) {
                        droppedItem = materials[3]; // 黄金矿石
                    } else {
                        droppedItem = materials[7]; // 稀有宝石
                    }
                }
                
                // Boss和精英怪物掉落更多数量
                let quantity = 1;
                if (monster && monster.type === 'elite') quantity = Math.floor(Math.random() * 2) + 1; // 1-2个
                if (monster && monster.type === 'boss') quantity = Math.floor(Math.random() * 3) + 2; // 2-4个
                
                // 检查是否已有该材料
                const existingMaterial = gameState.player.materials.find(item => item.name === droppedItem.name);
                if (existingMaterial) {
                    existingMaterial.count += quantity;
                    addLog(`获得了材料：${droppedItem.name} x${quantity} (总计: ${existingMaterial.count})`);
                } else {
                    gameState.player.materials.push({
                        name: droppedItem.name,
                        count: quantity,
                        description: getMaterialDescription(droppedItem.name)
                    });
                    addLog(`获得了材料：${droppedItem.name} x${quantity}`);
                }
                updateInventoryDisplay();
                return;
            } else if (dropType < 0.5) {
                // 药水掉落
                let potions;
                if (monster && (monster.type === 'elite' || monster.type === 'boss')) {
                    potions = equipment.potions.filter(p => p.rarity === 'rare' || p.rarity === 'epic');
                } else {
                    potions = equipment.potions.filter(p => p.rarity === 'common');
                }
                droppedItem = potions[Math.floor(Math.random() * potions.length)];
            } else if (dropType < 0.75) {
                // 武器或防具掉落
                let allEquipment;
                const currentLocation = gameState.currentLocation;
                const isTranscendentArea = ['dragonrealm', 'godsdomain', 'chaosrealm', 'voidrealm', 'infiniterealm'].includes(currentLocation);
                
                if (monster && monster.type === 'boss') {
                    if (isTranscendentArea) {
                        // 超高级地区Boss掉落超神品质装备
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'transcendent' || item.rarity === 'supreme' || item.rarity === 'legendary'
                        );
                    } else {
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'epic' || item.rarity === 'legendary'
                        );
                    }
                } else if (monster && monster.type === 'elite') {
                    if (isTranscendentArea) {
                        // 超高级地区精英怪掉落高品质装备
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'supreme' || item.rarity === 'legendary' || item.rarity === 'epic'
                        );
                    } else {
                        allEquipment = [...equipment.weapons, ...equipment.armors].filter(item => 
                            item.rarity === 'rare' || item.rarity === 'epic'
                        );
                    }
                } else {
                    allEquipment = [...equipment.weapons, ...equipment.armors];
                }
                droppedItem = allEquipment[Math.floor(Math.random() * allEquipment.length)];
            } else if (dropType < 0.9) {
                // 饰品掉落
                let accessories;
                const currentLocation = gameState.currentLocation;
                const isTranscendentArea = ['dragonrealm', 'godsdomain', 'chaosrealm', 'voidrealm', 'infiniterealm'].includes(currentLocation);
                
                if (monster && (monster.type === 'elite' || monster.type === 'boss')) {
                    if (isTranscendentArea) {
                        // 超高级地区掉落超神品质饰品
                        accessories = equipment.accessories.filter(item => 
                            item.rarity === 'transcendent' || item.rarity === 'supreme' || item.rarity === 'legendary'
                        );
                    } else {
                        accessories = equipment.accessories.filter(item => 
                            item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary'
                        );
                    }
                } else {
                    accessories = equipment.accessories;
                }
                droppedItem = accessories[Math.floor(Math.random() * accessories.length)];
            } else {
                // 高级药水掉落
                const rarePotions = equipment.potions.filter(p => p.rarity === 'rare' || p.rarity === 'epic');
                droppedItem = rarePotions[Math.floor(Math.random() * rarePotions.length)];
            }
            
            gameState.player.inventory.push({...droppedItem});
            addLog(`获得了物品：${droppedItem.name}`);
            updateInventoryDisplay();
            
            // 更新任务进度
            updateQuestProgress('collect', 'item');
        }

        // 显示商店
        function showShop() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('shopArea').classList.remove('hidden');
            
            const shopItems = document.getElementById('shopItems');
            shopItems.innerHTML = '';
            
            if (gameState.shopMode === 'buy') {
                // 购买模式
                // 显示武器
                equipment.weapons.forEach(weapon => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${weapon.rarity}`;
                    itemDiv.innerHTML = `
                        <div class="font-bold">${weapon.name}</div>
                        <div class="text-sm text-gray-300">攻击: ${weapon.attack[0]}-${weapon.attack[1]}</div>
                        <div class="text-sm text-yellow-400">价格: ${weapon.price}金币</div>
                        <button onclick="buyItem('weapon', '${weapon.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopItems.appendChild(itemDiv);
                });
                
                // 显示防具
                equipment.armors.forEach(armor => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${armor.rarity}`;
                    itemDiv.innerHTML = `
                        <div class="font-bold">${armor.name}</div>
                        <div class="text-sm text-gray-300">防御: ${armor.defense}</div>
                        <div class="text-sm text-yellow-400">价格: ${armor.price}金币</div>
                        <button onclick="buyItem('armor', '${armor.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopItems.appendChild(itemDiv);
                });
                
                // 显示饰品
                equipment.accessories.forEach(accessory => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${accessory.rarity}`;
                    itemDiv.innerHTML = `
                        <div class="font-bold">${accessory.name}</div>
                        <div class="text-sm text-gray-300">${getItemDescription(accessory)}</div>
                        <div class="text-sm text-yellow-400">价格: ${accessory.price}金币</div>
                        <button onclick="buyItem('accessory', '${accessory.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopItems.appendChild(itemDiv);
                });
                
                // 显示药水
                equipment.potions.forEach(potion => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${potion.rarity}`;
                    itemDiv.innerHTML = `
                        <div class="font-bold">${potion.name}</div>
                        <div class="text-sm text-gray-300">${getItemDescription(potion)}</div>
                        <div class="text-sm text-yellow-400">价格: ${potion.price}金币</div>
                        <button onclick="buyItem('potion', '${potion.name}')" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopItems.appendChild(itemDiv);
                });
                
                // 显示养成材料
                const cultivationMaterials = [
                    { name: '铁矿石', price: 10, description: '基础合成材料' },
                    { name: '银矿石', price: 30, description: '稀有合成材料' },
                    { name: '魔法水晶', price: 50, description: '魔法装备合成材料' },
                    { name: '黄金矿石', price: 80, description: '史诗合成材料' },
                    { name: '暗影精华', price: 120, description: '高级合成材料' },
                    { name: '龙鳞片', price: 200, description: '传说合成材料' },
                    { name: '神圣宝石', price: 300, description: '顶级合成材料' },
                    { name: '稀有宝石', price: 150, description: '用于高级合成的珍贵材料' }
                ];
                
                cultivationMaterials.forEach(material => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-gray-800 p-3 rounded border-2 border-purple-600';
                    itemDiv.innerHTML = `
                        <div class="font-bold text-purple-400">${material.name}</div>
                        <div class="text-sm text-gray-300">${material.description}</div>
                        <div class="text-sm text-yellow-400">价格: ${material.price}金币</div>
                        <button onclick="buyCultivationMaterial('${material.name}', ${material.price})" class="btn-primary px-3 py-1 rounded text-sm mt-2">购买</button>
                    `;
                    shopItems.appendChild(itemDiv);
                });
            } else {
                // 出售模式
                if (gameState.player.inventory.length === 0) {
                    shopItems.innerHTML = '<div class="text-gray-400 text-center py-8 col-span-2">背包中没有可出售的物品</div>';
                    return;
                }
                
                gameState.player.inventory.forEach((item, index) => {
                    const sellPrice = Math.floor(item.price * 0.5); // 出售价格为购买价格的50%
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `bg-gray-800 p-3 rounded border-2 border-gray-600 item-${item.rarity}`;
                    itemDiv.innerHTML = `
                        <div class="font-bold">${item.name}</div>
                        <div class="text-sm text-gray-300">${getItemDescription(item)}</div>
                        <div class="text-sm text-yellow-400">出售价格: ${sellPrice}金币</div>
                        <button onclick="sellItem(${index})" class="btn-primary px-3 py-1 rounded text-sm mt-2">出售</button>
                    `;
                    shopItems.appendChild(itemDiv);
                });
            }
        }

        // 购买物品
        function buyItem(type, itemName) {
            let itemList;
            if (type === 'weapon') {
                itemList = equipment.weapons;
            } else if (type === 'armor') {
                itemList = equipment.armors;
            } else if (type === 'accessory') {
                itemList = equipment.accessories;
            } else if (type === 'potion') {
                itemList = equipment.potions;
            }
            
            const item = itemList.find(i => i.name === itemName);
            
            if (gameState.player.gold >= item.price) {
                gameState.player.gold -= item.price;
                gameState.player.inventory.push({...item});
                addLog(`购买了${item.name}`);
                showFloatingText(`购买成功！${item.name}`, 'success');
                updateUI();
            } else {
                addLog('金币不足！');
            }
        }
        
        // 购买养成材料
        function buyCultivationMaterial(materialName, price) {
            if (gameState.player.gold >= price) {
                gameState.player.gold -= price;
                
                // 查找是否已有该材料
                const existingMaterial = gameState.player.materials.find(item => item.name === materialName);
                if (existingMaterial) {
                    existingMaterial.count += 1;
                } else {
                    gameState.player.materials.push({
                        name: materialName,
                        count: 1,
                        description: getMaterialDescription(materialName)
                    });
                }
                
                addLog(`购买了${materialName} x1`);
                showFloatingText(`购买成功！${materialName} x1`, 'success');
                updateUI();
                updateInventoryDisplay();
            } else {
                addLog('金币不足！');
            }
        }
        
        // 获取材料描述
        function getMaterialDescription(materialName) {
            const descriptions = {
                '铁矿石': '基础锻造材料',
                '魔法水晶': '蕴含魔力的水晶',
                '稀有宝石': '珍贵的宝石材料'
            };
            return descriptions[materialName] || '养成材料';
        }

        // 出售物品
        function sellItem(index) {
            const item = gameState.player.inventory[index];
            const sellPrice = Math.floor(item.price * 0.5);
            
            gameState.player.gold += sellPrice;
            
            // 更新金币收集任务进度
            updateQuestProgress('collect', 'gold', sellPrice);
            gameState.player.inventory.splice(index, 1);
            
            addLog(`出售了${item.name}，获得${sellPrice}金币`);
            updateUI();
            showShop(); // 刷新商店显示
        }

        // 添加日志
        function addLog(message) {
            const gameLog = document.getElementById('gameLog');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            gameLog.appendChild(logEntry);
            gameLog.scrollTop = gameLog.scrollHeight;
        }
        
        // 飘字效果函数
        function showFloatingText(text, type = 'success', x = null, y = null) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${type}`;
            floatingText.textContent = text;
            
            // 如果没有指定位置，使用屏幕中央偏上的位置
            if (x === null || y === null) {
                x = window.innerWidth / 2;
                y = window.innerHeight / 3;
            }
            
            floatingText.style.left = x + 'px';
            floatingText.style.top = y + 'px';
            floatingText.style.transform = 'translateX(-50%)';
            
            document.body.appendChild(floatingText);
            
            // 2秒后移除元素
            setTimeout(() => {
                if (floatingText.parentNode) {
                    floatingText.parentNode.removeChild(floatingText);
                }
            }, 2000);
        }

        // 存档功能
        function saveGame(slotIndex = null) {
            const saveData = {
                player: {...gameState.player},
                currentLocation: gameState.currentLocation,
                timestamp: new Date().toLocaleString(),
                version: '1.0'
            };
            
            if (slotIndex === null) {
                // 快速保存到默认槽位
                localStorage.setItem('legendSave_auto', JSON.stringify(saveData));
                addLog('游戏已自动保存');
            } else {
                // 保存到指定槽位
                localStorage.setItem(`legendSave_${slotIndex}`, JSON.stringify(saveData));
                addLog(`游戏已保存到存档槽 ${slotIndex + 1}`);
                showSaveSlots(); // 刷新存档列表
            }
        }

        function loadGame(slotIndex = null) {
            let saveKey = slotIndex === null ? 'legendSave_auto' : `legendSave_${slotIndex}`;
            const saveData = localStorage.getItem(saveKey);
            
            if (saveData) {
                try {
                    const data = JSON.parse(saveData);
                    gameState.player = {...data.player};
                    gameState.currentLocation = data.currentLocation;
                    
                    // 确保角色创建界面隐藏，游戏界面显示
                    document.getElementById('characterCreation').classList.add('hidden');
                    document.getElementById('gameInterface').classList.remove('hidden');
                    
                    updateUI();
                    goToLocation(gameState.currentLocation);
                    
                    // 初始化任务系统和称号系统
                    initializeQuests();
                    checkTitleConditions();
                    
                    const slotText = slotIndex === null ? '自动存档' : `存档槽 ${slotIndex + 1}`;
                    addLog(`已加载${slotText} (${data.timestamp})`);
                    addLog('任务系统已重新初始化');
                    
                    if (slotIndex !== null) {
                        hideSaveSlots();
                    }
                } catch (error) {
                    addLog('存档文件损坏，无法加载');
                }
            } else {
                const slotText = slotIndex === null ? '自动存档' : `存档槽 ${slotIndex + 1}`;
                addLog(`${slotText}不存在`);
            }
        }

        function deleteSave(slotIndex) {
            if (confirm(`确定要删除存档槽 ${slotIndex + 1} 吗？`)) {
                localStorage.removeItem(`legendSave_${slotIndex}`);
                addLog(`已删除存档槽 ${slotIndex + 1}`);
                showSaveSlots(); // 刷新存档列表
            }
        }

        // 显示养成系统面板
        function showCultivationPanel() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.remove('hidden');
            updateCultivationDisplay();
        }

        // 隐藏养成系统面板
        function hideCultivationPanel() {
            document.getElementById('cultivationArea').classList.add('hidden');
        }

        // 更新养成系统显示
        function updateCultivationDisplay() {
            const cultivation = gameState.player.cultivation;
            
            // 更新爆率提升
            document.getElementById('dropRateLevel').textContent = cultivation.dropRate.level;
            document.getElementById('dropRateExp').textContent = `${cultivation.dropRate.exp}/${getRequiredExp(cultivation.dropRate.level)}`;
            document.getElementById('dropRateEffect').textContent = `+${cultivation.dropRate.level * 10}%`;
            
            // 更新伤害提升
            document.getElementById('damageLevel').textContent = cultivation.damage.level;
            document.getElementById('damageExp').textContent = `${cultivation.damage.exp}/${getRequiredExp(cultivation.damage.level)}`;
            document.getElementById('damageEffect').textContent = `+${cultivation.damage.level * 5}%`;
            
            // 更新鞭尸概率
            document.getElementById('whipCorpseLevel').textContent = cultivation.whipCorpse.level;
            document.getElementById('whipCorpseExp').textContent = `${cultivation.whipCorpse.exp}/${getRequiredExp(cultivation.whipCorpse.level)}`;
            document.getElementById('whipCorpseEffect').textContent = `${cultivation.whipCorpse.level * 5}%`;
        }

        // 获取升级所需经验
        function getRequiredExp(level) {
            return 100 + level * 50;
        }

        // 升级养成系统
        function upgradeCultivation(type) {
            const cultivation = gameState.player.cultivation[type];
            const requiredMaterials = getUpgradeMaterials(type, cultivation.level);
            
            // 检查材料是否足够
            let canUpgrade = true;
            for (const material of requiredMaterials) {
                const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                if (!playerMaterial || playerMaterial.count < material.quantity) {
                    canUpgrade = false;
                    break;
                }
            }
            
            if (!canUpgrade) {
                addLog('材料不足，无法升级！');
                showUpgradeMaterials(type, cultivation.level);
                return;
            }
            
            // 消耗材料
            for (const material of requiredMaterials) {
                const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                playerMaterial.count -= material.quantity;
                if (playerMaterial.count <= 0) {
                    const index = gameState.player.materials.indexOf(playerMaterial);
                    gameState.player.materials.splice(index, 1);
                }
            }
            
            // 增加经验
            cultivation.exp += 50;
            const requiredExp = getRequiredExp(cultivation.level);
            
            if (cultivation.exp >= requiredExp) {
                cultivation.level++;
                cultivation.exp -= requiredExp;
                addLog(`${getTypeName(type)}升级到${cultivation.level}级！`);
            } else {
                addLog(`${getTypeName(type)}获得50点经验`);
            }
            
            updateCultivationDisplay();
            updateInventoryDisplay();
            updateWhipCorpseButton();
        }

        // 获取升级材料需求
        function getUpgradeMaterials(type, level) {
            const baseMaterials = [
                { name: '铁矿石', quantity: 2 + level },
                { name: '魔法水晶', quantity: 1 + Math.floor(level / 2) }
            ];
            
            if (level >= 5) {
                baseMaterials.push({ name: '稀有宝石', quantity: Math.floor(level / 5) });
            }
            
            return baseMaterials;
        }

        // 显示升级材料需求
        function showUpgradeMaterials(type, level) {
            const materials = getUpgradeMaterials(type, level);
            const materialsDiv = document.getElementById('cultivationMaterials');
            
            let html = `<div class="font-bold text-white mb-2">${getTypeName(type)}升级需要：</div>`;
            materials.forEach(material => {
                const playerMaterial = gameState.player.materials.find(item => item.name === material.name);
                const hasQuantity = playerMaterial ? playerMaterial.count : 0;
                const color = hasQuantity >= material.quantity ? 'text-green-400' : 'text-red-400';
                html += `<div class="${color}">${material.name}: ${hasQuantity}/${material.quantity}</div>`;
            });
            
            materialsDiv.innerHTML = html;
        }

        // 获取类型名称
        function getTypeName(type) {
            const names = {
                'dropRate': '爆率提升',
                'damage': '伤害提升',
                'whipCorpse': '鞭尸概率'
            };
            return names[type] || type;
        }

        // 鞭尸功能
        function whipCorpse() {
            const whipChance = gameState.player.cultivation.whipCorpse.level * 5; // 每级5%概率
            
            if (Math.random() * 100 < whipChance) {
                addLog('鞭尸成功！怪物再次掉落物品！');
                dropEquipment(gameState.lastDefeatedMonster); // 再次掉落
            } else {
                addLog('鞭尸失败...');
            }
            
            // 隐藏鞭尸按钮
            gameState.showWhipCorpse = false;
            updateWhipCorpseButton();
        }

        // 更新鞭尸按钮显示
        function updateWhipCorpseButton() {
            const button = document.getElementById('whipCorpseBtn');
            if (gameState.showWhipCorpse && gameState.player.cultivation.whipCorpse.level > 0) {
                button.classList.remove('hidden');
            } else {
                button.classList.add('hidden');
            }
        }

        // 任务配置
        const questTemplates = {
            // 基础打怪任务
            killMonsters: {
                id: 'kill_monsters_1',
                name: '清理怪物',
                description: '击败10只怪物',
                type: 'kill',
                target: 'any',
                targetCount: 10,
                currentCount: 0,
                rewards: { exp: 100, gold: 50 },
                level: 1
            },
            killMonstersAdvanced: {
                id: 'kill_monsters_2',
                name: '怪物猎手',
                description: '击败50只怪物',
                type: 'kill',
                target: 'any',
                targetCount: 50,
                currentCount: 0,
                rewards: { exp: 400, gold: 200, item: '强化药水' },
                level: 3
            },
            killMonstersExpert: {
                id: 'kill_monsters_3',
                name: '怪物终结者',
                description: '击败100只怪物',
                type: 'kill',
                target: 'any',
                targetCount: 100,
                currentCount: 0,
                rewards: { exp: 800, gold: 500, item: '精钢剑' },
                level: 5
            },
            // 特定怪物任务
            killWolves: {
                id: 'kill_wolves_1',
                name: '森林清剿',
                description: '击败15只森林狼',
                type: 'kill',
                target: '森林狼',
                targetCount: 15,
                currentCount: 0,
                rewards: { exp: 150, gold: 80 },
                level: 1
            },
            killBoars: {
                id: 'kill_boars_1',
                name: '野猪讨伐',
                description: '击败10只野猪',
                type: 'kill',
                target: '野猪',
                targetCount: 10,
                currentCount: 0,
                rewards: { exp: 200, gold: 120, item: '野猪牙' },
                level: 2
            },
            killSkeletons: {
                id: 'kill_skeletons_1',
                name: '亡灵净化',
                description: '击败20只骷髅',
                type: 'kill',
                target: '骷髅',
                targetCount: 20,
                currentCount: 0,
                rewards: { exp: 300, gold: 150, item: '圣水' },
                level: 3
            },
            killDemons: {
                id: 'kill_demons_1',
                name: '恶魔挑战',
                description: '击败5只恶魔',
                type: 'kill',
                target: '恶魔',
                targetCount: 5,
                currentCount: 0,
                rewards: { exp: 400, gold: 250, item: '恶魔之角' },
                level: 4
            },
            killDragons: {
                id: 'kill_dragons_1',
                name: '屠龙勇士',
                description: '击败1只龙',
                type: 'kill',
                target: '龙',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 1000, gold: 800, item: '龙鳞甲' },
                level: 8
            },
            // 连击任务
            killStreak: {
                id: 'kill_streak_1',
                name: '连击大师',
                description: '连续击败30只怪物不死亡',
                type: 'killStreak',
                target: 'any',
                targetCount: 30,
                currentCount: 0,
                rewards: { exp: 500, gold: 300, item: '连击戒指' },
                level: 4
            },
            // Boss任务
            killBoss: {
                id: 'kill_boss_1',
                name: 'Boss挑战',
                description: '击败任意Boss怪物',
                type: 'kill',
                target: 'boss',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 600, gold: 400, item: 'Boss战利品箱' },
                level: 5
            },
            // 其他任务
            collectGold: {
                id: 'collect_gold_1',
                name: '财富积累',
                description: '收集500金币',
                type: 'collect',
                target: 'gold',
                targetCount: 500,
                currentCount: 0,
                rewards: { exp: 150, gold: 100 },
                level: 1
            },
            reachLevel: {
                id: 'reach_level_5',
                name: '实力提升',
                description: '达到5级',
                type: 'level',
                target: 'level',
                targetCount: 5,
                currentCount: 0,
                rewards: { exp: 200, gold: 150, item: '银剑' },
                level: 1
            },
            equipItem: {
                id: 'equip_weapon_1',
                name: '装备武器',
                description: '装备一件武器',
                type: 'equip',
                target: 'weapon',
                targetCount: 1,
                currentCount: 0,
                rewards: { exp: 80, gold: 30 },
                level: 1
            }
        };

        // 称号配置
        const titleTemplates = {
            noviceKiller: {
                id: 'novice_killer',
                name: '新手杀手',
                description: '击败100只怪物',
                rarity: 'common',
                effects: { attack: [2, 3], critRate: 1 },
                condition: { type: 'kill', count: 100 }
            },
            goldCollector: {
                id: 'gold_collector',
                name: '黄金收集者',
                description: '累计获得10000金币',
                rarity: 'rare',
                effects: { goldBonus: 10 },
                condition: { type: 'gold', count: 10000 }
            },
            levelMaster: {
                id: 'level_master',
                name: '等级大师',
                description: '达到10级',
                rarity: 'epic',
                effects: { hp: 50, mp: 30, attack: [5, 8] },
                condition: { type: 'level', count: 10 }
            },
            legendaryWarrior: {
                id: 'legendary_warrior',
                name: '传奇战士',
                description: '击败传奇怪物',
                rarity: 'legendary',
                effects: { attack: [10, 15], critRate: 5, critDamage: 20 },
                condition: { type: 'kill_boss', count: 1 }
            },
            dragonSlayer: {
                id: 'dragon_slayer',
                name: '屠龙者',
                description: '击败龙类怪物',
                rarity: 'mythic',
                effects: { attack: [15, 25], critRate: 10, critDamage: 30, dragonDamage: 50 },
                condition: { type: 'kill_dragon', count: 1 }
            }
        };

        // 显示任务系统面板
        function showQuestPanel() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('titleArea').classList.add('hidden');
            document.getElementById('questArea').classList.remove('hidden');
            updateQuestDisplay();
        }

        // 隐藏任务系统面板
        function hideQuestPanel() {
            document.getElementById('questArea').classList.add('hidden');
        }

        // 显示称号系统面板
        function showTitlePanel() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('questArea').classList.add('hidden');
            document.getElementById('titleArea').classList.remove('hidden');
            updateTitleDisplay();
        }

        // 隐藏称号系统面板
        function hideTitlePanel() {
            document.getElementById('titleArea').classList.add('hidden');
        }

        // 更新任务显示
        function updateQuestDisplay() {
            updateAvailableQuests();
            updateActiveQuests();
            updateCompletedQuests();
        }

        // 更新可接任务
        function updateAvailableQuests() {
            const container = document.getElementById('availableQuests');
            const availableQuests = gameState.player.quests.available;
            
            if (availableQuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无可接任务</div>';
                return;
            }
            
            let html = '';
            availableQuests.forEach(quest => {
                html += `
                    <div class="bg-gray-700 p-3 rounded border border-blue-400">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold text-blue-400">${quest.name}</h5>
                                <p class="text-sm text-gray-300 mt-1">${quest.description}</p>
                                <div class="text-xs text-yellow-400 mt-2">
                                    奖励: ${quest.rewards.exp}经验 ${quest.rewards.gold}金币
                                    ${quest.rewards.item ? ` + ${quest.rewards.item}` : ''}
                                </div>
                            </div>
                            <button onclick="acceptQuest('${quest.id}')" class="btn-primary px-3 py-1 rounded text-sm ml-2">接取</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 更新进行中任务
        function updateActiveQuests() {
            const container = document.getElementById('activeQuests');
            const activeQuests = gameState.player.quests.active;
            
            if (activeQuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无进行中任务</div>';
                return;
            }
            
            let html = '';
            activeQuests.forEach(quest => {
                const progress = Math.min(quest.currentCount, quest.targetCount);
                const progressPercent = (progress / quest.targetCount * 100).toFixed(1);
                const isCompleted = quest.currentCount >= quest.targetCount;
                
                html += `
                    <div class="bg-gray-700 p-3 rounded border ${isCompleted ? 'border-green-400' : 'border-yellow-400'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold ${isCompleted ? 'text-green-400' : 'text-yellow-400'}">${quest.name}</h5>
                                <p class="text-sm text-gray-300 mt-1">${quest.description}</p>
                                <div class="text-sm mt-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">进度:</span>
                                        <span class="${isCompleted ? 'text-green-400' : 'text-yellow-400'}">${progress}/${quest.targetCount} (${progressPercent}%)</span>
                                    </div>
                                </div>
                                <div class="text-xs text-yellow-400 mt-1">
                                    奖励: ${quest.rewards.exp}经验 ${quest.rewards.gold}金币
                                    ${quest.rewards.item ? ` + ${quest.rewards.item}` : ''}
                                </div>
                            </div>
                            ${isCompleted ? `<button onclick="completeQuest('${quest.id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm ml-2">完成</button>` : ''}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 更新已完成任务
        function updateCompletedQuests() {
            const container = document.getElementById('completedQuests');
            const completedQuests = gameState.player.quests.completed;
            
            if (completedQuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无已完成任务</div>';
                return;
            }
            
            let html = '';
            completedQuests.slice(-10).forEach(quest => { // 只显示最近10个
                html += `
                    <div class="bg-gray-700 p-2 rounded border border-green-400">
                        <h5 class="font-bold text-green-400 text-sm">${quest.name}</h5>
                        <p class="text-xs text-gray-300">${quest.description}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 接取任务
        function acceptQuest(questId) {
            const questIndex = gameState.player.quests.available.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = gameState.player.quests.available[questIndex];
            gameState.player.quests.available.splice(questIndex, 1);
            gameState.player.quests.active.push(quest);
            
            addLog(`接取任务: ${quest.name}`);
            updateQuestDisplay();
        }

        // 完成任务
        function completeQuest(questId) {
            const questIndex = gameState.player.quests.active.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = gameState.player.quests.active[questIndex];
            if (quest.currentCount < quest.targetCount) return;
            
            // 发放奖励
            if (quest.rewards.exp) {
                gameState.player.exp += quest.rewards.exp;
                addLog(`获得 ${quest.rewards.exp} 经验值`);
            }
            if (quest.rewards.gold) {
                gameState.player.gold += quest.rewards.gold;
                addLog(`获得 ${quest.rewards.gold} 金币`);
            }
            if (quest.rewards.item) {
                const item = findItemByName(quest.rewards.item);
                if (item) {
                    gameState.player.inventory.push({...item});
                    addLog(`获得物品: ${item.name}`);
                }
            }
            
            // 移动任务到已完成
            gameState.player.quests.active.splice(questIndex, 1);
            gameState.player.quests.completed.push(quest);
            
            addLog(`完成任务: ${quest.name}`);
            showFloatingText('任务完成！', 'success');
            
            checkLevelUp();
            updateDisplay();
            updateQuestDisplay();
        }

        // 更新任务进度
        function updateQuestProgress(type, target, count = 1) {
            let hasUpdate = false;
            gameState.player.quests.active.forEach(quest => {
                if (quest.type === type && (quest.target === target || quest.target === 'any')) {
                    quest.currentCount += count;
                    hasUpdate = true;
                    if (quest.currentCount >= quest.targetCount) {
                        addLog(`任务 "${quest.name}" 已完成！`);
                        showFloatingText('任务可提交！', 'success');
                    }
                }
            });
            
            // 如果有任务进度更新，刷新任务UI
            if (hasUpdate) {
                updateActiveQuests();
            }
        }

        // 初始化任务系统
        function initializeQuests() {
            // 清空现有可接任务，重新分配
            gameState.player.quests.available = [];
            
            const playerLevel = gameState.player.level;
            
            // 根据玩家等级添加合适的任务
            Object.values(questTemplates).forEach(questTemplate => {
                // 检查任务等级要求
                if (questTemplate.level <= playerLevel) {
                    // 检查是否已经在进行中或已完成
                    const isActive = gameState.player.quests.active.some(q => q.id === questTemplate.id);
                    const isCompleted = gameState.player.quests.completed.some(q => q.id === questTemplate.id);
                    
                    if (!isActive && !isCompleted) {
                        gameState.player.quests.available.push({...questTemplate});
                    }
                }
            });
            
            // 如果没有可接任务，至少添加基础任务
            if (gameState.player.quests.available.length === 0) {
                gameState.player.quests.available.push(
                    {...questTemplates.killMonsters},
                    {...questTemplates.collectGold},
                    {...questTemplates.equipItem}
                );
            }
            
            addLog(`已刷新任务列表，当前可接任务: ${gameState.player.quests.available.length}个`);
        }

        // 根据装备名称查找装备
        function findItemByName(itemName) {
            // 在武器中查找
            let item = equipment.weapons.find(w => w.name === itemName);
            if (item) return {...item, type: 'weapon'};
            
            // 在防具中查找
            item = equipment.armors.find(a => a.name === itemName);
            if (item) return {...item, type: 'armor'};
            
            // 在饰品中查找
            item = equipment.accessories.find(a => a.name === itemName);
            if (item) return {...item, type: 'accessory'};
            
            return null;
        }

        // 更新称号显示
        function updateTitleDisplay() {
            updateCurrentTitle();
            updateOwnedTitles();
            updateTitleScrolls();
        }

        // 更新当前称号
        function updateCurrentTitle() {
            const container = document.getElementById('currentTitle');
            const effectContainer = document.getElementById('titleEffect');
            const activeTitle = gameState.player.titles.active;
            
            if (!activeTitle) {
                container.innerHTML = '<div class="text-gray-400">未激活称号</div>';
                effectContainer.innerHTML = '';
                return;
            }
            
            const rarityColors = {
                common: 'text-gray-300',
                rare: 'text-blue-400',
                epic: 'text-purple-400',
                legendary: 'text-orange-400',
                mythic: 'text-red-400'
            };
            
            container.innerHTML = `
                <div class="${rarityColors[activeTitle.rarity]} font-bold text-lg">${activeTitle.name}</div>
                <div class="text-sm text-gray-300 mt-1">${activeTitle.description}</div>
            `;
            
            // 显示称号效果
            let effectHtml = '<div class="font-bold text-green-400 mb-2">称号效果:</div>';
            const effects = activeTitle.effects;
            
            if (effects.attack) {
                effectHtml += `<div class="text-red-400">攻击力: +${effects.attack[0]}-${effects.attack[1]}</div>`;
            }
            if (effects.hp) {
                effectHtml += `<div class="text-green-400">生命值: +${effects.hp}</div>`;
            }
            if (effects.mp) {
                effectHtml += `<div class="text-blue-400">魔法值: +${effects.mp}</div>`;
            }
            if (effects.critRate) {
                effectHtml += `<div class="text-yellow-400">暴击率: +${effects.critRate}%</div>`;
            }
            if (effects.critDamage) {
                effectHtml += `<div class="text-yellow-400">暴击伤害: +${effects.critDamage}%</div>`;
            }
            if (effects.goldBonus) {
                effectHtml += `<div class="text-yellow-400">金币获取: +${effects.goldBonus}%</div>`;
            }
            if (effects.dragonDamage) {
                effectHtml += `<div class="text-red-400">对龙伤害: +${effects.dragonDamage}%</div>`;
            }
            
            effectContainer.innerHTML = effectHtml;
        }

        // 更新拥有的称号
        function updateOwnedTitles() {
            const container = document.getElementById('ownedTitles');
            const ownedTitles = gameState.player.titles.owned;
            
            if (ownedTitles.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无称号</div>';
                return;
            }
            
            const rarityColors = {
                common: 'border-gray-400 text-gray-300',
                rare: 'border-blue-400 text-blue-400',
                epic: 'border-purple-400 text-purple-400',
                legendary: 'border-orange-400 text-orange-400',
                mythic: 'border-red-400 text-red-400'
            };
            
            let html = '';
            ownedTitles.forEach(title => {
                const isActive = gameState.player.titles.active && gameState.player.titles.active.id === title.id;
                html += `
                    <div class="bg-gray-700 p-3 rounded border ${rarityColors[title.rarity]} ${isActive ? 'bg-gray-600' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold ${rarityColors[title.rarity].split(' ')[1]}">${title.name} ${isActive ? '(已激活)' : ''}</h5>
                                <p class="text-sm text-gray-300 mt-1">${title.description}</p>
                            </div>
                            ${!isActive ? `<button onclick="activateTitle('${title.id}')" class="btn-primary px-3 py-1 rounded text-sm ml-2">激活</button>` : 
                                         `<button onclick="deactivateTitle()" class="btn-secondary px-3 py-1 rounded text-sm ml-2">取消</button>`}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 更新称号卷轴
        function updateTitleScrolls() {
            const container = document.getElementById('titleScrolls');
            const scrolls = gameState.player.titles.scrolls;
            
            if (scrolls.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无称号卷轴</div>';
                return;
            }
            
            const rarityColors = {
                common: 'border-gray-400 text-gray-300',
                rare: 'border-blue-400 text-blue-400',
                epic: 'border-purple-400 text-purple-400',
                legendary: 'border-orange-400 text-orange-400',
                mythic: 'border-red-400 text-red-400'
            };
            
            let html = '';
            scrolls.forEach((scroll, index) => {
                html += `
                    <div class="bg-gray-700 p-3 rounded border ${rarityColors[scroll.rarity]}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-bold ${rarityColors[scroll.rarity].split(' ')[1]}">${scroll.name}卷轴</h5>
                                <p class="text-sm text-gray-300 mt-1">${scroll.description}</p>
                            </div>
                            <button onclick="useTitleScroll(${index})" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm ml-2">使用</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 激活称号
        function activateTitle(titleId) {
            const title = gameState.player.titles.owned.find(t => t.id === titleId);
            if (!title) return;
            
            gameState.player.titles.active = title;
            addLog(`激活称号: ${title.name}`);
            showFloatingText('称号激活！', 'success');
            
            updateTitleDisplay();
            updateDisplay(); // 更新属性显示
        }

        // 取消激活称号
        function deactivateTitle() {
            if (!gameState.player.titles.active) return;
            
            const titleName = gameState.player.titles.active.name;
            gameState.player.titles.active = null;
            addLog(`取消激活称号: ${titleName}`);
            
            updateTitleDisplay();
            updateDisplay(); // 更新属性显示
        }

        // 使用称号卷轴
        function useTitleScroll(index) {
            const scroll = gameState.player.titles.scrolls[index];
            if (!scroll) return;
            
            // 检查是否已拥有该称号
            const alreadyOwned = gameState.player.titles.owned.find(t => t.id === scroll.id);
            if (alreadyOwned) {
                addLog('你已经拥有这个称号了！');
                return;
            }
            
            // 添加称号到拥有列表
            gameState.player.titles.owned.push({...scroll});
            gameState.player.titles.scrolls.splice(index, 1);
            
            addLog(`获得称号: ${scroll.name}`);
            showFloatingText('获得新称号！', 'craft');
            
            updateTitleDisplay();
            updateInventoryDisplay();
        }

        // 检查称号条件
        function checkTitleConditions() {
            Object.values(titleTemplates).forEach(titleTemplate => {
                // 检查是否已拥有
                const alreadyOwned = gameState.player.titles.owned.find(t => t.id === titleTemplate.id);
                if (alreadyOwned) return;
                
                // 检查是否已有卷轴
                const hasScroll = gameState.player.titles.scrolls.find(s => s.id === titleTemplate.id);
                if (hasScroll) return;
                
                let conditionMet = false;
                const condition = titleTemplate.condition;
                
                switch (condition.type) {
                    case 'kill':
                        // 这里需要添加击杀计数统计
                        break;
                    case 'gold':
                        // 这里需要添加金币累计统计
                        break;
                    case 'level':
                        conditionMet = gameState.player.level >= condition.count;
                        break;
                }
                
                if (conditionMet) {
                    gameState.player.titles.scrolls.push({...titleTemplate});
                    addLog(`获得称号卷轴: ${titleTemplate.name}`);
                    showFloatingText('获得称号卷轴！', 'craft');
                }
            });
        }

        // 获取称号属性加成
        function getTitleBonus() {
            const activeTitle = gameState.player.titles.active;
            if (!activeTitle) return {};
            
            return activeTitle.effects || {};
        }

        function showSaveSlots() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('saveArea').classList.remove('hidden');
            
            const saveSlots = document.getElementById('saveSlots');
            saveSlots.innerHTML = '';
            
            // 显示5个存档槽位
            for (let i = 0; i < 5; i++) {
                const saveData = localStorage.getItem(`legendSave_${i}`);
                const slotDiv = document.createElement('div');
                slotDiv.className = 'bg-gray-800 p-4 rounded border-2 border-gray-600';
                
                if (saveData) {
                    try {
                        const data = JSON.parse(saveData);
                        slotDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-white">存档槽 ${i + 1}</div>
                                    <div class="text-sm text-gray-300">${classes[data.player.class].name} - 等级 ${data.player.level}</div>
                                    <div class="text-xs text-gray-400">${data.timestamp}</div>
                                </div>
                                <div class="space-x-2">
                                    <button onclick="loadGame(${i})" class="btn-primary px-3 py-1 rounded text-sm">加载</button>
                                    <button onclick="saveGame(${i})" class="btn-secondary px-3 py-1 rounded text-sm">覆盖</button>
                                    <button onclick="deleteSave(${i})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">删除</button>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        slotDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-white">存档槽 ${i + 1}</div>
                                    <div class="text-sm text-red-400">存档损坏</div>
                                </div>
                                <div class="space-x-2">
                                    <button onclick="saveGame(${i})" class="btn-secondary px-3 py-1 rounded text-sm">新建存档</button>
                                    <button onclick="deleteSave(${i})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">删除</button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    slotDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-white">存档槽 ${i + 1}</div>
                                <div class="text-sm text-gray-400">空槽位</div>
                            </div>
                            <div>
                                <button onclick="saveGame(${i})" class="btn-primary px-3 py-1 rounded text-sm">保存</button>
                            </div>
                        </div>
                    `;
                }
                
                saveSlots.appendChild(slotDiv);
            }
        }

        function hideSaveSlots() {
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('monsterArea').classList.remove('hidden');
        }

        // 属性面板功能
        function showAttributePanel() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('attributeArea').classList.remove('hidden');
            
            updateAttributeDisplay();
        }

        function hideAttributePanel() {
            document.getElementById('attributeArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('monsterArea').classList.remove('hidden');
        }

        function updateAttributeDisplay() {
            const player = gameState.player;
            
            // 基础属性
            document.getElementById('attrClass').textContent = classes[player.class].name;
            document.getElementById('attrLevel').textContent = player.level;
            
            // 计算包含百分比加成的最大生命值和魔法值
            const specialBonus = calculateSpecialEquipmentBonus();
            const setBonus = calculateSetBonus();
            const totalMaxHp = Math.floor(player.maxHp * (1 + (specialBonus.percentHp + setBonus.hp) / 100));
            const totalMaxMp = Math.floor(player.maxMp * (1 + (specialBonus.percentMp + setBonus.mp) / 100));
            
            document.getElementById('attrHp').textContent = `${player.hp}/${totalMaxHp}`;
            document.getElementById('attrMp').textContent = `${player.mp}/${totalMaxMp}`;
            document.getElementById('attrExp').textContent = `${player.exp}/${player.maxExp}`;
            document.getElementById('attrGold').textContent = player.gold;
            
            // 计算总攻击力
            let totalAttackMin = player.attack[0];
            let totalAttackMax = player.attack[1];
            if (player.equipment.weapon) {
                totalAttackMin += player.equipment.weapon.attack[0];
                totalAttackMax += player.equipment.weapon.attack[1];
            }
            
            // 应用特殊装备百分比攻击加成
            totalAttackMin *= (1 + specialBonus.percentAttack / 100);
            totalAttackMax *= (1 + specialBonus.percentAttack / 100);
            
            // 取整
            totalAttackMin = Math.floor(totalAttackMin);
            totalAttackMax = Math.floor(totalAttackMax);
            
            // 计算总防御力
            let totalDefense = player.defense;
            if (player.equipment.armor) {
                totalDefense += player.equipment.armor.defense;
            }
            
            // 计算总暴击率和暴击伤害
            let totalCritRate = player.critRate || 0;
            let totalCritDamage = player.critDamage || 150;
            let totalMagicPower = 0;
            
            // 装备加成
            if (player.equipment.weapon) {
                totalCritRate += player.equipment.weapon.critRate || 0;
                totalCritDamage += player.equipment.weapon.critDamage || 0;
                totalMagicPower += player.equipment.weapon.magicPower || 0;
            }
            if (player.equipment.armor) {
                totalCritRate += player.equipment.armor.critRate || 0;
                totalCritDamage += player.equipment.armor.critDamage || 0;
                totalMagicPower += player.equipment.armor.magicPower || 0;
            }
            if (player.equipment.ring) {
                totalCritRate += player.equipment.ring.critRate || 0;
                totalCritDamage += player.equipment.ring.critDamage || 0;
                totalMagicPower += player.equipment.ring.magicPower || 0;
                if (player.equipment.ring.attack) {
                    totalAttackMin += player.equipment.ring.attack[0];
                    totalAttackMax += player.equipment.ring.attack[1];
                }
                if (player.equipment.ring.defense) {
                    totalDefense += player.equipment.ring.defense;
                }
            }
            if (player.equipment.necklace) {
                totalCritRate += player.equipment.necklace.critRate || 0;
                totalCritDamage += player.equipment.necklace.critDamage || 0;
                totalMagicPower += player.equipment.necklace.magicPower || 0;
                if (player.equipment.necklace.attack) {
                    totalAttackMin += player.equipment.necklace.attack[0];
                    totalAttackMax += player.equipment.necklace.attack[1];
                }
                if (player.equipment.necklace.defense) {
                    totalDefense += player.equipment.necklace.defense;
                }
            }
            
            // 战斗属性
            document.getElementById('attrAttack').textContent = `${totalAttackMin}-${totalAttackMax}`;
            document.getElementById('attrDefense').textContent = totalDefense;
            document.getElementById('attrCritRate').textContent = `${totalCritRate}%`;
            document.getElementById('attrCritDamage').textContent = `${totalCritDamage}%`;
            document.getElementById('attrMagicPower').textContent = totalMagicPower;
            
            // 装备加成详情
            const equipmentBonus = document.getElementById('equipmentBonus');
            let bonusText = '';
            
            if (player.equipment.weapon) {
                const weapon = player.equipment.weapon;
                bonusText += `<div class="mb-2"><span class="text-yellow-400">${weapon.name}:</span> 攻击力+${weapon.attack[0]}-${weapon.attack[1]}`;
                if (weapon.critRate) bonusText += `, 暴击率+${weapon.critRate}%`;
                if (weapon.critDamage) bonusText += `, 暴击伤害+${weapon.critDamage}%`;
                if (weapon.magicPower) bonusText += `, 法术强度+${weapon.magicPower}`;
                bonusText += `</div>`;
            }
            
            if (player.equipment.armor) {
                const armor = player.equipment.armor;
                bonusText += `<div class="mb-2"><span class="text-blue-400">${armor.name}:</span> 防御力+${armor.defense}`;
                if (armor.hp) bonusText += `, 生命值+${armor.hp}`;
                if (armor.mp) bonusText += `, 魔法值+${armor.mp}`;
                if (armor.critRate) bonusText += `, 暴击率+${armor.critRate}%`;
                if (armor.critDamage) bonusText += `, 暴击伤害+${armor.critDamage}%`;
                if (armor.magicPower) bonusText += `, 法术强度+${armor.magicPower}`;
                bonusText += `</div>`;
            }
            
            if (player.equipment.ring) {
                const ring = player.equipment.ring;
                bonusText += `<div class="mb-2"><span class="text-green-400">${ring.name}:</span>`;
                if (ring.attack) bonusText += ` 攻击力+${ring.attack[0]}-${ring.attack[1]},`;
                if (ring.hp) bonusText += ` 生命值+${ring.hp},`;
                if (ring.mp) bonusText += ` 魔法值+${ring.mp},`;
                if (ring.defense) bonusText += ` 防御力+${ring.defense},`;
                if (ring.critRate) bonusText += ` 暴击率+${ring.critRate}%,`;
                if (ring.critDamage) bonusText += ` 暴击伤害+${ring.critDamage}%,`;
                if (ring.magicPower) bonusText += ` 法术强度+${ring.magicPower},`;
                bonusText = bonusText.replace(/,$/, ''); // 移除最后的逗号
                bonusText += `</div>`;
            }
            
            if (player.equipment.necklace) {
                const necklace = player.equipment.necklace;
                bonusText += `<div class="mb-2"><span class="text-purple-400">${necklace.name}:</span>`;
                if (necklace.attack) bonusText += ` 攻击力+${necklace.attack[0]}-${necklace.attack[1]},`;
                if (necklace.hp) bonusText += ` 生命值+${necklace.hp},`;
                if (necklace.mp) bonusText += ` 魔法值+${necklace.mp},`;
                if (necklace.defense) bonusText += ` 防御力+${necklace.defense},`;
                if (necklace.critRate) bonusText += ` 暴击率+${necklace.critRate}%,`;
                if (necklace.critDamage) bonusText += ` 暴击伤害+${necklace.critDamage}%,`;
                if (necklace.magicPower) bonusText += ` 法术强度+${necklace.magicPower},`;
                bonusText = bonusText.replace(/,$/, ''); // 移除最后的逗号
                bonusText += `</div>`;
            }
            
            // 添加特殊装备加成显示
            ['special1', 'special2', 'special3', 'special4'].forEach((slot, index) => {
                const equipment = player.equipment[slot];
                if (equipment) {
                    bonusText += `<div class="mb-2"><span class="text-orange-400">${equipment.name}:</span>`;
                    if (equipment.percentDamage) bonusText += ` 伤害+${equipment.percentDamage}%,`;
                    if (equipment.percentHp) bonusText += ` 生命+${equipment.percentHp}%,`;
                    if (equipment.percentMp) bonusText += ` 魔法+${equipment.percentMp}%,`;
                    if (equipment.percentAttack) bonusText += ` 攻击+${equipment.percentAttack}%,`;
                    if (equipment.divineMultiplier) bonusText += ` 神力倍攻x${equipment.divineMultiplier},`;
                    bonusText = bonusText.replace(/,$/, ''); // 移除最后的逗号
                    bonusText += `</div>`;
                }
            });
            
            if (bonusText === '') {
                bonusText = '<div>当前无装备加成</div>';
            }
            
            equipmentBonus.innerHTML = bonusText;
        }

        // 初始化游戏
        function initGame() {
            // 检查是否有自动存档
            const autoSave = localStorage.getItem('legendSave_auto');
            if (autoSave) {
                try {
                    const data = JSON.parse(autoSave);
                    // 在角色创建界面顶部添加继续游戏选项
                    const continueDiv = document.createElement('div');
                    continueDiv.className = 'text-center mb-6';
                    continueDiv.innerHTML = `
                        <div class="bg-gray-800 p-4 rounded border-2 border-yellow-500 mb-4">
                            <h3 class="text-yellow-400 font-bold mb-2">发现存档</h3>
                            <p class="text-gray-300 mb-2">${classes[data.player.class].name} - 等级 ${data.player.level}</p>
                            <p class="text-gray-400 text-sm mb-3">${data.timestamp}</p>
                            <div class="space-x-4">
                                <button onclick="loadGame(); this.parentElement.parentElement.parentElement.remove();" class="btn-primary px-4 py-2 rounded">继续游戏</button>
                                <button onclick="this.parentElement.parentElement.parentElement.remove();" class="btn-secondary px-4 py-2 rounded">新游戏</button>
                            </div>
                        </div>
                    `;
                    const characterCreation = document.getElementById('characterCreation');
                    characterCreation.insertBefore(continueDiv, characterCreation.firstChild);
                } catch (error) {
                    // 存档损坏，删除
                    localStorage.removeItem('legendSave_auto');
                }
            }
            
            document.getElementById('characterCreation').classList.remove('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
        }

        // 合成系统功能
        function showCraftPanel() {
            document.getElementById('monsterArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('attributeArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('craftArea').classList.remove('hidden');
            
            updateCraftRecipes();
        }

        function hideCraftPanel() {
            document.getElementById('craftArea').classList.add('hidden');
            document.getElementById('cultivationArea').classList.add('hidden');
            document.getElementById('shopArea').classList.add('hidden');
            document.getElementById('saveArea').classList.add('hidden');
            document.getElementById('battleArea').classList.add('hidden');
            document.getElementById('attributeArea').classList.add('hidden');
            document.getElementById('monsterArea').classList.remove('hidden');
        }

        function updateCraftRecipes() {
            const recipesContainer = document.getElementById('craftRecipes');
            recipesContainer.innerHTML = '';
            
            Object.keys(craftingRecipes).forEach(recipeName => {
                const recipe = craftingRecipes[recipeName];
                const recipeDiv = document.createElement('div');
                recipeDiv.className = 'bg-gray-800 p-3 rounded border-2 border-gray-600 cursor-pointer hover:border-blue-400';
                recipeDiv.onclick = () => selectRecipe(recipeName);
                
                recipeDiv.innerHTML = `
                    <div class="font-bold text-white">${recipeName}</div>
                    <div class="text-sm text-gray-300">金币: ${recipe.gold}</div>
                    <div class="text-xs text-gray-400 mt-1">${recipe.materials.length}种材料</div>
                `;
                
                recipesContainer.appendChild(recipeDiv);
            });
        }

        let selectedRecipe = null;

        function selectRecipe(recipeName) {
            selectedRecipe = recipeName;
            const recipe = craftingRecipes[recipeName];
            
            // 更新合成详情显示
            document.getElementById('craftDetails').classList.remove('hidden');
            
            // 显示所需材料
            const materialsContainer = document.getElementById('craftMaterials');
            materialsContainer.innerHTML = '';
            
            let canCraft = true;
            
            recipe.materials.forEach(material => {
                const playerCount = getPlayerMaterialCount(material.name);
                const hasEnough = playerCount >= material.count;
                if (!hasEnough) canCraft = false;
                
                const materialDiv = document.createElement('div');
                materialDiv.className = `flex justify-between items-center p-2 rounded ${hasEnough ? 'bg-green-800' : 'bg-red-800'}`;
                materialDiv.innerHTML = `
                    <span class="text-white">${material.name}</span>
                    <span class="${hasEnough ? 'text-green-300' : 'text-red-300'}">${playerCount}/${material.count}</span>
                `;
                
                materialsContainer.appendChild(materialDiv);
            });
            
            // 检查金币
            const hasEnoughGold = gameState.player.gold >= recipe.gold;
            if (!hasEnoughGold) canCraft = false;
            
            const goldDiv = document.createElement('div');
            goldDiv.className = `flex justify-between items-center p-2 rounded ${hasEnoughGold ? 'bg-green-800' : 'bg-red-800'}`;
            goldDiv.innerHTML = `
                <span class="text-white">金币</span>
                <span class="${hasEnoughGold ? 'text-green-300' : 'text-red-300'}">${gameState.player.gold}/${recipe.gold}</span>
            `;
            materialsContainer.appendChild(goldDiv);
            
            // 显示合成结果
            const resultContainer = document.getElementById('craftResult');
            const resultItem = equipment.specialEquipment.find(item => item.name === recipe.result);
            if (resultItem) {
                resultContainer.innerHTML = `
                    <div class="font-bold text-white">${resultItem.name}</div>
                    <div class="text-sm text-gray-300">${getItemDescription(resultItem)}</div>
                `;
            }
            
            // 更新合成按钮状态
            const craftButton = document.getElementById('craftButton');
            craftButton.disabled = !canCraft;
            craftButton.className = canCraft ? 'btn-primary px-4 py-2 rounded mt-3 w-full' : 'btn-secondary px-4 py-2 rounded mt-3 w-full opacity-50';
        }

        function getPlayerMaterialCount(materialName) {
            // 检查材料系统中的材料
            const material = gameState.player.materials.find(m => m.name === materialName);
            if (material) {
                return material.count;
            }
            
            // 如果材料系统中没有，检查背包中的物品
            return gameState.player.inventory.filter(item => item.name === materialName).length;
        }

        function performCraft() {
            if (!selectedRecipe) return;
            
            const recipe = craftingRecipes[selectedRecipe];
            
            // 检查材料和金币
            let canCraft = true;
            recipe.materials.forEach(material => {
                if (getPlayerMaterialCount(material.name) < material.count) {
                    canCraft = false;
                }
            });
            
            if (gameState.player.gold < recipe.gold) {
                canCraft = false;
            }
            
            if (!canCraft) {
                addLog('材料或金币不足，无法合成');
                return;
            }
            
            // 消耗材料
            recipe.materials.forEach(material => {
                // 优先从材料系统中消耗
                const playerMaterial = gameState.player.materials.find(m => m.name === material.name);
                if (playerMaterial && playerMaterial.count >= material.count) {
                    playerMaterial.count -= material.count;
                    // 如果材料数量为0，从数组中移除
                    if (playerMaterial.count <= 0) {
                        const materialIndex = gameState.player.materials.indexOf(playerMaterial);
                        gameState.player.materials.splice(materialIndex, 1);
                    }
                } else {
                    // 如果材料系统中不足，从背包中消耗
                    let remainingCount = material.count;
                    if (playerMaterial) {
                        remainingCount -= playerMaterial.count;
                        const materialIndex = gameState.player.materials.indexOf(playerMaterial);
                        gameState.player.materials.splice(materialIndex, 1);
                    }
                    
                    // 从背包中消耗剩余数量
                    for (let i = 0; i < remainingCount; i++) {
                        const index = gameState.player.inventory.findIndex(item => item.name === material.name);
                        if (index !== -1) {
                            gameState.player.inventory.splice(index, 1);
                        }
                    }
                }
            });
            
            // 消耗金币
            gameState.player.gold -= recipe.gold;
            
            // 获得合成结果
            const resultItem = equipment.specialEquipment.find(item => item.name === recipe.result);
            if (resultItem) {
                gameState.player.inventory.push({...resultItem});
                addLog(`成功合成了${resultItem.name}！`);
                showFloatingText(`合成成功！${resultItem.name}`, 'craft');
            }
            
            // 更新UI
            updateUI();
            updateCultivationDisplay(); // 更新养成系统显示
            selectRecipe(selectedRecipe); // 刷新合成详情
        }

        // 页面加载完成后初始化
        window.onload = function() {
            initGame();
            // 初始化任务和称号系统
            initializeQuests();
            checkTitleConditions();
        };
    </script>
</body>
</html>